 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Program.cs --- 
--- NOMBRE: Program.cs --- 
 
using IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Services;
using IntegraPro.DataAccess.Factory;
using Microsoft.OpenApi.Models;
using IntegraPro.API.Filters;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.IdentityModel.Tokens;
using System.Text;

var builder = WebApplication.CreateBuilder(args);

// ==========================================
// 1. CONFIGURACI”N DE CONEXI”N
// ==========================================
string connectionString = builder.Configuration.GetConnectionString("DefaultConnection")
    ?? "Server=DESKTOP-AR7JSQE\\SQLEXPRESS;Database=ERP_SistemaPro;Integrated Security=SSPI;TrustServerCertificate=True;";

// ==========================================
// 2. CONFIGURACI”N DE CORS Y AUTENTICACI”N
// ==========================================
builder.Services.AddCors(options => {
    options.AddPolicy("AllowAll", policy => {
        policy.AllowAnyOrigin().AllowAnyMethod().AllowAnyHeader();
    });
});

// --- ConfiguraciÛn de AutenticaciÛn JWT ---
// Sincronizamos la clave, emisor y audiencia con el UsuarioService usando appsettings.json
var jwtKey = builder.Configuration["Jwt:Key"] ?? "EstaEsUnaClaveSecretaMuyLargaDeAlMenos32Caracteres2026!";
var key = Encoding.ASCII.GetBytes(jwtKey);

builder.Services.AddAuthentication(x =>
{
    x.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    x.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(x =>
{
    x.RequireHttpsMetadata = false;
    x.SaveToken = true;
    x.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuerSigningKey = true,
        IssuerSigningKey = new SymmetricSecurityKey(key),

        // ValidaciÛn din·mica: Debe coincidir EXACTAMENTE con lo que genera el UsuarioService
        ValidateIssuer = true,
        ValidIssuer = builder.Configuration["Jwt:Issuer"] ?? "IntegraProAPI",

        ValidateAudience = true,
        ValidAudience = builder.Configuration["Jwt:Audience"] ?? "IntegraProUsers",

        ValidateLifetime = true,
        ClockSkew = TimeSpan.Zero
    };
});

// ==========================================
// 3. INYECCI”N DE DEPENDENCIAS (N-Capas)
// ==========================================

// --- Capa de Datos (Factories) ---
builder.Services.AddScoped(sp => new UsuarioFactory(connectionString));
builder.Services.AddScoped(sp => new ProductoFactory(connectionString));
builder.Services.AddScoped(sp => new CategoriaFactory(connectionString));
builder.Services.AddScoped(sp => new ConfiguracionFactory(connectionString));
builder.Services.AddScoped(sp => new InventarioFactory(connectionString));
builder.Services.AddScoped(sp => new VentaFactory(connectionString));
builder.Services.AddScoped(sp => new CajaFactory(connectionString));
builder.Services.AddScoped(sp => new ClienteFactory(connectionString));
builder.Services.AddScoped(sp => new ProveedorFactory(connectionString));
builder.Services.AddScoped(sp => new CompraFactory(connectionString));
builder.Services.AddScoped(sp => new AbonoFactory(connectionString));
builder.Services.AddScoped(sp => new ProformaFactory(connectionString));

// --- Capa de LÛgica (Services) ---
// --- Capa de LÛgica (Services) ---
builder.Services.AddScoped<IVentaService, VentaService>(); // Agregado para resolver el error 500
builder.Services.AddScoped<IConfiguracionService, ConfiguracionService>();
builder.Services.AddScoped<IUsuarioService, UsuarioService>();
builder.Services.AddScoped<IProductoService, ProductoService>();
builder.Services.AddScoped<ICategoriaService, CategoriaService>();
builder.Services.AddScoped<IInventarioService, InventarioService>();
builder.Services.AddScoped<IProveedorService, ProveedorService>();
builder.Services.AddScoped<IClienteService, ClienteService>();
builder.Services.AddScoped<ICompraService, CompraService>();
builder.Services.AddScoped<IProformaService, ProformaService>();
builder.Services.AddScoped<IAbonoService, AbonoService>();
builder.Services.AddScoped<ICajaService, CajaService>();
builder.Services.AddScoped<LicenciaService>();
builder.Services.AddScoped(sp => new XmlParserService(connectionString));

// ==========================================
// 4. SERVICIOS BASE DE LA API
// ==========================================
builder.Services.AddControllers(options =>
{
    options.Filters.Add<LicenseFilter>();
})
.AddJsonOptions(options =>
{
    // Esta es la lÌnea m·gica que resolver· tu problema:
    options.JsonSerializerOptions.PropertyNameCaseInsensitive = true;
});

builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new OpenApiInfo
    {
        Title = "IntegraPro ERP - Sistema de GestiÛn General",
        Version = "v1",
        Description = "API para gestiÛn de inventarios, facturaciÛn, compras y licenciamiento."
    });

    // ConfiguraciÛn para que Swagger permita enviar el Token JWT
    c.AddSecurityDefinition("Bearer", new OpenApiSecurityScheme
    {
        Description = "JWT Authorization header usando el esquema Bearer. \r\n\r\n Escriba 'Bearer' [espacio] y el token abajo.\r\n\r\nEjemplo: \"Bearer 12345abcdef\"",
        Name = "Authorization",
        In = ParameterLocation.Header,
        Type = SecuritySchemeType.ApiKey,
        Scheme = "Bearer"
    });

    c.AddSecurityRequirement(new OpenApiSecurityRequirement
    {
        {
            new OpenApiSecurityScheme
            {
                Reference = new OpenApiReference { Type = ReferenceType.SecurityScheme, Id = "Bearer" }
            },
            Array.Empty<string>()
        }
    });
});

var app = builder.Build();

// ==========================================
// 5. PIPELINE DE SOLICITUDES (Middlewares)
// ==========================================

// IMPORTANTE: El orden de los middlewares define el Èxito de la peticiÛn
app.UseCors("AllowAll");

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "IntegraPro API v1");
    });
}

app.UseHttpsRedirection();

// El orden aquÌ es CRÕTICO: Authentication siempre debe ir antes que Authorization
app.UseAuthentication();
app.UseAuthorization();

app.MapControllers();

app.Run();
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\AbonosController.cs --- 
--- NOMBRE: AbonosController.cs --- 
 
Ôªøusing Microsoft.AspNetCore.Mvc;
using IntegraPro.AppLogic.Interfaces;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Authorization;

namespace IntegraPro.API.Controllers;

[Route("api/[controller]")]
[ApiController]
[Authorize] // Importante: Asegura que el Token sea obligatorio
public class AbonosController(IAbonoService service) : BaseController // Hereda de tu BaseController
{
    private readonly IAbonoService _service = service;

    [HttpGet("buscar")]
    public IActionResult Buscar([FromQuery] string? filtro = null)
    {
        // Usamos UsuarioActual (la propiedad real de tu BaseController)
        var res = _service.BuscarCuentas(filtro, UsuarioActual);
        return res.Result ? Ok(res) : BadRequest(res);
    }

    [HttpGet("dashboard/resumen")]
    public IActionResult Resumen()
    {
        var res = _service.ObtenerResumenGeneral(UsuarioActual);
        return res.Result ? Ok(res) : BadRequest(res);
    }

    [HttpPost("registrar/{clienteId}")]
    public IActionResult Registrar(int clienteId, [FromBody] AbonoDTO abono)
    {
        var res = _service.ProcesarAbono(abono, clienteId, UsuarioActual);
        return res.Result ? Ok(res) : BadRequest(res);
    }

    [HttpGet("historial/{cuentaId}")]
    public IActionResult Historial(int cuentaId)
    {
        var res = _service.ObtenerHistorial(cuentaId, UsuarioActual);
        return res.Result ? Ok(res) : BadRequest(res);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\AuthController.cs --- 
--- NOMBRE: AuthController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;

namespace IntegraPro.API.Controllers;

[ApiController]
[Route("api/[controller]")]
// Heredamos de BaseController para usar 'UsuarioActual' en el registro
public class AuthController(IUsuarioService usuarioService) : BaseController
{
    private readonly IUsuarioService _usuarioService = usuarioService;

    [HttpPost("login")]
    [AllowAnonymous] // El login SIEMPRE debe ser p√∫blico
    public ActionResult<ApiResponse<UsuarioDTO>> Login([FromBody] LoginRequest request)
    {
        // El Login no usa UsuarioActual porque el usuario apenas se est√° identificando
        var response = _usuarioService.Login(request.Username, request.Password);

        if (!response.Result)
            return BadRequest(response);

        return Ok(response);
    }

    [HttpPost("register")]
    [Authorize] // Solo usuarios autenticados (Admin) pueden registrar a otros
    public ActionResult<ApiResponse<bool>> Register([FromBody] UsuarioDTO usuario)
    {
        // Eliminamos ObtenerEjecutor() local y usamos UsuarioActual del BaseController
        // Esto garantiza que el registro quede auditado con el ID del Admin real
        var response = _usuarioService.Registrar(usuario, UsuarioActual);

        if (!response.Result)
            return BadRequest(response);

        return Ok(response);
    }
}

public record LoginRequest(string Username, string Password);.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\BaseController.cs --- 
--- NOMBRE: BaseController.cs --- 
 
Ôªøusing Microsoft.AspNetCore.Mvc;
using IntegraPro.DTO.Models;
using System.Security.Claims;
using System.Diagnostics;
using System.Linq;

namespace IntegraPro.API.Controllers;

/// <summary>
/// Controlador base para centralizar la obtenci√≥n del usuario autenticado y sus permisos.
/// </summary>
public class BaseController : ControllerBase
{
    protected UsuarioDTO UsuarioActual
    {
        get
        {
            // Verificamos si hay un token v√°lido y el usuario est√° autenticado
            if (User.Identity?.IsAuthenticated == true)
            {
                // Obtenemos la lista de claims una sola vez para mejorar el rendimiento
                var claims = User.Claims.ToList();

                // Buscamos los valores de forma insensible a may√∫sculas (Case-Insensitive)
                // Esto evita que el sistema falle si el token trae "id" pero buscamos "Id"
                var userIdStr = claims.FirstOrDefault(c => c.Type.Equals("id", StringComparison.OrdinalIgnoreCase))?.Value
                                ?? User.FindFirst(ClaimTypes.NameIdentifier)?.Value
                                ?? "0";

                var rolIdStr = claims.FirstOrDefault(c => c.Type.Equals("rolId", StringComparison.OrdinalIgnoreCase))?.Value
                               ?? "0";

                var sucursalIdStr = claims.FirstOrDefault(c => c.Type.Equals("sucursalId", StringComparison.OrdinalIgnoreCase))?.Value
                                    ?? "0";

                var permisosRaw = claims.FirstOrDefault(c => c.Type.Equals("permisos", StringComparison.OrdinalIgnoreCase))?.Value;

                // --- BLOQUE DE DEPURACI√ìN EN CONSOLA ---
                Debug.WriteLine("================ AUTH DEBUG START ================");
                Debug.WriteLine($"[USUARIO]: {User.Identity.Name}");
                Debug.WriteLine($"[ID]: {userIdStr}");
                Debug.WriteLine($"[ROL]: {rolIdStr}");
                Debug.WriteLine($"[SUCURSAL]: {sucursalIdStr}");
                Debug.WriteLine($"[PERMISOS RAW]: {permisosRaw}");

                // Tip: Imprimimos todos los claims si permisosRaw llega nulo para ver qu√© nombres traen
                if (string.IsNullOrEmpty(permisosRaw))
                {
                    Debug.WriteLine("[WARN] No se encontr√≥ el claim 'permisos'. Claims disponibles:");
                    foreach (var c in claims) Debug.WriteLine($" -> {c.Type}: {c.Value}");
                }
                Debug.WriteLine("================= AUTH DEBUG END =================");

                return new UsuarioDTO
                {
                    Id = int.Parse(userIdStr),
                    RolId = int.Parse(rolIdStr),
                    SucursalId = int.Parse(sucursalIdStr),
                    Username = User.Identity.Name ?? "Sin nombre",
                    // Al asignar PermisosJson, el setter en UsuarioDTO har√° el resto
                    PermisosJson = permisosRaw ?? "{}"
                };
            }

            // Fallback para usuarios no autenticados
            return new UsuarioDTO
            {
                Id = 0,
                Username = "Anonimo",
                RolId = 0,
                SucursalId = 0,
                PermisosJson = "{}"
            };
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\CajaController.cs --- 
--- NOMBRE: CajaController.cs --- 
 
Ôªøusing Microsoft.AspNetCore.Mvc;
using IntegraPro.AppLogic.Interfaces;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Authorization;

namespace IntegraPro.API.Controllers;

[Route("api/[controller]")]
[ApiController]
[Authorize] // Bloquea el acceso si no hay un token JWT v√°lido
public class CajaController(ICajaService service) : BaseController // Herencia aplicada
{
    private readonly ICajaService _service = service;

    [HttpPost("abrir")]
    public IActionResult Abrir([FromBody] CajaAperturaDTO apertura)
    {
        // Usamos la propiedad UsuarioActual de BaseController
        var res = _service.AbrirCaja(apertura, UsuarioActual);
        return res.Result ? Ok(res) : BadRequest(res);
    }

    [HttpPost("cerrar")]
    public IActionResult Cerrar([FromBody] CajaCierreDTO cierre)
    {
        var res = _service.CerrarCaja(cierre, UsuarioActual);
        return res.Result ? Ok(res) : BadRequest(res);
    }

    [HttpGet("historial")]
    public IActionResult GetHistorial()
    {
        var res = _service.ObtenerHistorial(UsuarioActual);
        return res.Result ? Ok(res) : BadRequest(res);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\CategoriaController.cs --- 
--- NOMBRE: CategoriaController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;

namespace IntegraPro.API.Controllers;

[ApiController]
[Route("api/[controller]")]
[Authorize] // Asegura que las categor√≠as solo sean accesibles con Token
public class CategoriaController(ICategoriaService service) : BaseController // Herencia aplicada
{
    private readonly ICategoriaService _service = service;

    [HttpGet]
    public IActionResult Get()
    {
        // Usamos la propiedad 'UsuarioActual' heredada de BaseController
        var response = _service.ObtenerTodas(UsuarioActual);
        return response.Result ? Ok(response) : BadRequest(response);
    }

    [HttpPost]
    public IActionResult Post([FromBody] CategoriaDTO dto)
    {
        var response = _service.Crear(dto, UsuarioActual);
        return response.Result ? Ok(response) : BadRequest(response);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\ClienteController.cs --- 
--- NOMBRE: ClienteController.cs --- 
 
Ôªøusing Microsoft.AspNetCore.Mvc;
using IntegraPro.AppLogic.Interfaces;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Authorization;

namespace IntegraPro.API.Controllers;

[Route("api/[controller]")]
[ApiController]
[Authorize] // Protege todos los endpoints del controlador
public class ClienteController(IClienteService service) : BaseController // Hereda de BaseController
{
    private readonly IClienteService _service = service;

    [HttpGet]
    public IActionResult Get()
    {
        // Usamos UsuarioActual de la clase base
        var response = _service.ObtenerTodos(UsuarioActual);
        return response.Result ? Ok(response) : BadRequest(response);
    }

    [HttpPost]
    public IActionResult Post([FromBody] ClienteDTO cliente)
    {
        var response = _service.Crear(cliente, UsuarioActual);

        if (response.Result)
            return Ok(new { success = true, idCreated = response.Data, message = response.Message });

        return BadRequest(new { success = false, message = response.Message });
    }

    [HttpPut]
    public IActionResult Put([FromBody] ClienteDTO cliente)
    {
        var response = _service.Actualizar(cliente, UsuarioActual);

        if (response.Result)
            return Ok(new { success = true, message = response.Message });

        return BadRequest(new { success = false, message = response.Message });
    }

    [HttpGet("buscar/{identificacion}")]
    public IActionResult GetByIdentificacion(string identificacion)
    {
        // IMPORTANTE: Se a√±ade UsuarioActual para que el Service valide permisos de lectura
        var response = _service.BuscarPorIdentificacion(identificacion, UsuarioActual);

        if (!response.Result)
            return NotFound(new { success = false, message = response.Message });

        return Ok(new { success = true, data = response.Data });
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\CompraController.cs --- 
--- NOMBRE: CompraController.cs --- 
 
Ôªøusing Microsoft.AspNetCore.Mvc;
using IntegraPro.AppLogic.Interfaces;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Authorization;

namespace IntegraPro.API.Controllers;

[ApiController]
[Route("api/[controller]")]
[Authorize] // Protege todo el m√≥dulo de compras
public class CompraController(ICompraService compraService) : BaseController // Hereda de tu BaseController real
{
    private readonly ICompraService _service = compraService;

    [HttpPost]
    public IActionResult Post(CompraDTO compra)
    {
        try
        {
            // Usamos UsuarioActual del BaseController (ya trae claims y permisos)
            _service.RegistrarNuevaCompra(compra, UsuarioActual);
            return Ok(new { mensaje = "Compra procesada exitosamente." });
        }
        catch (UnauthorizedAccessException ex)
        {
            return StatusCode(403, new { error = ex.Message, detalle = "Acceso denegado al m√≥dulo de compras." });
        }
        catch (Exception ex)
        {
            return BadRequest(new { error = ex.Message });
        }
    }

    [HttpPost("pagar")]
    public IActionResult PagarFactura([FromBody] PagoCxpDTO pago)
    {
        try
        {
            _service.AbonarAFactura(pago, UsuarioActual);
            return Ok(new { mensaje = "Pago registrado exitosamente." });
        }
        catch (Exception ex)
        {
            return BadRequest(new { error = ex.Message });
        }
    }

    [HttpGet("resumen-general")]
    public IActionResult GetResumenGeneral()
    {
        try
        {
            var resumen = _service.ObtenerResumenCxp(UsuarioActual);
            return Ok(resumen);
        }
        catch (Exception ex)
        {
            return BadRequest(new { error = ex.Message });
        }
    }

    [HttpGet("buscar-deudas")]
    public IActionResult GetDeudas([FromQuery] string? filtro = null)
    {
        try
        {
            var deudas = _service.ListarDeudas(filtro ?? "", UsuarioActual);
            return Ok(deudas);
        }
        catch (Exception ex)
        {
            return BadRequest(new { error = ex.Message });
        }
    }

    [HttpGet("{compraId}/historial-pagos")]
    public IActionResult GetHistorialPagos(int compraId)
    {
        try
        {
            // Nota: Aqu√≠ podr√≠as pasar UsuarioActual si el service requiere filtrar por sucursal
            var historial = _service.ListarHistorialDePagos(compraId);
            return Ok(historial);
        }
        catch (Exception ex)
        {
            return BadRequest(new { error = ex.Message });
        }
    }

    [HttpDelete("{id}")]
    public IActionResult Anular(int id)
    {
        try
        {
            _service.AnularCompraExistente(id, UsuarioActual);
            return Ok(new { mensaje = "Compra anulada y stock revertido." });
        }
        catch (Exception ex)
        {
            return BadRequest(new { error = ex.Message });
        }
    }

    [HttpGet("alertas-pagos")]
    public IActionResult GetAlertas()
    {
        try
        {
            var alertas = _service.ListarAlertasPagos(UsuarioActual);
            return Ok(alertas);
        }
        catch (Exception ex)
        {
            return BadRequest(new { error = ex.Message });
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\ConfiguracionController.cs --- 
--- NOMBRE: ConfiguracionController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;

namespace IntegraPro.API.Controllers;

[ApiController]
[Route("api/[controller]")]
[Authorize] // Bloqueo global: nadie ve la config sin Token
public class ConfiguracionController(IConfiguracionService service) : BaseController // Hereda de BaseController
{
    private readonly IConfiguracionService _service = service;

    [HttpGet("empresa")]
    public IActionResult GetEmpresa()
    {
        // Usamos UsuarioActual de la clase base (elimina el Mock de Id=1)
        var res = _service.ObtenerDatosEmpresa(UsuarioActual);
        return res.Result ? Ok(res) : NotFound(res);
    }

    [HttpPost("empresa")]
    public IActionResult SaveEmpresa([FromBody] EmpresaDTO dto)
    {
        var res = _service.ActualizarEmpresa(dto, UsuarioActual);
        return res.Result ? Ok(res) : BadRequest(res);
    }

    [HttpPut("empresa/{id}")]
    public IActionResult UpdateEmpresa(int id, [FromBody] EmpresaDTO dto)
    {
        dto.Id = id;
        var res = _service.ActualizarEmpresa(dto, UsuarioActual);
        return res.Result ? Ok(res) : BadRequest(res);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\InventarioController.cs --- 
--- NOMBRE: InventarioController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;

namespace IntegraPro.API.Controllers;

[ApiController]
[Route("api/[controller]")]
[Authorize] // Bloqueo de seguridad: Requiere Token JWT
public class InventarioController(IInventarioService service) : BaseController // Herencia aplicada
{
    private readonly IInventarioService _service = service;

    /// <summary>
    /// Registra un movimiento de inventario manual.
    /// POST: api/inventario
    /// </summary>
    [HttpPost]
    public IActionResult Post([FromBody] MovimientoInventarioDTO dto)
    {
        // Usamos 'UsuarioActual' del BaseController. 
        // Si el token es inv√°lido, el BaseController ya maneja el fallback o [Authorize] rebota la petici√≥n.
        var result = _service.Registrar(dto, UsuarioActual);

        return result.Result ? Ok(result) : BadRequest(result);
    }

    /// <summary>
    /// Procesa la producci√≥n (Explosi√≥n de materiales).
    /// POST: api/inventario/producir
    /// </summary>
    [HttpPost("producir")]
    public IActionResult Producir([FromQuery] int productoId, [FromQuery] decimal cantidad)
    {
        // Al usar 'UsuarioActual', garantizamos que se use la SucursalId real del usuario logueado
        var result = _service.ProcesarProduccion(productoId, cantidad, UsuarioActual);

        return result.Result ? Ok(result) : BadRequest(result);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\LicenciaController.cs --- 
--- NOMBRE: LicenciaController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Services;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace IntegraPro.API.Controllers; // Ajustado al namespace de tus otros controllers

[ApiController]
[Route("api/[controller]")]
public class LicenciaController(LicenciaService service) : BaseController // Herencia aplicada
{
    private readonly LicenciaService _service = service;

    [AllowAnonymous]
    [HttpGet("mi-hardware-id")]
    public IActionResult GetHardwareId() => Ok(new { hardwareId = _service.GetHardwareId() });

    [AllowAnonymous]
    [HttpPost("activar")]
    public IActionResult Activar([FromQuery] string llave, [FromQuery] string empresa, [FromQuery] string ruc, [FromQuery] int maxEquipos)
    {
        // Usamos el sistema de permisos de UsuarioDTO pero marcado como Sistema (ID 0)
        // ya que en la activaci√≥n inicial no hay un token JWT todav√≠a.
        var sistema = new UsuarioDTO { Id = 0, RolId = 1, SucursalId = 1, PermisosJson = "{\"config\":true}" };

        var response = _service.ActivarLicencia(llave, empresa, ruc, maxEquipos, sistema);
        return Ok(response);
    }

    [AllowAnonymous]
    [HttpPost("auto-activar")]
    public IActionResult AutoActivar([FromQuery] string empresa, [FromQuery] string ruc)
    {
        try
        {
            var sistema = new UsuarioDTO { Id = 0, RolId = 1, SucursalId = 1, PermisosJson = "{\"config\":true}" };

            string hid = _service.GetHardwareId();
            int equiposGratis = 5;
            string llaveGenerada = _service.GenerarLlave(ruc, hid, equiposGratis);

            var response = _service.ActivarLicencia(llaveGenerada, empresa, ruc, equiposGratis, sistema);
            return Ok(response);
        }
        catch (Exception ex) { return BadRequest(new ApiResponse<bool>(false, ex.Message)); }
    }

    [HttpGet("validar-estado")]
    [Authorize] // Para validar el estado actual, s√≠ exigimos que el usuario est√© logueado
    public IActionResult Validar()
    {
        // Aqu√≠ podr√≠as incluso pasar UsuarioActual si el servicio lo requiere para auditor√≠a
        var response = _service.ValidarSistema();
        return response.Result ? Ok(response) : StatusCode(403, response);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\ProductoController.cs --- 
--- NOMBRE: ProductoController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;

namespace IntegraPro.API.Controllers;

[ApiController]
[Route("api/[controller]")]
[Authorize] // Exigimos Token JWT para cualquier operaci√≥n de productos
public class ProductoController(IProductoService service) : BaseController // Herencia de tu BaseController real
{
    private readonly IProductoService _service = service;

    [HttpGet]
    public IActionResult Get()
    {
        // Usamos UsuarioActual (la propiedad real del BaseController)
        var response = _service.ObtenerTodos(UsuarioActual);
        return response.Result ? Ok(response) : BadRequest(response);
    }

    [HttpGet("{id}")]
    public IActionResult GetById(int id)
    {
        var response = _service.ObtenerPorId(id, UsuarioActual);
        return response.Result ? Ok(response) : NotFound(response);
    }

    [HttpPost]
    public IActionResult Post([FromBody] ProductoDTO dto)
    {
        var response = _service.Crear(dto, UsuarioActual);
        return response.Result ? Ok(response) : BadRequest(response);
    }

    [HttpPut]
    public IActionResult Put([FromBody] ProductoDTO dto)
    {
        var response = _service.Actualizar(dto, UsuarioActual);
        return response.Result ? Ok(response) : BadRequest(response);
    }

    [HttpGet("alertas")]
    public IActionResult GetAlertas()
    {
        var response = _service.ObtenerAlertasStock(UsuarioActual);
        return response.Result ? Ok(response) : BadRequest(response);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\ProformasController.cs --- 
--- NOMBRE: ProformasController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Mvc;
using QuestPDF.Fluent;
using QuestPDF.Infrastructure;
using Microsoft.AspNetCore.Authorization;

namespace IntegraPro.API.Controllers;

[ApiController]
[Route("api/[controller]")]
[Authorize] // Asegura que nadie entre sin Token
public class ProformasController(
    IProformaService service,
    IConfiguracionService configService) : BaseController // HERENCIA: Ahora hereda de tu BaseController
{
    private readonly IProformaService _service = service;
    private readonly IConfiguracionService _configService = configService;

    [HttpPost]
    public IActionResult Post(ProformaEncabezadoDTO dto)
    {
        // CAMBIO: Usamos UsuarioActual (heredado)
        var res = _service.GuardarProforma(dto, UsuarioActual);
        return res.Result ? Ok(res) : TratarResultadoFallido(res);
    }

    [HttpGet]
    public IActionResult Get(string filtro = "")
    {
        var res = _service.Consultar(filtro, UsuarioActual);
        return Ok(res);
    }

    [HttpGet("{id}")]
    public IActionResult GetById(int id)
    {
        var res = _service.ObtenerPorId(id, UsuarioActual);
        return res.Result ? Ok(res) : NotFound(res);
    }

    [HttpGet("{id}/imprimir")]
    public IActionResult GenerarPdf(int id)
    {
        try
        {
            // CAMBIO: Usamos UsuarioActual
            var resProforma = _service.ObtenerPorId(id, UsuarioActual);
            var resEmpresa = _configService.ObtenerDatosEmpresa(UsuarioActual);

            if (!resProforma.Result || resProforma.Data == null) return NotFound(resProforma);
            if (!resEmpresa.Result || resEmpresa.Data == null) return BadRequest(resEmpresa);

            QuestPDF.Settings.License = LicenseType.Community;

            var documento = new Reports.ProformaReport(resProforma.Data, resEmpresa.Data);
            byte[] pdfBytes = documento.GeneratePdf();

            return File(pdfBytes, "application/pdf", $"Proforma_{id}_{DateTime.Now:yyyyMMdd}.pdf");
        }
        catch (Exception ex)
        {
            return BadRequest(new ApiResponse<string>(false, "Error al generar reporte: " + ex.Message));
        }
    }

    [HttpGet("cliente/{clienteId}")]
    public IActionResult GetByCliente(int clienteId)
    {
        var res = _service.ObtenerPorCliente(clienteId, UsuarioActual);
        return Ok(res);
    }

    [HttpPatch("{id}/anular")]
    public IActionResult Anular(int id)
    {
        var res = _service.Anular(id, UsuarioActual);
        return res.Result ? Ok(res) : TratarResultadoFallido(res);
    }

    [HttpPost("{id}/convertir-a-factura")]
    public IActionResult Facturar(int id, [FromQuery] string medio = "Efectivo")
    {
        var res = _service.Facturar(id, medio, UsuarioActual);
        return res.Result ? Ok(res) : TratarResultadoFallido(res);
    }

    private IActionResult TratarResultadoFallido<T>(ApiResponse<T> res)
    {
        if (res.Message.Contains("denegado") || res.Message.Contains("No tiene permiso"))
            return StatusCode(403, res);

        return BadRequest(res);
    }

    // NOTA: Se borr√≥ ObtenerEjecutor() porque BaseController ya lo hace mejor.
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\ProveedorController.cs --- 
--- NOMBRE: ProveedorController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace IntegraPro.API.Controllers;

[ApiController]
[Route("api/[controller]")]
[Authorize] // Protegemos el acceso global al controlador
public class ProveedorController(IProveedorService service) : BaseController // Herencia de BaseController
{
    private readonly IProveedorService _service = service;

    // Obtener todos los proveedores
    [HttpGet]
    public IActionResult Get()
    {
        // UsuarioActual viene del BaseController con todos sus Claims
        var response = _service.ObtenerTodos(UsuarioActual);
        return response.Result ? Ok(response) : BadRequest(response);
    }

    // Crear un nuevo proveedor
    [HttpPost]
    public IActionResult Post([FromBody] ProveedorDTO proveedor)
    {
        var response = _service.Crear(proveedor, UsuarioActual);

        // Si el servicio lanza un UnauthorizedAccessException, el BaseController o 
        // la l√≥gica del Service lo atrapar√°. Aqu√≠ retornamos 403 si falla el permiso.
        if (!response.Result && response.Message.Contains("permiso"))
            return StatusCode(403, response);

        return response.Result ? Ok(response) : BadRequest(response);
    }

    // Actualizar un proveedor existente
    [HttpPut]
    public IActionResult Put([FromBody] ProveedorDTO proveedor)
    {
        if (proveedor.Id <= 0)
            return BadRequest(new ApiResponse<bool>(false, "ID de proveedor no v√°lido para actualizar."));

        var response = _service.Actualizar(proveedor, UsuarioActual);
        return response.Result ? Ok(response) : BadRequest(response);
    }

    // Eliminar (o desactivar) un proveedor
    [HttpDelete("{id}")]
    public IActionResult Delete(int id)
    {
        if (id <= 0)
            return BadRequest(new ApiResponse<bool>(false, "ID de proveedor no v√°lido."));

        var response = _service.Eliminar(id, UsuarioActual);
        return response.Result ? Ok(response) : BadRequest(response);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\UsuarioController.cs --- 
--- NOMBRE: UsuarioController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization; // Necesario para [Authorize]
using System.Security.Claims;

namespace IntegraPro.API.Controllers;

[Route("api/[controller]")]
[ApiController]
[Authorize] // <--- MEDIDA DE SEGURIDAD 1: Todo el controlador requiere JWT por defecto
public class UsuarioController(IUsuarioService service) : ControllerBase
{
    private readonly IUsuarioService _service = service;

    [HttpPost("login")]
    [AllowAnonymous] // <--- MEDIDA DE SEGURIDAD 2: El login es la √∫nica puerta abierta
    public IActionResult Login([FromBody] LoginRequest request)
    {
        var result = _service.Login(request.Username, request.Password);
        if (!result.Result) return Unauthorized(result);
        return Ok(result);
    }

    [HttpPost("registrar")]
    public IActionResult Registrar([FromBody] UsuarioDTO usuario)
    {
        var result = _service.Registrar(usuario, ObtenerEjecutor());
        if (!result.Result) return BadRequest(result);
        return Ok(result);
    }

    [HttpPost("logout/{id}")]
    public IActionResult Logout(int id)
    {
        // Validamos que el usuario solo pueda cerrarse la sesi√≥n a s√≠ mismo 
        // a menos que sea un administrador.
        var result = _service.Logout(id);
        return Ok(result);
    }

    [HttpPost("forzar-cierre")]
    [AllowAnonymous] // Se permite an√≥nimo para que el usuario libere su propia sesi√≥n si se trab√≥
    public IActionResult ForzarCierre([FromBody] LoginRequest request)
    {
        var result = _service.ForzarCierreSesion(request.Username, request.Password);
        if (!result.Result) return BadRequest(result);
        return Ok(result);
    }

    [HttpGet("listar-todos")]
    public IActionResult GetAll()
    {
        var result = _service.ObtenerTodos(ObtenerEjecutor());
        return Ok(result);
    }

    [HttpGet("roles-disponibles")]
    public IActionResult GetRoles()
    {
        var result = _service.ListarRolesDisponibles(ObtenerEjecutor());
        return Ok(result);
    }

    [HttpPut("actualizar-rol")]
    public IActionResult UpdateRol([FromQuery] int usuarioId, [FromQuery] int nuevoRolId)
    {
        var result = _service.ActualizarRol(usuarioId, nuevoRolId, ObtenerEjecutor());
        if (!result.Result) return BadRequest(result);
        return Ok(result);
    }

    private UsuarioDTO ObtenerEjecutor()
    {
        // MEDIDA DE SEGURIDAD 3: Sincronizaci√≥n exacta con los claims del JWT generado en el Service
        if (User.Identity?.IsAuthenticated == true)
        {
            return new UsuarioDTO
            {
                // Usamos los strings exactos que definimos en UsuarioService.GenerarJwtToken
                Id = int.Parse(User.FindFirst("id")?.Value ?? "0"),
                RolId = int.Parse(User.FindFirst("rolId")?.Value ?? "0"),
                SucursalId = int.Parse(User.FindFirst("sucursalId")?.Value ?? "0"),
                Username = User.Identity.Name ?? string.Empty,
                PermisosJson = User.FindFirst("permisos")?.Value
            };
        }

        // Ya no devolvemos un Admin de prueba. Si llegamos aqu√≠, es un error de seguridad.
        throw new UnauthorizedAccessException("Operaci√≥n no permitida sin una sesi√≥n v√°lida.");
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\VentaController.cs --- 
--- NOMBRE: VentaController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces; // Usar la interfaz para Inyecci√≥n de Dependencias
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;
using QuestPDF.Fluent;
using QuestPDF.Infrastructure;
using IntegraPro.API.Reports;
using System.Data;
using System.Security.Claims;

namespace IntegraPro.API.Controllers;

[Route("api/[controller]")]
[ApiController]
[Authorize] // Asegura que nadie sin Token JWT pueda facturar o ver reportes
public class VentaController(IVentaService service) : ControllerBase
{
    private readonly IVentaService _service = service;

    [HttpPost]
    public IActionResult Post([FromBody] FacturaDTO factura)
    {
        // Forzamos datos de Hacienda (Simulaci√≥n)
        factura.EstadoHacienda = "ACEPTADO";
        factura.EsOffline = false;

        var response = _service.ProcesarVenta(factura, ObtenerEjecutor());

        if (!response.Result)
            return BadRequest(response);

        return Ok(new
        {
            success = true,
            factura = response.Data, // El consecutivo generado
            estado = factura.EstadoHacienda,
            message = response.Message
        });
    }

    [HttpGet("reportes")]
    public IActionResult GetReportes(
        [FromQuery] DateTime? desde,
        [FromQuery] DateTime? hasta,
        [FromQuery] int? clienteId,
        [FromQuery] string buscar = "",
        [FromQuery] string? condicion = "")
    {
        DateTime fechaInicio = desde ?? DateTime.Now.AddMonths(-1);
        DateTime fechaFin = hasta ?? DateTime.Now;

        var response = _service.ObtenerReporteVentas(
            fechaInicio,
            fechaFin,
            clienteId,
            buscar ?? "",
            condicion ?? "",
            ObtenerEjecutor()
        );

        if (!response.Result)
            return BadRequest(response);

        DataTable dt = response.Data;
        decimal sumaTotales = 0;
        var filas = new List<Dictionary<string, object>>();

        foreach (DataRow row in dt.Rows)
        {
            var diccionario = new Dictionary<string, object>();
            foreach (DataColumn col in dt.Columns)
            {
                diccionario[col.ColumnName] = row[col] == DBNull.Value ? null : row[col];
            }
            filas.Add(diccionario);

            if (dt.Columns.Contains("total_comprobante") && row["total_comprobante"] != DBNull.Value)
                sumaTotales += Convert.ToDecimal(row["total_comprobante"]);
        }

        return Ok(new
        {
            success = true,
            conteo = filas.Count,
            totalSuma = sumaTotales,
            data = filas
        });
    }

    [HttpGet("imprimir/{id}")]
    public IActionResult Imprimir(int id)
    {
        var ejecutor = ObtenerEjecutor();

        // 1. Obtener la factura
        var responseFactura = _service.ObtenerFacturaParaImpresion(id, ejecutor);
        if (!responseFactura.Result || responseFactura.Data == null)
            return NotFound(responseFactura);

        // 2. Obtener datos de la empresa (Ahora requiere ejecutor)
        var responseEmpresa = _service.ObtenerEmpresa(ejecutor);
        if (!responseEmpresa.Result || responseEmpresa.Data == null)
            return BadRequest(responseEmpresa);

        try
        {
            QuestPDF.Settings.License = LicenseType.Community;

            var documento = new FacturaReport(responseFactura.Data, responseEmpresa.Data);
            byte[] pdfBytes = documento.GeneratePdf();

            return File(pdfBytes, "application/pdf", $"Factura_{responseFactura.Data.Consecutivo}.pdf");
        }
        catch (Exception ex)
        {
            return BadRequest(new { success = false, message = "Error al renderizar PDF: " + ex.Message });
        }
    }

    /// <summary>
    /// Extrae de forma segura la identidad del usuario desde el Token JWS.
    /// </summary>
    private UsuarioDTO ObtenerEjecutor()
    {
        if (User.Identity?.IsAuthenticated == true)
        {
            return new UsuarioDTO
            {
                Id = int.Parse(User.FindFirst("Id")?.Value ?? "0"),
                RolId = int.Parse(User.FindFirst("RolId")?.Value ?? "0"),
                SucursalId = int.Parse(User.FindFirst("SucursalId")?.Value ?? "0"),
                Username = User.Identity.Name ?? "System",
                // Cargamos permisos desde el token si existen
                PermisosJson = User.FindFirst("permisos")?.Value
            };
        }

        // En producci√≥n, esto deber√≠a lanzar un error de No Autorizado
        throw new UnauthorizedAccessException("Debe estar autenticado para realizar esta operaci√≥n.");
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\XmlController.cs --- 
--- NOMBRE: XmlController.cs --- 
 
Ôªøusing Microsoft.AspNetCore.Mvc;
using IntegraPro.AppLogic.Services;

namespace IntegraPro.API.Controllers;

[ApiController]
[Route("api/[controller]")]
public class XmlController(IConfiguration config) : ControllerBase
{
    private readonly string _conn = config.GetConnectionString("DefaultConnection")!;

    [HttpPost("preprocesar")]
    public IActionResult SubirXml(IFormFile archivo)
    {
        if (archivo == null) return BadRequest("No se recibi√≥ archivo.");

        using var reader = new StreamReader(archivo.OpenReadStream());
        string contenido = reader.ReadToEnd();

        var service = new XmlParserService(_conn);
        var resultado = service.ProcesarFacturaCR(contenido);

        return Ok(resultado);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Filters\LicenseFilter.cs --- 
--- NOMBRE: LicenseFilter.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Services;
using IntegraPro.DataAccess.Factory;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Filters;
using System.Security.Claims;

namespace IntegraPro.API.Filters;

public class LicenseFilter : IAuthorizationFilter
{
    private readonly LicenciaService _licenciaService;
    private readonly UsuarioFactory _usuarioFactory;

    public LicenseFilter(LicenciaService licenciaService, UsuarioFactory usuarioFactory)
    {
        _licenciaService = licenciaService;
        _usuarioFactory = usuarioFactory;
    }

    public void OnAuthorization(AuthorizationFilterContext context)
    {
        // =================================================================================
        // EXCEPCI√ìN: Permitir el paso libre a los endpoints de Activaci√≥n
        // =================================================================================
        var path = context.HttpContext.Request.Path.Value?.ToLower() ?? "";

        // Si la URL contiene "licencia", permitimos el acceso sin validar hardware ni sesi√≥n
        if (path.Contains("/api/licencia"))
        {
            return;
        }

        // 1. VALIDACI√ìN DE HARDWARE (¬øLa PC tiene permiso de usar el software?)
        var validacionHardware = _licenciaService.ValidarSistema();
        string hidActual = _licenciaService.GetHardwareId();

        if (!validacionHardware.Result)
        {
            context.Result = new ObjectResult(new
            {
                Result = false,
                Message = "EQUIPO_NO_AUTORIZADO",
                Details = "Esta computadora no cuenta con una licencia activa."
            })
            { StatusCode = 403 };
            return;
        }

        // 2. VALIDACI√ìN DE SESI√ìN √öNICA (¬øEs este usuario el que se logue√≥ en esta PC?)
        var username = context.HttpContext.User.Identity?.Name;

        if (!string.IsNullOrEmpty(username))
        {
            var usuario = _usuarioFactory.GetByUsername(username);

            if (usuario != null && !string.IsNullOrEmpty(usuario.HardwareIdSesion))
            {
                if (usuario.HardwareIdSesion != hidActual)
                {
                    context.Result = new ObjectResult(new
                    {
                        Result = false,
                        Message = "SESION_INVALIDA_OTRO_EQUIPO",
                        Details = "Tu sesi√≥n ha sido abierta en otra computadora. Se ha cerrado el acceso aqu√≠."
                    })
                    { StatusCode = 401 };
                }
            }
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\obj\Debug\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
--- NOMBRE: .NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
 
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\obj\Debug\net9.0\IntegraPro.API.AssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.API.AssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("IntegraPro.API")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0+4153b5f28a857579dabbc5516649e889b6ddb8bd")]
[assembly: System.Reflection.AssemblyProductAttribute("IntegraPro.API")]
[assembly: System.Reflection.AssemblyTitleAttribute("IntegraPro.API")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\obj\Debug\net9.0\IntegraPro.API.GlobalUsings.g.cs --- 
--- NOMBRE: IntegraPro.API.GlobalUsings.g.cs --- 
 
// <auto-generated/>
global using global::Microsoft.AspNetCore.Builder;
global using global::Microsoft.AspNetCore.Hosting;
global using global::Microsoft.AspNetCore.Http;
global using global::Microsoft.AspNetCore.Routing;
global using global::Microsoft.Extensions.Configuration;
global using global::Microsoft.Extensions.DependencyInjection;
global using global::Microsoft.Extensions.Hosting;
global using global::Microsoft.Extensions.Logging;
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Net.Http.Json;
global using global::System.Threading;
global using global::System.Threading.Tasks;
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\obj\Debug\net9.0\IntegraPro.API.MvcApplicationPartsAssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.API.MvcApplicationPartsAssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: Microsoft.AspNetCore.Mvc.ApplicationParts.ApplicationPartAttribute("Microsoft.AspNetCore.OpenApi")]
[assembly: Microsoft.AspNetCore.Mvc.ApplicationParts.ApplicationPartAttribute("Swashbuckle.AspNetCore.SwaggerGen")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Reports\FacturaReport.cs --- 
--- NOMBRE: FacturaReport.cs --- 
 
Ôªøusing QuestPDF.Fluent;
using QuestPDF.Helpers;
using QuestPDF.Infrastructure;
using IntegraPro.DTO.Models;

namespace IntegraPro.API.Reports;

public class FacturaReport(FacturaDTO model, EmpresaDTO empresa) : IDocument
{
    public DocumentMetadata GetMetadata() => DocumentMetadata.Default;

    public void Compose(IDocumentContainer container)
    {
        string regimen = empresa.TipoRegimen?.ToUpper() ?? "TRADICIONAL";

        container.Page(page =>
        {
            page.Margin(1f, Unit.Centimetre);
            page.DefaultTextStyle(x => x.FontFamily(Fonts.Arial).FontSize(10));

            // ENCABEZADO
            page.Header().Row(row =>
            {
                row.RelativeItem().Column(col =>
                {
                    col.Item().Text(empresa.NombreComercial.ToUpper()).FontSize(18).Bold().FontColor(Colors.Blue.Medium);
                    col.Item().Text(empresa.RazonSocial).FontSize(10).SemiBold();
                    col.Item().Text($"C√©dula Jur√≠dica: {empresa.CedulaJuridica}");

                    if (!string.IsNullOrEmpty(empresa.Telefono))
                        col.Item().Text($"Tel√©fono: {empresa.Telefono}");

                    if (regimen == "SIMPLIFICADO")
                        col.Item().PaddingTop(5f).Text("R√©gimen Simplificado").FontSize(9).Italic().FontColor(Colors.Grey.Medium);
                });

                row.RelativeItem().AlignRight().Column(col =>
                {
                    col.Item().Text("FACTURA ELECTR√ìNICA").FontSize(16).Light();
                    col.Item().Text($"# {model.Consecutivo ?? "000000"}").Bold();
                    col.Item().Text($"Fecha: {model.Fecha:dd/MM/yyyy HH:mm}");
                    col.Item().Text($"Condici√≥n: {model.CondicionVenta}").FontSize(9);
                });
            });

            // CONTENIDO
            page.Content().PaddingVertical(0.5f, Unit.Centimetre).Column(col =>
            {
                // SECCI√ìN CLIENTE (IGUAL A PROFORMA)
                col.Item().PaddingBottom(5f).BorderBottom(1f).BorderColor(Colors.Grey.Lighten2).Row(row =>
                {
                    row.RelativeItem().Column(c => {
                        c.Item().Text(t => {
                            t.Span("CLIENTE: ").Bold();
                            t.Span(model.ClienteNombre?.ToUpper() ?? "CLIENTE CONTADO");
                        });

                        if (!string.IsNullOrEmpty(model.ClienteIdentificacion))
                        {
                            c.Item().Text(t => {
                                t.Span("C√âDULA: ").Bold().FontSize(9);
                                t.Span(model.ClienteIdentificacion).FontSize(9);
                            });
                        }
                    });

                    row.RelativeItem().AlignRight().Text(t => {
                        t.Span("PAGO: ").Bold();
                        t.Span(model.MedioPago.ToUpper());
                    });
                });

                // TABLA DE PRODUCTOS
                col.Item().PaddingTop(10f).Table(table =>
                {
                    table.ColumnsDefinition(columns => {
                        columns.RelativeColumn(3f);
                        columns.RelativeColumn(0.7f);
                        columns.RelativeColumn(1.2f);
                        if (regimen != "SIMPLIFICADO")
                        {
                            columns.RelativeColumn(0.6f);
                            columns.RelativeColumn(1f);
                        }
                        columns.RelativeColumn(1.2f);
                    });

                    table.Header(header => {
                        header.Cell().BorderBottom(1f).PaddingBottom(5f).Text("Producto").Bold();
                        header.Cell().BorderBottom(1f).PaddingBottom(5f).AlignRight().Text("Cant.").Bold();
                        header.Cell().BorderBottom(1f).PaddingBottom(5f).AlignRight().Text("P. Unit").Bold();
                        if (regimen != "SIMPLIFICADO")
                        {
                            header.Cell().BorderBottom(1f).PaddingBottom(5f).AlignRight().Text("%").Bold();
                            header.Cell().BorderBottom(1f).PaddingBottom(5f).AlignRight().Text("IVA").Bold();
                        }
                        header.Cell().BorderBottom(1f).PaddingBottom(5f).AlignRight().Text("Total").Bold();
                    });

                    foreach (var item in model.Detalles)
                    {
                        table.Cell().PaddingVertical(2f).BorderBottom(1f).BorderColor(Colors.Grey.Lighten4).Text(item.ProductoNombre ?? "N/A").FontSize(9);
                        table.Cell().PaddingVertical(2f).BorderBottom(1f).BorderColor(Colors.Grey.Lighten4).AlignRight().Text(item.Cantidad.ToString("N2"));
                        table.Cell().PaddingVertical(2f).BorderBottom(1f).BorderColor(Colors.Grey.Lighten4).AlignRight().Text(item.PrecioUnitario.ToString("N2"));

                        if (regimen != "SIMPLIFICADO")
                        {
                            table.Cell().PaddingVertical(2f).BorderBottom(1f).BorderColor(Colors.Grey.Lighten4).AlignRight().Text($"{item.PorcentajeImpuesto:N0}%").FontSize(8);
                            table.Cell().PaddingVertical(2f).BorderBottom(1f).BorderColor(Colors.Grey.Lighten4).AlignRight().Text(item.MontoImpuesto.ToString("N2"));
                        }
                        table.Cell().PaddingVertical(2f).BorderBottom(1f).BorderColor(Colors.Grey.Lighten4).AlignRight().Text(item.TotalLinea.ToString("N2")).Bold();
                    }
                });

                // TOTALES
                col.Item().AlignRight().PaddingTop(10f).MinWidth(200f).Column(c =>
                {
                    c.Item().Row(r => {
                        r.RelativeItem().Text("Subtotal:").AlignRight();
                        r.ConstantItem(85f).AlignRight().Text($"{model.TotalNeto:N2}");
                    });

                    if (regimen != "SIMPLIFICADO")
                    {
                        c.Item().Row(r => {
                            r.RelativeItem().Text("IVA:").AlignRight();
                            r.ConstantItem(85f).AlignRight().Text($"{model.TotalImpuesto:N2}");
                        });
                    }

                    c.Item().PaddingTop(5f).BorderTop(1f).Row(r => {
                        r.RelativeItem().Text("TOTAL:").FontSize(14).Bold().FontColor(Colors.Blue.Medium).AlignRight();
                        r.ConstantItem(85f).AlignRight().Text($"{model.TotalComprobante:N2}").FontSize(14).Bold().FontColor(Colors.Blue.Medium);
                    });
                });

                if (!string.IsNullOrEmpty(model.ClaveNumerica))
                {
                    col.Item().PaddingTop(15f).Text(t => {
                        t.Span("Clave: ").Bold().FontSize(8);
                        t.Span(model.ClaveNumerica).FontSize(8);
                    });
                }
            });

            page.Footer().AlignCenter().Column(c => {
                c.Item().Text("Autorizada mediante resoluci√≥n DGT-R-033-2019").FontSize(7).FontColor(Colors.Grey.Medium);
                c.Item().PaddingTop(2f).Text(x => {
                    x.Span("P√°gina ").FontSize(8);
                    x.CurrentPageNumber().FontSize(8);
                    x.Span(" de ").FontSize(8);
                    x.TotalPages().FontSize(8);
                });
            });
        });
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Reports\ProformaReport.cs --- 
--- NOMBRE: ProformaReport.cs --- 
 
Ôªøusing QuestPDF.Fluent;
using QuestPDF.Helpers;
using QuestPDF.Infrastructure;
using IntegraPro.DTO.Models;

namespace IntegraPro.API.Reports;

public class ProformaReport(ProformaEncabezadoDTO model, EmpresaDTO empresa) : IDocument
{
    public DocumentMetadata GetMetadata() => DocumentMetadata.Default;

    public void Compose(IDocumentContainer container)
    {
        container.Page(page =>
        {
            page.Margin(1, Unit.Centimetre);
            page.DefaultTextStyle(x => x.FontFamily(Fonts.Arial).FontSize(10));

            // ==========================================
            // ENCABEZADO: DATOS EMPRESA Y DOCUMENTO
            // ==========================================
            page.Header().Row(row =>
            {
                row.RelativeItem().Column(col =>
                {
                    col.Item().Text(empresa.NombreComercial.ToUpper()).FontSize(18).Bold().FontColor(Colors.Blue.Medium);
                    col.Item().Text($"C√©dula Jur√≠dica: {empresa.CedulaJuridica}");

                    if (!string.IsNullOrEmpty(empresa.Telefono))
                        col.Item().Text($"Tel√©fono: {empresa.Telefono}");

                    if (!string.IsNullOrEmpty(empresa.CorreoNotificaciones))
                    {
                        col.Item().Row(r =>
                        {
                            r.AutoItem().Text("Email: ");
                            r.RelativeItem().Hyperlink($"mailto:{empresa.CorreoNotificaciones}")
                                .Text(empresa.CorreoNotificaciones.ToLower())
                                .FontColor(Colors.Blue.Medium)
                                .Underline();
                        });
                    }
                });

                row.RelativeItem().AlignRight().Column(col =>
                {
                    col.Item().Text("PROFORMA").FontSize(22).Light();
                    col.Item().Text($"# {model.Id:D6}").Bold();
                    col.Item().Text($"Fecha: {model.Fecha:dd/MM/yyyy}");
                    col.Item().Text($"Vence: {model.FechaVencimiento:dd/MM/yyyy}").FontSize(9).Italic();
                });
            });

            // ==========================================
            // CONTENIDO: CLIENTE Y TABLA DE PRODUCTOS
            // ==========================================
            page.Content().PaddingVertical(1, Unit.Centimetre).Column(col =>
            {
                // SECCI√ìN CLIENTE
                col.Item().PaddingBottom(10).BorderBottom(1).BorderColor(Colors.Grey.Lighten2).PaddingBottom(5).Row(row =>
                {
                    row.RelativeItem().Column(c => {
                        c.Item().Text(t => {
                            t.Span("CLIENTE: ").Bold();
                            t.Span(model.ClienteNombre?.ToUpper() ?? "N/A");
                        });

                        if (!string.IsNullOrEmpty(model.ClienteIdentificacion))
                        {
                            c.Item().Text(t => {
                                t.Span("C√âDULA: ").Bold().FontSize(9);
                                t.Span(model.ClienteIdentificacion).FontSize(9);
                            });
                        }
                    });

                    row.RelativeItem().AlignRight().Text(t => {
                        t.Span("ESTADO: ").Bold();
                        t.Span(model.Estado.ToUpper()).FontColor(model.Estado == "Pendiente" ? Colors.Orange.Medium : Colors.Green.Medium);
                    });
                });

                // TABLA DE PRODUCTOS (CON DESGLOSE DE IVA)
                col.Item().PaddingTop(10).Table(table =>
                {
                    table.ColumnsDefinition(columns => {
                        columns.RelativeColumn(1f);    // C√≥digo
                        columns.RelativeColumn(2.5f);  // Producto
                        columns.RelativeColumn(0.6f);  // Cant.
                        columns.RelativeColumn(1.1f);  // P. Neto
                        columns.RelativeColumn(0.5f);  // %
                        columns.RelativeColumn(1f);    // IVA
                        columns.RelativeColumn(1.2f);  // Total
                    });

                    table.Header(header => {
                        header.Cell().BorderBottom(1).PaddingBottom(5).Text("C√≥digo").Bold();
                        header.Cell().BorderBottom(1).PaddingBottom(5).Text("Producto").Bold();
                        header.Cell().BorderBottom(1).PaddingBottom(5).AlignRight().Text("Cant.").Bold();
                        header.Cell().BorderBottom(1).PaddingBottom(5).AlignRight().Text("P. Neto").Bold();
                        header.Cell().BorderBottom(1).PaddingBottom(5).AlignRight().Text("%").Bold();
                        header.Cell().BorderBottom(1).PaddingBottom(5).AlignRight().Text("IVA").Bold();
                        header.Cell().BorderBottom(1).PaddingBottom(5).AlignRight().Text("Total").Bold();
                    });

                    foreach (var item in model.Detalles)
                    {
                        table.Cell().PaddingVertical(2).BorderBottom(1).BorderColor(Colors.Grey.Lighten4).Text(item.ProductoCodigo).FontSize(8);
                        table.Cell().PaddingVertical(2).BorderBottom(1).BorderColor(Colors.Grey.Lighten4).Text(item.ProductoNombre).FontSize(9);
                        table.Cell().PaddingVertical(2).BorderBottom(1).BorderColor(Colors.Grey.Lighten4).AlignRight().Text(item.Cantidad.ToString("N2"));
                        table.Cell().PaddingVertical(2).BorderBottom(1).BorderColor(Colors.Grey.Lighten4).AlignRight().Text(item.PrecioUnitario.ToString("N2"));
                        table.Cell().PaddingVertical(2).BorderBottom(1).BorderColor(Colors.Grey.Lighten4).AlignRight().Text($"{item.PorcentajeImpuesto:N0}%").FontSize(8);
                        table.Cell().PaddingVertical(2).BorderBottom(1).BorderColor(Colors.Grey.Lighten4).AlignRight().Text(item.ImpuestoTotal.ToString("N2"));
                        table.Cell().PaddingVertical(2).BorderBottom(1).BorderColor(Colors.Grey.Lighten4).AlignRight().Text(item.TotalLineas.ToString("N2")).Bold();
                    }
                });

                // ==========================================
                // SECCI√ìN DE TOTALES FINALES
                // ==========================================
                col.Item().AlignRight().PaddingTop(10).MinWidth(180).Column(c =>
                {
                    c.Item().Row(r => {
                        r.RelativeItem().Text("Subtotal Neto:").AlignRight();
                        r.ConstantItem(85).AlignRight().Text($"{model.TotalNeto:N2}");
                    });

                    c.Item().Row(r => {
                        r.RelativeItem().Text("Total Impuestos:").AlignRight();
                        r.ConstantItem(85).AlignRight().Text($"{model.TotalImpuesto:N2}");
                    });

                    c.Item().PaddingTop(5).BorderTop(1).Row(r => {
                        r.RelativeItem().Text("TOTAL COMPROBANTE:").FontSize(12).Bold().FontColor(Colors.Blue.Medium).AlignRight();
                        r.ConstantItem(85).AlignRight().Text($"{model.Total:N2}").FontSize(12).Bold().FontColor(Colors.Blue.Medium);
                    });
                });
            });

            // PIE DE P√ÅGINA
            page.Footer().AlignCenter().Column(c => {
                c.Item().Text(x =>
                {
                    x.Span("Gracias por su preferencia. ").FontSize(9);
                    x.Span($"Esta proforma es v√°lida hasta el {model.FechaVencimiento:dd/MM/yyyy}.").FontSize(9).Italic();
                });

                c.Item().PaddingTop(5).Text(x => {
                    x.Span("P√°gina ").FontSize(8);
                    x.CurrentPageNumber().FontSize(8);
                    x.Span(" de ").FontSize(8);
                    x.TotalPages().FontSize(8);
                });
            });
        });
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Class1.cs --- 
--- NOMBRE: Class1.cs --- 
 
Ôªønamespace IntegraPro.AppLogic;

public class Class1
{

}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\IAbonoService.cs --- 
--- NOMBRE: IAbonoService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;
using System.Collections.Generic; // Aseg√∫rate de tener este using para List<>

namespace IntegraPro.AppLogic.Interfaces;

public interface IAbonoService
{
    ApiResponse<bool> ProcesarAbono(AbonoDTO abono, int clienteId, UsuarioDTO ejecutor);
    
    ApiResponse<List<CxcConsultaDTO>> BuscarCuentas(string filtro, UsuarioDTO ejecutor);
    
    ApiResponse<List<AlertaCxcDTO>> ObtenerAlertasMora(UsuarioDTO ejecutor);
    
    ApiResponse<ResumenCxcDTO> ObtenerResumenGeneral(UsuarioDTO ejecutor);
    
    // A√±adimos ejecutor para que el Service pueda validar permisos antes de listar
    ApiResponse<List<AbonoHistorialDTO>> ObtenerHistorial(int facturaId, UsuarioDTO ejecutor);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\ICajaService.cs --- 
--- NOMBRE: ICajaService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Interfaces;

public interface ICajaService
{
    ApiResponse<int> AbrirCaja(CajaAperturaDTO apertura, UsuarioDTO ejecutor);
    ApiResponse<bool> CerrarCaja(CajaCierreDTO cierre, UsuarioDTO ejecutor);
    ApiResponse<List<object>> ObtenerHistorial(UsuarioDTO ejecutor);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\ICategoriaService.cs --- 
--- NOMBRE: ICategoriaService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;
using System.Collections.Generic;

namespace IntegraPro.AppLogic.Interfaces;

public interface ICategoriaService
{
    // ACTUALIZADO: Se a√±ade el ejecutor para validar permisos de acceso al m√≥dulo
    ApiResponse<List<CategoriaDTO>> ObtenerTodas(UsuarioDTO ejecutor);

    // Mantenemos el ejecutor para validaci√≥n de roles y escritura
    ApiResponse<bool> Crear(CategoriaDTO categoria, UsuarioDTO ejecutor);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\IClienteService.cs --- 
--- NOMBRE: IClienteService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;
using System.Collections.Generic;

namespace IntegraPro.AppLogic.Interfaces;

public interface IClienteService
{
    // Recibe ejecutor para validar permiso de lectura del m√≥dulo
    ApiResponse<List<ClienteDTO>> ObtenerTodos(UsuarioDTO ejecutor);

    // Devuelve el ID generado del nuevo cliente
    ApiResponse<int> Crear(ClienteDTO cliente, UsuarioDTO ejecutor);

    // Actualizaci√≥n de datos existentes
    ApiResponse<bool> Actualizar(ClienteDTO cliente, UsuarioDTO ejecutor);

    // B√∫squeda r√°pida (com√∫nmente usada en ventas)
    // CAMBIO: Ahora requiere el ejecutor para validar que quien busca tiene permisos
    ApiResponse<ClienteDTO> BuscarPorIdentificacion(string identificacion, UsuarioDTO ejecutor);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\ICompraService.cs --- 
--- NOMBRE: ICompraService.cs --- 
 
Ôªøusing IntegraPro.DTO.Models;
using System.Collections.Generic;

namespace IntegraPro.AppLogic.Interfaces;

public interface ICompraService
{
    void RegistrarNuevaCompra(CompraDTO compra, UsuarioDTO ejecutor);
    void AbonarAFactura(PagoCxpDTO pago, UsuarioDTO ejecutor);
    List<DeudaConsultaDTO> ListarDeudas(string filtro, UsuarioDTO ejecutor);
    List<PagoHistorialDTO> ListarHistorialDePagos(int compraId);
    ResumenCxpDTO ObtenerResumenCxp(UsuarioDTO ejecutor);
    void AnularCompraExistente(int compraId, UsuarioDTO ejecutor);
    List<AlertaPagoDTO> ListarAlertasPagos(UsuarioDTO ejecutor);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\IConfiguracionService.cs --- 
--- NOMBRE: IConfiguracionService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Interfaces;

public interface IConfiguracionService
{
    // ACTUALIZADO: Ahora requiere el ejecutor para validar permisos de lectura del m√≥dulo 'config'
    ApiResponse<EmpresaDTO> ObtenerDatosEmpresa(UsuarioDTO ejecutor);

    ApiResponse<bool> ActualizarEmpresa(EmpresaDTO empresa, UsuarioDTO ejecutor);

    ApiResponse<bool> RegistrarLicenciaInicial(string nombre, string ruc, int equipos, string hid, UsuarioDTO ejecutor);

    // Se mantiene sin ejecutor porque se consulta usualmente antes del login (validaci√≥n de equipo)
    ApiResponse<LicenciaDTO> ConsultarLicencia(string hardwareId);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\IInventarioService.cs --- 
--- NOMBRE: IInventarioService.cs --- 
 
Ôªøusing IntegraPro.DTO.Models;
using IntegraPro.AppLogic.Utils;

namespace IntegraPro.AppLogic.Interfaces;

public interface IInventarioService
{
    /// <summary>
    /// Registra un movimiento manual (Entrada/Salida/Ajuste).
    /// El ejecutor define la sucursal y la auditor√≠a del movimiento.
    /// </summary>
    ApiResponse<bool> Registrar(MovimientoInventarioDTO mov, UsuarioDTO ejecutor);

    /// <summary>
    /// Realiza la explosi√≥n de materiales (BOM) para generar stock de un producto elaborado.
    /// Valida existencias de insumos en la sucursal del ejecutor.
    /// </summary>
    ApiResponse<bool> ProcesarProduccion(int productoPadreId, decimal cantidadAProducir, UsuarioDTO ejecutor);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\IProductoService.cs --- 
--- NOMBRE: IProductoService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Interfaces;

public interface IProductoService
{
    /// <summary>
    /// Lista los productos activos. Filtra autom√°ticamente por la sucursal del ejecutor 
    /// si este tiene el permiso 'sucursal_limit'.
    /// </summary>
    ApiResponse<List<ProductoDTO>> ObtenerTodos(UsuarioDTO ejecutor);

    /// <summary>
    /// Obtiene un producto espec√≠fico. Valida que pertenezca a la sucursal permitida.
    /// </summary>
    ApiResponse<ProductoDTO> ObtenerPorId(int id, UsuarioDTO ejecutor);

    /// <summary>
    /// Registra un nuevo producto y su receta (si es elaborado). 
    /// Requiere permiso de escritura y asocia la sucursal seg√∫n el perfil.
    /// </summary>
    ApiResponse<bool> Crear(ProductoDTO producto, UsuarioDTO ejecutor);

    /// <summary>
    /// Actualiza datos maestros del producto. Valida pertenencia de sucursal.
    /// </summary>
    ApiResponse<bool> Actualizar(ProductoDTO producto, UsuarioDTO ejecutor);

    /// <summary>
    /// Consulta productos cuya existencia est√© por debajo del stock m√≠nimo configurado.
    /// </summary>
    ApiResponse<List<ProductoDTO>> ObtenerAlertasStock(UsuarioDTO ejecutor);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\IProformaService.cs --- 
--- NOMBRE: IProformaService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Interfaces;

public interface IProformaService
{
    ApiResponse<int> GuardarProforma(ProformaEncabezadoDTO p, UsuarioDTO ejecutor);
    ApiResponse<List<ProformaEncabezadoDTO>> Consultar(string filtro, UsuarioDTO ejecutor);
    ApiResponse<ProformaEncabezadoDTO> ObtenerPorId(int id, UsuarioDTO ejecutor);
    ApiResponse<List<ProformaEncabezadoDTO>> ObtenerPorCliente(int clienteId, UsuarioDTO ejecutor);
    ApiResponse<bool> Anular(int id, UsuarioDTO ejecutor);
    ApiResponse<string> Facturar(int id, string medio, UsuarioDTO ejecutor);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\IProveedorService.cs --- 
--- NOMBRE: IProveedorService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Interfaces;

public interface IProveedorService
{
    ApiResponse<List<ProveedorDTO>> ObtenerTodos(UsuarioDTO ejecutor);
    ApiResponse<bool> Crear(ProveedorDTO proveedor, UsuarioDTO ejecutor);
    ApiResponse<bool> Actualizar(ProveedorDTO proveedor, UsuarioDTO ejecutor);
    ApiResponse<bool> Eliminar(int id, UsuarioDTO ejecutor);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\IUsuarioService.cs --- 
--- NOMBRE: IUsuarioService.cs --- 
 
Ôªøusing IntegraPro.DTO.Models;
using IntegraPro.AppLogic.Utils;

namespace IntegraPro.AppLogic.Interfaces;

public interface IUsuarioService
{
    ApiResponse<UsuarioDTO> Login(string username, string password);
    ApiResponse<bool> Registrar(UsuarioDTO usuario, UsuarioDTO ejecutor);
    ApiResponse<bool> Logout(int usuarioId);
    ApiResponse<bool> ForzarCierreSesion(string username, string password);
    ApiResponse<List<UsuarioDTO>> ObtenerTodos(UsuarioDTO ejecutor);
    ApiResponse<bool> ActualizarRol(int usuarioId, int nuevoRolId, UsuarioDTO ejecutor);
    ApiResponse<List<RolDTO>> ListarRolesDisponibles(UsuarioDTO ejecutor);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\IVentaService.cs --- 
--- NOMBRE: IVentaService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;
using System.Data;

namespace IntegraPro.AppLogic.Interfaces;

public interface IVentaService
{
    ApiResponse<string> ProcesarVenta(FacturaDTO factura, UsuarioDTO ejecutor);
    ApiResponse<DataTable> ObtenerReporteVentas(DateTime? desde, DateTime? hasta, int? clienteId, string busqueda, string? condicionVenta, UsuarioDTO ejecutor);
    ApiResponse<FacturaDTO> ObtenerFacturaParaImpresion(int id, UsuarioDTO ejecutor);

    // CORRECCI√ìN: Ahora coincide con la implementaci√≥n y la Factory
    ApiResponse<EmpresaDTO> ObtenerEmpresa(UsuarioDTO ejecutor);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\obj\Debug\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
--- NOMBRE: .NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
 
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\obj\Debug\net9.0\IntegraPro.AppLogic.AssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.AppLogic.AssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("IntegraPro.AppLogic")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0+4153b5f28a857579dabbc5516649e889b6ddb8bd")]
[assembly: System.Reflection.AssemblyProductAttribute("IntegraPro.AppLogic")]
[assembly: System.Reflection.AssemblyTitleAttribute("IntegraPro.AppLogic")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\obj\Debug\net9.0\IntegraPro.AppLogic.GlobalUsings.g.cs --- 
--- NOMBRE: IntegraPro.AppLogic.GlobalUsings.g.cs --- 
 
// <auto-generated/>
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Threading;
global using global::System.Threading.Tasks;
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\AbonoService.cs --- 
--- NOMBRE: AbonoService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class AbonoService(AbonoFactory factory) : IAbonoService
{
    private readonly AbonoFactory _factory = factory;

    // 1. PROCESAR ABONO
    public ApiResponse<bool> ProcesarAbono(AbonoDTO abono, int clienteId, UsuarioDTO ejecutor)
    {
        try
        {
            // --- SEGURIDAD: Validar antes de tocar la DB ---
            ejecutor.ValidarAcceso("abonos");
            ejecutor.ValidarEscritura();

            // Validaciones b√°sicas de negocio
            if (abono.MontoAbonado <= 0)
                return new ApiResponse<bool>(false, "El monto del abono debe ser mayor a cero.", false);

            _factory.ProcesarAbonoCompleto(abono, clienteId, ejecutor);

            return new ApiResponse<bool>(true, "Abono procesado y saldos actualizados", true);
        }
        catch (UnauthorizedAccessException ex)
        {
            return new ApiResponse<bool>(false, ex.Message, false);
        }
        catch (Exception ex)
        {
            return new ApiResponse<bool>(false, $"Error en la operaci√≥n: {ex.Message}", false);
        }
    }

    // 2. BUSCAR CUENTAS
    public ApiResponse<List<CxcConsultaDTO>> BuscarCuentas(string filtro, UsuarioDTO ejecutor)
    {
        try
        {
            ejecutor.ValidarAcceso("abonos");

            var datos = _factory.BuscarCxcClientes(filtro, ejecutor);
            return new ApiResponse<List<CxcConsultaDTO>>(true, "Cuentas localizadas", datos);
        }
        catch (UnauthorizedAccessException ex)
        {
            return new ApiResponse<List<CxcConsultaDTO>>(false, ex.Message);
        }
        catch (Exception ex)
        {
            return new ApiResponse<List<CxcConsultaDTO>>(false, ex.Message);
        }
    }

    // ACTUALIZADO: Ahora recibe UsuarioDTO para validar acceso
    public ApiResponse<List<AbonoHistorialDTO>> ObtenerHistorial(int facturaId, UsuarioDTO ejecutor)
    {
        try
        {
            // Seguridad: Validamos que el usuario pueda ver el m√≥dulo de abonos
            ejecutor.ValidarAcceso("abonos");

            var lista = _factory.ListarHistorialAbonos(facturaId);
            return new ApiResponse<List<AbonoHistorialDTO>>(true, "Historial cargado", lista);
        }
        catch (UnauthorizedAccessException ex)
        {
            return new ApiResponse<List<AbonoHistorialDTO>>(false, ex.Message);
        }
        catch (Exception ex)
        {
            return new ApiResponse<List<AbonoHistorialDTO>>(false, $"Error al cargar historial: {ex.Message}");
        }
    }

    // 3. ALERTAS DE MORA
    public ApiResponse<List<AlertaCxcDTO>> ObtenerAlertasMora(UsuarioDTO ejecutor)
    {
        try
        {
            ejecutor.ValidarAcceso("abonos");
            var alertas = _factory.ObtenerAlertasVencimiento(ejecutor);
            return new ApiResponse<List<AlertaCxcDTO>>(true, "Alertas de mora obtenidas", alertas);
        }
        catch (UnauthorizedAccessException ex)
        {
            return new ApiResponse<List<AlertaCxcDTO>>(false, ex.Message);
        }
        catch (Exception ex)
        {
            return new ApiResponse<List<AlertaCxcDTO>>(false, ex.Message);
        }
    }

    // 4. RESUMEN GENERAL
    public ApiResponse<ResumenCxcDTO> ObtenerResumenGeneral(UsuarioDTO ejecutor)
    {
        try
        {
            ejecutor.ValidarAcceso("abonos");
            var resumen = _factory.ObtenerTotalesCxc(ejecutor);
            return new ApiResponse<ResumenCxcDTO>(true, "Resumen generado", resumen);
        }
        catch (UnauthorizedAccessException ex)
        {
            return new ApiResponse<ResumenCxcDTO>(false, ex.Message);
        }
        catch (Exception ex)
        {
            return new ApiResponse<ResumenCxcDTO>(false, ex.Message);
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\CajaService.cs --- 
--- NOMBRE: CajaService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class CajaService(CajaFactory factory) : ICajaService
{
    private readonly CajaFactory _factory = factory;

    public ApiResponse<int> AbrirCaja(CajaAperturaDTO apertura, UsuarioDTO ejecutor)
    {
        try
        {
            // --- SEGURIDAD: Validaci√≥n preventiva ---
            ejecutor.ValidarAcceso("caja");
            ejecutor.ValidarEscritura();

            int id = _factory.AbrirCaja(apertura, ejecutor);
            return new ApiResponse<int>(true, "Caja abierta con √©xito", id);
        }
        catch (UnauthorizedAccessException ex)
        {
            return new ApiResponse<int>(false, ex.Message);
        }
        catch (Exception ex)
        {
            return new ApiResponse<int>(false, $"Error al abrir caja: {ex.Message}");
        }
    }

    public ApiResponse<bool> CerrarCaja(CajaCierreDTO cierre, UsuarioDTO ejecutor)
    {
        try
        {
            // --- SEGURIDAD: Validaci√≥n preventiva ---
            ejecutor.ValidarAcceso("caja");
            ejecutor.ValidarEscritura();

            _factory.CerrarCaja(cierre, ejecutor);
            return new ApiResponse<bool>(true, "Caja cerrada correctamente", true);
        }
        catch (UnauthorizedAccessException ex)
        {
            return new ApiResponse<bool>(false, ex.Message, false);
        }
        catch (Exception ex)
        {
            return new ApiResponse<bool>(false, ex.Message, false);
        }
    }

    public ApiResponse<List<object>> ObtenerHistorial(UsuarioDTO ejecutor)
    {
        try
        {
            // --- SEGURIDAD: Validaci√≥n preventiva ---
            ejecutor.ValidarAcceso("caja");

            var historial = _factory.ObtenerHistorialCierres(ejecutor);
            return new ApiResponse<List<object>>(true, "Historial recuperado", historial);
        }
        catch (UnauthorizedAccessException ex)
        {
            return new ApiResponse<List<object>>(false, ex.Message);
        }
        catch (Exception ex)
        {
            return new ApiResponse<List<object>>(false, $"Error: {ex.Message}");
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\CategoriaService.cs --- 
--- NOMBRE: CategoriaService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class CategoriaService(CategoriaFactory factory) : ICategoriaService
{
    private readonly CategoriaFactory _factory = factory;

    // ACTUALIZADO: Ahora recibe UsuarioDTO para validar acceso preventivo
    public ApiResponse<List<CategoriaDTO>> ObtenerTodas(UsuarioDTO ejecutor)
    {
        try
        {
            // --- SEGURIDAD: Validaci√≥n preventiva ---
            ejecutor.ValidarAcceso("inventario");

            var lista = _factory.GetAll(ejecutor);
            return new ApiResponse<List<CategoriaDTO>>(true, "Lista de categor√≠as", lista);
        }
        catch (UnauthorizedAccessException ex)
        {
            return new ApiResponse<List<CategoriaDTO>>(false, ex.Message);
        }
        catch (Exception ex)
        {
            return new ApiResponse<List<CategoriaDTO>>(false, $"Error al obtener categor√≠as: {ex.Message}");
        }
    }

    public ApiResponse<bool> Crear(CategoriaDTO categoria, UsuarioDTO ejecutor)
    {
        try
        {
            // --- SEGURIDAD: Validaci√≥n preventiva ---
            ejecutor.ValidarAcceso("inventario");
            ejecutor.ValidarEscritura();

            // L√≥gica original: Validaciones de negocio
            if (string.IsNullOrWhiteSpace(categoria.Nombre))
                return new ApiResponse<bool>(false, "El nombre de la categor√≠a es obligatorio.");

            bool ok = _factory.Create(categoria, ejecutor);

            return new ApiResponse<bool>(ok, ok ? "Categor√≠a guardada con √©xito" : "No se pudo guardar la categor√≠a", ok);
        }
        catch (UnauthorizedAccessException ex)
        {
            // Captura los errores de permisos (tanto del Service como del Factory)
            return new ApiResponse<bool>(false, ex.Message, false);
        }
        catch (Exception ex)
        {
            return new ApiResponse<bool>(false, $"Error en el servicio de categor√≠as: {ex.Message}", false);
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\ClienteService.cs --- 
--- NOMBRE: ClienteService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class ClienteService(ClienteFactory cliFactory) : IClienteService
{
    private readonly ClienteFactory _cliFactory = cliFactory;

    public ApiResponse<List<ClienteDTO>> ObtenerTodos(UsuarioDTO ejecutor)
    {
        try
        {
            // --- SEGURIDAD: Validaci√≥n preventiva ---
            ejecutor.ValidarAcceso("clientes");

            var clientes = _cliFactory.ObtenerTodos(ejecutor);
            return new ApiResponse<List<ClienteDTO>>(true, "Clientes recuperados con √©xito", clientes);
        }
        catch (UnauthorizedAccessException ex)
        {
            return new ApiResponse<List<ClienteDTO>>(false, ex.Message);
        }
        catch (Exception ex)
        {
            return new ApiResponse<List<ClienteDTO>>(false, $"Error al listar clientes: {ex.Message}");
        }
    }

    // ACTUALIZADO: Ahora recibe 'ejecutor' para cumplir con la interfaz y la seguridad
    public ApiResponse<ClienteDTO> BuscarPorIdentificacion(string identificacion, UsuarioDTO ejecutor)
    {
        try
        {
            // --- SEGURIDAD: Solo usuarios autorizados pueden buscar por ID ---
            ejecutor.ValidarAcceso("clientes");

            if (string.IsNullOrWhiteSpace(identificacion))
                return new ApiResponse<ClienteDTO>(false, "La identificaci√≥n no puede estar vac√≠a.");

            // Sincronizado con Factory: Se pasa ejecutor por si la Factory aplica filtros de sucursal
            var cliente = _cliFactory.ObtenerPorIdentificacion(identificacion, ejecutor);

            if (cliente == null)
                return new ApiResponse<ClienteDTO>(false, "Cliente no encontrado.");

            return new ApiResponse<ClienteDTO>(true, "Cliente localizado", cliente);
        }
        catch (UnauthorizedAccessException ex)
        {
            return new ApiResponse<ClienteDTO>(false, ex.Message);
        }
        catch (Exception ex)
        {
            return new ApiResponse<ClienteDTO>(false, $"Error al buscar cliente: {ex.Message}");
        }
    }

    public ApiResponse<int> Crear(ClienteDTO cliente, UsuarioDTO ejecutor)
    {
        try
        {
            ejecutor.ValidarAcceso("clientes");
            ejecutor.ValidarEscritura();

            if (string.IsNullOrWhiteSpace(cliente.Identificacion))
                return new ApiResponse<int>(false, "La identificaci√≥n es obligatoria.");

            int nuevoId = _cliFactory.Insertar(cliente, ejecutor);

            return new ApiResponse<int>(true, "Cliente registrado correctamente", nuevoId);
        }
        catch (UnauthorizedAccessException ex) { return new ApiResponse<int>(false, ex.Message); }
        catch (Exception ex) { return new ApiResponse<int>(false, $"Error: {ex.Message}"); }
    }

    public ApiResponse<bool> Actualizar(ClienteDTO cliente, UsuarioDTO ejecutor)
    {
        try
        {
            ejecutor.ValidarAcceso("clientes");
            ejecutor.ValidarEscritura();

            if (cliente.Id <= 0)
                return new ApiResponse<bool>(false, "ID de cliente no v√°lido.", false);

            bool exito = _cliFactory.Actualizar(cliente, ejecutor);
            return new ApiResponse<bool>(true, "Cliente actualizado correctamente", exito);
        }
        catch (UnauthorizedAccessException ex) { return new ApiResponse<bool>(false, ex.Message, false); }
        catch (Exception ex) { return new ApiResponse<bool>(false, $"Error: {ex.Message}", false); }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\CompraService.cs --- 
--- NOMBRE: CompraService.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;
using IntegraPro.AppLogic.Interfaces; // Agregado para la interfaz
using System;
using System.Collections.Generic;

namespace IntegraPro.AppLogic.Services;

public class CompraService(CompraFactory compraFactory) : ICompraService
{
    private readonly CompraFactory _factory = compraFactory;

    public void RegistrarNuevaCompra(CompraDTO compra, UsuarioDTO ejecutor)
    {
        if (compra.Detalles.Count == 0)
            throw new Exception("No hay productos en la compra.");

        // Pasamos el ejecutor para que el Factory valide permisos 'compras' 
        // y asigne la sucursal correcta si tiene 'sucursal_limit'.
        _factory.ProcesarCompra(compra, ejecutor);
    }

    public void AbonarAFactura(PagoCxpDTO pago, UsuarioDTO ejecutor)
    {
        if (pago.Monto <= 0)
            throw new Exception("El monto del abono debe ser mayor a cero.");

        if (pago.CompraId <= 0)
            throw new Exception("Debe especificar una compra v√°lida para aplicar el pago.");

        // El Factory usar√° el ID del ejecutor para el historial de pagos.
        _factory.RegistrarPagoCxp(pago, ejecutor);
    }

    public List<DeudaConsultaDTO> ListarDeudas(string filtro, UsuarioDTO ejecutor)
    {
        // CORRECCI√ìN: Se agrega 'ejecutor' para cumplir con la firma del Factory
        // y permitir el filtrado de seguridad por sucursal.
        return _factory.BuscarDeudas(filtro?.Trim() ?? "", ejecutor);
    }

    public List<PagoHistorialDTO> ListarHistorialDePagos(int compraId)
    {
        if (compraId <= 0)
            throw new Exception("El ID de la compra proporcionado no es v√°lido.");

        return _factory.ObtenerHistorialPagos(compraId);
    }

    public ResumenCxpDTO ObtenerResumenCxp(UsuarioDTO ejecutor)
    {
        // El resumen ahora ser√° filtrado por sucursal autom√°ticamente si el ejecutor tiene l√≠mites.
        return _factory.ObtenerResumenGeneralCxp(ejecutor);
    }

    public void AnularCompraExistente(int compraId, UsuarioDTO ejecutor)
    {
        // Ya no pasamos un simple usuarioId, sino el DTO completo para validar 
        // si tiene permiso de anular en la sucursal de la compra.
        _factory.AnularCompra(compraId, ejecutor);
    }

    public List<AlertaPagoDTO> ListarAlertasPagos(UsuarioDTO ejecutor)
    {
        return _factory.ObtenerAlertasPagos(ejecutor);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\ConfiguracionService.cs --- 
--- NOMBRE: ConfiguracionService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class ConfiguracionService(ConfiguracionFactory factory) : IConfiguracionService
{
    private readonly ConfiguracionFactory _factory = factory;

    /// <summary>
    /// Recupera los datos de la empresa. Ahora requiere el ejecutor para validar acceso.
    /// </summary>
    public ApiResponse<EmpresaDTO> ObtenerDatosEmpresa(UsuarioDTO ejecutor)
    {
        try
        {
            // --- SEGURIDAD: Validaci√≥n preventiva ---
            ejecutor.ValidarAcceso("config");

            var datos = _factory.ObtenerEmpresa(ejecutor);
            if (datos == null)
                return new ApiResponse<EmpresaDTO>(false, "No se encontraron datos de configuraci√≥n de la empresa.");

            return new ApiResponse<EmpresaDTO>(true, "Datos recuperados exitosamente.", datos);
        }
        catch (UnauthorizedAccessException ex)
        {
            return new ApiResponse<EmpresaDTO>(false, ex.Message);
        }
        catch (Exception ex)
        {
            return new ApiResponse<EmpresaDTO>(false, $"Error al obtener datos: {ex.Message}");
        }
    }

    /// <summary>
    /// Actualiza la informaci√≥n comercial.
    /// </summary>
    public ApiResponse<bool> ActualizarEmpresa(EmpresaDTO empresa, UsuarioDTO ejecutor)
    {
        try
        {
            // --- SEGURIDAD: Validaci√≥n preventiva ---
            ejecutor.ValidarAcceso("config");
            ejecutor.ValidarEscritura();

            _factory.GuardarEmpresa(empresa, ejecutor);
            return new ApiResponse<bool>(true, "Empresa actualizada correctamente.", true);
        }
        catch (UnauthorizedAccessException ex)
        {
            return new ApiResponse<bool>(false, ex.Message, false);
        }
        catch (Exception ex)
        {
            return new ApiResponse<bool>(false, $"Error cr√≠tico: {ex.Message}", false);
        }
    }

    /// <summary>
    /// Realiza el registro inicial en la base de datos.
    /// </summary>
    public ApiResponse<bool> RegistrarLicenciaInicial(string nombre, string ruc, int equipos, string hid, UsuarioDTO ejecutor)
    {
        try
        {
            // --- SEGURIDAD: Validaci√≥n preventiva ---
            ejecutor.ValidarAcceso("config");
            ejecutor.ValidarEscritura();

            _factory.RegistrarConfiguracionInicial(nombre, ruc, equipos, hid, ejecutor);
            return new ApiResponse<bool>(true, "Licencia registrada y sistema activado.", true);
        }
        catch (UnauthorizedAccessException ex)
        {
            return new ApiResponse<bool>(false, ex.Message, false);
        }
        catch (Exception ex)
        {
            return new ApiResponse<bool>(false, $"Error en activaci√≥n: {ex.Message}", false);
        }
    }

    /// <summary>
    /// Consulta el estado de la licencia para un equipo espec√≠fico (No requiere ejecutor por ser pre-auth).
    /// </summary>
    public ApiResponse<LicenciaDTO> ConsultarLicencia(string hardwareId)
    {
        try
        {
            var licencia = _factory.ObtenerLicencia(hardwareId);
            if (licencia == null)
                return new ApiResponse<LicenciaDTO>(false, "Este equipo no cuenta con una licencia registrada.");

            return new ApiResponse<LicenciaDTO>(true, "Licencia encontrada.", licencia);
        }
        catch (Exception ex)
        {
            return new ApiResponse<LicenciaDTO>(false, $"Error al consultar licencia: {ex.Message}");
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\InventarioService.cs --- 
--- NOMBRE: InventarioService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;
using System;
using System.Collections.Generic;

namespace IntegraPro.AppLogic.Services;

public class InventarioService(InventarioFactory factory, ProductoFactory productoFactory) : IInventarioService
{
    private readonly InventarioFactory _factory = factory;
    private readonly ProductoFactory _productoFactory = productoFactory;

    public ApiResponse<bool> Registrar(MovimientoInventarioDTO mov, UsuarioDTO ejecutor)
    {
        try
        {
            ejecutor.ValidarAcceso("inventario");
            ejecutor.ValidarEscritura();

            if (mov.Cantidad <= 0)
                return new ApiResponse<bool>(false, "La cantidad debe ser mayor a cero", false);

            // === CORRECCI√ìN DE L√ìGICA ===
            // 1. Si NO tiene 'all' Y tiene 'sucursal_limit', lo obligamos a su sede.
            // 2. Si tiene 'all', ignoramos el 'sucursal_limit' y dejamos que pase el mov.SucursalId del JSON.
            if (!ejecutor.TienePermiso("all") && ejecutor.TienePermiso("sucursal_limit"))
            {
                mov.SucursalId = ejecutor.SucursalId;
            }

            bool ok = _factory.Insertar(mov, ejecutor);
            return new ApiResponse<bool>(ok, ok ? "Movimiento registrado y stock actualizado" : "Error al registrar", ok);
        }
        catch (UnauthorizedAccessException ex) { return new ApiResponse<bool>(false, ex.Message, false); }
        catch (Exception ex) { return new ApiResponse<bool>(false, $"Error: {ex.Message}", false); }
    }

    /// <summary>
    /// Procesa la producci√≥n rebajando materias primas e ingresando producto terminado.
    /// </summary>
    public ApiResponse<bool> ProcesarProduccion(int productoPadreId, decimal cantidadAProducir, UsuarioDTO ejecutor)
    {
        try
        {
            ejecutor.ValidarAcceso("inventario");
            ejecutor.ValidarEscritura();

            if (cantidadAProducir <= 0)
                return new ApiResponse<bool>(false, "Cantidad inv√°lida", false);

            var receta = _productoFactory.ObtenerComposicion(productoPadreId);
            if (receta == null || receta.Count == 0)
                return new ApiResponse<bool>(false, "El producto no tiene receta definida.", false);

            // NOTA: Aqu√≠ se recomienda implementar un TransactionScope en producci√≥n
            // para asegurar que si falla el paso 3, se revierta el paso 2.

            // 2. EXPLOSI√ìN DE MATERIALES (Salidas)
            foreach (var item in receta)
            {
                var movSalida = new MovimientoInventarioDTO
                {
                    ProductoId = item.MaterialId,
                    UsuarioId = ejecutor.Id,
                    SucursalId = ejecutor.SucursalId,
                    TipoMovimiento = "SALIDA",
                    Cantidad = item.CantidadNecesaria * cantidadAProducir,
                    DocumentoReferencia = $"PROD-P{productoPadreId}",
                    Notas = $"Consumo autom√°tico para producci√≥n."
                };

                if (!_factory.Insertar(movSalida, ejecutor))
                    throw new Exception($"Stock insuficiente para material ID {item.MaterialId}.");
            }

            // 3. ENTRADA PRODUCTO TERMINADO
            var movEntrada = new MovimientoInventarioDTO
            {
                ProductoId = productoPadreId,
                UsuarioId = ejecutor.Id,
                SucursalId = ejecutor.SucursalId,
                TipoMovimiento = "ENTRADA",
                Cantidad = cantidadAProducir,
                DocumentoReferencia = "ORDEN-PROD",
                Notas = $"Ingreso por producci√≥n"
            };

            _factory.Insertar(movEntrada, ejecutor);

            return new ApiResponse<bool>(true, $"Producci√≥n finalizada exitosamente.", true);
        }
        catch (UnauthorizedAccessException ex) { return new ApiResponse<bool>(false, ex.Message, false); }
        catch (Exception ex) { return new ApiResponse<bool>(false, "Error en producci√≥n: " + ex.Message, false); }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\LicenciaService.cs --- 
--- NOMBRE: LicenciaService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;
using System.Management;
using System.Security.Cryptography;
using System.Text;
using System.Data;

namespace IntegraPro.AppLogic.Services;

public class LicenciaService
{
    private readonly ConfiguracionFactory _factory;
    private readonly string _masterKey = "IntegraPro_Secret_2026";
    private readonly string _killSwitchUrl = "https://tu-servidor-remoto.com/blacklist.txt";

    public LicenciaService(ConfiguracionFactory factory)
    {
        _factory = factory;
    }

    public ApiResponse<bool> ActivarLicencia(string llaveActivacion, string nombreEmpresa, string ruc, int maxEquipos, UsuarioDTO ejecutor)
    {
        try
        {
            string hidActual = GetHardwareId();
            string llaveEsperada = GenerarLlave(ruc, hidActual, maxEquipos);

            if (llaveActivacion != llaveEsperada)
                return new ApiResponse<bool>(false, "La llave de activaci√≥n es inv√°lida.");

            _factory.RegistrarConfiguracionInicial(nombreEmpresa, ruc, maxEquipos, hidActual, ejecutor);
            return new ApiResponse<bool>(true, "¬°Sistema activado con √©xito!", true);
        }
        catch (UnauthorizedAccessException ex) { return new ApiResponse<bool>(false, ex.Message); }
        catch (Exception ex) { return new ApiResponse<bool>(false, $"Error: {ex.Message}"); }
    }

    public ApiResponse<bool> ValidarSistema()
    {
        try
        {
            string hid = GetHardwareId();
            DataTable dt = _factory.ValidarLicenciaMultiEquipo(hid);

            if (dt != null && dt.Rows.Count > 0)
            {
                string resultado = dt.Rows[0]["Resultado"]?.ToString() ?? "";
                string rucRegistrado = dt.Rows[0]["Ruc"]?.ToString() ?? "";

                if (resultado == "EQUIPO_AUTORIZADO" || resultado == "NUEVO_EQUIPO_REGISTRADO")
                {
                    if (!string.IsNullOrEmpty(rucRegistrado) && EstaEnListaNegra(rucRegistrado))
                        return new ApiResponse<bool>(false, "Licencia revocada.");

                    return new ApiResponse<bool>(true, "Acceso concedido", true);
                }
                if (resultado == "LIMITE_ALCANZADO") return new ApiResponse<bool>(false, "L√≠mite de equipos alcanzado.");
            }
            return new ApiResponse<bool>(false, "Sistema no activado.");
        }
        catch (Exception ex) { return new ApiResponse<bool>(false, $"Error: {ex.Message}"); }
    }

    public string GenerarLlave(string ruc, string hid, int maxEquipos)
    {
        using var sha = SHA256.Create();
        string rawData = $"{ruc.Trim()}-{hid.Trim()}-{maxEquipos}-{_masterKey}";
        byte[] bytes = sha.ComputeHash(Encoding.UTF8.GetBytes(rawData));
        return Convert.ToBase64String(bytes).Replace("+", "").Replace("/", "").Replace("=", "").Substring(0, 16).ToUpper();
    }

    public string GetHardwareId()
    {
        string serial = "";
        try
        {
            serial = GetWmiProperty("Win32_BaseBoard", "SerialNumber");
            if (EsInvalido(serial)) serial = GetWmiProperty("Win32_BIOS", "SerialNumber");
            if (EsInvalido(serial)) serial = GetWmiProperty("Win32_Processor", "ProcessorId");
            if (EsInvalido(serial)) serial = $"PC-{Environment.MachineName.ToUpper()}";
        }
        catch { serial = $"FB-{Environment.MachineName.ToUpper()}"; }
        return serial.Trim();
    }

    private bool EstaEnListaNegra(string ruc)
    {
        try
        {
            using var client = new HttpClient { Timeout = TimeSpan.FromSeconds(2) };
            var response = client.GetStringAsync(_killSwitchUrl).Result;
            return response.Contains(ruc);
        }
        catch { return false; }
    }

    private string GetWmiProperty(string table, string property)
    {
        try
        {
            using ManagementObjectSearcher searcher = new ManagementObjectSearcher($"SELECT {property} FROM {table}");
            foreach (ManagementObject obj in searcher.Get()) return obj[property]?.ToString()?.Trim() ?? "";
        }
        catch { }
        return "";
    }

    private bool EsInvalido(string sid)
    {
        if (string.IsNullOrWhiteSpace(sid)) return true;
        string val = sid.ToLower();
        return val == "default string" || val == "none" || val == "00000000" || val.Length < 5;
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\ProductoService.cs --- 
--- NOMBRE: ProductoService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class ProductoService(ProductoFactory factory) : IProductoService
{
    private readonly ProductoFactory _factory = factory;

    public ApiResponse<List<ProductoDTO>> ObtenerTodos(UsuarioDTO ejecutor)
    {
        try
        {
            // SEGURIDAD: Validaci√≥n preventiva de acceso al m√≥dulo
            ejecutor.ValidarAcceso("productos");

            var productos = _factory.GetAll(ejecutor);
            return new ApiResponse<List<ProductoDTO>>(true, "Productos obtenidos exitosamente.", productos);
        }
        catch (UnauthorizedAccessException ex) { return new ApiResponse<List<ProductoDTO>>(false, ex.Message); }
        catch (Exception ex) { return new ApiResponse<List<ProductoDTO>>(false, $"Error: {ex.Message}"); }
    }

    public ApiResponse<ProductoDTO> ObtenerPorId(int id, UsuarioDTO ejecutor)
    {
        try
        {
            ejecutor.ValidarAcceso("productos");

            var prod = _factory.GetById(id, ejecutor);
            return new ApiResponse<ProductoDTO>(prod != null,
                prod != null ? "Producto encontrado." : "El producto no existe o no tiene permisos para verlo.", prod);
        }
        catch (UnauthorizedAccessException ex) { return new ApiResponse<ProductoDTO>(false, ex.Message); }
        catch (Exception ex) { return new ApiResponse<ProductoDTO>(false, ex.Message); }
    }

    public ApiResponse<bool> Crear(ProductoDTO producto, UsuarioDTO ejecutor)
    {
        try
        {
            // SEGURIDAD: Validamos acceso y escritura antes de procesar nada
            ejecutor.ValidarAcceso("productos");
            ejecutor.ValidarEscritura();

            if (string.IsNullOrWhiteSpace(producto.Nombre))
                return new ApiResponse<bool>(false, "El nombre del producto es obligatorio.", false);

            // 1. Crear el producto base
            int nuevoId = _factory.Create(producto, ejecutor);

            // 2. Si es un producto elaborado, insertamos su receta/composici√≥n
            if (producto.EsElaborado && producto.Receta != null && producto.Receta.Any())
            {
                foreach (var item in producto.Receta)
                {
                    _factory.InsertarComposicion(nuevoId, item.MaterialId, item.CantidadNecesaria, ejecutor);
                }
            }

            return new ApiResponse<bool>(true, "Producto creado exitosamente.", true);
        }
        catch (UnauthorizedAccessException ex) { return new ApiResponse<bool>(false, ex.Message, false); }
        catch (Exception ex) { return new ApiResponse<bool>(false, $"Error al crear: {ex.Message}", false); }
    }

    public ApiResponse<bool> Actualizar(ProductoDTO producto, UsuarioDTO ejecutor)
    {
        try
        {
            ejecutor.ValidarAcceso("productos");
            ejecutor.ValidarEscritura();

            if (producto.Id <= 0)
                return new ApiResponse<bool>(false, "ID de producto no v√°lido.", false);

            _factory.Update(producto, ejecutor);
            return new ApiResponse<bool>(true, "Producto actualizado correctamente.", true);
        }
        catch (UnauthorizedAccessException ex) { return new ApiResponse<bool>(false, ex.Message, false); }
        catch (Exception ex) { return new ApiResponse<bool>(false, $"Error al actualizar: {ex.Message}", false); }
    }

    public ApiResponse<List<ProductoDTO>> ObtenerAlertasStock(UsuarioDTO ejecutor)
    {
        try
        {
            ejecutor.ValidarAcceso("productos");

            var alertas = _factory.GetStockAlerts(ejecutor);
            return new ApiResponse<List<ProductoDTO>>(true, $"Se encontraron {alertas.Count} productos bajo el stock m√≠nimo.", alertas);
        }
        catch (UnauthorizedAccessException ex) { return new ApiResponse<List<ProductoDTO>>(false, ex.Message); }
        catch (Exception ex) { return new ApiResponse<List<ProductoDTO>>(false, ex.Message); }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\ProformaService.cs --- 
--- NOMBRE: ProformaService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;
using System;
using System.Collections.Generic;
using System.Linq;

namespace IntegraPro.AppLogic.Services;

public class ProformaService(
    ProformaFactory factory,
    ConfiguracionFactory configFactory,
    ProductoFactory prodFactory) : IProformaService
{
    private readonly ProformaFactory _factory = factory;
    private readonly ConfiguracionFactory _configFactory = configFactory;
    private readonly ProductoFactory _prodFactory = prodFactory;

    public ApiResponse<int> GuardarProforma(ProformaEncabezadoDTO p, UsuarioDTO ejecutor)
    {
        try
        {
            ejecutor.ValidarAcceso("proformas");
            ejecutor.ValidarEscritura();

            int id = _factory.CrearProforma(p, ejecutor);
            return new ApiResponse<int>(true, "Proforma generada correctamente", id);
        }
        catch (UnauthorizedAccessException ex) { return new ApiResponse<int>(false, ex.Message); }
        catch (Exception ex) { return new ApiResponse<int>(false, $"Error al guardar: {ex.Message}"); }
    }

    public ApiResponse<List<ProformaEncabezadoDTO>> Consultar(string filtro, UsuarioDTO ejecutor)
    {
        try
        {
            ejecutor.ValidarAcceso("proformas");
            var lista = _factory.ListarProformas(filtro, ejecutor);
            return new ApiResponse<List<ProformaEncabezadoDTO>>(true, "Consulta exitosa", lista);
        }
        catch (Exception ex) { return new ApiResponse<List<ProformaEncabezadoDTO>>(false, ex.Message); }
    }

    public ApiResponse<ProformaEncabezadoDTO> ObtenerPorId(int id, UsuarioDTO ejecutor)
    {
        try
        {
            ejecutor.ValidarAcceso("proformas");
            var p = _factory.ObtenerPorId(id, ejecutor);

            return p != null
                ? new ApiResponse<ProformaEncabezadoDTO>(true, "Ok", p)
                : new ApiResponse<ProformaEncabezadoDTO>(false, "Proforma no encontrada o sin acceso.");
        }
        catch (Exception ex) { return new ApiResponse<ProformaEncabezadoDTO>(false, ex.Message); }
    }

    public ApiResponse<List<ProformaEncabezadoDTO>> ObtenerPorCliente(int clienteId, UsuarioDTO ejecutor)
    {
        try
        {
            ejecutor.ValidarAcceso("proformas");
            var lista = _factory.ListarProformas(string.Empty, ejecutor)
                                .Where(x => x.ClienteId == clienteId).ToList();

            return new ApiResponse<List<ProformaEncabezadoDTO>>(true, "Ok", lista);
        }
        catch (Exception ex) { return new ApiResponse<List<ProformaEncabezadoDTO>>(false, ex.Message); }
    }

    public ApiResponse<bool> Anular(int id, UsuarioDTO ejecutor)
    {
        try
        {
            ejecutor.ValidarAcceso("proformas");
            ejecutor.ValidarEscritura();

            _factory.AnularProforma(id, ejecutor);
            return new ApiResponse<bool>(true, "Proforma anulada correctamente", true);
        }
        catch (Exception ex) { return new ApiResponse<bool>(false, ex.Message); }
    }

    public ApiResponse<string> Facturar(int id, string medio, UsuarioDTO ejecutor)
    {
        try
        {
            // 1. Validaciones de Seguridad Base
            ejecutor.ValidarAcceso("ventas");
            ejecutor.ValidarEscritura();

            // 2. Cargar Proforma Completa (Incluyendo detalles)
            var proforma = _factory.ObtenerPorId(id, ejecutor);
            if (proforma == null)
                return new ApiResponse<string>(false, "La proforma no existe o no tiene permisos para verla.");

            // 3. Validaci√≥n de Stock Preventiva
            var empresa = _configFactory.ObtenerEmpresa(ejecutor);
            bool permitirNegativo = empresa?.PermitirStockNegativo ?? false;

            if (!permitirNegativo)
            {
                // Forzamos al ProductoFactory a mirar la sucursal de la Proforma usando un usuario ficticio
                var validadorSucursal = new UsuarioDTO
                {
                    Id = ejecutor.Id,
                    SucursalId = proforma.SucursalId, // Usamos la sucursal origen de la proforma
                    // Correcci√≥n Error CS0019: Se usa un nuevo diccionario vac√≠o del mismo tipo
                    Permisos = ejecutor.Permisos ?? new Dictionary<string, bool>()
                };

                if (proforma.Detalles == null || !proforma.Detalles.Any())
                    return new ApiResponse<string>(false, "La proforma no tiene l√≠neas de detalle para facturar.");

                foreach (var det in proforma.Detalles)
                {
                    // Obtener producto filtrado por la sucursal de la proforma
                    var producto = _prodFactory.GetById(det.ProductoId, validadorSucursal);

                    if (producto == null)
                        return new ApiResponse<string>(false, $"El producto ID {det.ProductoId} no est√° registrado en la Sucursal {proforma.SucursalId}.");

                    if (producto.Existencia < det.Cantidad)
                    {
                        return new ApiResponse<string>(false,
                            $"Stock insuficiente en Sucursal {proforma.SucursalId} para '{producto.Nombre}'. " +
                            $"Disponible: {producto.Existencia:N2}, Requerido: {det.Cantidad:N2}");
                    }
                }
            }

            // 4. Ejecuci√≥n del Proceso en DB (Hereda la sucursal de la proforma internamente)
            string consecutivo = _factory.ConvertirAFactura(id, medio, ejecutor);

            return new ApiResponse<string>(true, $"Factura {consecutivo} generada con √©xito.", consecutivo);
        }
        catch (UnauthorizedAccessException ex) { return new ApiResponse<string>(false, ex.Message); }
        catch (Exception ex) { return new ApiResponse<string>(false, $"Error en facturaci√≥n: {ex.Message}"); }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\ProveedorService.cs --- 
--- NOMBRE: ProveedorService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class ProveedorService(ProveedorFactory factory) : IProveedorService
{
    private readonly ProveedorFactory _factory = factory;

    public ApiResponse<List<ProveedorDTO>> ObtenerTodos(UsuarioDTO ejecutor)
    {
        try
        {
            // SEGURIDAD: Validaci√≥n preventiva en la capa de servicio
            ejecutor.ValidarAcceso("proveedores");

            var lista = _factory.ObtenerTodos(ejecutor);
            return new ApiResponse<List<ProveedorDTO>>(true, "Proveedores cargados con √©xito", lista);
        }
        catch (UnauthorizedAccessException ex)
        {
            return new ApiResponse<List<ProveedorDTO>>(false, ex.Message);
        }
        catch (Exception ex)
        {
            return new ApiResponse<List<ProveedorDTO>>(false, "Error al listar proveedores: " + ex.Message);
        }
    }

    public ApiResponse<bool> Crear(ProveedorDTO proveedor, UsuarioDTO ejecutor)
    {
        try
        {
            // SEGURIDAD: Doble validaci√≥n (Acceso al m√≥dulo y permiso de escritura)
            ejecutor.ValidarAcceso("proveedores");
            ejecutor.ValidarEscritura();

            _factory.Crear(proveedor, ejecutor);
            return new ApiResponse<bool>(true, "Proveedor creado con √©xito", true);
        }
        catch (UnauthorizedAccessException ex) { return new ApiResponse<bool>(false, ex.Message, false); }
        catch (Exception ex) { return new ApiResponse<bool>(false, "Error interno: " + ex.Message, false); }
    }

    public ApiResponse<bool> Actualizar(ProveedorDTO proveedor, UsuarioDTO ejecutor)
    {
        try
        {
            ejecutor.ValidarAcceso("proveedores");
            ejecutor.ValidarEscritura();

            _factory.Actualizar(proveedor, ejecutor);
            return new ApiResponse<bool>(true, "Proveedor actualizado con √©xito", true);
        }
        catch (UnauthorizedAccessException ex) { return new ApiResponse<bool>(false, ex.Message, false); }
        catch (Exception ex) { return new ApiResponse<bool>(false, "Error al actualizar: " + ex.Message, false); }
    }

    public ApiResponse<bool> Eliminar(int id, UsuarioDTO ejecutor)
    {
        try
        {
            ejecutor.ValidarAcceso("proveedores");
            ejecutor.ValidarEscritura();

            _factory.Eliminar(id, ejecutor);
            return new ApiResponse<bool>(true, "Proveedor desactivado correctamente", true);
        }
        catch (UnauthorizedAccessException ex) { return new ApiResponse<bool>(false, ex.Message, false); }
        catch (Exception ex) { return new ApiResponse<bool>(false, "Error al eliminar: " + ex.Message, false); }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\UsuarioService.cs --- 
--- NOMBRE: UsuarioService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;
using Microsoft.Extensions.Configuration;
using Microsoft.IdentityModel.Tokens;
using System;
using System.Collections.Generic;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Text;

namespace IntegraPro.AppLogic.Services;

public class UsuarioService : IUsuarioService
{
    private readonly UsuarioFactory _factory;
    private readonly LicenciaService _licenciaService;
    private readonly IConfiguration _config;

    public UsuarioService(UsuarioFactory factory, LicenciaService licenciaService, IConfiguration config)
    {
        _factory = factory;
        _licenciaService = licenciaService;
        _config = config;
    }

    public ApiResponse<UsuarioDTO> Login(string username, string password)
    {
        try
        {
            Guard.AgainstEmptyString(username, nameof(username));
            Guard.AgainstEmptyString(password, nameof(password));

            var usuario = _factory.GetByUsername(username);
            if (usuario == null || !usuario.Activo)
                return new ApiResponse<UsuarioDTO>(false, "Credenciales incorrectas o usuario inactivo");

            if (!PasswordHasher.VerifyPassword(password, usuario.PasswordHash))
            {
                Logger.WriteLog("Seguridad", "Login Fallido", $"Intento fallido: {username}");
                return new ApiResponse<UsuarioDTO>(false, "Credenciales incorrectas");
            }

            // Validaci√≥n de Hardware ID (Evitar m√∫ltiples terminales con la misma cuenta)
            string hidActual = _licenciaService.GetHardwareId();
            if (!string.IsNullOrEmpty(usuario.HardwareIdSesion) && usuario.HardwareIdSesion != hidActual)
            {
                Logger.WriteLog("Seguridad", "Bloqueo Sesi√≥n", $"Usuario {username} intent√≥ entrar desde otra PC.");
                return new ApiResponse<UsuarioDTO>(false, "SESION_ABIERTA_OTRO_EQUIPO");
            }

            _factory.ActualizarSesionHardware(usuario.Id, hidActual);
            _factory.RegistrarLogin(usuario.Id);

            // Generar el Token con la identidad real
            usuario.Token = GenerarJwtToken(usuario);
            usuario.UltimoLogin = DateTime.Now;
            usuario.HardwareIdSesion = hidActual;
            usuario.PasswordHash = string.Empty; // Seguridad: Nunca devolver el hash al cliente

            Logger.WriteLog("Seguridad", "Login Exitoso", $"Usuario {username} ha ingresado en equipo {hidActual}.");
            return new ApiResponse<UsuarioDTO>(true, "Acceso concedido", usuario);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "Login", ex.Message);
            return new ApiResponse<UsuarioDTO>(false, $"Error interno: {ex.Message}");
        }
    }

    private string GenerarJwtToken(UsuarioDTO usuario)
    {
        var secretKey = _config["Jwt:Key"] ?? "EstaEsUnaClaveSecretaMuyLargaDeAlMenos32Caracteres2026!";
        var key = Encoding.ASCII.GetBytes(secretKey);

        // Los Claims deben coincidir EXACTAMENTE con lo que busca tu BaseController
        var tokenDescriptor = new SecurityTokenDescriptor
        {
            Subject = new ClaimsIdentity(new[]
            {
                new Claim("id", usuario.Id.ToString()),
                new Claim(ClaimTypes.Name, usuario.Username),
                new Claim("rolId", usuario.RolId.ToString()),
                new Claim("sucursalId", usuario.SucursalId.ToString()),
                new Claim("permisos", usuario.PermisosJson ?? "{}")
            }),
            Expires = DateTime.UtcNow.AddHours(12),
            Issuer = _config["Jwt:Issuer"],
            Audience = _config["Jwt:Audience"],
            SigningCredentials = new SigningCredentials(
                new SymmetricSecurityKey(key),
                SecurityAlgorithms.HmacSha256Signature)
        };

        var tokenHandler = new JwtSecurityTokenHandler();
        var token = tokenHandler.CreateToken(tokenDescriptor);
        return tokenHandler.WriteToken(token);
    }

    public ApiResponse<bool> Registrar(UsuarioDTO usuario, UsuarioDTO ejecutor)
    {
        try
        {
            Guard.AgainstNull(usuario, nameof(usuario));

            // Usamos las validaciones directas del DTO
            if (!ejecutor.TienePermiso("usuarios"))
                return new ApiResponse<bool>(false, "No tiene permisos para registrar usuarios.");

            if (ejecutor.TienePermiso("solo_lectura"))
                return new ApiResponse<bool>(false, "Operaci√≥n denegada: Perfil de solo lectura.");

            var existente = _factory.GetByUsername(usuario.Username);
            if (existente != null)
                return new ApiResponse<bool>(false, "El nombre de usuario ya est√° en uso");

            usuario.PasswordHash = PasswordHasher.HashPassword(usuario.Password);
            _factory.Create(usuario, ejecutor);

            return new ApiResponse<bool>(true, "Usuario creado exitosamente", true);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "Registro", ex.Message);
            return new ApiResponse<bool>(false, ex.Message);
        }
    }

    public ApiResponse<bool> Logout(int usuarioId)
    {
        try
        {
            _factory.ActualizarSesionHardware(usuarioId, null);
            return new ApiResponse<bool>(true, "Sesi√≥n cerrada correctamente", true);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "Logout", ex.Message);
            return new ApiResponse<bool>(false, $"Error al cerrar sesi√≥n: {ex.Message}");
        }
    }

    public ApiResponse<bool> ForzarCierreSesion(string username, string password)
    {
        try
        {
            var usuario = _factory.GetByUsername(username);
            if (usuario != null && PasswordHasher.VerifyPassword(password, usuario.PasswordHash))
            {
                _factory.ActualizarSesionHardware(usuario.Id, null);
                return new ApiResponse<bool>(true, "Sesiones liberadas", true);
            }
            return new ApiResponse<bool>(false, "Credenciales inv√°lidas.");
        }
        catch (Exception ex)
        {
            return new ApiResponse<bool>(false, ex.Message);
        }
    }

    public ApiResponse<List<UsuarioDTO>> ObtenerTodos(UsuarioDTO ejecutor)
    {
        try
        {
            if (!ejecutor.TienePermiso("usuarios"))
                return new ApiResponse<List<UsuarioDTO>>(false, "No tiene permisos para ver esta lista.");

            var usuarios = _factory.GetAll(ejecutor);
            usuarios.ForEach(u => u.PasswordHash = string.Empty);
            return new ApiResponse<List<UsuarioDTO>>(true, "Lista cargada", usuarios);
        }
        catch (Exception ex)
        {
            return new ApiResponse<List<UsuarioDTO>>(false, ex.Message);
        }
    }

    public ApiResponse<bool> ActualizarRol(int usuarioId, int nuevoRolId, UsuarioDTO ejecutor)
    {
        try
        {
            if (!ejecutor.TienePermiso("usuarios") || ejecutor.TienePermiso("solo_lectura"))
                return new ApiResponse<bool>(false, "No tiene permisos para modificar roles.");

            _factory.ActualizarRol(usuarioId, nuevoRolId, ejecutor);
            return new ApiResponse<bool>(true, "Rol actualizado correctamente", true);
        }
        catch (Exception ex)
        {
            return new ApiResponse<bool>(false, $"Error: {ex.Message}");
        }
    }

    public ApiResponse<List<RolDTO>> ListarRolesDisponibles(UsuarioDTO ejecutor)
    {
        try
        {
            return new ApiResponse<List<RolDTO>>(true, "Roles cargados", _factory.GetRoles(ejecutor));
        }
        catch (Exception ex)
        {
            return new ApiResponse<List<RolDTO>>(false, ex.Message);
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\VentaService.cs --- 
--- NOMBRE: VentaService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;
using System.Data;

namespace IntegraPro.AppLogic.Services;

public class VentaService(
    VentaFactory ventaFactory,
    ClienteFactory cliFactory,
    ProductoFactory prodFactory,
    ConfiguracionFactory configFactory) : IVentaService
{
    private readonly VentaFactory _ventaFactory = ventaFactory;
    private readonly ClienteFactory _cliFactory = cliFactory;
    private readonly ProductoFactory _prodFactory = prodFactory;
    private readonly ConfiguracionFactory _configFactory = configFactory;

    public ApiResponse<string> ProcesarVenta(FacturaDTO factura, UsuarioDTO ejecutor)
    {
        try
        {
            // CORRECCI√ìN: Ahora pasamos el ejecutor a ObtenerEmpresa
            var empresa = _configFactory.ObtenerEmpresa(ejecutor);
            bool permitirNegativo = empresa?.PermitirStockNegativo ?? false;

            if (!permitirNegativo)
            {
                foreach (var det in factura.Detalles)
                {
                    var producto = _prodFactory.GetById(det.ProductoId, ejecutor);

                    if (producto == null)
                        return new ApiResponse<string>(false, $"El producto ID {det.ProductoId} no est√° disponible.");

                    if (producto.Existencia < det.Cantidad)
                    {
                        return new ApiResponse<string>(false, $"Stock insuficiente para '{producto.Nombre}'. " +
                                                              $"Solicitado: {det.Cantidad:N2}, Disponible: {producto.Existencia:N2}.");
                    }
                }
            }

            // 2. VALIDACI√ìN DE CR√âDITO
            if (factura.CondicionVenta != null && factura.CondicionVenta.Equals("Credito", StringComparison.OrdinalIgnoreCase))
            {
                var (saldoActual, limite, activo) = _cliFactory.ObtenerEstadoCredito(factura.ClienteId);
                if (!activo) return new ApiResponse<string>(false, "El cliente seleccionado se encuentra INACTIVO para cr√©dito.");

                if ((saldoActual + factura.TotalComprobante) > limite)
                {
                    return new ApiResponse<string>(false, $"L√≠mite de cr√©dito excedido. Saldo: {saldoActual:N2}, L√≠mite: {limite:N2}.");
                }
            }

            // 3. EJECUCI√ìN (Ya pasaba el ejecutor correctamente)
            string consecutivoGenerado = _ventaFactory.CrearFactura(factura, ejecutor);

            // 4. ACTUALIZAR SALDO
            if (factura.CondicionVenta != null && factura.CondicionVenta.Equals("Credito", StringComparison.OrdinalIgnoreCase))
            {
                _cliFactory.ActualizarSaldo(factura.ClienteId, factura.TotalComprobante);
            }

            return new ApiResponse<string>(true, "Venta procesada con √©xito", consecutivoGenerado);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "ProcesarVenta", ex.Message);
            return new ApiResponse<string>(false, $"Error al procesar la venta: {ex.Message}");
        }
    }

    public ApiResponse<DataTable> ObtenerReporteVentas(DateTime? desde, DateTime? hasta, int? clienteId, string busqueda, string? condicionVenta, UsuarioDTO ejecutor)
    {
        try
        {
            var dt = _ventaFactory.ObtenerReporteVentas(desde, hasta, clienteId, busqueda, condicionVenta ?? "", ejecutor);
            return new ApiResponse<DataTable>(true, "Reporte generado", dt);
        }
        catch (Exception ex)
        {
            return new ApiResponse<DataTable>(false, ex.Message);
        }
    }

    public ApiResponse<FacturaDTO> ObtenerFacturaParaImpresion(int id, UsuarioDTO ejecutor)
    {
        try
        {
            var factura = _ventaFactory.ObtenerPorId(id, ejecutor);
            if (factura != null)
            {
                factura.Detalles = _ventaFactory.ListarDetalles(id);
                return new ApiResponse<FacturaDTO>(true, "Factura cargada", factura);
            }
            return new ApiResponse<FacturaDTO>(false, "No se encontr√≥ la factura.");
        }
        catch (Exception ex)
        {
            return new ApiResponse<FacturaDTO>(false, ex.Message);
        }
    }

    public ApiResponse<EmpresaDTO> ObtenerEmpresa(UsuarioDTO ejecutor)
    {
        try
        {
            // CORRECCI√ìN: Se agrega el par√°metro ejecutor al m√©todo y se pasa a la Factory
            return new ApiResponse<EmpresaDTO>(true, "Datos de empresa cargados", _configFactory.ObtenerEmpresa(ejecutor));
        }
        catch (Exception ex)
        {
            return new ApiResponse<EmpresaDTO>(false, ex.Message);
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\XmlParserService.cs --- 
--- NOMBRE: XmlParserService.cs --- 
 
Ôªøusing System.Xml.Linq;
using System.Globalization;
using Microsoft.Data.SqlClient;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class XmlParserService(string connectionString)
{
    private readonly string _connectionString = connectionString;

    public XmlPreprocesoDTO ProcesarFacturaCR(string xmlContent)
    {
        XDocument doc = XDocument.Parse(xmlContent);
        XNamespace ns = doc.Root.GetDefaultNamespace();

        var emisor = doc.Descendants(ns + "Emisor").FirstOrDefault();

        // Extracci√≥n de datos b√°sicos
        var cedulaXml = emisor?.Element(ns + "Identificacion")?.Element(ns + "Numero")?.Value;
        var nombreXml = emisor?.Element(ns + "Nombre")?.Value;

        // Extracci√≥n de contacto
        var nodoTel = emisor?.Element(ns + "Telefono");
        var telefonoXml = nodoTel != null
            ? $"{nodoTel.Element(ns + "CodigoPais")?.Value}{nodoTel.Element(ns + "NumTelefono")?.Value}"
            : null;
        var correoXml = emisor?.Element(ns + "CorreoElectronico")?.Value;

        // 1. Garantizar proveedor con datos de contacto
        int proveedorIdInterno = ObtenerORegistrarProveedor(cedulaXml, nombreXml, telefonoXml, correoXml);

        var resultado = new XmlPreprocesoDTO
        {
            NumeroFactura = doc.Descendants(ns + "NumeroConsecutivo").FirstOrDefault()?.Value,
            FechaEmision = DateTime.TryParse(doc.Descendants(ns + "FechaEmision").FirstOrDefault()?.Value, out var fecha) ? fecha : DateTime.Now,
            ProveedorCedula = cedulaXml,
            ProveedorNombre = nombreXml,
            ProveedorId = proveedorIdInterno
        };

        foreach (var linea in doc.Descendants(ns + "LineaDetalle"))
        {
            string cabys = linea.Element(ns + "Codigo")?.Value
                          ?? linea.Element(ns + "CodigoCABYS")?.Value
                          ?? "";

            var sugerencia = BuscarEquivalencia(proveedorIdInterno, cabys);

            resultado.Lineas.Add(new LineaPreprocesoDTO
            {
                DetalleXml = linea.Element(ns + "Detalle")?.Value,
                CodigoCabys = cabys,
                Cantidad = decimal.Parse(linea.Element(ns + "Cantidad")?.Value ?? "0", CultureInfo.InvariantCulture),
                PrecioUnitario = decimal.Parse(linea.Element(ns + "PrecioUnitario")?.Value ?? "0", CultureInfo.InvariantCulture),
                MontoImpuesto = decimal.Parse(linea.Descendants(ns + "Monto").FirstOrDefault()?.Value ?? "0", CultureInfo.InvariantCulture),
                TotalLinea = decimal.Parse(linea.Element(ns + "MontoTotalLinea")?.Value ?? "0", CultureInfo.InvariantCulture),
                ProductoIdSugerido = sugerencia.id,
                ProductoNombreSugerido = sugerencia.nombre
            });
        }
        return resultado;
    }

    private int ObtenerORegistrarProveedor(string? cedula, string? nombre, string? telefono, string? correo)
    {
        if (string.IsNullOrEmpty(cedula)) return 0;

        string cedulaLimpia = cedula.Replace("-", "").Trim();

        using var conn = new SqlConnection(_connectionString);
        conn.Open();

        string sqlBusqueda = "SELECT id FROM PROVEEDOR WHERE REPLACE(identificacion, '-', '') = @ced";
        using (var cmdBusqueda = new SqlCommand(sqlBusqueda, conn))
        {
            cmdBusqueda.Parameters.AddWithValue("@ced", cedulaLimpia);
            var result = cmdBusqueda.ExecuteScalar();
            if (result != null) return Convert.ToInt32(result);
        }

        // Insertar con Tel√©fono y Correo (Aseg√∫rate de que estas columnas existan en tu tabla)
        string sqlInsert = @"INSERT INTO PROVEEDOR (nombre, identificacion, telefono, correo, activo) 
                             VALUES (@nom, @ced, @tel, @eml, 1);
                             SELECT SCOPE_IDENTITY();";

        using (var cmdInsert = new SqlCommand(sqlInsert, conn))
        {
            cmdInsert.Parameters.AddWithValue("@nom", nombre ?? "Proveedor Nuevo (XML)");
            cmdInsert.Parameters.AddWithValue("@ced", cedulaLimpia);
            cmdInsert.Parameters.AddWithValue("@tel", (object?)telefono ?? DBNull.Value);
            cmdInsert.Parameters.AddWithValue("@eml", (object?)correo ?? DBNull.Value);
            return Convert.ToInt32(cmdInsert.ExecuteScalar());
        }
    }

    private (int? id, string? nombre) BuscarEquivalencia(int proveedorId, string cabys)
    {
        if (proveedorId == 0 || string.IsNullOrEmpty(cabys)) return (null, null);

        using var conn = new SqlConnection(_connectionString);
        string sql = @"SELECT P.id, P.nombre 
                       FROM PRODUCTO_EQUIVALENCIA E 
                       INNER JOIN PRODUCTO P ON E.producto_id = P.id 
                       WHERE E.proveedor_id = @provId AND E.codigo_xml = @cabys";

        using var cmd = new SqlCommand(sql, conn);
        cmd.Parameters.AddWithValue("@provId", proveedorId);
        cmd.Parameters.AddWithValue("@cabys", cabys);

        try
        {
            conn.Open();
            using var reader = cmd.ExecuteReader();
            if (reader.Read())
            {
                return (Convert.ToInt32(reader["id"]), reader["nombre"].ToString());
            }
        }
        catch { }

        return (null, null);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Utils\ApiResponse.cs --- 
--- NOMBRE: ApiResponse.cs --- 
 
namespace IntegraPro.AppLogic.Utils;

public class ApiResponse<T>
{
    public T? Data { get; set; }
    public string Message { get; set; } = string.Empty;
    public bool Result { get; set; }

    public ApiResponse(bool result, string message, T? data = default)
    {
        Result = result;
        Message = message;
        Data = data;
    }
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Utils\AuthHelper.cs --- 
--- NOMBRE: AuthHelper.cs --- 
 
Ôªøusing System.Text.Json;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Utils
{
    public static class AuthHelper
    {
        public static PermisosDetalle ObtenerPermisos(string json)
        {
            if (string.IsNullOrWhiteSpace(json)) return new PermisosDetalle();

            try
            {
                return JsonSerializer.Deserialize<PermisosDetalle>(json,
                    new JsonSerializerOptions { PropertyNameCaseInsensitive = true }) ?? new PermisosDetalle();
            }
            catch
            {
                return new PermisosDetalle();
            }
        }

        // M√©todo para verificar si el usuario tiene permiso para un m√≥dulo
        public static bool TieneAcceso(PermisosDetalle permisos, string modulo)
        {
            if (permisos.All) return true; // El admin siempre entra

            return modulo.ToLower() switch
            {
                "ventas" => permisos.Ventas,
                "inventario" => permisos.Inventario,
                "compras" => permisos.Compras,
                "caja" => permisos.Caja,
                _ => false
            };
        }
    }
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Utils\Guard.cs --- 
--- NOMBRE: Guard.cs --- 
 
namespace IntegraPro.AppLogic.Utils;

public static class Guard
{
    public static void AgainstNull(object? input, string parameterName)
    {
        if (input == null)
            throw new ArgumentNullException(parameterName, $"{parameterName} no puede ser nulo.");
    }

    public static void AgainstEmptyString(string input, string parameterName)
    {
        if (string.IsNullOrWhiteSpace(input))
            throw new ArgumentException($"{parameterName} no puede estar vacio.", parameterName);
    }

    public static string GenerateReadableId(string prefix)
    {
        return $"{prefix}-{Guid.NewGuid().ToString()[..8].ToUpper()}";
    }
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Utils\Logger.cs --- 
--- NOMBRE: Logger.cs --- 
 
namespace IntegraPro.AppLogic.Utils;

public static class Logger
{
    private static readonly string LogPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "logs.txt");

    public static void WriteLog(string modulo, string accion, string detalle)
    {
        try
        {
            string logLine = $"[{DateTime.Now:yyyy-MM-dd HH:mm:ss}] | {modulo} | {accion} | {detalle}{Environment.NewLine}";
            File.AppendAllText(LogPath, logLine);
        }
        catch { /* Fallback silencioso si el archivo esta bloqueado */ }
    }
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Utils\PasswordHasher.cs --- 
--- NOMBRE: PasswordHasher.cs --- 
 
using System.Security.Cryptography;

namespace IntegraPro.AppLogic.Utils;

public static class PasswordHasher
{
    private const int SaltSize = 16; // 128 bit
    private const int KeySize = 32;  // 256 bit
    private const int Iterations = 100000;
    private static readonly HashAlgorithmName _hashAlgorithm = HashAlgorithmName.SHA256;

    public static string HashPassword(string password)
    {
        byte[] salt = RandomNumberGenerator.GetBytes(SaltSize);
        byte[] hash = Rfc2898DeriveBytes.Pbkdf2(password, salt, Iterations, _hashAlgorithm, KeySize);

        return $"{Convert.ToHexString(salt)}.{Convert.ToHexString(hash)}";
    }

    public static bool VerifyPassword(string password, string hashedPassword)
    {
        string[] parts = hashedPassword.Split('.');
        byte[] salt = Convert.FromHexString(parts[0]);
        byte[] hash = Convert.FromHexString(parts[1]);

        byte[] inputHash = Rfc2898DeriveBytes.Pbkdf2(password, salt, Iterations, _hashAlgorithm, KeySize);

        return CryptographicOperations.FixedTimeEquals(hash, inputHash);
    }
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Class1.cs --- 
--- NOMBRE: Class1.cs --- 
 
Ôªønamespace IntegraPro.DataAccess;

public class Class1
{

}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Dao\MasterDao.cs --- 
--- NOMBRE: MasterDao.cs --- 
 
Ôªøusing System.Data;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Dao;

public abstract class MasterDao
{
    private readonly string _connectionString;

    protected MasterDao(string connectionString)
    {
        _connectionString = connectionString;
    }

    protected SqlConnection GetConnection() => new SqlConnection(_connectionString);

    // 1. Para consultas SELECT
    protected DataTable ExecuteQuery(string query, SqlParameter[]? parameters = null, bool isStoredProcedure = true)
    {
        var table = new DataTable();
        using var connection = GetConnection();
        using var command = new SqlCommand(query, connection);
        command.CommandType = isStoredProcedure ? CommandType.StoredProcedure : CommandType.Text;

        if (parameters != null)
            command.Parameters.AddRange(parameters);

        using var adapter = new SqlDataAdapter(command);
        adapter.Fill(table);
        return table;
    }

    // 2. ExecuteScalar (Devuelve un objeto, ej: un ID)
    protected object ExecuteScalar(string query, SqlParameter[]? parameters = null, bool isStoredProcedure = true)
    {
        using var connection = GetConnection();
        using var command = new SqlCommand(query, connection);
        command.CommandType = isStoredProcedure ? CommandType.StoredProcedure : CommandType.Text;

        if (parameters != null)
            command.Parameters.AddRange(parameters);

        connection.Open();
        var result = command.ExecuteScalar();
        return result ?? DBNull.Value;
    }

    // 3. CORREGIDO: Ahora devuelve INT (filas afectadas)
    protected int ExecuteNonQuery(string query, SqlParameter[]? parameters = null, bool isStoredProcedure = true)
    {
        using var connection = GetConnection();
        using var command = new SqlCommand(query, connection);
        command.CommandType = isStoredProcedure ? CommandType.StoredProcedure : CommandType.Text;

        if (parameters != null)
            command.Parameters.AddRange(parameters);

        connection.Open();
        return command.ExecuteNonQuery(); // Devuelve el n√∫mero de filas
    }

    // 4. CORREGIDO: Ahora devuelve INT para compatibilidad
    protected int ExecuteStoredProcedure(string spName, SqlParameter[] parameters)
    {
        return ExecuteNonQuery(spName, parameters, true);
    }

    // ==========================================
    // NUEVOS M√âTODOS PARA TRANSACCIONES (CORREGIDOS)
    // ==========================================

    protected object ExecuteScalarInTransaction(string sql, SqlParameter[] parameters, SqlConnection connection, SqlTransaction transaction)
    {
        using var command = new SqlCommand(sql, connection, transaction);
        if (parameters != null) command.Parameters.AddRange(parameters);
        var result = command.ExecuteScalar();
        return result ?? DBNull.Value;
    }

    // CORREGIDO: Ahora devuelve INT
    protected int ExecuteNonQueryInTransaction(string sql, SqlParameter[] parameters, SqlConnection connection, SqlTransaction transaction)
    {
        using var command = new SqlCommand(sql, connection, transaction);
        if (parameters != null) command.Parameters.AddRange(parameters);
        return command.ExecuteNonQuery(); // Devuelve el n√∫mero de filas
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\AbonoFactory.cs --- 
--- NOMBRE: AbonoFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class AbonoFactory(string connectionString) : MasterDao(connectionString)
{
    // 1. REGISTRAR ABONO (Transaccional + Seguridad)
    public void ProcesarAbonoCompleto(AbonoDTO abono, int clienteId, UsuarioDTO ejecutor)
    {
        // SEGURIDAD A√ëADIDA
        ejecutor.ValidarAcceso("abonos");
        ejecutor.ValidarEscritura();

        string sql = @"
            BEGIN TRANSACTION;
            BEGIN TRY
                -- 1. Insertar el registro del abono
                INSERT INTO ABONO_CLIENTE (cuenta_cobrar_id, usuario_id, sucursal_id, fecha, monto_abonado, medio_pago, referencia)
                VALUES (@ccid, @uid, @sid, GETDATE(), @monto, @medio, @ref);

                -- 2. Restar el saldo de la cuenta por cobrar y actualizar estado
                UPDATE CUENTA_COBRAR 
                SET saldo_pendiente = saldo_pendiente - @monto,
                    estado = CASE WHEN (saldo_pendiente - @monto) <= 0.01 THEN 'Pagada' ELSE 'Pendiente' END
                WHERE id = @ccid;

                -- 3. Restar el saldo general del CLIENTE
                UPDATE CLIENTE 
                SET saldo_pendiente = saldo_pendiente - @monto 
                WHERE id = @clienteId;

                COMMIT TRANSACTION;
            END TRY
            BEGIN CATCH
                IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
                THROW;
            END CATCH";

        var p = new[] {
            new SqlParameter("@ccid", abono.CuentaCobrarId),
            new SqlParameter("@uid", ejecutor.Id),
            new SqlParameter("@sid", ejecutor.SucursalId),
            new SqlParameter("@monto", abono.MontoAbonado),
            new SqlParameter("@medio", abono.MedioPago),
            new SqlParameter("@ref", (object?)abono.Referencia ?? DBNull.Value),
            new SqlParameter("@clienteId", clienteId)
        };

        ExecuteNonQuery(sql, p, false);
    }

    // 2. BUSCAR CUENTAS (Multitenancy con GetFiltroSucursal)
    public List<CxcConsultaDTO> BuscarCxcClientes(string filtro, UsuarioDTO ejecutor)
    {
        // SEGURIDAD: Filtrado autom√°tico por sucursal
        string sql = $@"SELECT * FROM VW_EstadoCuenta_Clientes 
                        WHERE {ejecutor.GetFiltroSucursal()} ";

        if (!string.IsNullOrWhiteSpace(filtro))
        {
            sql += " AND (cliente_nombre LIKE @f OR factura_numero LIKE @f OR cedula LIKE @f) ";
        }

        sql += " ORDER BY fecha_vencimiento ASC";

        var p = new List<SqlParameter>();
        if (!string.IsNullOrWhiteSpace(filtro))
            p.Add(new SqlParameter("@f", $"%{filtro}%"));

        var dt = ExecuteQuery(sql, p.ToArray(), false);
        var lista = new List<CxcConsultaDTO>();

        if (dt == null) return lista;

        foreach (DataRow row in dt.Rows)
        {
            lista.Add(new CxcConsultaDTO
            {
                CuentaCobrarId = (int)row["cuenta_id"],
                NumeroFactura = row["factura_numero"].ToString()!,
                ClienteNombre = row["cliente_nombre"].ToString()!,
                ClienteCedula = row["cedula"]?.ToString() ?? "N/A",
                FechaEmision = Convert.ToDateTime(row["fecha_emision"]),
                FechaVencimiento = Convert.ToDateTime(row["fecha_vencimiento"]),
                MontoTotal = Convert.ToDecimal(row["monto_total"]),
                SaldoPendiente = Convert.ToDecimal(row["saldo_pendiente"]),
                Estado = row["estado"]?.ToString() ?? "Pendiente",
                DiasCredito = Convert.ToInt32(row["dias_para_vencimiento"])
            });
        }
        return lista;
    }

    // 3. ALERTAS DE MORA (Seguridad por sucursal a√±adida)
    public List<AlertaCxcDTO> ObtenerAlertasVencimiento(UsuarioDTO ejecutor)
    {
        // SEGURIDAD: Filtrado autom√°tico por sucursal
        string sql = $@"SELECT * FROM VW_EstadoCuenta_Clientes 
                       WHERE saldo_pendiente > 0 
                       AND fecha_vencimiento < GETDATE()
                       AND {ejecutor.GetFiltroSucursal()}";

        var dt = ExecuteQuery(sql, null, false);
        var alertas = new List<AlertaCxcDTO>();
        if (dt == null) return alertas;

        foreach (DataRow row in dt.Rows)
        {
            int dias = Convert.ToInt32(row["dias_para_vencimiento"]);
            alertas.Add(new AlertaCxcDTO
            {
                FacturaId = (int)row["cuenta_id"],
                ClienteNombre = row["cliente_nombre"].ToString()!,
                NumeroFactura = row["factura_numero"].ToString()!,
                SaldoPendiente = Convert.ToDecimal(row["saldo_pendiente"]),
                FechaVencimiento = Convert.ToDateTime(row["fecha_vencimiento"]),
                DiasVencidos = Math.Abs(dias),
                NivelRiesgo = Math.Abs(dias) > 30 ? "Cr√≠tico" : "Mora"
            });
        }
        return alertas;
    }

    // 4. RESUMEN GENERAL (Seguridad por sucursal a√±adida)
    public ResumenCxcDTO ObtenerTotalesCxc(UsuarioDTO ejecutor)
    {
        // SEGURIDAD: Filtrado autom√°tico por sucursal
        string sql = $@"SELECT 
                        SUM(saldo_pendiente) as TotalCobrar,
                        SUM(CASE WHEN fecha_vencimiento < GETDATE() THEN saldo_pendiente ELSE 0 END) as TotalVencido,
                        COUNT(cuenta_id) as CantidadFacturas,
                        COUNT(DISTINCT cliente_id) as TotalClientes
                       FROM VW_EstadoCuenta_Clientes 
                       WHERE saldo_pendiente > 0
                       AND {ejecutor.GetFiltroSucursal()}";

        var dt = ExecuteQuery(sql, null, false);

        if (dt != null && dt.Rows.Count > 0 && dt.Rows[0]["TotalCobrar"] != DBNull.Value)
        {
            var row = dt.Rows[0];
            return new ResumenCxcDTO
            {
                TotalPorCobrar = Convert.ToDecimal(row["TotalCobrar"]),
                TotalVencido = Convert.ToDecimal(row["TotalVencido"]),
                CantidadFacturasPendientes = Convert.ToInt32(row["CantidadFacturas"]),
                ClientesMorosos = Convert.ToInt32(row["TotalClientes"])
            };
        }
        return new ResumenCxcDTO();
    }

    // 5. HISTORIAL DE ABONOS (Sin cambios, ya que cuentaId es un identificador √∫nico seguro)
    public List<AbonoHistorialDTO> ListarHistorialAbonos(int cuentaId)
    {
        string sql = @"SELECT A.id, A.monto_abonado, A.fecha, A.medio_pago, A.referencia, U.nombre_completo
                   FROM ABONO_CLIENTE A
                   INNER JOIN USUARIO U ON A.usuario_id = U.id
                   WHERE A.cuenta_cobrar_id = @cId
                   ORDER BY A.fecha DESC";

        var p = new[] { new SqlParameter("@cId", cuentaId) };
        var dt = ExecuteQuery(sql, p, false);

        var lista = new List<AbonoHistorialDTO>();
        if (dt == null) return lista;

        foreach (DataRow row in dt.Rows)
        {
            lista.Add(new AbonoHistorialDTO
            {
                Id = Convert.ToInt32(row["id"]),
                Monto = Convert.ToDecimal(row["monto_abonado"]),
                FechaAbono = Convert.ToDateTime(row["fecha"]),
                MetodoPago = row["medio_pago"].ToString()!,
                NumeroReferencia = row["referencia"]?.ToString() ?? "Sin Ref.",
                NombreUsuario = row["nombre_completo"].ToString()!
            });
        }
        return lista;
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\CajaFactory.cs --- 
--- NOMBRE: CajaFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;
using System.Collections.Generic;
using System;

namespace IntegraPro.DataAccess.Factory;

public class CajaFactory(string connectionString) : MasterDao(connectionString)
{
    public int AbrirCaja(CajaAperturaDTO apertura, UsuarioDTO ejecutor)
    {
        // 1. SEGURIDAD: Validar acceso y escritura
        ejecutor.ValidarAcceso("caja");
        ejecutor.ValidarEscritura();

        string sql = @"INSERT INTO CAJA_CIERRE (sucursal_id, usuario_id, fecha_apertura, monto_inicial, estado) 
                       VALUES (@sid, @uid, GETDATE(), @monto, 'Abierta');
                       SELECT CAST(SCOPE_IDENTITY() as int);";

        var p = new[] {
            new SqlParameter("@sid", ejecutor.SucursalId),
            new SqlParameter("@uid", ejecutor.Id),
            new SqlParameter("@monto", apertura.MontoInicial)
        };

        var dt = ExecuteQuery(sql, p, false);
        return Convert.ToInt32(dt.Rows[0][0]);
    }

    public void CerrarCaja(CajaCierreDTO cierre, UsuarioDTO ejecutor)
    {
        // 2. SEGURIDAD: Validar permisos de escritura antes de procesar
        ejecutor.ValidarAcceso("caja");
        ejecutor.ValidarEscritura();

        string sqlInfo = "SELECT sucursal_id, fecha_apertura FROM CAJA_CIERRE WHERE id = @id AND estado = 'Abierta'";
        var dtInfo = ExecuteQuery(sqlInfo, new[] { new SqlParameter("@id", cierre.CajaId) }, false);

        if (dtInfo.Rows.Count == 0) throw new Exception("La caja no existe o ya se encuentra cerrada.");

        var sid = dtInfo.Rows[0]["sucursal_id"];
        var fechaApertura = dtInfo.Rows[0]["fecha_apertura"];

        string sqlCierre = @"
            DECLARE @ventas decimal(18,2) = (SELECT ISNULL(SUM(total_comprobante),0) FROM FACTURA_ENCABEZADO 
                                            WHERE sucursal_id = @sid AND fecha >= @fecha AND medio_pago = 'Efectivo');
            
            DECLARE @abonos decimal(18,2) = (SELECT ISNULL(SUM(monto_abonado),0) FROM ABONO_CLIENTE 
                                            WHERE sucursal_id = @sid AND fecha >= @fecha AND medio_pago = 'Efectivo');

            UPDATE CAJA_CIERRE SET 
                fecha_cierre = GETDATE(),
                ventas_efectivo = @ventas,
                abonos_efectivo = @abonos,
                esperado_caja = monto_inicial + @ventas + @abonos,
                real_caja = @montoReal,
                notas = @notas,
                estado = 'Cerrada'
            WHERE id = @id";

        var p = new[] {
            new SqlParameter("@id", cierre.CajaId),
            new SqlParameter("@sid", sid),
            new SqlParameter("@fecha", fechaApertura),
            new SqlParameter("@montoReal", cierre.MontoRealEnCaja),
            new SqlParameter("@notas", (object?)cierre.Notas ?? DBNull.Value)
        };

        ExecuteNonQuery(sqlCierre, p, false);
    }

    public List<object> ObtenerHistorialCierres(UsuarioDTO ejecutor)
    {
        // 3. SEGURIDAD: L√≥gica de prioridad de permisos
        // Si el usuario tiene el permiso 'all', el filtro permanece vac√≠o y ve todo.
        string sucursalFilter = "";
        List<SqlParameter> parametros = new List<SqlParameter>();

        if (!ejecutor.TienePermiso("all") && ejecutor.TienePermiso("sucursal_limit"))
        {
            // Ahora que la vista tiene sucursal_id, podemos filtrar sin errores
            sucursalFilter = " WHERE sucursal_id = @sid";
            parametros.Add(new SqlParameter("@sid", ejecutor.SucursalId));
        }

        string sql = $@"SELECT * FROM VW_REPORTE_CIERRES_CAJA 
                        {sucursalFilter} 
                        ORDER BY fecha_cierre DESC";

        var dt = ExecuteQuery(sql, parametros.Count > 0 ? parametros.ToArray() : null, false);
        var lista = new List<object>();

        if (dt == null) return lista;

        foreach (DataRow row in dt.Rows)
        {
            lista.Add(new
            {
                Id = row["caja_id"],
                Sucursal = row["sucursal"].ToString(),
                Cajero = row["cajero"].ToString(),
                Apertura = row["fecha_apertura"],
                Cierre = row["fecha_cierre"],
                MontoInicial = row["monto_inicial"],
                VentasEfectivo = row["ventas_efectivo"],
                AbonosEfectivo = row["abonos_efectivo"],
                Esperado = row["esperado_caja"],
                Real = row["real_caja"],
                Diferencia = row["diferencia"],
                Estado = row["estado_auditoria"],
                Notas = row["notas"].ToString()
            });
        }
        return lista;
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\CategoriaFactory.cs --- 
--- NOMBRE: CategoriaFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class CategoriaFactory(string connectionString) : MasterDao(connectionString)
{
    public List<CategoriaDTO> GetAll(UsuarioDTO ejecutor)
    {
        // SEGURIDAD: Validar que el usuario tiene permiso para ver este m√≥dulo
        ejecutor.ValidarAcceso("inventario"); // O "categorias", seg√∫n tu JSON

        // Las categor√≠as suelen ser globales, por lo que no aplicamos GetFiltroSucursal 
        // a menos que tu tabla CATEGORIA tenga una columna sucursal_id.
        var dt = ExecuteQuery("SELECT * FROM CATEGORIA", null, false);
        var lista = new List<CategoriaDTO>();

        if (dt == null) return lista;

        foreach (DataRow row in dt.Rows)
        {
            lista.Add(new CategoriaDTO
            {
                Id = Convert.ToInt32(row["id"]),
                Nombre = row["nombre"].ToString() ?? "",
                Descripcion = row["descripcion"]?.ToString()
            });
        }
        return lista;
    }

    public bool Create(CategoriaDTO dto, UsuarioDTO ejecutor)
    {
        // SEGURIDAD: Reemplazamos el 'if' manual por los helpers del DTO
        ejecutor.ValidarAcceso("inventario");
        ejecutor.ValidarEscritura();

        var parameters = new[] {
            new SqlParameter("@nombre", dto.Nombre),
            new SqlParameter("@descripcion", (object?)dto.Descripcion ?? DBNull.Value)
        };

        ExecuteNonQuery("INSERT INTO CATEGORIA (nombre, descripcion) VALUES (@nombre, @descripcion)", parameters, false);
        return true;
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\ClienteFactory.cs --- 
--- NOMBRE: ClienteFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class ClienteFactory(string connectionString) : MasterDao(connectionString)
{
    // 1. OBTENER TODOS (Clientes globales)
    public List<ClienteDTO> ObtenerTodos(UsuarioDTO ejecutor)
    {
        // El ejecutor debe tener permiso para ver el m√≥dulo de clientes
        ejecutor.ValidarAcceso("clientes");

        string sql = "SELECT id, identificacion, nombre, correo, telefono, limite_credito, activo FROM CLIENTE";

        var dt = ExecuteQuery(sql, null, false);
        var lista = new List<ClienteDTO>();

        if (dt == null) return lista;

        foreach (DataRow row in dt.Rows)
        {
            lista.Add(new ClienteDTO
            {
                Id = (int)row["id"],
                Identificacion = row["identificacion"].ToString() ?? "",
                Nombre = row["nombre"].ToString() ?? "",
                Correo = row["correo"]?.ToString(),
                Telefono = row["telefono"]?.ToString(),
                LimiteCredito = Convert.ToDecimal(row["limite_credito"]),
                Activo = Convert.ToBoolean(row["activo"])
            });
        }
        return lista;
    }

    // 2. INSERTAR (Sin sucursal_id)
    public int Insertar(ClienteDTO cliente, UsuarioDTO ejecutor)
    {
        ejecutor.ValidarAcceso("clientes");
        ejecutor.ValidarEscritura();

        string sql = @"INSERT INTO CLIENTE (identificacion, nombre, correo, telefono, limite_credito, activo) 
                       VALUES (@ident, @nomb, @corr, @tele, @limi, @acti);
                       SELECT CAST(SCOPE_IDENTITY() as int) AS NuevoID;";

        var p = new[] {
            new SqlParameter("@ident", cliente.Identificacion),
            new SqlParameter("@nomb", cliente.Nombre),
            new SqlParameter("@corr", (object?)cliente.Correo ?? DBNull.Value),
            new SqlParameter("@tele", (object?)cliente.Telefono ?? DBNull.Value),
            new SqlParameter("@limi", cliente.LimiteCredito),
            new SqlParameter("@acti", cliente.Activo)
        };

        var dt = ExecuteQuery(sql, p, false);
        return dt.Rows.Count > 0 ? Convert.ToInt32(dt.Rows[0][0]) : 0;
    }

    // 3. ACTUALIZAR
    public bool Actualizar(ClienteDTO cliente, UsuarioDTO ejecutor)
    {
        ejecutor.ValidarAcceso("clientes");
        ejecutor.ValidarEscritura();

        string sql = @"UPDATE CLIENTE SET 
                    identificacion = CASE 
                        WHEN @ident <> 'string' AND ISNULL(@ident, '') <> '' THEN @ident 
                        ELSE identificacion END, 
                    nombre = CASE 
                        WHEN @nomb <> 'string' AND ISNULL(@nomb, '') <> '' THEN @nomb 
                        ELSE nombre END, 
                    correo = CASE 
                        WHEN @corr <> 'string' AND ISNULL(@corr, '') <> '' THEN @corr 
                        ELSE correo END, 
                    telefono = CASE 
                        WHEN @tele <> 'string' AND ISNULL(@tele, '') <> '' THEN @tele 
                        ELSE telefono END, 
                    limite_credito = CASE 
                        WHEN @limi > 0 THEN @limi 
                        ELSE limite_credito END, 
                    activo = @acti 
                   WHERE id = @id";

        var p = new[] {
            new SqlParameter("@id", cliente.Id),
            new SqlParameter("@ident", (object?)cliente.Identificacion ?? DBNull.Value),
            new SqlParameter("@nomb", (object?)cliente.Nombre ?? DBNull.Value),
            new SqlParameter("@corr", (object?)cliente.Correo ?? DBNull.Value),
            new SqlParameter("@tele", (object?)cliente.Telefono ?? DBNull.Value),
            new SqlParameter("@limi", cliente.LimiteCredito),
            new SqlParameter("@acti", cliente.Activo)
        };

        ExecuteNonQuery(sql, p, false);
        return true;
    }

    // 4. ESTADO DE CR√âDITO
    public (decimal saldo, decimal limite, bool activo) ObtenerEstadoCredito(int clienteId)
    {
        // Se asume que el campo en SQL es saldo_pendiente
        string sql = "SELECT ISNULL(saldo_pendiente, 0) as saldo_pendiente, limite_credito, activo FROM CLIENTE WHERE id = @id";
        var dt = ExecuteQuery(sql, new[] { new SqlParameter("@id", clienteId) }, false);

        if (dt != null && dt.Rows.Count > 0)
        {
            return (
                Convert.ToDecimal(dt.Rows[0]["saldo_pendiente"]),
                Convert.ToDecimal(dt.Rows[0]["limite_credito"]),
                Convert.ToBoolean(dt.Rows[0]["activo"])
            );
        }
        return (0, 0, false);
    }

    // 5. ACTUALIZAR SALDO
    public void ActualizarSaldo(int clienteId, decimal monto)
    {
        string sql = "UPDATE CLIENTE SET saldo_pendiente = ISNULL(saldo_pendiente, 0) + @monto WHERE id = @id";
        ExecuteNonQuery(sql, [
            new SqlParameter("@monto", monto),
            new SqlParameter("@id", clienteId)
        ], false);
    }

    // 6. BUSCAR POR IDENTIFICACI√ìN (Sincronizado con Service)
    public ClienteDTO? ObtenerPorIdentificacion(string identificacion, UsuarioDTO ejecutor)
    {
        // Nota: No filtramos por sucursal_id porque me indicas que no existe en la tabla.
        string sql = "SELECT * FROM CLIENTE WHERE identificacion = @cedula";

        var dt = ExecuteQuery(sql, [new SqlParameter("@cedula", identificacion)], false);

        if (dt == null || dt.Rows.Count == 0) return null;

        var row = dt.Rows[0];
        return new ClienteDTO
        {
            Id = Convert.ToInt32(row["id"]),
            Identificacion = row["identificacion"].ToString() ?? "",
            Nombre = row["nombre"].ToString() ?? "",
            Correo = row["correo"]?.ToString() ?? "",
            Telefono = row["telefono"] != DBNull.Value ? row["telefono"].ToString() : "",
            LimiteCredito = row["limite_credito"] != DBNull.Value ? Convert.ToDecimal(row["limite_credito"]) : 0,
            Activo = row["activo"] != DBNull.Value && Convert.ToBoolean(row["activo"])
        };
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\CompraFactory.cs --- 
--- NOMBRE: CompraFactory.cs --- 
 
Ôªøusing Microsoft.Data.SqlClient;
using IntegraPro.DTO.Models;
using System.Data;
using IntegraPro.DataAccess.Dao;
using System.Collections.Generic;
using System;

namespace IntegraPro.DataAccess.Factory;

public class CompraFactory(string connectionString) : MasterDao(connectionString)
{
    private readonly string _connectionString = connectionString;

    public void ProcesarCompra(CompraDTO compra, UsuarioDTO ejecutor)
    {
        // === INTEGRACI√ìN DE SEGURIDAD ROBUSTA ===
        if (ejecutor.Permisos == null || ejecutor.Permisos.Count == 0)
        {
            throw new UnauthorizedAccessException($"Acceso denegado: El sistema no detect√≥ permisos cargados. (JSON: {ejecutor.PermisosJson})");
        }

        bool tieneAcceso = ejecutor.TienePermiso("all") || ejecutor.TienePermiso("compras");
        bool esSoloLectura = ejecutor.Permisos.TryGetValue("solo_lectura", out bool sl) && sl;

        if (!tieneAcceso)
            throw new UnauthorizedAccessException("No tiene permisos para procesar compras.");

        if (esSoloLectura)
            throw new UnauthorizedAccessException("Su usuario tiene restricciones de solo lectura y no puede realizar transacciones.");

        // ASIGNACI√ìN DE SUCURSAL: 
        // Si el usuario es 'all', respetamos la sucursal que venga en el DTO (permitiendo compras inter-sucursales).
        // Si NO es 'all' y tiene 'sucursal_limit', forzamos su propia sucursal.
        if (!ejecutor.TienePermiso("all") && ejecutor.TienePermiso("sucursal_limit"))
        {
            compra.SucursalId = ejecutor.SucursalId;
        }

        using var conn = new SqlConnection(_connectionString);
        conn.Open();
        using var trans = conn.BeginTransaction();
        try
        {
            string sqlEnc = @"INSERT INTO COMPRA_ENCABEZADO 
                (proveedor_id, sucursal_id, usuario_id, numero_factura_proveedor, fecha_compra, subtotal, total_impuestos, total_compra, notas, estado, tipo_pago) 
                VALUES (@prov, @suc, @usu, @num, @fecC, @sub, @imp, @tot, @not, 'Procesada', @tPag);
                SELECT CAST(SCOPE_IDENTITY() as int);";

            using var cmdEnc = new SqlCommand(sqlEnc, conn, trans);
            cmdEnc.Parameters.AddWithValue("@prov", compra.ProveedorId);
            cmdEnc.Parameters.AddWithValue("@suc", compra.SucursalId);
            cmdEnc.Parameters.AddWithValue("@usu", ejecutor.Id);
            cmdEnc.Parameters.AddWithValue("@num", (object?)compra.NumeroFacturaProveedor ?? DBNull.Value);
            cmdEnc.Parameters.AddWithValue("@fecC", compra.FechaCompra);
            cmdEnc.Parameters.AddWithValue("@sub", compra.Subtotal);
            cmdEnc.Parameters.AddWithValue("@imp", compra.TotalImpuestos);
            cmdEnc.Parameters.AddWithValue("@tot", compra.TotalCompra);
            cmdEnc.Parameters.AddWithValue("@not", (object?)compra.Notas ?? DBNull.Value);
            cmdEnc.Parameters.AddWithValue("@tPag", compra.TipoPago);

            int compraId = (int)cmdEnc.ExecuteScalar();

            if (compra.TipoPago == "Credito")
            {
                string sqlCxp = @"INSERT INTO CUENTA_PAGAR 
                    (compra_id, proveedor_id, monto_total, saldo_pendiente, fecha_vencimiento, estado) 
                    VALUES (@cId, @pId, @tot, @tot, @fVen, 'Pendiente')";

                using var cmdCxp = new SqlCommand(sqlCxp, conn, trans);
                cmdCxp.Parameters.AddWithValue("@cId", compraId);
                cmdCxp.Parameters.AddWithValue("@pId", compra.ProveedorId);
                cmdCxp.Parameters.AddWithValue("@tot", compra.TotalCompra);
                cmdCxp.Parameters.AddWithValue("@fVen", compra.FechaCompra.AddDays(compra.DiasCredito));
                cmdCxp.ExecuteNonQuery();
            }

            foreach (var det in compra.Detalles)
            {
                string sqlDet = "INSERT INTO COMPRA_DETALLE (compra_id, producto_id, cantidad, costo_unitario_neto, monto_impuesto, total_linea) VALUES (@cId, @pId, @can, @cos, @mImp, @totL)";
                using var cmdDet = new SqlCommand(sqlDet, conn, trans);
                cmdDet.Parameters.AddWithValue("@cId", compraId);
                cmdDet.Parameters.AddWithValue("@pId", det.ProductoId);
                cmdDet.Parameters.AddWithValue("@can", det.Cantidad);
                cmdDet.Parameters.AddWithValue("@cos", det.CostoUnitarioNeto);
                cmdDet.Parameters.AddWithValue("@mImp", det.MontoImpuesto);
                cmdDet.Parameters.AddWithValue("@totL", det.TotalLinea);
                cmdDet.ExecuteNonQuery();

                string sqlMov = @"INSERT INTO MOVIMIENTO_INVENTARIO 
                    (producto_id, usuario_id, sucursal_id, fecha, tipo_movimiento, cantidad, documento_referencia, notas) 
                    VALUES (@pId, @uId, @sId, GETDATE(), 'Entrada', @can, @ref, 'Compra Recibida')";

                using var cmdMov = new SqlCommand(sqlMov, conn, trans);
                cmdMov.Parameters.AddWithValue("@pId", det.ProductoId);
                cmdMov.Parameters.AddWithValue("@uId", ejecutor.Id);
                cmdMov.Parameters.AddWithValue("@sId", compra.SucursalId);
                cmdMov.Parameters.AddWithValue("@can", det.Cantidad);
                cmdMov.Parameters.AddWithValue("@ref", "FAC-" + (compra.NumeroFacturaProveedor ?? "S/N"));
                cmdMov.ExecuteNonQuery();

                string sqlCosto = "UPDATE PRODUCTO SET costo_actual = @nCos WHERE id = @pId";
                using var cmdCosto = new SqlCommand(sqlCosto, conn, trans);
                cmdCosto.Parameters.AddWithValue("@nCos", det.CostoUnitarioNeto);
                cmdCosto.Parameters.AddWithValue("@pId", det.ProductoId);
                cmdCosto.ExecuteNonQuery();

                if (!string.IsNullOrEmpty(det.CodigoCabys) && det.ProductoId > 0)
                {
                    string sqlEquiv = @"
                        IF EXISTS (SELECT 1 FROM PRODUCTO_EQUIVALENCIA WHERE proveedor_id = @provId AND codigo_xml = @codXml)
                            UPDATE PRODUCTO_EQUIVALENCIA SET producto_id = @prodId WHERE proveedor_id = @provId AND codigo_xml = @codXml
                        ELSE
                            INSERT INTO PRODUCTO_EQUIVALENCIA (proveedor_id, codigo_xml, producto_id) VALUES (@provId, @codXml, @prodId)";

                    using var cmdEquiv = new SqlCommand(sqlEquiv, conn, trans);
                    cmdEquiv.Parameters.AddWithValue("@provId", compra.ProveedorId);
                    cmdEquiv.Parameters.AddWithValue("@codXml", det.CodigoCabys);
                    cmdEquiv.Parameters.AddWithValue("@prodId", det.ProductoId);
                    cmdEquiv.ExecuteNonQuery();
                }
            }
            trans.Commit();
        }
        catch { trans.Rollback(); throw; }
    }

    public List<DeudaConsultaDTO> BuscarDeudas(string filtro, UsuarioDTO ejecutor)
    {
        var lista = new List<DeudaConsultaDTO>();
        using var conn = new SqlConnection(_connectionString);

        // L√ìGICA DE FILTRADO POR SUCURSAL
        string sucursalFilter = "";
        if (!ejecutor.TienePermiso("all") && ejecutor.TienePermiso("sucursal_limit"))
        {
            sucursalFilter = $" AND CompraId IN (SELECT id FROM COMPRA_ENCABEZADO WHERE sucursal_id = {ejecutor.SucursalId})";
        }

        string sql = $@"SELECT * FROM VW_CONSULTA_DEUDAS 
                       WHERE (ProveedorCedula LIKE @f 
                          OR ProveedorNombre LIKE @f 
                          OR NumeroFactura LIKE @f)
                          {sucursalFilter}
                       ORDER BY FechaVencimiento ASC";

        using var cmd = new SqlCommand(sql, conn);
        cmd.Parameters.AddWithValue("@f", $"%{filtro}%");

        conn.Open();
        using var reader = cmd.ExecuteReader();
        while (reader.Read())
        {
            lista.Add(new DeudaConsultaDTO
            {
                DeudaId = (int)reader["DeudaId"],
                CompraId = (int)reader["CompraId"],
                ProveedorCedula = reader["ProveedorCedula"].ToString()!,
                ProveedorNombre = reader["ProveedorNombre"].ToString()!,
                NumeroFactura = reader["NumeroFactura"].ToString()!,
                FechaCompra = (DateTime)reader["FechaCompra"],
                MontoOriginal = (decimal)reader["MontoOriginal"],
                SaldoActual = (decimal)reader["SaldoActual"],
                FechaVencimiento = (DateTime)reader["FechaVencimiento"],
                EstadoDeuda = reader["EstadoDeuda"].ToString()!
            });
        }
        return lista;
    }

    public List<PagoHistorialDTO> ObtenerHistorialPagos(int compraId)
    {
        var historial = new List<PagoHistorialDTO>();
        using var conn = new SqlConnection(_connectionString);

        string sql = @"SELECT H.id, H.monto, H.fecha_pago, H.numero_referencia, H.notas, U.nombre_completo as nombre_usuario
                       FROM PAGO_CXP_HISTORIAL H
                       JOIN USUARIO U ON H.usuario_id = U.id
                       WHERE H.compra_id = @cId
                       ORDER BY H.fecha_pago DESC";

        using var cmd = new SqlCommand(sql, conn);
        cmd.Parameters.AddWithValue("@cId", compraId);

        conn.Open();
        using var reader = cmd.ExecuteReader();
        while (reader.Read())
        {
            historial.Add(new PagoHistorialDTO
            {
                Id = (int)reader["id"],
                Monto = (decimal)reader["monto"],
                FechaPago = (DateTime)reader["fecha_pago"],
                NumeroReferencia = reader["numero_referencia"]?.ToString(),
                Notas = reader["notas"]?.ToString(),
                NombreUsuario = reader["nombre_usuario"]?.ToString()
            });
        }
        return historial;
    }

    public void RegistrarPagoCxp(PagoCxpDTO pago, UsuarioDTO ejecutor)
    {
        bool esSoloLectura = ejecutor.Permisos.TryGetValue("solo_lectura", out bool sl) && sl;
        if (esSoloLectura)
            throw new UnauthorizedAccessException("El rol de auditor√≠a no puede registrar pagos.");

        using var conn = new SqlConnection(_connectionString);
        conn.Open();

        string sqlCheck = "SELECT saldo_pendiente FROM CUENTA_PAGAR WHERE compra_id = @cId AND estado != 'Anulado'";
        using (var cmdCheck = new SqlCommand(sqlCheck, conn))
        {
            cmdCheck.Parameters.AddWithValue("@cId", pago.CompraId);
            var result = cmdCheck.ExecuteScalar();
            if (result == null) throw new Exception("Error: Esta compra no genera deuda.");
            decimal saldoActual = Convert.ToDecimal(result);
            if (saldoActual <= 0) throw new Exception("Esta factura ya ha sido pagada.");
            if (pago.Monto > saldoActual) throw new Exception($"Monto excede el saldo ({saldoActual}).");
        }

        using var trans = conn.BeginTransaction();
        try
        {
            string sqlHistorial = "INSERT INTO PAGO_CXP_HISTORIAL (compra_id, usuario_id, monto, fecha_pago, numero_referencia, notas) VALUES (@cId, @uId, @monto, GETDATE(), @ref, @not)";
            using (var cmdHist = new SqlCommand(sqlHistorial, conn, trans))
            {
                cmdHist.Parameters.AddWithValue("@cId", pago.CompraId);
                cmdHist.Parameters.AddWithValue("@uId", ejecutor.Id);
                cmdHist.Parameters.AddWithValue("@monto", pago.Monto);
                cmdHist.Parameters.AddWithValue("@ref", (object?)pago.NumeroReferencia ?? DBNull.Value);
                cmdHist.Parameters.AddWithValue("@not", (object?)pago.Notas ?? DBNull.Value);
                cmdHist.ExecuteNonQuery();
            }

            string sqlUpdateCxp = @"UPDATE CUENTA_PAGAR SET saldo_pendiente = saldo_pendiente - @monto,
                                    estado = CASE WHEN (saldo_pendiente - @monto) <= 0 THEN 'Pagada' ELSE 'Pendiente' END
                                    WHERE compra_id = @cId";
            using (var cmdUp = new SqlCommand(sqlUpdateCxp, conn, trans))
            {
                cmdUp.Parameters.AddWithValue("@monto", pago.Monto);
                cmdUp.Parameters.AddWithValue("@cId", pago.CompraId);
                cmdUp.ExecuteNonQuery();
            }
            trans.Commit();
        }
        catch { trans.Rollback(); throw; }
    }

    public void AnularCompra(int compraId, UsuarioDTO ejecutor)
    {
        bool tieneAcceso = ejecutor.TienePermiso("all") || ejecutor.TienePermiso("compras");
        bool esSoloLectura = ejecutor.Permisos.TryGetValue("solo_lectura", out bool sl) && sl;

        if (!tieneAcceso || esSoloLectura)
            throw new UnauthorizedAccessException("No tiene permisos para anular compras.");

        using var conn = new SqlConnection(_connectionString);
        conn.Open();
        using var trans = conn.BeginTransaction();
        try
        {
            var detalles = new List<(int pId, decimal cant, string refProv, int sId)>();
            string sqlGet = @"SELECT D.producto_id, D.cantidad, E.numero_factura_proveedor, E.sucursal_id 
                          FROM COMPRA_DETALLE D 
                          JOIN COMPRA_ENCABEZADO E ON D.compra_id = E.id 
                          WHERE E.id = @id AND E.estado = 'Procesada'";

            using (var cmdGet = new SqlCommand(sqlGet, conn, trans))
            {
                cmdGet.Parameters.AddWithValue("@id", compraId);
                using var reader = cmdGet.ExecuteReader();
                while (reader.Read())
                    detalles.Add(((int)reader[0], (decimal)reader[1], reader[2]?.ToString() ?? "S/N", (int)reader[3]));
            }

            if (detalles.Count == 0) throw new Exception("Compra no encontrada o no es anulable.");

            // Validamos sucursal solo si NO es administrador global
            if (!ejecutor.TienePermiso("all") && ejecutor.TienePermiso("sucursal_limit") && detalles[0].sId != ejecutor.SucursalId)
                throw new UnauthorizedAccessException("No puede anular compras de otra sucursal.");

            foreach (var det in detalles)
            {
                string sqlMov = @"INSERT INTO MOVIMIENTO_INVENTARIO (producto_id, usuario_id, sucursal_id, fecha, tipo_movimiento, cantidad, documento_referencia, notas) 
                              VALUES (@pId, @uId, @sId, GETDATE(), 'Salida', @can, @ref, 'ANULACI√ìN DE COMPRA')";
                using var cmdMov = new SqlCommand(sqlMov, conn, trans);
                cmdMov.Parameters.AddWithValue("@pId", det.pId);
                cmdMov.Parameters.AddWithValue("@uId", ejecutor.Id);
                cmdMov.Parameters.AddWithValue("@sId", det.sId);
                cmdMov.Parameters.AddWithValue("@can", det.cant);
                cmdMov.Parameters.AddWithValue("@ref", "ANUL-" + det.refProv);
                cmdMov.ExecuteNonQuery();
            }

            string sqlUpdateCxp = "UPDATE CUENTA_PAGAR SET estado = 'Anulado', saldo_pendiente = 0 WHERE compra_id = @id";
            using (var cmdUp1 = new SqlCommand(sqlUpdateCxp, conn, trans))
            {
                cmdUp1.Parameters.AddWithValue("@id", compraId);
                cmdUp1.ExecuteNonQuery();
            }

            string sqlUpdateEnc = "UPDATE COMPRA_ENCABEZADO SET estado = 'Anulada' WHERE id = @id";
            using (var cmdUp2 = new SqlCommand(sqlUpdateEnc, conn, trans))
            {
                cmdUp2.Parameters.AddWithValue("@id", compraId);
                cmdUp2.ExecuteNonQuery();
            }

            trans.Commit();
        }
        catch { trans.Rollback(); throw; }
    }

    public List<AlertaPagoDTO> ObtenerAlertasPagos(UsuarioDTO ejecutor)
    {
        var alertas = new List<AlertaPagoDTO>();
        string sql = "SELECT * FROM VW_ALERTA_CUENTAS_PAGAR_PROXIMAS";

        // Filtramos por sucursal solo si NO es 'all'
        if (!ejecutor.TienePermiso("all") && ejecutor.TienePermiso("sucursal_limit"))
            sql += " WHERE sucursal_id = " + ejecutor.SucursalId;

        sql += " ORDER BY fecha_vencimiento ASC";

        var dt = ExecuteQuery(sql, null, false);
        foreach (DataRow row in dt.Rows)
        {
            alertas.Add(new AlertaPagoDTO
            {
                Id = (int)row["id"],
                ProveedorNombre = row["proveedor_nombre"].ToString()!,
                SaldoPendiente = (decimal)row["saldo_pendiente"],
                FechaVencimiento = (DateTime)row["fecha_vencimiento"],
                DiasParaVencimiento = (int)row["dias_para_vencimiento"],
                Urgencia = row["urgencia"].ToString()!
            });
        }
        return alertas;
    }

    public ResumenCxpDTO ObtenerResumenGeneralCxp(UsuarioDTO ejecutor)
    {
        // El administrador global (all) ve el consolidado de todas las sucursales.
        string filter = "";
        if (!ejecutor.TienePermiso("all") && ejecutor.TienePermiso("sucursal_limit"))
        {
            filter = $" AND C.compra_id IN (SELECT id FROM COMPRA_ENCABEZADO WHERE sucursal_id = {ejecutor.SucursalId})";
        }

        string sql = $@"SELECT 
                        SUM(saldo_pendiente) as TotalGlobal,
                        COUNT(id) as TotalFacturas,
                        COUNT(DISTINCT proveedor_id) as TotalProveedores,
                        MIN(fecha_vencimiento) as ProximaFecha
                       FROM CUENTA_PAGAR C
                       WHERE estado = 'Pendiente' AND saldo_pendiente > 0 {filter}";

        var dt = ExecuteQuery(sql, null, false);
        if (dt != null && dt.Rows.Count > 0)
        {
            var row = dt.Rows[0];
            return new ResumenCxpDTO
            {
                TotalDeudaGlobal = row["TotalGlobal"] != DBNull.Value ? (decimal)row["TotalGlobal"] : 0,
                FacturasPendientes = row["TotalFacturas"] != DBNull.Value ? (int)row["TotalFacturas"] : 0,
                ProveedoresAQuienesSeDebe = row["TotalProveedores"] != DBNull.Value ? (int)row["TotalProveedores"] : 0,
                FechaProximoVencimiento = row["ProximaFecha"] != DBNull.Value ? (DateTime)row["ProximaFecha"] : null
            };
        }
        return new ResumenCxpDTO();
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\ConfiguracionFactory.cs --- 
--- NOMBRE: ConfiguracionFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class ConfiguracionFactory(string connectionString) : MasterDao(connectionString)
{
    /// <summary>
    /// Obtiene los datos comerciales. Ahora requiere validaci√≥n de acceso al m√≥dulo config.
    /// </summary>
    public EmpresaDTO? ObtenerEmpresa(UsuarioDTO ejecutor)
    {
        // SEGURIDAD: Validar que el usuario tiene permiso para ver la configuraci√≥n
        ejecutor.ValidarAcceso("config");

        string sql = @"SELECT TOP 1 
                        id, nombre_comercial, razon_social, cedula_juridica, 
                        tipo_regimen, telefono, correo_notificaciones, sitio_web, 
                        logo, permitir_stock_negativo
                       FROM EMPRESA";

        DataTable dt = ExecuteQuery(sql, null, false);

        if (dt == null || dt.Rows.Count == 0) return null;

        DataRow row = dt.Rows[0];
        return new EmpresaDTO
        {
            Id = Convert.ToInt32(row["id"]),
            NombreComercial = row["nombre_comercial"]?.ToString() ?? string.Empty,
            RazonSocial = row["razon_social"]?.ToString() ?? string.Empty,
            CedulaJuridica = row["cedula_juridica"]?.ToString() ?? string.Empty,
            TipoRegimen = row["tipo_regimen"]?.ToString() ?? "Tradicional",
            Telefono = row["telefono"]?.ToString() ?? string.Empty,
            CorreoNotificaciones = row["correo_notificaciones"]?.ToString() ?? string.Empty,
            SitioWeb = row["sitio_web"]?.ToString() ?? string.Empty,
            Logo = row["logo"]?.ToString(),
            PermitirStockNegativo = row["permitir_stock_negativo"] != DBNull.Value && Convert.ToBoolean(row["permitir_stock_negativo"])
        };
    }

    /// <summary>
    /// Guarda o actualiza con l√≥gica blindada.
    /// </summary>
    public void GuardarEmpresa(EmpresaDTO empresa, UsuarioDTO ejecutor)
    {
        // SEGURIDAD: Reemplazamos el 'if' manual por los helpers estandarizados
        ejecutor.ValidarAcceso("config");
        ejecutor.ValidarEscritura();

        string sql = @"
            UPDATE EMPRESA SET 
                nombre_comercial = CASE WHEN ISNULL(@nom, '') NOT IN ('', 'string') THEN @nom ELSE nombre_comercial END,
                razon_social = CASE WHEN ISNULL(@raz, '') NOT IN ('', 'string') THEN @raz ELSE razon_social END,
                cedula_juridica = CASE WHEN ISNULL(@ced, '') NOT IN ('', 'string') THEN @ced ELSE cedula_juridica END,
                tipo_regimen = CASE WHEN ISNULL(@reg, '') NOT IN ('', 'string') THEN @reg ELSE tipo_regimen END,
                telefono = CASE WHEN ISNULL(@tel, '') NOT IN ('', 'string') THEN @tel ELSE telefono END,
                correo_notificaciones = CASE WHEN ISNULL(@cor, '') NOT IN ('', 'string') THEN @cor ELSE correo_notificaciones END,
                sitio_web = CASE WHEN ISNULL(@sit, '') NOT IN ('', 'string') THEN @sit ELSE sitio_web END,
                permitir_stock_negativo = @stk
            WHERE id = 1;
            
            IF @@ROWCOUNT = 0
            BEGIN
                INSERT INTO EMPRESA (nombre_comercial, razon_social, cedula_juridica, tipo_regimen, telefono, correo_notificaciones, sitio_web, permitir_stock_negativo)
                VALUES (@nom, @raz, @ced, @reg, @tel, @cor, @sit, @stk)
            END";

        var p = new SqlParameter[] {
            new SqlParameter("@nom", (object?)empresa.NombreComercial ?? DBNull.Value),
            new SqlParameter("@raz", (object?)empresa.RazonSocial ?? DBNull.Value),
            new SqlParameter("@ced", (object?)empresa.CedulaJuridica ?? DBNull.Value),
            new SqlParameter("@reg", (object?)empresa.TipoRegimen ?? DBNull.Value),
            new SqlParameter("@tel", (object?)empresa.Telefono ?? DBNull.Value),
            new SqlParameter("@cor", (object?)empresa.CorreoNotificaciones ?? DBNull.Value),
            new SqlParameter("@sit", (object?)empresa.SitioWeb ?? DBNull.Value),
            new SqlParameter("@stk", empresa.PermitirStockNegativo)
        };

        ExecuteNonQuery(sql, p, false);
    }

    /// <summary>
    /// Registra la licencia. Mantenemos el permiso 'config'.
    /// </summary>
    public void RegistrarConfiguracionInicial(string nombreEmpresa, string ruc, int maxEquipos, string hid, UsuarioDTO ejecutor)
    {
        ejecutor.ValidarAcceso("config");
        ejecutor.ValidarEscritura();

        var parameters = new SqlParameter[] {
            new SqlParameter("@nombre_empresa", nombreEmpresa),
            new SqlParameter("@ruc", ruc),
            new SqlParameter("@max_equipos", maxEquipos),
            new SqlParameter("@hid_principal", hid)
        };

        ExecuteNonQuery("sp_Configuracion_ActivarSistema", parameters);
    }

    // Los m√©todos ValidarLicenciaMultiEquipo y ObtenerLicencia se quedan igual
    // ya que se usan en procesos de arranque o validaci√≥n de equipo f√≠sico (pre-auth).

    public DataTable ValidarLicenciaMultiEquipo(string hardwareId)
    {
        var parameters = new SqlParameter[] { new SqlParameter("@hardware_id", hardwareId) };
        return ExecuteQuery("sp_Licencia_AutoValidar_MultiEquipo", parameters);
    }

    public LicenciaDTO? ObtenerLicencia(string hardwareId)
    {
        var p = new SqlParameter[] { new SqlParameter("@hardware_id", hardwareId) };
        var dt = ExecuteQuery("sp_Licencia_Validar", p);

        if (dt == null || dt.Rows.Count == 0) return null;

        var row = dt.Rows[0];
        return new LicenciaDTO
        {
            HardwareId = row["hardware_id"].ToString()!,
            Estado = row["estado"].ToString()!,
            FechaVencimiento = Convert.ToDateTime(row["fecha_vencimiento"])
        };
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\EmpresaFactory.cs --- 
--- NOMBRE: EmpresaFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class EmpresaFactory(string connectionString) : MasterDao(connectionString)
{
    /// <summary>
    /// Obtiene la configuraci√≥n global de la empresa. 
    /// Se a√±ade el ejecutor para validar que tiene permiso de acceso al m√≥dulo.
    /// </summary>
    public EmpresaDTO? ObtenerConfiguracion(UsuarioDTO ejecutor)
    {
        // SEGURIDAD: Validar acceso preventivo
        ejecutor.ValidarAcceso("config");

        string sql = @"SELECT TOP 1 id, nombre_comercial, cedula_juridica, 
                                correo_notificaciones, tipo_regimen 
                       FROM EMPRESA";

        var dt = ExecuteQuery(sql, null, false);

        if (dt == null || dt.Rows.Count == 0) return null;

        DataRow r = dt.Rows[0];
        return new EmpresaDTO
        {
            Id = Convert.ToInt32(r["id"]),
            NombreComercial = r["nombre_comercial"]?.ToString() ?? "",
            CedulaJuridica = r["cedula_juridica"]?.ToString() ?? "",
            CorreoNotificaciones = r["correo_notificaciones"]?.ToString() ?? "",
            TipoRegimen = r["tipo_regimen"]?.ToString() ?? "Tradicional"
        };
    }

    /// <summary>
    /// Alias para compatibilidad con VentaService. 
    /// Nota: Si VentaService lo usa internamente para imprimir facturas, 
    /// aseg√∫rate de pasar un ejecutor v√°lido o sobrecargar si es un proceso autom√°tico.
    /// </summary>
    public EmpresaDTO? ObtenerEmpresa(UsuarioDTO ejecutor) => ObtenerConfiguracion(ejecutor);

    /// <summary>
    /// Registra la empresa por primera vez.
    /// </summary>
    public int RegistrarEmpresa(EmpresaDTO e, UsuarioDTO ejecutor)
    {
        // SEGURIDAD: Usamos los helpers estandarizados
        ejecutor.ValidarAcceso("config");
        ejecutor.ValidarEscritura();

        // 2. VALIDACI√ìN DE EXISTENCIA PREVIA (L√≥gica de negocio intacta)
        string sqlCheck = "SELECT COUNT(*) FROM EMPRESA";
        var count = Convert.ToInt32(ExecuteScalar(sqlCheck, null, false));

        if (count > 0)
            throw new Exception("Ya existe una empresa registrada. Use Actualizar para modificar los datos.");

        string sql = @"INSERT INTO EMPRESA (nombre_comercial, cedula_juridica, correo_notificaciones, tipo_regimen)
                        VALUES (@nom, @ced, @cor, @reg);
                        SELECT CAST(SCOPE_IDENTITY() as int);";

        var p = new[] {
            new SqlParameter("@nom", e.NombreComercial),
            new SqlParameter("@ced", e.CedulaJuridica),
            new SqlParameter("@cor", (object?)e.CorreoNotificaciones ?? DBNull.Value),
            new SqlParameter("@reg", (object?)e.TipoRegimen ?? "Tradicional")
        };

        return Convert.ToInt32(ExecuteScalar(sql, p, false));
    }

    /// <summary>
    /// Actualiza los datos maestros.
    /// </summary>
    public void ActualizarEmpresa(EmpresaDTO e, UsuarioDTO ejecutor)
    {
        // SEGURIDAD: Usamos los helpers estandarizados
        ejecutor.ValidarAcceso("config");
        ejecutor.ValidarEscritura();

        string sql = @"UPDATE EMPRESA SET 
                        nombre_comercial = @nom, 
                        cedula_juridica = @ced,
                        correo_notificaciones = @cor, 
                        tipo_regimen = @reg
                       WHERE id = @id";

        var p = new[] {
            new SqlParameter("@id", e.Id),
            new SqlParameter("@nom", e.NombreComercial),
            new SqlParameter("@ced", e.CedulaJuridica),
            new SqlParameter("@cor", (object?)e.CorreoNotificaciones ?? DBNull.Value),
            new SqlParameter("@reg", (object?)e.TipoRegimen ?? "Tradicional")
        };

        ExecuteNonQuery(sql, p, false);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\FacturaFactory.cs --- 
--- NOMBRE: FacturaFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class FacturaFactory(string connectionString) : MasterDao(connectionString)
{
    // 1. CREAR ENCABEZADO (Blindado con UsuarioDTO)
    public int CrearEncabezado(FacturaDTO factura, string consecutivo, string clave, UsuarioDTO ejecutor)
    {
        // SEGURIDAD: Validar acceso al m√≥dulo de ventas/facturaci√≥n
        ejecutor.ValidarAcceso("ventas");
        ejecutor.ValidarEscritura();

        // IMPORTANTE: Forzamos que la sucursal y el usuario sean los del token, no los que vengan en el JSON
        // Esto evita fraudes donde un usuario intenta facturar a nombre de otra sucursal.
        int sucursalReal = ejecutor.SucursalId;
        int usuarioReal = ejecutor.Id;

        string sql = @"INSERT INTO FACTURA_ENCABEZADO 
            (cliente_id, sucursal_id, usuario_id, consecutivo, clave_numerica, fecha, condicion_venta, medio_pago, total_neto, total_descuento, total_impuesto, total_comprobante, estado_hacienda)
            VALUES (@cli, @suc, @usu, @cons, @clav, GETDATE(), @cond, @medi, @neto, @tdesc, @imp, @total, 'Pendiente');
            SELECT CAST(SCOPE_IDENTITY() as int) AS NuevoID;";

        var p = new[] {
            new SqlParameter("@cli", SqlDbType.Int) { Value = factura.ClienteId },
            new SqlParameter("@suc", SqlDbType.Int) { Value = sucursalReal },
            new SqlParameter("@usu", SqlDbType.Int) { Value = usuarioReal },
            new SqlParameter("@cons", SqlDbType.NVarChar) { Value = consecutivo },
            new SqlParameter("@clav", SqlDbType.NVarChar) { Value = clave },
            new SqlParameter("@cond", SqlDbType.NVarChar) { Value = factura.CondicionVenta },
            new SqlParameter("@medi", SqlDbType.NVarChar) { Value = factura.MedioPago },
            new SqlParameter("@neto", SqlDbType.Decimal) { Value = factura.TotalNeto },
            new SqlParameter("@tdesc", SqlDbType.Decimal) { Value = factura.TotalDescuento },
            new SqlParameter("@imp", SqlDbType.Decimal) { Value = factura.TotalImpuesto },
            new SqlParameter("@total", SqlDbType.Decimal) { Value = factura.TotalComprobante }
        };

        var dt = ExecuteQuery(sql, p, false);

        if (dt != null && dt.Rows.Count > 0)
        {
            return Convert.ToInt32(dt.Rows[0][0]);
        }

        throw new Exception("Error cr√≠tico: No se pudo generar el registro de la factura.");
    }

    // 2. INSERTAR DETALLE (Mantenemos tu l√≥gica de c√°lculo decimal)
    public void InsertarDetalle(int facturaId, FacturaDetalleDTO d)
    {
        string sql = @"INSERT INTO FACTURA_DETALLE 
            (factura_id, producto_id, cantidad, precio_unitario, porcentaje_descuento, monto_descuento, monto_impuesto, total_linea)
            VALUES (@fid, @pid, @cant, @prec, @pdes, @mdes, @mimp, @total)";

        // Tu l√≥gica de c√°lculo se mantiene intacta
        decimal montoDesc = (d.PrecioUnitario * d.Cantidad) * (d.PorcentajeDescuento / 100);
        decimal subtotal = (d.PrecioUnitario * d.Cantidad) - montoDesc;
        decimal impuesto = subtotal * 0.13m; // IVA est√°ndar

        var p = new[] {
            new SqlParameter("@fid", SqlDbType.Int) { Value = facturaId },
            new SqlParameter("@pid", SqlDbType.Int) { Value = d.ProductoId },
            new SqlParameter("@cant", SqlDbType.Decimal) { Value = d.Cantidad },
            new SqlParameter("@prec", SqlDbType.Decimal) { Value = d.PrecioUnitario },
            new SqlParameter("@pdes", SqlDbType.Decimal) { Value = d.PorcentajeDescuento },
            new SqlParameter("@mdes", SqlDbType.Decimal) { Value = montoDesc },
            new SqlParameter("@mimp", SqlDbType.Decimal) { Value = impuesto },
            new SqlParameter("@total", SqlDbType.Decimal) { Value = subtotal + impuesto }
        };

        ExecuteNonQuery(sql, p, false);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\InventarioFactory.cs --- 
--- NOMBRE: InventarioFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class InventarioFactory(string connectionString) : MasterDao(connectionString)
{
    public bool Insertar(MovimientoInventarioDTO dto, UsuarioDTO ejecutor)
    {
        // 1. SEGURIDAD B√ÅSICA
        ejecutor.ValidarAcceso("inventario");
        ejecutor.ValidarEscritura();

        // 2. L√ìGICA DE PRIORIDAD DE SUCURSAL (EL CORAZ√ìN DEL CAMBIO)
        int sucursalDestino;

        // Si es 'all', el administrador manda y el JSON manda.
        if (ejecutor.TienePermiso("all"))
        {
            sucursalDestino = dto.SucursalId; // Aqu√≠ ya tomar√° el 3 del JSON
        }
        // Si NO es 'all' pero tiene l√≠mite, forzamos su sede.
        else if (ejecutor.TienePermiso("sucursal_limit"))
        {
            sucursalDestino = ejecutor.SucursalId;
        }
        // Caso por defecto (seguridad)
        else
        {
            sucursalDestino = dto.SucursalId;
        }

        string sql = @"INSERT INTO MOVIMIENTO_INVENTARIO 
                       (producto_id, usuario_id, sucursal_id, tipo_movimiento, cantidad, documento_referencia, notas) 
                       VALUES (@pid, @uid, @sid, @tipo, @cant, @ref, @not)";

        var p = new[] {
            new SqlParameter("@pid", dto.ProductoId),
            new SqlParameter("@uid", ejecutor.Id),
            new SqlParameter("@sid", sucursalDestino), // Usamos la variable calculada
            new SqlParameter("@tipo", dto.TipoMovimiento.ToUpper()),
            new SqlParameter("@cant", dto.Cantidad),
            new SqlParameter("@ref", (object?)dto.DocumentoReferencia ?? DBNull.Value),
            new SqlParameter("@not", (object?)dto.Notas ?? DBNull.Value)
        };

        try
        {
            ExecuteNonQuery(sql, p, false);
            return true;
        }
        catch (Exception)
        {
            throw;
        }
    }

    public DataTable ObtenerHistorial(UsuarioDTO ejecutor, int? productoId, DateTime? desde, DateTime? hasta)
    {
        if (!ejecutor.TienePermiso("inventario") && !ejecutor.TienePermiso("auditoria"))
            throw new UnauthorizedAccessException("No tiene permisos para consultar el historial.");

        // Aplicamos la misma jerarqu√≠a para la visualizaci√≥n
        int? sIdFiltro = null;
        if (!ejecutor.TienePermiso("all") && ejecutor.TienePermiso("sucursal_limit"))
        {
            sIdFiltro = ejecutor.SucursalId;
        }

        string sql = @"SELECT m.*, p.nombre as ProductoNombre, u.username as UsuarioNombre, s.nombre as SucursalNombre
                       FROM MOVIMIENTO_INVENTARIO m
                       INNER JOIN PRODUCTO p ON m.producto_id = p.id
                       INNER JOIN USUARIO u ON m.usuario_id = u.id
                       INNER JOIN SUCURSAL s ON m.sucursal_id = s.id
                       WHERE 1=1";

        var parametros = new List<SqlParameter>();

        if (productoId.HasValue)
        {
            sql += " AND m.producto_id = @pid";
            parametros.Add(new SqlParameter("@pid", productoId.Value));
        }

        if (sIdFiltro.HasValue)
        {
            sql += " AND m.sucursal_id = @sid";
            parametros.Add(new SqlParameter("@sid", sIdFiltro.Value));
        }

        if (desde.HasValue)
        {
            sql += " AND m.fecha >= @desde";
            parametros.Add(new SqlParameter("@desde", desde.Value));
        }

        if (hasta.HasValue)
        {
            sql += " AND m.fecha <= @hasta";
            parametros.Add(new SqlParameter("@hasta", hasta.Value.Date.AddDays(1).AddSeconds(-1)));
        }

        sql += " ORDER BY m.fecha DESC";

        return ExecuteQuery(sql, parametros.ToArray(), false);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\ProductoFactory.cs --- 
--- NOMBRE: ProductoFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DataAccess.Mappers;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;
using System.Collections.Generic;
using System;

namespace IntegraPro.DataAccess.Factory;

public class ProductoFactory(string connectionString) : MasterDao(connectionString)
{
    private readonly ProductoMapper _mapper = new();

    public List<ProductoDTO> GetAll(UsuarioDTO ejecutor)
    {
        ejecutor.ValidarAcceso("productos");

        string sql;
        List<SqlParameter> parameters = new();

        if (!ejecutor.TienePermiso("all") && ejecutor.TienePermiso("sucursal_limit"))
        {
            sql = @"SELECT p.*, ps.sucursal_id, s.nombre as sucursal_nombre, ps.existencia as existencia_local 
                FROM PRODUCTO p 
                INNER JOIN PRODUCTO_SUCURSAL ps ON p.id = ps.producto_id 
                INNER JOIN SUCURSAL s ON ps.sucursal_id = s.id
                WHERE p.activo = 1 AND ps.sucursal_id = @sucId";

            parameters.Add(new SqlParameter("@sucId", ejecutor.SucursalId));
        }
        else
        {
            sql = @"SELECT p.*, 
                           ps.sucursal_id, 
                           s.nombre as sucursal_nombre,
                           ps.existencia as existencia_local,
                           (SELECT SUM(existencia) FROM PRODUCTO_SUCURSAL WHERE producto_id = p.id) as existencia_total
                FROM PRODUCTO p
                LEFT JOIN PRODUCTO_SUCURSAL ps ON p.id = ps.producto_id
                LEFT JOIN SUCURSAL s ON ps.sucursal_id = s.id
                WHERE p.activo = 1";
        }

        var dt = ExecuteQuery(sql, parameters.Count > 0 ? parameters.ToArray() : null, false);
        var lista = new List<ProductoDTO>();

        foreach (DataRow row in dt.Rows)
        {
            var dto = _mapper.MapFromRow(row);

            if (row.Table.Columns.Contains("sucursal_nombre") && row["sucursal_nombre"] != DBNull.Value)
            {
                dto.Descripcion = $"[Sede: {row["sucursal_nombre"]}] " + (dto.Descripcion ?? "");
            }

            if (row.Table.Columns.Contains("existencia_total"))
            {
                dto.Existencia = row["existencia_total"] != DBNull.Value
                                 ? Convert.ToDecimal(row["existencia_total"])
                                 : 0m;
            }

            lista.Add(dto);
        }
        return lista;
    }

    public ProductoDTO? GetById(int id, UsuarioDTO ejecutor)
    {
        ejecutor.ValidarAcceso("productos");

        string sql = @"SELECT p.*, ps.sucursal_id, ps.existencia as existencia_local 
                       FROM PRODUCTO p 
                       LEFT JOIN PRODUCTO_SUCURSAL ps ON p.id = ps.producto_id";

        List<SqlParameter> parameters = [new SqlParameter("@id", id)];

        if (!ejecutor.TienePermiso("all") && ejecutor.TienePermiso("sucursal_limit"))
        {
            sql += " WHERE p.id = @id AND ps.sucursal_id = @sucId";
            parameters.Add(new SqlParameter("@sucId", ejecutor.SucursalId));
        }
        else
        {
            sql += " WHERE p.id = @id";
        }

        var dt = ExecuteQuery(sql, parameters.ToArray(), false);
        return dt.Rows.Count > 0 ? _mapper.MapFromRow(dt.Rows[0]) : null;
    }

    public int Create(ProductoDTO producto, UsuarioDTO ejecutor)
    {
        ejecutor.ValidarAcceso("productos");
        ejecutor.ValidarEscritura();

        if (!ejecutor.TienePermiso("all") && ejecutor.TienePermiso("sucursal_limit"))
            producto.SucursalId = ejecutor.SucursalId;

        object result = ExecuteScalar("sp_Producto_Insert", _mapper.MapToParameters(producto).ToArray(), true);
        return Convert.ToInt32(result);
    }

    public void Update(ProductoDTO producto, UsuarioDTO ejecutor)
    {
        ejecutor.ValidarAcceso("productos");
        ejecutor.ValidarEscritura();

        if (!ejecutor.TienePermiso("all") && ejecutor.TienePermiso("sucursal_limit"))
        {
            var prodActual = GetById(producto.Id, ejecutor);
            if (prodActual == null)
                throw new UnauthorizedAccessException("No tiene permisos para modificar este producto en su sucursal.");

            producto.SucursalId = ejecutor.SucursalId;
        }

        ExecuteNonQuery("sp_Producto_Update", _mapper.MapToParameters(producto).ToArray(), true);
    }

    public List<ProductoDTO> GetStockAlerts(UsuarioDTO ejecutor)
    {
        ejecutor.ValidarAcceso("productos");

        // Cambiamos p.id, p.nombre por p.* para que el Mapper no falle por columnas faltantes
        string sql = @"SELECT p.*, ps.existencia as existencia_local, ps.sucursal_id 
                       FROM PRODUCTO p 
                       INNER JOIN PRODUCTO_SUCURSAL ps ON p.id = ps.producto_id 
                       WHERE ps.existencia <= p.stock_minimo 
                       AND p.activo = 1 AND p.es_servicio = 0";

        List<SqlParameter> parameters = new();

        if (!ejecutor.TienePermiso("all") && ejecutor.TienePermiso("sucursal_limit"))
        {
            sql += " AND ps.sucursal_id = @sucId";
            parameters.Add(new SqlParameter("@sucId", ejecutor.SucursalId));
        }

        var dt = ExecuteQuery(sql, parameters.Count > 0 ? parameters.ToArray() : null, false);
        var lista = new List<ProductoDTO>();
        foreach (DataRow row in dt.Rows)
        {
            // Ahora el mapper recibir√° todas las columnas y no dar√° error de DBNull
            lista.Add(_mapper.MapFromRow(row));
        }
        return lista;
    }

    public void InsertarComposicion(int padreId, int materialId, decimal cantidad, UsuarioDTO ejecutor)
    {
        ejecutor.ValidarAcceso("productos");
        ejecutor.ValidarEscritura();
        var parameters = new[] {
            new SqlParameter("@producto_padre_id", padreId),
            new SqlParameter("@material_id", materialId),
            new SqlParameter("@cantidad_necesaria", cantidad)
        };
        ExecuteNonQuery("INSERT INTO PRODUCTO_COMPOSICION (producto_padre_id, material_id, cantidad_necesaria) VALUES (@producto_padre_id, @material_id, @cantidad_necesaria)", parameters, false);
    }

    public List<ProductoComposicionDTO> ObtenerComposicion(int padreId)
    {
        var parameters = new[] { new SqlParameter("@id", padreId) };
        var dt = ExecuteQuery("SELECT material_id, cantidad_necesaria FROM PRODUCTO_COMPOSICION WHERE producto_padre_id = @id", parameters, false);
        var lista = new List<ProductoComposicionDTO>();
        foreach (DataRow row in dt.Rows)
        {
            lista.Add(new ProductoComposicionDTO
            {
                MaterialId = Convert.ToInt32(row["material_id"]),
                CantidadNecesaria = Convert.ToDecimal(row["cantidad_necesaria"])
            });
        }
        return lista;
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\ProformaFactory.cs --- 
--- NOMBRE: ProformaFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System;
using System.Collections.Generic;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class ProformaFactory(string connectionString) : MasterDao(connectionString)
{
    private readonly string _connectionString = connectionString;

    public int CrearProforma(ProformaEncabezadoDTO p, UsuarioDTO ejecutor)
    {
        ejecutor.ValidarAcceso("proformas");
        ejecutor.ValidarEscritura();

        if (!ejecutor.TienePermiso("all") && ejecutor.TienePermiso("sucursal_limit"))
        {
            p.SucursalId = ejecutor.SucursalId;
        }

        var configFact = new ConfiguracionFactory(_connectionString);
        var empresa = configFact.ObtenerEmpresa(ejecutor);
        bool esTradicional = empresa?.TipoRegimen?.Equals("Tradicional", StringComparison.OrdinalIgnoreCase) ?? true;

        decimal totalNetoAcumulado = 0;
        decimal totalIVAAcumulado = 0;

        foreach (var det in p.Detalles)
        {
            string sqlValidar = "SELECT costo_actual, porcentaje_impuesto FROM PRODUCTO WHERE id = @prodid";
            var dt = ExecuteQuery(sqlValidar, new[] { new SqlParameter("@prodid", det.ProductoId) }, false);

            if (dt == null || dt.Rows.Count == 0)
                throw new Exception($"El producto con ID {det.ProductoId} no existe.");

            DataRow row = dt.Rows[0];
            decimal precioVigente = Convert.ToDecimal(row["costo_actual"]);
            decimal pctIVA = Convert.ToDecimal(row["porcentaje_impuesto"]);

            decimal subtotalLinea = precioVigente * det.Cantidad;
            decimal impuestoLinea = esTradicional ? (subtotalLinea * (pctIVA / 100)) : 0;

            det.PrecioUnitario = precioVigente;
            det.PorcentajeImpuesto = esTradicional ? pctIVA : 0;
            det.ImpuestoTotal = impuestoLinea;
            det.TotalLineas = subtotalLinea + impuestoLinea;

            totalNetoAcumulado += subtotalLinea;
            totalIVAAcumulado += impuestoLinea;
        }

        string sqlEnc = @"INSERT INTO PROFORMA_ENCABEZADO 
                          (cliente_id, sucursal_id, fecha, fecha_vencimiento, total_neto, total_impuesto, total, estado)
                          VALUES (@cid, @sid, GETDATE(), @fvenc, @tneto, @tiva, @total, 'Pendiente');
                          SELECT CAST(SCOPE_IDENTITY() AS INT);";

        var parametrosEnc = new[] {
            new SqlParameter("@cid", p.ClienteId == 0 ? DBNull.Value : p.ClienteId),
            new SqlParameter("@sid", p.SucursalId),
            new SqlParameter("@fvenc", p.FechaVencimiento == DateTime.MinValue ? DateTime.Now.AddDays(30) : p.FechaVencimiento),
            new SqlParameter("@tneto", totalNetoAcumulado),
            new SqlParameter("@tiva", totalIVAAcumulado),
            new SqlParameter("@total", totalNetoAcumulado + totalIVAAcumulado)
        };

        int idGenerado = (int)ExecuteScalar(sqlEnc, parametrosEnc, false);

        foreach (var det in p.Detalles)
        {
            string sqlDet = @"INSERT INTO PROFORMA_DETALLE 
                              (proforma_id, producto_id, cantidad, precio_unitario, porcentaje_impuesto, monto_impuesto, total_linea)
                              VALUES (@pid, @prodid, @cant, @pre, @pct, @montoIva, @total)";

            ExecuteNonQuery(sqlDet, new[] {
                new SqlParameter("@pid", idGenerado),
                new SqlParameter("@prodid", det.ProductoId),
                new SqlParameter("@cant", det.Cantidad),
                new SqlParameter("@pre", det.PrecioUnitario),
                new SqlParameter("@pct", det.PorcentajeImpuesto),
                new SqlParameter("@montoIva", det.ImpuestoTotal),
                new SqlParameter("@total", det.TotalLineas)
            }, false);
        }

        return idGenerado;
    }

    public string ConvertirAFactura(int proformaId, string medioPago, UsuarioDTO ejecutor)
    {
        ejecutor.ValidarAcceso("ventas");
        ejecutor.ValidarEscritura();

        string sql = @"
        BEGIN TRANSACTION;
        BEGIN TRY
            DECLARE @clienteId INT, @sucursalId INT, @totalNeto DECIMAL(18,2), @totalImpuesto DECIMAL(18,2), 
                    @totalComprobante DECIMAL(18,2), @facturaId INT, @estadoActual NVARCHAR(20),
                    @permitirNegativo BIT, @stockActual DECIMAL(18,2), @prodNombreErr NVARCHAR(200);

            DECLARE @consecutivo NVARCHAR(50) = 'FAC-' + CAST(NEXT VALUE FOR Seq_Consecutivos AS NVARCHAR(20));

            -- 1. Obtener datos de la proforma para identificar la sucursal de ORIGEN
            SELECT @clienteId = cliente_id, @sucursalId = sucursal_id, @totalNeto = total_neto, 
                   @totalImpuesto = total_impuesto, @totalComprobante = total, @estadoActual = estado 
            FROM PROFORMA_ENCABEZADO WHERE id = @profId;

            SELECT TOP 1 @permitirNegativo = permitir_stock_negativo FROM EMPRESA;

            IF @clienteId IS NULL THROW 50000, 'La proforma no existe.', 1;
            IF @estadoActual <> 'Pendiente' THROW 50002, 'Solo se pueden facturar proformas Pendientes.', 1;
            
            -- Validaci√≥n de seguridad por sucursal si el usuario tiene limites
            IF @esAdmin = 0 AND @sucursalLimit = 1 AND @sucursalId <> @userSucId 
                THROW 50003, 'Acceso denegado: Proforma de otra sucursal.', 1;

            -- 2. VALIDACI√ìN DE STOCK REAL EN LA SUCURSAL DE LA PROFORMA
            IF ISNULL(@permitirNegativo, 0) = 0
            BEGIN
                -- Buscamos el primer producto que no tenga stock en la SUCURSAL DE LA PROFORMA (@sucursalId)
                SELECT TOP 1 @prodNombreErr = p.nombre, @stockActual = ISNULL(ps.existencia, 0)
                FROM PROFORMA_DETALLE d
                INNER JOIN PRODUCTO p ON d.producto_id = p.id
                LEFT JOIN PRODUCTO_SUCURSAL ps ON d.producto_id = ps.producto_id AND ps.sucursal_id = @sucursalId
                WHERE d.proforma_id = @profId AND ISNULL(ps.existencia, 0) < d.cantidad;

                IF @prodNombreErr IS NOT NULL
                BEGIN
                    DECLARE @msg NVARCHAR(300) = 'Stock insuficiente de ' + @prodNombreErr + ' en Sucursal ' + CAST(@sucursalId AS NVARCHAR) + '. Disponible: ' + CAST(@stockActual AS NVARCHAR);
                    THROW 50005, @msg, 1;
                END
            END

            -- 3. Crear el encabezado de factura heredando la sucursal de la proforma
            INSERT INTO FACTURA_ENCABEZADO (cliente_id, sucursal_id, usuario_id, consecutivo, clave_numerica, 
                                          total_neto, total_descuento, total_impuesto, total_comprobante, medio_pago, 
                                          estado_hacienda, condicion_venta, fecha)
            VALUES (@clienteId, @sucursalId, @usuarioId, @consecutivo, '00000', 
                    @totalNeto, 0, @totalImpuesto, @totalComprobante, @medioPago, 'Pendiente', 'Contado', GETDATE());
            
            SET @facturaId = SCOPE_IDENTITY();

            -- 4. Copiar detalles
            INSERT INTO FACTURA_DETALLE (factura_id, producto_id, cantidad, precio_unitario, porcentaje_descuento, monto_descuento, monto_impuesto, total_linea)
            SELECT @facturaId, d.producto_id, d.cantidad, d.precio_unitario, 0, 0, d.monto_impuesto, d.total_linea
            FROM PROFORMA_DETALLE d WHERE d.proforma_id = @profId;

            -- 5. Generar movimientos de inventario en la SUCURSAL DE LA PROFORMA
            INSERT INTO MOVIMIENTO_INVENTARIO (producto_id, usuario_id, sucursal_id, fecha, tipo_movimiento, cantidad, documento_referencia, notas)
            SELECT d.producto_id, @usuarioId, @sucursalId, GETDATE(), 'SALIDA', d.cantidad, @consecutivo, 'Fact. desde Proforma #' + CAST(@profId AS NVARCHAR(10))
            FROM PROFORMA_DETALLE d WHERE d.proforma_id = @profId;

            -- 6. Marcar proforma como procesada
            UPDATE PROFORMA_ENCABEZADO SET estado = 'Facturada' WHERE id = @profId;

            COMMIT TRANSACTION;
            SELECT @consecutivo;
        END TRY
        BEGIN CATCH
            IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
            THROW;
        END CATCH";

        var parametros = new[] {
            new SqlParameter("@profId", proformaId),
            new SqlParameter("@usuarioId", ejecutor.Id),
            new SqlParameter("@userSucId", ejecutor.SucursalId),
            new SqlParameter("@sucursalLimit", ejecutor.TienePermiso("sucursal_limit") ? 1 : 0),
            new SqlParameter("@esAdmin", ejecutor.TienePermiso("all") ? 1 : 0),
            new SqlParameter("@medioPago", medioPago)
        };

        object result = ExecuteScalar(sql, parametros, false);
        return result?.ToString() ?? string.Empty;
    }

    public void AnularProforma(int id, UsuarioDTO ejecutor)
    {
        ejecutor.ValidarAcceso("proformas");
        ejecutor.ValidarEscritura();

        string sql = "UPDATE PROFORMA_ENCABEZADO SET estado = 'Anulada' WHERE id = @id AND estado = 'Pendiente'";
        var pars = new List<SqlParameter> { new SqlParameter("@id", id) };

        if (!ejecutor.TienePermiso("all") && ejecutor.TienePermiso("sucursal_limit"))
        {
            sql += " AND sucursal_id = @sid";
            pars.Add(new SqlParameter("@sid", ejecutor.SucursalId));
        }

        int filas = ExecuteNonQuery(sql, pars.ToArray(), false);
        if (filas == 0)
            throw new Exception("No se pudo anular la proforma.");
    }

    public List<ProformaEncabezadoDTO> ListarProformas(string filtro, UsuarioDTO ejecutor)
    {
        ejecutor.ValidarAcceso("proformas");

        string sql = @"SELECT P.*, ISNULL(C.nombre, 'CLIENTE CONTADO') as ClienteNombre, 
                       C.identificacion as ClienteIdentificacion 
                       FROM PROFORMA_ENCABEZADO P
                       LEFT JOIN CLIENTE C ON P.cliente_id = C.id
                       WHERE 1=1";

        var pars = new List<SqlParameter>();

        if (!string.IsNullOrEmpty(filtro))
        {
            sql += " AND (C.nombre LIKE @f OR P.estado LIKE @f OR CAST(P.id AS NVARCHAR) LIKE @f)";
            pars.Add(new SqlParameter("@f", $"%{filtro}%"));
        }

        if (!ejecutor.TienePermiso("all") && ejecutor.TienePermiso("sucursal_limit"))
        {
            sql += " AND P.sucursal_id = @sid";
            pars.Add(new SqlParameter("@sid", ejecutor.SucursalId));
        }

        sql += " ORDER BY P.id DESC";

        var dt = ExecuteQuery(sql, pars.ToArray(), false);
        var lista = new List<ProformaEncabezadoDTO>();
        foreach (DataRow r in dt.Rows) lista.Add(MapearEncabezado(r));
        return lista;
    }

    public ProformaEncabezadoDTO? ObtenerPorId(int id, UsuarioDTO ejecutor)
    {
        ejecutor.ValidarAcceso("proformas");

        string sql = @"SELECT P.*, ISNULL(C.nombre, 'CLIENTE CONTADO') as ClienteNombre,
                       C.identificacion as ClienteIdentificacion 
                       FROM PROFORMA_ENCABEZADO P
                       LEFT JOIN CLIENTE C ON P.cliente_id = C.id
                       WHERE P.id = @id";

        if (!ejecutor.TienePermiso("all") && ejecutor.TienePermiso("sucursal_limit"))
            sql += " AND P.sucursal_id = " + ejecutor.SucursalId;

        var dt = ExecuteQuery(sql, new[] { new SqlParameter("@id", id) }, false);
        if (dt.Rows.Count == 0) return null;

        var proforma = MapearEncabezado(dt.Rows[0]);
        proforma.Detalles = ObtenerDetallesProforma(id);
        return proforma;
    }

    private List<ProformaDetalleDTO> ObtenerDetallesProforma(int proformaId)
    {
        var lista = new List<ProformaDetalleDTO>();
        string sql = @"SELECT D.*, P.nombre as ProductoNombre, P.codigo_barras as ProductoCodigo 
                       FROM PROFORMA_DETALLE D 
                       JOIN PRODUCTO P ON D.producto_id = P.id 
                       WHERE D.proforma_id = @id";

        var dt = ExecuteQuery(sql, new[] { new SqlParameter("@id", proformaId) }, false);
        foreach (DataRow r in dt.Rows)
        {
            lista.Add(new ProformaDetalleDTO
            {
                ProductoId = (int)r["producto_id"],
                ProductoCodigo = r["ProductoCodigo"].ToString(),
                ProductoNombre = r["ProductoNombre"].ToString(),
                Cantidad = (decimal)r["cantidad"],
                PrecioUnitario = (decimal)r["precio_unitario"],
                PorcentajeImpuesto = (decimal)r["porcentaje_impuesto"],
                ImpuestoTotal = (decimal)r["monto_impuesto"],
                TotalLineas = (decimal)r["total_linea"]
            });
        }
        return lista;
    }

    private ProformaEncabezadoDTO MapearEncabezado(DataRow r)
    {
        return new ProformaEncabezadoDTO
        {
            Id = Convert.ToInt32(r["id"]),
            ClienteId = r["cliente_id"] == DBNull.Value ? 0 : Convert.ToInt32(r["cliente_id"]),
            ClienteNombre = r["ClienteNombre"].ToString(),
            ClienteIdentificacion = r.Table.Columns.Contains("ClienteIdentificacion") ? r["ClienteIdentificacion"].ToString() : "",
            SucursalId = Convert.ToInt32(r["sucursal_id"]),
            TotalNeto = Convert.ToDecimal(r["total_neto"]),
            TotalImpuesto = Convert.ToDecimal(r["total_impuesto"]),
            Total = Convert.ToDecimal(r["total"]),
            Fecha = Convert.ToDateTime(r["fecha"]),
            FechaVencimiento = Convert.ToDateTime(r["fecha_vencimiento"]),
            Estado = r["estado"].ToString()
        };
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\ProveedorFactory.cs --- 
--- NOMBRE: ProveedorFactory.cs --- 
 
Ôªøusing Microsoft.Data.SqlClient;
using IntegraPro.DTO.Models;
using System.Data;
using IntegraPro.DataAccess.Dao;
using System;
using System.Collections.Generic;

namespace IntegraPro.DataAccess.Factory;

public class ProveedorFactory(string connectionString) : MasterDao(connectionString)
{
    public List<ProveedorDTO> ObtenerTodos(UsuarioDTO ejecutor)
    {
        // SEGURIDAD: Validaci√≥n directa usando el DTO para evitar dependencia de AppLogic
        if (!ejecutor.TienePermiso("proveedores"))
        {
            throw new UnauthorizedAccessException("No tiene permisos para acceder al m√≥dulo de proveedores.");
        }

        // Los proveedores suelen ser globales, no filtramos por sucursal_id
        string sql = "SELECT * FROM PROVEEDOR WHERE activo = 1";

        var dt = ExecuteQuery(sql, null, false);
        var lista = new List<ProveedorDTO>();

        foreach (DataRow row in dt.Rows)
        {
            lista.Add(MapearProveedor(row));
        }
        return lista;
    }

    public void Crear(ProveedorDTO proveedor, UsuarioDTO ejecutor)
    {
        // SEGURIDAD: Validaci√≥n de acceso y escritura
        if (!ejecutor.TienePermiso("proveedores"))
            throw new UnauthorizedAccessException("No tiene permisos para el m√≥dulo de proveedores.");

        if (ejecutor.TienePermiso("solo_lectura"))
            throw new UnauthorizedAccessException("Su cuenta es de solo lectura. No puede realizar esta acci√≥n.");

        // TRAZABILIDAD: Guardamos qui√©n lo cre√≥ 
        string sql = @"INSERT INTO PROVEEDOR (identificacion, nombre, correo, telefono, creado_por, activo) 
                       VALUES (@ide, @nom, @cor, @tel, @usr, 1)";

        SqlParameter[] parameters = {
            new SqlParameter("@ide", proveedor.Identificacion),
            new SqlParameter("@nom", proveedor.Nombre),
            new SqlParameter("@cor", (object?)proveedor.Correo ?? DBNull.Value),
            new SqlParameter("@tel", (object?)proveedor.Telefono ?? DBNull.Value),
            new SqlParameter("@usr", ejecutor.Id) // ID del usuario que registra
        };

        ExecuteNonQuery(sql, parameters, false);
    }

    public void Actualizar(ProveedorDTO proveedor, UsuarioDTO ejecutor)
    {
        // SEGURIDAD
        if (!ejecutor.TienePermiso("proveedores"))
            throw new UnauthorizedAccessException("No tiene permisos para el m√≥dulo de proveedores.");

        if (ejecutor.TienePermiso("solo_lectura"))
            throw new UnauthorizedAccessException("Su cuenta es de solo lectura.");

        string sql = @"UPDATE PROVEEDOR 
                       SET identificacion = @ide, nombre = @nom, correo = @cor, telefono = @tel 
                       WHERE id = @id";

        SqlParameter[] parameters = {
            new SqlParameter("@id", proveedor.Id),
            new SqlParameter("@ide", proveedor.Identificacion),
            new SqlParameter("@nom", proveedor.Nombre),
            new SqlParameter("@cor", (object?)proveedor.Correo ?? DBNull.Value),
            new SqlParameter("@tel", (object?)proveedor.Telefono ?? DBNull.Value)
        };

        int filasAfectadas = ExecuteNonQuery(sql, parameters, false);

        if (filasAfectadas == 0)
            throw new Exception("No se encontr√≥ el proveedor para actualizar.");
    }

    public void Eliminar(int id, UsuarioDTO ejecutor)
    {
        // SEGURIDAD
        if (!ejecutor.TienePermiso("proveedores"))
            throw new UnauthorizedAccessException("No tiene permisos para el m√≥dulo de proveedores.");

        if (ejecutor.TienePermiso("solo_lectura"))
            throw new UnauthorizedAccessException("Su cuenta es de solo lectura.");

        // Borrado l√≥gico
        string sql = "UPDATE PROVEEDOR SET activo = 0 WHERE id = @id";
        ExecuteNonQuery(sql, [new SqlParameter("@id", id)], false);
    }

    private ProveedorDTO MapearProveedor(DataRow row)
    {
        return new ProveedorDTO
        {
            Id = (int)row["id"],
            Identificacion = row["identificacion"].ToString() ?? string.Empty,
            Nombre = row["nombre"].ToString() ?? string.Empty,
            Correo = row["correo"]?.ToString(),
            Telefono = row["telefono"]?.ToString(),
            Activo = row["activo"] != DBNull.Value && Convert.ToBoolean(row["activo"])
        };
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\UsuarioFactory.cs --- 
--- NOMBRE: UsuarioFactory.cs --- 
 
Ôªøusing System;
using System.Collections.Generic;
using System.Data;
using IntegraPro.DataAccess.Dao;
using IntegraPro.DataAccess.Mappers;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Factory;

public class UsuarioFactory : MasterDao
{
    private readonly UsuarioMapper _mapper;

    public UsuarioFactory(string connectionString) : base(connectionString)
    {
        _mapper = new UsuarioMapper();
    }

    /// <summary>
    /// Obtiene un usuario y sus permisos. Punto de entrada para Auth.
    /// Exento de validaci√≥n de ejecutor.
    /// </summary>
    public UsuarioDTO? GetByUsername(string username)
    {
        var parameters = new SqlParameter[] {
            new SqlParameter("@username", username)
        };

        // sp_Usuario_GetByUsername retorna: id, rol_id, sucursal_id, nombre_completo, 
        // username, password_hash, correo_electronico, activo, nombre_rol, permisos_json
        var table = ExecuteQuery("sp_Usuario_GetByUsername", parameters);

        if (table == null || table.Rows.Count == 0) return null;

        return _mapper.MapFromRow(table.Rows[0]);
    }

    /// <summary>
    /// Crea un usuario validando permisos y jurisdicci√≥n de sucursal.
    /// </summary>
    public void Create(UsuarioDTO nuevoUsuario, UsuarioDTO ejecutor)
    {
        // SEGURIDAD: Validaci√≥n directa usando el DTO
        if (!ejecutor.TienePermiso("usuarios"))
            throw new UnauthorizedAccessException("No tiene permisos para gestionar usuarios.");

        if (ejecutor.TienePermiso("solo_lectura"))
            throw new UnauthorizedAccessException("Su cuenta est√° en modo solo lectura.");

        // L√≥gica de Jurisdicci√≥n: Si el admin est√° limitado a su sucursal
        if (ejecutor.TienePermiso("sucursal_limit"))
        {
            nuevoUsuario.SucursalId = ejecutor.SucursalId;

            // Bloqueo de jerarqu√≠a: No puede crear Admins Globales (Rol 1)
            if (nuevoUsuario.RolId == 1)
                throw new UnauthorizedAccessException("No tiene autoridad para asignar el rol de Administrador Global.");
        }

        var parameters = new SqlParameter[] {
            new SqlParameter("@rol_id", nuevoUsuario.RolId),
            new SqlParameter("@sucursal_id", nuevoUsuario.SucursalId),
            new SqlParameter("@nombre_completo", nuevoUsuario.NombreCompleto),
            new SqlParameter("@username", nuevoUsuario.Username),
            new SqlParameter("@password_hash", nuevoUsuario.PasswordHash),
            new SqlParameter("@correo_electronico", (object?)nuevoUsuario.CorreoElectronico ?? DBNull.Value),
            new SqlParameter("@activo", nuevoUsuario.Activo)
        };

        ExecuteStoredProcedure("sp_Usuario_Insert", parameters);
    }

    /// <summary>
    /// Lista usuarios filtrando por sucursal autom√°ticamente seg√∫n el perfil del ejecutor.
    /// </summary>
    public List<UsuarioDTO> GetAll(UsuarioDTO ejecutor)
    {
        // SEGURIDAD: Solo usuarios autorizados listan usuarios
        if (!ejecutor.TienePermiso("usuarios"))
            return new List<UsuarioDTO>();

        bool limitarSucursal = ejecutor.TienePermiso("sucursal_limit");

        string sql = @"SELECT u.*, r.nombre_rol, r.permisos_json 
                       FROM USUARIO u 
                       INNER JOIN ROL r ON u.rol_id = r.id
                       WHERE 1=1";

        List<SqlParameter> parameters = new List<SqlParameter>();

        if (limitarSucursal)
        {
            sql += " AND u.sucursal_id = @sucursalId";
            parameters.Add(new SqlParameter("@sucursalId", ejecutor.SucursalId));
        }

        var table = ExecuteQuery(sql, parameters.ToArray(), false);
        var lista = new List<UsuarioDTO>();

        if (table != null)
        {
            foreach (DataRow row in table.Rows)
            {
                lista.Add(_mapper.MapFromRow(row));
            }
        }

        return lista;
    }

    /// <summary>
    /// Actualiza el rol verificando jurisdicci√≥n de sucursal.
    /// </summary>
    public void ActualizarRol(int usuarioId, int nuevoRolId, UsuarioDTO ejecutor)
    {
        if (!ejecutor.TienePermiso("usuarios") || ejecutor.TienePermiso("solo_lectura"))
            throw new UnauthorizedAccessException("Permisos insuficientes para modificar roles.");

        // Bloqueo de escalada de privilegios
        if (ejecutor.TienePermiso("sucursal_limit") && nuevoRolId == 1)
            throw new UnauthorizedAccessException("No puede asignar administraci√≥n global desde una cuenta limitada por sucursal.");

        string sql = "UPDATE USUARIO SET rol_id = @rolId WHERE id = @id";
        var parameters = new List<SqlParameter> {
            new SqlParameter("@id", usuarioId),
            new SqlParameter("@rolId", nuevoRolId)
        };

        // Forzamos que solo pueda editar usuarios de SU sucursal si tiene el l√≠mite
        if (ejecutor.TienePermiso("sucursal_limit"))
        {
            sql += " AND sucursal_id = @sid";
            parameters.Add(new SqlParameter("@sid", ejecutor.SucursalId));
        }

        int filas = ExecuteNonQuery(sql, parameters.ToArray(), false);

        if (filas == 0)
            throw new Exception("No se pudo actualizar: El usuario no existe o no pertenece a su sucursal.");
    }

    public List<RolDTO> GetRoles(UsuarioDTO ejecutor)
    {
        if (!ejecutor.TienePermiso("usuarios")) return new List<RolDTO>();

        string sql = "SELECT id, nombre_rol, permisos_json FROM ROL";

        // Un admin de sucursal no debe ver ni asignar el rol de Admin Global (ID 1)
        if (ejecutor.TienePermiso("sucursal_limit"))
            sql += " WHERE id > 1";

        var table = ExecuteQuery(sql, [], false);
        var lista = new List<RolDTO>();

        if (table != null)
        {
            foreach (DataRow row in table.Rows)
            {
                lista.Add(new RolDTO
                {
                    Id = Convert.ToInt32(row["id"]),
                    NombreRol = row["nombre_rol"].ToString() ?? "",
                    PermisosJson = row["permisos_json"].ToString() ?? "{}"
                });
            }
        }
        return lista;
    }

    public void ActualizarSesionHardware(int usuarioId, string? hardwareId)
    {
        var parameters = new SqlParameter[] {
            new SqlParameter("@id", usuarioId),
            new SqlParameter("@hardware_id_sesion", (object?)hardwareId ?? DBNull.Value)
        };
        ExecuteNonQuery("sp_Usuario_ActualizarSesion", parameters);
    }

    public void RegistrarLogin(int usuarioId)
    {
        var parameters = new SqlParameter[] {
            new SqlParameter("@id", usuarioId)
        };
        ExecuteNonQuery("sp_Usuario_RegistrarLogin", parameters);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\VentaFactory.cs --- 
--- NOMBRE: VentaFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class VentaFactory(string connectionString) : MasterDao(connectionString)
{
    public string CrearFactura(FacturaDTO venta, UsuarioDTO ejecutor)
    {
        // Seguridad: Forzar sucursal seg√∫n permisos del ejecutor (Si no es Admin Total)
        if (ejecutor.TienePermiso("sucursal_limit") && !ejecutor.TienePermiso("all"))
            venta.SucursalId = ejecutor.SucursalId;

        using (var connection = new SqlConnection(connectionString))
        {
            connection.Open();
            using (var transaction = connection.BeginTransaction())
            {
                try
                {
                    // 0. VALIDACI√ìN DE CONFIGURACI√ìN (STOCK NEGATIVO)
                    bool permitirNegativo = false;
                    using (var cmdEmp = new SqlCommand("SELECT TOP 1 permitir_stock_negativo FROM EMPRESA", connection, transaction))
                    {
                        var resultEmp = cmdEmp.ExecuteScalar();
                        permitirNegativo = resultEmp != null && Convert.ToBoolean(resultEmp);
                    }

                    decimal acumuladoNeto = 0;
                    decimal acumuladoImpuesto = 0;
                    var detallesProcesados = new List<FacturaDetalleDTO>();

                    // 1. PROCESAR Y CALCULAR CADA L√çNEA DESDE LA DB (Seguridad de Precios)
                    foreach (var item in venta.Detalles)
                    {
                        using (var cmdProd = new SqlCommand("SELECT nombre, costo_actual, porcentaje_impuesto, existencia FROM PRODUCTO WHERE id = @pid", connection, transaction))
                        {
                            cmdProd.Parameters.AddWithValue("@pid", item.ProductoId);
                            using (var reader = cmdProd.ExecuteReader())
                            {
                                if (!reader.Read())
                                    throw new Exception($"El producto con ID {item.ProductoId} no existe.");

                                decimal stockActual = reader.GetDecimal(reader.GetOrdinal("existencia"));
                                decimal precioReal = reader.GetDecimal(reader.GetOrdinal("costo_actual"));
                                decimal porcentajeIvaReal = reader.GetDecimal(reader.GetOrdinal("porcentaje_impuesto"));
                                string nombreProd = reader.GetString(reader.GetOrdinal("nombre"));

                                // VALIDACI√ìN DE STOCK REAL-TIME
                                if (!permitirNegativo && stockActual < item.Cantidad)
                                {
                                    throw new Exception($"Stock insuficiente para '{nombreProd}'. Disponible: {stockActual}, Solicitado: {item.Cantidad}");
                                }

                                decimal montoNetoLinea = item.Cantidad * precioReal;
                                decimal montoIvaLinea = montoNetoLinea * (porcentajeIvaReal / 100);
                                decimal totalLinea = montoNetoLinea + montoIvaLinea;

                                detallesProcesados.Add(new FacturaDetalleDTO
                                {
                                    ProductoId = item.ProductoId,
                                    Cantidad = item.Cantidad,
                                    PrecioUnitario = precioReal,
                                    PorcentajeImpuesto = porcentajeIvaReal,
                                    MontoImpuesto = montoIvaLinea,
                                    TotalLinea = totalLinea
                                });

                                acumuladoNeto += montoNetoLinea;
                                acumuladoImpuesto += montoIvaLinea;
                            }
                        }
                    }

                    // FACTURACI√ìN ELECTR√ìNICA (HACIENDA)
                    string consecutivoHacienda = venta.Consecutivo;
                    string claveNumerica = venta.ClaveNumerica;

                    if (string.IsNullOrEmpty(claveNumerica))
                    {
                        string cedulaEmisor = "3101123456".PadLeft(12, '0');
                        string terminal = "00001";
                        string numeroDoc = DateTime.Now.Ticks.ToString().Substring(10).PadLeft(10, '0');
                        consecutivoHacienda = "001" + terminal + "01" + numeroDoc;
                        claveNumerica = GenerarClaveHacienda(cedulaEmisor, consecutivoHacienda);
                    }

                    string estadoFinalHacienda = venta.EstadoHacienda ?? "LOCAL";

                    // 2. INSERTAR ENCABEZADO
                    string sqlEnc = @"INSERT INTO FACTURA_ENCABEZADO 
                                      (cliente_id, sucursal_id, usuario_id, consecutivo, clave_numerica, fecha, 
                                       condicion_venta, medio_pago, total_neto, total_impuesto, total_comprobante, 
                                       estado_hacienda, es_offline) 
                                      VALUES (@cid, @sid, @uid, @cons, @clave, GETDATE(), 
                                              @cond, @medio, @neto, @iva, @total, @estado, @offline);
                                      SELECT CAST(SCOPE_IDENTITY() as int);";

                    var pEnc = new[] {
                        new SqlParameter("@cid", (venta.ClienteId == 0 ? DBNull.Value : venta.ClienteId)),
                        new SqlParameter("@sid", venta.SucursalId),
                        new SqlParameter("@uid", ejecutor.Id),
                        new SqlParameter("@cons", consecutivoHacienda),
                        new SqlParameter("@clave", claveNumerica),
                        new SqlParameter("@cond", venta.CondicionVenta ?? "Contado"),
                        new SqlParameter("@medio", venta.MedioPago ?? "Efectivo"),
                        new SqlParameter("@neto", acumuladoNeto),
                        new SqlParameter("@iva", acumuladoImpuesto),
                        new SqlParameter("@total", acumuladoNeto + acumuladoImpuesto),
                        new SqlParameter("@estado", estadoFinalHacienda),
                        new SqlParameter("@offline", venta.EsOffline ? 1 : 0)
                    };

                    int facturaId = Convert.ToInt32(ExecuteScalarInTransaction(sqlEnc, pEnc, connection, transaction));

                    // 3. INSERTAR DETALLES, ACTUALIZAR STOCK Y KARDEX
                    foreach (var det in detallesProcesados)
                    {
                        string sqlDet = @"INSERT INTO FACTURA_DETALLE 
                                          (factura_id, producto_id, cantidad, precio_unitario, monto_impuesto, total_linea, porcentaje_impuesto) 
                                          VALUES (@fid, @pid, @cant, @pre, @miva, @tot, @piva)";

                        ExecuteNonQueryInTransaction(sqlDet, [
                            new SqlParameter("@fid", facturaId),
                            new SqlParameter("@pid", det.ProductoId),
                            new SqlParameter("@cant", det.Cantidad),
                            new SqlParameter("@pre", det.PrecioUnitario),
                            new SqlParameter("@miva", det.MontoImpuesto),
                            new SqlParameter("@tot", det.TotalLinea),
                            new SqlParameter("@piva", det.PorcentajeImpuesto)
                        ], connection, transaction);

                        // ACTUALIZACI√ìN DE EXISTENCIAS (STOCK)
                        string sqlUpdateStock = "UPDATE PRODUCTO SET existencia = existencia - @cant WHERE id = @pid";
                        ExecuteNonQueryInTransaction(sqlUpdateStock, [
                            new SqlParameter("@cant", det.Cantidad),
                            new SqlParameter("@pid", det.ProductoId)
                        ], connection, transaction);

                        // REGISTRO EN KARDEX
                        string sqlKardex = @"INSERT INTO MOVIMIENTO_INVENTARIO 
                                            (producto_id, usuario_id, sucursal_id, fecha, tipo_movimiento, cantidad, documento_referencia, notas) 
                                            VALUES (@pid, @uid, @sid, GETDATE(), 'SALIDA', @cant, @ref, @notas)";

                        ExecuteNonQueryInTransaction(sqlKardex, [
                            new SqlParameter("@pid", det.ProductoId),
                            new SqlParameter("@uid", ejecutor.Id),
                            new SqlParameter("@sid", venta.SucursalId),
                            new SqlParameter("@cant", det.Cantidad),
                            new SqlParameter("@ref", consecutivoHacienda),
                            new SqlParameter("@notas", $"Venta Autom√°tica - Factura #{facturaId}")
                        ], connection, transaction);
                    }

                    transaction.Commit();
                    return consecutivoHacienda;
                }
                catch (Exception ex)
                {
                    transaction.Rollback();
                    throw new Exception("Error en VentaFactory: " + ex.Message);
                }
            }
        }
    }

    private string GenerarClaveHacienda(string cedula, string consecutivo)
    {
        string pais = "506";
        string dia = DateTime.Now.Day.ToString("D2");
        string mes = DateTime.Now.Month.ToString("D2");
        string anio = DateTime.Now.ToString("yy");
        string situacion = "1";
        string codigoSeguridad = new Random().Next(10000000, 99999999).ToString();
        return pais + dia + mes + anio + cedula + consecutivo + situacion + codigoSeguridad;
    }

    public FacturaDTO? ObtenerPorId(int id, UsuarioDTO ejecutor)
    {
        string sql = @"SELECT f.*, 
                               ISNULL(c.nombre, 'CLIENTE CONTADO') as ClienteNombre, 
                               c.identificacion as ClienteIdentificacion 
                      FROM FACTURA_ENCABEZADO f 
                      LEFT JOIN CLIENTE c ON f.cliente_id = c.id 
                      WHERE f.id = @id";

        // Filtro de sucursal: Solo si no es Admin Total
        if (ejecutor.TienePermiso("sucursal_limit") && !ejecutor.TienePermiso("all"))
            sql += " AND f.sucursal_id = @sid";

        var p = new List<SqlParameter> { new SqlParameter("@id", id) };
        if (ejecutor.TienePermiso("sucursal_limit") && !ejecutor.TienePermiso("all"))
            p.Add(new SqlParameter("@sid", ejecutor.SucursalId));

        var dt = ExecuteQuery(sql, p.ToArray(), false);
        if (dt == null || dt.Rows.Count == 0) return null;

        var row = dt.Rows[0];
        return new FacturaDTO
        {
            Id = Convert.ToInt32(row["id"]),
            ClienteId = row["cliente_id"] != DBNull.Value ? Convert.ToInt32(row["cliente_id"]) : 0,
            ClienteNombre = row["ClienteNombre"]?.ToString(),
            ClienteIdentificacion = row["ClienteIdentificacion"]?.ToString() ?? "",
            Consecutivo = row["consecutivo"]?.ToString(),
            ClaveNumerica = row["clave_numerica"]?.ToString(),
            Fecha = Convert.ToDateTime(row["fecha"]),
            TotalNeto = Convert.ToDecimal(row["total_neto"]),
            TotalImpuesto = Convert.ToDecimal(row["total_impuesto"]),
            TotalComprobante = Convert.ToDecimal(row["total_comprobante"]),
            CondicionVenta = row["condicion_venta"]?.ToString() ?? "Contado",
            MedioPago = row["medio_pago"]?.ToString() ?? "Efectivo",
            SucursalId = Convert.ToInt32(row["sucursal_id"])
        };
    }

    public List<FacturaDetalleDTO> ListarDetalles(int facturaId)
    {
        string sql = @"SELECT d.*, p.nombre as ProductoNombre 
                       FROM FACTURA_DETALLE d
                       INNER JOIN PRODUCTO p ON d.producto_id = p.id
                       WHERE d.factura_id = @fid";

        var dt = ExecuteQuery(sql, [new SqlParameter("@fid", facturaId)], false);
        var lista = new List<FacturaDetalleDTO>();

        if (dt != null)
        {
            foreach (DataRow dr in dt.Rows)
            {
                lista.Add(new FacturaDetalleDTO
                {
                    ProductoId = Convert.ToInt32(dr["producto_id"]),
                    ProductoNombre = dr["ProductoNombre"]?.ToString() ?? "Producto Desconocido",
                    Cantidad = Convert.ToDecimal(dr["cantidad"]),
                    PrecioUnitario = Convert.ToDecimal(dr["precio_unitario"]),
                    TotalLinea = Convert.ToDecimal(dr["total_linea"]),
                    PorcentajeImpuesto = Convert.ToDecimal(dr["porcentaje_impuesto"]),
                    MontoImpuesto = Convert.ToDecimal(dr["monto_impuesto"])
                });
            }
        }
        return lista;
    }

    public DataTable ObtenerReporteVentas(DateTime? desde, DateTime? hasta, int? clienteId, string busqueda, string condicionVenta, UsuarioDTO ejecutor)
    {
        // Se asume que VW_REPORTE_VENTAS es una vista que une FACTURA_ENCABEZADO con CLIENTE
        string sql = "SELECT * FROM VW_REPORTE_VENTAS WHERE 1=1";
        List<SqlParameter> parametros = new List<SqlParameter>();

        if (desde.HasValue)
        {
            sql += " AND fecha >= @desde";
            parametros.Add(new SqlParameter("@desde", desde.Value));
        }
        if (hasta.HasValue)
        {
            sql += " AND fecha <= @hasta";
            parametros.Add(new SqlParameter("@hasta", hasta.Value.Date.AddDays(1).AddSeconds(-1)));
        }
        if (clienteId.HasValue && clienteId > 0)
        {
            sql += " AND cliente_id = @cId";
            parametros.Add(new SqlParameter("@cId", clienteId.Value));
        }

        // L√ìGICA DE SEGURIDAD ACTUALIZADA:
        // Si el usuario tiene 'all', ve todo.
        // Si no tiene 'all' pero tiene 'sucursal_limit', se filtra por su sucursal.
        if (ejecutor.TienePermiso("sucursal_limit") && !ejecutor.TienePermiso("all"))
        {
            sql += " AND sucursal_id = @sId";
            parametros.Add(new SqlParameter("@sId", ejecutor.SucursalId));
        }

        if (!string.IsNullOrEmpty(condicionVenta))
        {
            sql += " AND condicion_venta = @condicion";
            parametros.Add(new SqlParameter("@condicion", condicionVenta));
        }

        if (!string.IsNullOrEmpty(busqueda))
        {
            sql += " AND (consecutivo LIKE @bus OR cliente_cedula LIKE @bus OR cliente_nombre LIKE @bus)";
            parametros.Add(new SqlParameter("@bus", "%" + busqueda + "%"));
        }

        sql += " ORDER BY fecha DESC";
        return ExecuteQuery(sql, parametros.ToArray(), false);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Mappers\IMapper.cs --- 
--- NOMBRE: IMapper.cs --- 
 
Ôªøusing System.Data;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Mappers;

public interface IMapper<T>
{
    T MapFromRow(DataRow row);
    SqlParameter[] MapToParameters(T entity);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Mappers\ProductoMapper.cs --- 
--- NOMBRE: ProductoMapper.cs --- 
 
Ôªøusing System.Data;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Mappers;

public class ProductoMapper : IMapper<ProductoDTO>
{
    public ProductoDTO MapFromRow(DataRow row)
    {
        return new ProductoDTO
        {
            Id = Convert.ToInt32(row["id"]),
            // Agregamos el mapeo de SucursalId para que no salga en 0
            SucursalId = row.Table.Columns.Contains("sucursal_id") && row["sucursal_id"] != DBNull.Value
                         ? Convert.ToInt32(row["sucursal_id"])
                         : 0,

            CategoriaId = Convert.ToInt32(row["categoria_id"]),
            CodCabys = row["cod_cabys"]?.ToString(),
            CodigoBarras = row["codigo_barras"]?.ToString(),
            Nombre = row["nombre"].ToString() ?? "",
            Descripcion = row["descripcion"]?.ToString(),
            UnidadMedida = row["unidad_medida"].ToString() ?? "Unid",
            CostoActual = Convert.ToDecimal(row["costo_actual"]),
            Precio1 = Convert.ToDecimal(row["precio_1"]),

            Precio2 = row["precio_2"] != DBNull.Value ? Convert.ToDecimal(row["precio_2"]) : null,
            Precio3 = row["precio_3"] != DBNull.Value ? Convert.ToDecimal(row["precio_3"]) : null,
            Precio4 = row["precio_4"] != DBNull.Value ? Convert.ToDecimal(row["precio_4"]) : null,

            Existencia = row.Table.Columns.Contains("existencia_local")
                         ? Convert.ToDecimal(row["existencia_local"])
                         : Convert.ToDecimal(row["existencia"]),

            StockMinimo = Convert.ToDecimal(row["stock_minimo"]),
            ExentoIva = Convert.ToBoolean(row["exento_iva"]),

            PorcentajeImpuesto = row.Table.Columns.Contains("porcentaje_impuesto")
                                 ? Convert.ToDecimal(row["porcentaje_impuesto"])
                                 : 0,

            EsServicio = Convert.ToBoolean(row["es_servicio"]),
            EsElaborado = Convert.ToBoolean(row["es_elaborado"]),
            Activo = Convert.ToBoolean(row["activo"])

        };
    }

    public SqlParameter[] MapToParameters(ProductoDTO entity)
    {
        var parameters = new List<SqlParameter>
        {
            new SqlParameter("@categoria_id", entity.CategoriaId),
            new SqlParameter("@cod_cabys", (object?)entity.CodCabys ?? DBNull.Value),
            new SqlParameter("@codigo_barras", (object?)entity.CodigoBarras ?? DBNull.Value),
            new SqlParameter("@nombre", entity.Nombre),
            new SqlParameter("@descripcion", (object?)entity.Descripcion ?? DBNull.Value),
            new SqlParameter("@unidad_medida", entity.UnidadMedida),
            new SqlParameter("@costo_actual", entity.CostoActual),
            new SqlParameter("@precio_1", entity.Precio1),
            new SqlParameter("@precio_2", (object?)entity.Precio2 ?? DBNull.Value),
            new SqlParameter("@precio_3", (object?)entity.Precio3 ?? DBNull.Value),
            new SqlParameter("@precio_4", (object?)entity.Precio4 ?? DBNull.Value),
            new SqlParameter("@exento_iva", entity.ExentoIva),
            new SqlParameter("@porcentaje_impuesto", entity.PorcentajeImpuesto), // Agregado
            new SqlParameter("@existencia", entity.Existencia),
            new SqlParameter("@stock_minimo", entity.StockMinimo),
            new SqlParameter("@es_servicio", entity.EsServicio),
            new SqlParameter("@es_elaborado", entity.EsElaborado),
            new SqlParameter("@activo", entity.Activo),
            new SqlParameter("@sucursal_id", entity.SucursalId) // Agregado para el contexto de sucursal
        };

        if (entity.Id > 0)
        {
            parameters.Add(new SqlParameter("@id", entity.Id));
        }

        return parameters.ToArray();
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Mappers\UsuarioMapper.cs --- 
--- NOMBRE: UsuarioMapper.cs --- 
 
Ôªøusing System.Data;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Mappers;

public class UsuarioMapper : IMapper<UsuarioDTO>
{
    public UsuarioDTO MapFromRow(DataRow row)
    {
        var columns = row.Table.Columns;

        return new UsuarioDTO
        {
            Id = columns.Contains("id") ? Convert.ToInt32(row["id"]) : 0,
            RolId = columns.Contains("rol_id") ? Convert.ToInt32(row["rol_id"]) : 0,
            SucursalId = columns.Contains("sucursal_id") ? Convert.ToInt32(row["sucursal_id"]) : 0,
            NombreCompleto = columns.Contains("nombre_completo") ? row["nombre_completo"]?.ToString() ?? "" : "",
            Username = columns.Contains("username") ? row["username"]?.ToString() ?? "" : "",
            PasswordHash = columns.Contains("password_hash") ? row["password_hash"]?.ToString() ?? "" : "",

            CorreoElectronico = columns.Contains("correo_electronico") && row["correo_electronico"] != DBNull.Value
                                ? row["correo_electronico"].ToString() ?? "" : "",

            NombreRol = columns.Contains("nombre_rol") && row["nombre_rol"] != DBNull.Value
                        ? row["nombre_rol"].ToString() : null,

            PermisosJson = columns.Contains("permisos_json") && row["permisos_json"] != DBNull.Value
                           ? row["permisos_json"].ToString() : null,

            Activo = columns.Contains("activo") && row["activo"] != DBNull.Value && Convert.ToBoolean(row["activo"]),

            UltimoLogin = columns.Contains("ultimo_login") && row["ultimo_login"] != DBNull.Value
                          ? Convert.ToDateTime(row["ultimo_login"]) : null,

            HardwareIdSesion = columns.Contains("hardware_id_sesion") && row["hardware_id_sesion"] != DBNull.Value
                               ? row["hardware_id_sesion"].ToString() : null
        };
    }

    public SqlParameter[] MapToParameters(UsuarioDTO entity)
    {
        return new SqlParameter[]
        {
            new SqlParameter("@id", entity.Id),
            new SqlParameter("@rol_id", entity.RolId),
            new SqlParameter("@sucursal_id", entity.SucursalId),
            new SqlParameter("@nombre_completo", entity.NombreCompleto ?? (object)DBNull.Value),
            new SqlParameter("@username", entity.Username ?? (object)DBNull.Value),
            new SqlParameter("@password_hash", entity.PasswordHash ?? (object)DBNull.Value),
            new SqlParameter("@correo_electronico", entity.CorreoElectronico ?? (object)DBNull.Value),
            new SqlParameter("@activo", entity.Activo),
            new SqlParameter("@hardware_id_sesion", (object?)entity.HardwareIdSesion ?? DBNull.Value)
        };
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\obj\Debug\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
--- NOMBRE: .NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
 
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\obj\Debug\net9.0\IntegraPro.DataAccess.AssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.DataAccess.AssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("IntegraPro.DataAccess")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0+4153b5f28a857579dabbc5516649e889b6ddb8bd")]
[assembly: System.Reflection.AssemblyProductAttribute("IntegraPro.DataAccess")]
[assembly: System.Reflection.AssemblyTitleAttribute("IntegraPro.DataAccess")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\obj\Debug\net9.0\IntegraPro.DataAccess.GlobalUsings.g.cs --- 
--- NOMBRE: IntegraPro.DataAccess.GlobalUsings.g.cs --- 
 
// <auto-generated/>
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Threading;
global using global::System.Threading.Tasks;
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Class1.cs --- 
--- NOMBRE: Class1.cs --- 
 
Ôªønamespace IntegraPro.DTO;

public class Class1
{

}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\AbonoDTO.cs --- 
--- NOMBRE: AbonoDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class AbonoDTO
{
    public int CuentaCobrarId { get; set; }
    public int UsuarioId { get; set; }
    public int SucursalId { get; set; }
    public decimal MontoAbonado { get; set; }
    public string MedioPago { get; set; } = "Efectivo";
    public string? Referencia { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\AbonoHistorialDTO.cs --- 
--- NOMBRE: AbonoHistorialDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class AbonoHistorialDTO
{
    public int Id { get; set; }
    public decimal Monto { get; set; }
    public DateTime FechaAbono { get; set; }
    public string MetodoPago { get; set; } = string.Empty;
    public string NumeroReferencia { get; set; } = string.Empty;
    public string NombreUsuario { get; set; } = string.Empty; // Qui√©n recibi√≥ el dinero
    public string Notas { get; set; } = string.Empty;
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\AlertaCxcDTO.cs --- 
--- NOMBRE: AlertaCxcDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class AlertaCxcDTO
{
    public int FacturaId { get; set; }
    public string ClienteNombre { get; set; } = string.Empty;
    public string NumeroFactura { get; set; } = string.Empty;
    public decimal SaldoPendiente { get; set; }
    public DateTime FechaVencimiento { get; set; }
    public int DiasVencidos { get; set; } // Negativo si falta para vencer, positivo si ya venci√≥
    public string NivelRiesgo { get; set; } = string.Empty; // Bajo, Medio, Alto (Mora)
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\AlertaPagoDTO.cs --- 
--- NOMBRE: AlertaPagoDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class AlertaPagoDTO
{
    public int Id { get; set; }
    public string ProveedorNombre { get; set; } = string.Empty;
    public decimal SaldoPendiente { get; set; }
    public DateTime FechaVencimiento { get; set; }
    public int DiasParaVencimiento { get; set; }
    public string Urgencia { get; set; } = string.Empty;

    public int SucursalId { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\CajaDTO.cs --- 
--- NOMBRE: CajaDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class CajaAperturaDTO
{
    public int SucursalId { get; set; }
    public int UsuarioId { get; set; }
    public decimal MontoInicial { get; set; }
}

public class CajaCierreDTO
{
    public int CajaId { get; set; }
    public decimal MontoRealEnCaja { get; set; }
    public string? Notas { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\CategoriaDTO.cs --- 
--- NOMBRE: CategoriaDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class CategoriaDTO
{
    public int Id { get; set; }
    public string Nombre { get; set; } = string.Empty;
    public string? Descripcion { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\ClienteDTO.cs --- 
--- NOMBRE: ClienteDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class ClienteDTO
{
    public int Id { get; set; }
    public string Identificacion { get; set; } = string.Empty;
    public string Nombre { get; set; } = string.Empty;
    public string? Correo { get; set; }
    public string? Telefono { get; set; }
    public decimal LimiteCredito { get; set; }
    public bool Activo { get; set; } = true;
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\CompraDTO.cs --- 
--- NOMBRE: CompraDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class CompraDTO
{
    // --- Encabezado ---
    public int Id { get; set; }
    public int ProveedorId { get; set; }
    public int SucursalId { get; set; }
    public int UsuarioId { get; set; }
    public string? NumeroFacturaProveedor { get; set; }
    public DateTime FechaCompra { get; set; }
    public decimal Subtotal { get; set; }
    public decimal TotalImpuestos { get; set; }
    public decimal TotalCompra { get; set; }
    public string? Notas { get; set; }

    // --- L√≥gica de Negocio y Estado ---
    public string Estado { get; set; } = "Procesada";
    public string TipoPago { get; set; } = "Contado";
    public int DiasCredito { get; set; }

    // --- Detalle Unificado ---
    public List<CompraDetalleDTO> Detalles { get; set; } = new();
}

public class CompraDetalleDTO
{
    public int ProductoId { get; set; }
    public decimal Cantidad { get; set; }
    public decimal CostoUnitarioNeto { get; set; }
    public decimal MontoImpuesto { get; set; }
    public decimal TotalLinea { get; set; }

    // --- IMPORTANTE: Propiedades para el flujo XML ---
    /// <summary>
    /// C√≥digo CABYS o Comercial que viene en el XML. 
    /// Se usa para crear la equivalencia autom√°tica.
    /// </summary>
    public string? CodigoCabys { get; set; }

    /// <summary>
    /// Nombre tal cual viene en el XML (ej: "ENERGIA"). 
    /// Ayuda al usuario a identificar el producto en la pantalla de mapeo.
    /// </summary>
    public string? DetalleOriginalXml { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\ConfiguracionDTO.cs --- 
--- NOMBRE: ConfiguracionDTO.cs --- 
 
Ôªøusing System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace IntegraPro.DTO.Models;

public class EmpresaDTO
{
    public int Id { get; set; }
    public string NombreComercial { get; set; } = string.Empty;
    public string RazonSocial { get; set; } = string.Empty; // Agregado
    public string CedulaJuridica { get; set; } = string.Empty;
    public string TipoRegimen { get; set; } = "Tradicional";
    public string Telefono { get; set; } = string.Empty; // Agregado
    public string CorreoNotificaciones { get; set; } = string.Empty;
    public string SitioWeb { get; set; } = string.Empty; // Agregado
    public string? Logo { get; set; } // Agregado (Nombre del archivo o ruta)

    public bool PermitirStockNegativo { get; set; }
}

public class LicenciaDTO
{
    public string LicenciaKey { get; set; } = string.Empty;
    public string HardwareId { get; set; } = string.Empty;
    public DateTime FechaVencimiento { get; set; }
    public string Estado { get; set; } = "Demo";
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\CxcConsultaDTO.cs --- 
--- NOMBRE: CxcConsultaDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class CxcConsultaDTO
{
    public int CuentaCobrarId { get; set; }
    public string NumeroFactura { get; set; } = string.Empty;
    public string ClienteNombre { get; set; } = string.Empty;
    public string ClienteCedula { get; set; } = string.Empty;
    public DateTime FechaEmision { get; set; }
    public DateTime FechaVencimiento { get; set; }
    public decimal MontoTotal { get; set; }
    public decimal SaldoPendiente { get; set; }
    public string Estado { get; set; } = string.Empty; // Pendiente, Pagada, Vencida
    public int DiasCredito { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\DeudaConsultaDTO.cs --- 
--- NOMBRE: DeudaConsultaDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class DeudaConsultaDTO
{
    public int DeudaId { get; set; }
    public int CompraId { get; set; }
    public string ProveedorCedula { get; set; } = string.Empty;
    public string ProveedorNombre { get; set; } = string.Empty;
    public string NumeroFactura { get; set; } = string.Empty;
    public DateTime FechaCompra { get; set; }
    public decimal MontoOriginal { get; set; }
    public decimal SaldoActual { get; set; }
    public DateTime FechaVencimiento { get; set; }
    public string EstadoDeuda { get; set; } = string.Empty;
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\FacturaDTO.cs --- 
--- NOMBRE: FacturaDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class FacturaDTO
{
    public int Id { get; set; }
    public int ClienteId { get; set; }
    public string? ClienteNombre { get; set; }
    public string? ClienteIdentificacion { get; set; }
    public int SucursalId { get; set; }
    public int UsuarioId { get; set; }
    public string? Consecutivo { get; set; }
    public string? ClaveNumerica { get; set; }
    public DateTime Fecha { get; set; }
    public string CondicionVenta { get; set; } = "Contado";
    public string MedioPago { get; set; } = "Efectivo";

    public decimal TotalNeto { get; set; }
    public decimal TotalDescuento { get; set; } // Ahora es decimal est√°ndar (no nulo)
    public decimal TotalImpuesto { get; set; }
    public decimal TotalComprobante { get; set; }

    public string? EstadoHacienda { get; set; } = "LOCAL";
    public bool EsOffline { get; set; } = true;

    public List<FacturaDetalleDTO> Detalles { get; set; } = new();
}

public class FacturaDetalleDTO
{
    public int ProductoId { get; set; }
    public string? ProductoNombre { get; set; }
    public decimal Cantidad { get; set; }
    public decimal PrecioUnitario { get; set; }
    public decimal PorcentajeImpuesto { get; set; } = 13;
    public decimal MontoImpuesto { get; set; } // Ahora permite asignaci√≥n
    public decimal PorcentajeDescuento { get; set; }
    public decimal MontoDescuento { get; set; } // Ahora permite asignaci√≥n
    public decimal TotalLinea { get; set; } // Ahora permite asignaci√≥n
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\MovimientoInventarioDTO.cs --- 
--- NOMBRE: MovimientoInventarioDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class MovimientoInventarioDTO
{
    public int Id { get; set; }
    public int ProductoId { get; set; }
    public int UsuarioId { get; set; }

    // NUEVO: Propiedad necesaria para el control multi-sucursal
    public int SucursalId { get; set; }

    public DateTime Fecha { get; set; } = DateTime.Now;

    // ENTRADA, SALIDA o AJUSTE
    public string TipoMovimiento { get; set; } = "ENTRADA";

    public decimal Cantidad { get; set; }

    // Estos campos suelen ser calculados por el Trigger en la base de datos
    public decimal? ExistenciaPrevia { get; set; }
    public decimal? ExistenciaPosterior { get; set; }

    public string? DocumentoReferencia { get; set; }
    public string? Notas { get; set; }

    // PROPIEDADES DE NAVEGACI√ìN (Opcionales: √∫tiles para mostrar nombres en el historial)
    public string? ProductoNombre { get; set; }
    public string? UsuarioNombre { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\PagoCxpDTO.cs --- 
--- NOMBRE: PagoCxpDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class PagoCxpDTO
{
    public int CompraId { get; set; }
    public int UsuarioId { get; set; }
    public decimal Monto { get; set; }
    public string? NumeroReferencia { get; set; }
    public string? Notas { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\PagoHistorialDTO.cs --- 
--- NOMBRE: PagoHistorialDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class PagoHistorialDTO
{
    public int Id { get; set; }
    public decimal Monto { get; set; }
    public DateTime FechaPago { get; set; }
    public string? NumeroReferencia { get; set; }
    public string? Notas { get; set; }
    public string? NombreUsuario { get; set; } // Para saber qui√©n aplic√≥ el pago
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\PermisosDetalle.cs --- 
--- NOMBRE: PermisosDetalle.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models
{
    public class PermisosDetalle
    {
        public bool Ventas { get; set; }
        public bool Compras { get; set; }
        public bool Inventario { get; set; }
        public bool Caja { get; set; }
        public bool Reportes { get; set; }
        public bool Clientes { get; set; }
        public bool Sucursal_Limit { get; set; } // La llave para filtrar por sucursal
        public bool All { get; set; } // Para el Administrador
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\ProductoDTO.cs --- 
--- NOMBRE: ProductoDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class ProductoDTO
{
    public int Id { get; set; }
    public int CategoriaId { get; set; }
    public string? CodCabys { get; set; }
    public string? CodigoBarras { get; set; }
    public string Nombre { get; set; } = string.Empty;
    public string? Descripcion { get; set; }
    public string UnidadMedida { get; set; } = "Unid";
    public decimal CostoActual { get; set; }

    public decimal Precio1 { get; set; }
    public decimal? Precio2 { get; set; }
    public decimal? Precio3 { get; set; }
    public decimal? Precio4 { get; set; }

    public decimal Existencia { get; set; }
    public decimal StockMinimo { get; set; }

    public bool ExentoIva { get; set; }
    public decimal PorcentajeImpuesto { get; set; } // Faltaba seg√∫n tu SQL
    public bool Activo { get; set; }
    public bool EsServicio { get; set; }
    public bool EsElaborado { get; set; }

    // --- PROPIEDADES DE CONTEXTO ---
    // Esta es la que causaba el error CS1061
    public int SucursalId { get; set; }

    public List<ProductoComposicionDTO> Receta { get; set; } = new();
}

public class ProductoComposicionDTO
{
    public int MaterialId { get; set; }
    public string? MaterialNombre { get; set; }
    public decimal CantidadNecesaria { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\ProformaDTO.cs --- 
--- NOMBRE: ProformaDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class ProformaEncabezadoDTO
{
    public int Id { get; set; }
    public int ClienteId { get; set; }
    public string? ClienteNombre { get; set; }
    public string? ClienteIdentificacion { get; set; }
    public int SucursalId { get; set; }
    public DateTime Fecha { get; set; }
    public DateTime FechaVencimiento { get; set; }

    // --- Totales del Encabezado (Suma de todos los detalles) ---
    public decimal TotalNeto { get; set; }      // Subtotal sin impuestos
    public decimal TotalImpuesto { get; set; }  // Total de IVAs acumulados
    public decimal Total { get; set; }          // Monto final (Neto + Impuesto)

    public string Estado { get; set; } = "Pendiente";
    public List<ProformaDetalleDTO> Detalles { get; set; } = new();
}

public class ProformaDetalleDTO
{
    public int ProductoId { get; set; }
    public string? ProductoCodigo { get; set; }
    public string? ProductoNombre { get; set; }
    public decimal Cantidad { get; set; }

    // --- Desglose por L√≠nea ---
    public decimal PrecioUnitario { get; set; }    // Precio Neto (sacado de 'costo_actual')
    public decimal PorcentajeImpuesto { get; set; } // El % aplicado (ej: 13, 1, 0)
    public decimal ImpuestoTotal { get; set; }      // El monto de dinero del impuesto para esta l√≠nea
    public decimal TotalLineas { get; set; }        // (Cantidad * PrecioUnitario) + ImpuestoTotal
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\ProveedorDTO.cs --- 
--- NOMBRE: ProveedorDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class ProveedorDTO
{
    public int Id { get; set; }
    public string Identificacion { get; set; } = string.Empty;
    public string Nombre { get; set; } = string.Empty;
    public string? Correo { get; set; }
    public string? Telefono { get; set; }
    public bool Activo { get; set; } = true;
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\ResumenCxcDTO.cs --- 
--- NOMBRE: ResumenCxcDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class ResumenCxcDTO
{
    public decimal TotalPorCobrar { get; set; }
    public decimal TotalVencido { get; set; }
    public int CantidadFacturasPendientes { get; set; }
    public int ClientesMorosos { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\ResumenCxpDTO.cs --- 
--- NOMBRE: ResumenCxpDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class ResumenCxpDTO
{
    public decimal TotalDeudaGlobal { get; set; }
    public int FacturasPendientes { get; set; }
    public int ProveedoresAQuienesSeDebe { get; set; }
    public decimal ProximoVencimientoMonto { get; set; }
    public DateTime? FechaProximoVencimiento { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\RolDTO.cs --- 
--- NOMBRE: RolDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class RolDTO
{
    public int Id { get; set; }
    public string NombreRol { get; set; } = string.Empty;
    public string PermisosJson { get; set; } = "{}";
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\UsuarioDTO.cs --- 
--- NOMBRE: UsuarioDTO.cs --- 
 
Ôªøusing System;
using System.Collections.Generic;
using System.Text.Json;

namespace IntegraPro.DTO.Models;

public class UsuarioDTO
{
    public int Id { get; set; }
    public int RolId { get; set; }
    public int SucursalId { get; set; }
    public string NombreCompleto { get; set; } = string.Empty;
    public string Username { get; set; } = string.Empty;
    public string? Password { get; set; } // Uso temporal en Login
    public string PasswordHash { get; set; } = string.Empty;
    public string CorreoElectronico { get; set; } = string.Empty;
    public bool Activo { get; set; }
    public DateTime? UltimoLogin { get; set; }
    public string? HardwareIdSesion { get; set; }
    public string? Token { get; set; }
    public string? NombreRol { get; set; }

    private string? _permisosJson;
    public string? PermisosJson
    {
        get => _permisosJson;
        set
        {
            _permisosJson = value;
            if (!string.IsNullOrEmpty(value))
            {
                try
                {
                    // Limpieza de JSON escapado proveniente de JWT
                    string cleanJson = value.Trim('"').Replace("\\\"", "\"");
                    var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
                    Permisos = JsonSerializer.Deserialize<Dictionary<string, bool>>(cleanJson, options) ?? new();
                }
                catch
                {
                    Permisos = new Dictionary<string, bool>();
                }
            }
            else
            {
                Permisos = new Dictionary<string, bool>();
            }
        }
    }

    public Dictionary<string, bool> Permisos { get; set; } = new();

    // ==========================================
    // M√âTODOS DE L√ìGICA DE SEGURIDAD (NUEVOS)
    // ==========================================

    /// <summary>
    /// Eval√∫a si el usuario cuenta con un permiso espec√≠fico.
    /// </summary>
    public bool TienePermiso(string clave)
    {
        if (Permisos == null) return false;

        // 1. RESTRICCIONES CR√çTICAS (Solo lectura)
        if (clave == "solo_lectura")
            return Permisos.TryGetValue("solo_lectura", out bool restringido) && restringido;

        // 2. ACCESO TOTAL (all)
        if (Permisos.TryGetValue("all", out bool all) && all) return true;

        // 3. PERMISO ESPEC√çFICO
        return Permisos.TryGetValue(clave, out bool p) && p;
    }

    /// <summary>
    /// Lanza una excepci√≥n si el usuario tiene el perfil de "solo_lectura".
    /// Ideal para proteger m√©todos Insert, Update y Delete.
    /// </summary>
    public void ValidarEscritura()
    {
        if (TienePermiso("solo_lectura"))
            throw new UnauthorizedAccessException("Operaci√≥n denegada: Su usuario solo tiene permisos de consulta (Auditor√≠a).");
    }

    /// <summary>
    /// Valida si el usuario tiene acceso a un m√≥dulo. Si no, lanza excepci√≥n.
    /// </summary>
    public void ValidarAcceso(string clavePermiso)
    {
        if (!TienePermiso(clavePermiso))
            throw new UnauthorizedAccessException($"Acceso denegado: No cuenta con el permiso '{clavePermiso}' para realizar esta acci√≥n.");
    }

    /// <summary>
    /// Genera din√°micamente el fragmento SQL para filtrar por sucursal.
    /// </summary>
    /// <param name="aliasTabla">Opcional: alias de la tabla en el SQL (ej: 'p')</param>
    public string GetFiltroSucursal(string aliasTabla = "")
    {
        // Si no tiene la limitaci√≥n, devolvemos una condici√≥n siempre verdadera.
        if (!TienePermiso("sucursal_limit")) return " (1=1) ";

        string prefijo = string.IsNullOrEmpty(aliasTabla) ? "" : $"{aliasTabla}.";
        return $" {prefijo}sucursal_id = {this.SucursalId} ";
    }
}

public class LoginRequest
{
    public string Username { get; set; } = string.Empty;
    public string Password { get; set; } = string.Empty;
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\XmlPreprocesoDTO.cs --- 
--- NOMBRE: XmlPreprocesoDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class XmlPreprocesoDTO
{
    public string? NumeroFactura { get; set; }
    public DateTime FechaEmision { get; set; }
    public string? ProveedorCedula { get; set; }
    public string? ProveedorNombre { get; set; }

    // Propiedad a√±adida para vincular con el ID interno de la DB
    public int ProveedorId { get; set; }

    public List<LineaPreprocesoDTO> Lineas { get; set; } = new();
}

public class LineaPreprocesoDTO
{
    public string? DetalleXml { get; set; }
    public string? CodigoCabys { get; set; }
    public decimal Cantidad { get; set; }
    public decimal PrecioUnitario { get; set; }
    public decimal MontoImpuesto { get; set; }
    public decimal TotalLinea { get; set; }
    public int? ProductoIdSugerido { get; set; }
    public string? ProductoNombreSugerido { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\obj\Debug\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
--- NOMBRE: .NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
 
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\obj\Debug\net9.0\IntegraPro.DTO.AssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.DTO.AssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("IntegraPro.DTO")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0+4153b5f28a857579dabbc5516649e889b6ddb8bd")]
[assembly: System.Reflection.AssemblyProductAttribute("IntegraPro.DTO")]
[assembly: System.Reflection.AssemblyTitleAttribute("IntegraPro.DTO")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\obj\Debug\net9.0\IntegraPro.DTO.GlobalUsings.g.cs --- 
--- NOMBRE: IntegraPro.DTO.GlobalUsings.g.cs --- 
 
// <auto-generated/>
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Threading;
global using global::System.Threading.Tasks;
.
