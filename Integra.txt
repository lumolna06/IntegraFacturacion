 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Program.cs --- 
--- NOMBRE: Program.cs --- 
 
using IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Services;
using IntegraPro.DataAccess.Factory;
using Microsoft.OpenApi.Models;

var builder = WebApplication.CreateBuilder(args);

// ==========================================
// 1. CONFIGURACI”N DE CONEXI”N
// ==========================================
// Se prioriza la cadena de appsettings.json, si no existe usa la de respaldo.
string connectionString = builder.Configuration.GetConnectionString("DefaultConnection")
    ?? "Server=DESKTOP-AR7JSQE\\SQLEXPRESS;Database=ERP_SistemaPro;Integrated Security=SSPI;TrustServerCertificate=True;";

// ==========================================
// 2. INYECCI”N DE DEPENDENCIAS (N-Capas)
// ==========================================

// --- Capa de Datos (Factories) ---
// Registramos las Factories pasando la cadena de conexiÛn al constructor
builder.Services.AddScoped(sp => new UsuarioFactory(connectionString));
builder.Services.AddScoped(sp => new ProductoFactory(connectionString));
builder.Services.AddScoped(sp => new CategoriaFactory(connectionString));
builder.Services.AddScoped(sp => new ConfiguracionFactory(connectionString)); // Nueva Factory Zona 1

// --- Capa de LÛgica (Services) ---
// Registramos los servicios vincul·ndolos con sus interfaces
builder.Services.AddScoped<IUsuarioService, UsuarioService>();
builder.Services.AddScoped<IProductoService, ProductoService>();
builder.Services.AddScoped<LicenciaService>(); // Servicio de ValidaciÛn de Licencia y Hardware
// builder.Services.AddScoped<ICategoriaService, CategoriaService>(); 

// ==========================================
// 3. SERVICIOS BASE DE LA API
// ==========================================
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new OpenApiInfo
    {
        Title = "IntegraPro ERP - Sistema de GestiÛn General",
        Version = "v1",
        Description = "API para gestiÛn de inventarios, recetas de producciÛn, facturaciÛn y licenciamiento."
    });
});

var app = builder.Build();

// ==========================================
// 4. PIPELINE DE SOLICITUDES (Middlewares)
// ==========================================

// ConfiguraciÛn para el entorno de desarrollo
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "IntegraPro API v1");
    });
}

app.UseHttpsRedirection();

// Importante para que los Controladores funcionen
app.UseAuthorization();
app.MapControllers();

app.Run();
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\AuthController.cs --- 
--- NOMBRE: AuthController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Mvc;

namespace IntegraPro.API.Controllers;

[ApiController]
[Route("api/[controller]")]
public class AuthController : ControllerBase
{
    private readonly IUsuarioService _usuarioService;

    public AuthController(IUsuarioService usuarioService)
    {
        _usuarioService = usuarioService;
    }

    [HttpPost("login")]
    public ActionResult<ApiResponse<UsuarioDTO>> Login([FromBody] LoginRequest request)
    {
        var response = _usuarioService.Login(request.Username, request.Password);
        if (!response.Result)
            return BadRequest(response);

        return Ok(response);
    }

    [HttpPost("register")]
    public ActionResult<ApiResponse<bool>> Register([FromBody] UsuarioDTO usuario)
    {
        var response = _usuarioService.Registrar(usuario);
        if (!response.Result)
            return BadRequest(response);

        return Ok(response);
    }
}

public record LoginRequest(string Username, string Password);.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\obj\Debug\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
--- NOMBRE: .NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
 
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\obj\Debug\net9.0\IntegraPro.API.AssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.API.AssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("IntegraPro.API")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0")]
[assembly: System.Reflection.AssemblyProductAttribute("IntegraPro.API")]
[assembly: System.Reflection.AssemblyTitleAttribute("IntegraPro.API")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\obj\Debug\net9.0\IntegraPro.API.GlobalUsings.g.cs --- 
--- NOMBRE: IntegraPro.API.GlobalUsings.g.cs --- 
 
// <auto-generated/>
global using global::Microsoft.AspNetCore.Builder;
global using global::Microsoft.AspNetCore.Hosting;
global using global::Microsoft.AspNetCore.Http;
global using global::Microsoft.AspNetCore.Routing;
global using global::Microsoft.Extensions.Configuration;
global using global::Microsoft.Extensions.DependencyInjection;
global using global::Microsoft.Extensions.Hosting;
global using global::Microsoft.Extensions.Logging;
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Net.Http.Json;
global using global::System.Threading;
global using global::System.Threading.Tasks;
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\obj\Debug\net9.0\IntegraPro.API.MvcApplicationPartsAssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.API.MvcApplicationPartsAssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: Microsoft.AspNetCore.Mvc.ApplicationParts.ApplicationPartAttribute("Microsoft.AspNetCore.OpenApi")]
[assembly: Microsoft.AspNetCore.Mvc.ApplicationParts.ApplicationPartAttribute("Swashbuckle.AspNetCore.SwaggerGen")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Class1.cs --- 
--- NOMBRE: Class1.cs --- 
 
Ôªønamespace IntegraPro.AppLogic;

public class Class1
{

}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\IProductoService.cs --- 
--- NOMBRE: IProductoService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Interfaces;

public interface IProductoService
{
    ApiResponse<List<ProductoDTO>> ObtenerTodos();
    ApiResponse<ProductoDTO> ObtenerPorId(int id);
    ApiResponse<bool> Crear(ProductoDTO producto);
    ApiResponse<bool> Actualizar(ProductoDTO producto);
    ApiResponse<List<ProductoDTO>> ObtenerAlertasStock();
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\IUsuarioService.cs --- 
--- NOMBRE: IUsuarioService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Interfaces;

public interface IUsuarioService
{
    ApiResponse<UsuarioDTO> Login(string username, string password);
    ApiResponse<bool> Registrar(UsuarioDTO usuario);
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\obj\Debug\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
--- NOMBRE: .NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
 
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\obj\Debug\net9.0\IntegraPro.AppLogic.AssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.AppLogic.AssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("IntegraPro.AppLogic")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0")]
[assembly: System.Reflection.AssemblyProductAttribute("IntegraPro.AppLogic")]
[assembly: System.Reflection.AssemblyTitleAttribute("IntegraPro.AppLogic")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\obj\Debug\net9.0\IntegraPro.AppLogic.GlobalUsings.g.cs --- 
--- NOMBRE: IntegraPro.AppLogic.GlobalUsings.g.cs --- 
 
// <auto-generated/>
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Threading;
global using global::System.Threading.Tasks;
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\LicenciaService.cs --- 
--- NOMBRE: LicenciaService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;
using System.Management; // Necesitas agregar System.Management v√≠a NuGet

namespace IntegraPro.AppLogic.Services;

public class LicenciaService
{
    private readonly ConfiguracionFactory _factory;

    public LicenciaService(ConfiguracionFactory factory)
    {
        _factory = factory;
    }

    public string GetHardwareId()
    {
        // Obtenemos el Serial de la BIOS como ID √∫nico
        string serial = "";
        try
        {
            ManagementObjectSearcher searcher = new ManagementObjectSearcher("SELECT SerialNumber FROM Win32_BIOS");
            foreach (ManagementObject obj in searcher.Get())
            {
                serial = obj["SerialNumber"].ToString()!;
            }
        }
        catch { serial = "HARDWARE-ID-GENERICO"; }
        return serial;
    }

    public ApiResponse<bool> ValidarSistema()
    {
        string hid = GetHardwareId();
        var licencia = _factory.ObtenerLicencia(hid);

        if (licencia == null)
            return new ApiResponse<bool>(false, "Sistema no registrado o Licencia inv√°lida para este equipo.");

        return new ApiResponse<bool>(true, "Licencia Activa", true);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\ProductoService.cs --- 
--- NOMBRE: ProductoService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class ProductoService : IProductoService
{
    private readonly ProductoFactory _factory;

    public ProductoService(ProductoFactory factory)
    {
        _factory = factory;
    }

    public ApiResponse<List<ProductoDTO>> ObtenerTodos()
    {
        try
        {
            var lista = _factory.GetAll();
            return new ApiResponse<List<ProductoDTO>>(true, "Productos recuperados con √©xito", lista);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "ObtenerTodosProductos", ex.Message);
            return new ApiResponse<List<ProductoDTO>>(false, $"Error al obtener productos: {ex.Message}");
        }
    }

    public ApiResponse<bool> Crear(ProductoDTO producto)
    {
        try
        {
            // Validaciones b√°sicas
            Guard.AgainstEmptyString(producto.Nombre, "Nombre del Producto");
            if (producto.Precio1 < 0) return new ApiResponse<bool>(false, "El precio no puede ser negativo");

            // 1. Insertar el producto en la tabla PRODUCTO
            // El factory debe devolver el ID generado (SCOPE_IDENTITY)
            int nuevoProductoId = _factory.Create(producto);

            // 2. Si el producto es elaborado (tiene receta), guardamos su composici√≥n
            if (producto.EsElaborado && producto.Receta != null && producto.Receta.Any())
            {
                foreach (var item in producto.Receta)
                {
                    // Guardamos cada material asociado al producto padre
                    _factory.InsertarComposicion(nuevoProductoId, item.MaterialId, item.CantidadNecesaria);
                }
                Logger.WriteLog("Inventario", "CrearProducto", $"Producto elaborado '{producto.Nombre}' creado con {producto.Receta.Count} materiales.");
            }
            else
            {
                Logger.WriteLog("Inventario", "CrearProducto", $"Producto simple '{producto.Nombre}' creado.");
            }

            return new ApiResponse<bool>(true, "Producto registrado correctamente", true);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "CrearProducto", ex.Message);
            return new ApiResponse<bool>(false, $"Error al crear producto: {ex.Message}");
        }
    }

    public ApiResponse<List<ProductoDTO>> ObtenerAlertasStock()
    {
        try
        {
            // Utiliza la vista VW_ALERTA_STOCK_BAJO definida en tu SQL
            var alertas = _factory.GetStockAlerts();
            return new ApiResponse<List<ProductoDTO>>(true, "Alertas de stock bajo obtenidas", alertas);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "ObtenerAlertasStock", ex.Message);
            return new ApiResponse<List<ProductoDTO>>(false, ex.Message);
        }
    }

    public ApiResponse<ProductoDTO> ObtenerPorId(int id)
    {
        try
        {
            var producto = _factory.GetById(id);
            if (producto == null) return new ApiResponse<ProductoDTO>(false, "Producto no encontrado");
            return new ApiResponse<ProductoDTO>(true, "Producto encontrado", producto);
        }
        catch (Exception ex)
        {
            return new ApiResponse<ProductoDTO>(false, ex.Message);
        }
    }

    public ApiResponse<bool> Actualizar(ProductoDTO producto)
    {
        try
        {
            _factory.Update(producto);
            return new ApiResponse<bool>(true, "Producto actualizado con √©xito", true);
        }
        catch (Exception ex)
        {
            return new ApiResponse<bool>(false, ex.Message);
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\UsuarioService.cs --- 
--- NOMBRE: UsuarioService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class UsuarioService : IUsuarioService
{
    private readonly UsuarioFactory _factory;

    public UsuarioService(UsuarioFactory factory)
    {
        _factory = factory;
    }

    public ApiResponse<UsuarioDTO> Login(string username, string password)
    {
        try
        {
            Guard.AgainstEmptyString(username, nameof(username));
            Guard.AgainstEmptyString(password, nameof(password));

            var usuario = _factory.GetByUsername(username);
            if (usuario == null || !usuario.Activo)
                return new ApiResponse<UsuarioDTO>(false, "Credenciales incorrectas o usuario inactivo");

            if (!PasswordHasher.VerifyPassword(password, usuario.PasswordHash))
            {
                Logger.WriteLog("Seguridad", "Login Fallido", $"Intento fallido: {username}");
                return new ApiResponse<UsuarioDTO>(false, "Credenciales incorrectas");
            }

            usuario.PasswordHash = string.Empty; // Seguridad: No devolver el hash
            Logger.WriteLog("Seguridad", "Login Exitoso", $"Usuario {username} ha ingresado.");
            return new ApiResponse<UsuarioDTO>(true, "Acceso concedido", usuario);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "Login", ex.Message);
            return new ApiResponse<UsuarioDTO>(false, $"Error interno: {ex.Message}");
        }
    }

    public ApiResponse<bool> Registrar(UsuarioDTO usuario)
    {
        try
        {
            Guard.AgainstNull(usuario, nameof(usuario));
            Guard.AgainstEmptyString(usuario.Username, "Nombre de Usuario");

            if (string.IsNullOrEmpty(usuario.Password))
                return new ApiResponse<bool>(false, "La contrase√±a es obligatoria");

            var existente = _factory.GetByUsername(usuario.Username);
            if (existente != null)
                return new ApiResponse<bool>(false, "El nombre de usuario ya est√° en uso");

            usuario.PasswordHash = PasswordHasher.HashPassword(usuario.Password);
            _factory.Create(usuario);

            return new ApiResponse<bool>(true, "Usuario creado exitosamente", true);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "Registro", ex.Message);
            return new ApiResponse<bool>(false, ex.Message);
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Utils\ApiResponse.cs --- 
--- NOMBRE: ApiResponse.cs --- 
 
namespace IntegraPro.AppLogic.Utils;

public class ApiResponse<T>
{
    public T? Data { get; set; }
    public string Message { get; set; } = string.Empty;
    public bool Result { get; set; }

    public ApiResponse(bool result, string message, T? data = default)
    {
        Result = result;
        Message = message;
        Data = data;
    }
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Utils\Guard.cs --- 
--- NOMBRE: Guard.cs --- 
 
namespace IntegraPro.AppLogic.Utils;

public static class Guard
{
    public static void AgainstNull(object? input, string parameterName)
    {
        if (input == null)
            throw new ArgumentNullException(parameterName, $"{parameterName} no puede ser nulo.");
    }

    public static void AgainstEmptyString(string input, string parameterName)
    {
        if (string.IsNullOrWhiteSpace(input))
            throw new ArgumentException($"{parameterName} no puede estar vacio.", parameterName);
    }

    public static string GenerateReadableId(string prefix)
    {
        return $"{prefix}-{Guid.NewGuid().ToString()[..8].ToUpper()}";
    }
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Utils\Logger.cs --- 
--- NOMBRE: Logger.cs --- 
 
namespace IntegraPro.AppLogic.Utils;

public static class Logger
{
    private static readonly string LogPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "logs.txt");

    public static void WriteLog(string modulo, string accion, string detalle)
    {
        try
        {
            string logLine = $"[{DateTime.Now:yyyy-MM-dd HH:mm:ss}] | {modulo} | {accion} | {detalle}{Environment.NewLine}";
            File.AppendAllText(LogPath, logLine);
        }
        catch { /* Fallback silencioso si el archivo esta bloqueado */ }
    }
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Utils\PasswordHasher.cs --- 
--- NOMBRE: PasswordHasher.cs --- 
 
using System.Security.Cryptography;

namespace IntegraPro.AppLogic.Utils;

public static class PasswordHasher
{
    private const int SaltSize = 16; // 128 bit
    private const int KeySize = 32;  // 256 bit
    private const int Iterations = 100000;
    private static readonly HashAlgorithmName _hashAlgorithm = HashAlgorithmName.SHA256;

    public static string HashPassword(string password)
    {
        byte[] salt = RandomNumberGenerator.GetBytes(SaltSize);
        byte[] hash = Rfc2898DeriveBytes.Pbkdf2(password, salt, Iterations, _hashAlgorithm, KeySize);

        return $"{Convert.ToHexString(salt)}.{Convert.ToHexString(hash)}";
    }

    public static bool VerifyPassword(string password, string hashedPassword)
    {
        string[] parts = hashedPassword.Split('.');
        byte[] salt = Convert.FromHexString(parts[0]);
        byte[] hash = Convert.FromHexString(parts[1]);

        byte[] inputHash = Rfc2898DeriveBytes.Pbkdf2(password, salt, Iterations, _hashAlgorithm, KeySize);

        return CryptographicOperations.FixedTimeEquals(hash, inputHash);
    }
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Class1.cs --- 
--- NOMBRE: Class1.cs --- 
 
Ôªønamespace IntegraPro.DataAccess;

public class Class1
{

}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Dao\MasterDao.cs --- 
--- NOMBRE: MasterDao.cs --- 
 
Ôªøusing System.Data;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Dao;

public abstract class MasterDao
{
    private readonly string _connectionString;

    protected MasterDao(string connectionString)
    {
        _connectionString = connectionString;
    }

    protected SqlConnection GetConnection() => new SqlConnection(_connectionString);

    // 1. Para consultas SELECT (devuelve tablas)
    protected DataTable ExecuteQuery(string query, SqlParameter[]? parameters = null, bool isStoredProcedure = true)
    {
        var table = new DataTable();
        using var connection = GetConnection();
        using var command = new SqlCommand(query, connection);

        if (isStoredProcedure)
            command.CommandType = CommandType.StoredProcedure;

        if (parameters != null)
            command.Parameters.AddRange(parameters);

        using var adapter = new SqlDataAdapter(command);
        adapter.Fill(table);
        return table;
    }

    // 2. Para INSERT que devuelven el ID generado (Indispensable para ProductoFactory)
    protected int ExecuteScalar(string spName, SqlParameter[]? parameters = null)
    {
        using var connection = GetConnection();
        using var command = new SqlCommand(spName, connection);
        command.CommandType = CommandType.StoredProcedure;

        if (parameters != null)
            command.Parameters.AddRange(parameters);

        connection.Open();
        var result = command.ExecuteScalar();
        return result != DBNull.Value ? Convert.ToInt32(result) : 0;
    }

    // 3. Para cambios directos (UPDATE, DELETE, INSERT simples)
    protected void ExecuteNonQuery(string query, SqlParameter[]? parameters = null, bool isStoredProcedure = true)
    {
        using var connection = GetConnection();
        using var command = new SqlCommand(query, connection);

        if (isStoredProcedure)
            command.CommandType = CommandType.StoredProcedure;

        if (parameters != null)
            command.Parameters.AddRange(parameters);

        connection.Open();
        command.ExecuteNonQuery();
    }

    // 4. Alias para compatibilidad con UsuarioFactory
    protected void ExecuteStoredProcedure(string spName, SqlParameter[] parameters)
    {
        ExecuteNonQuery(spName, parameters, true);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\CategoriaFactory.cs --- 
--- NOMBRE: CategoriaFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao; 
using IntegraPro.DTO.Models;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class CategoriaFactory : MasterDao
{
    public CategoriaFactory(string connectionString) : base(connectionString) { }

    public List<CategoriaDTO> GetAll()
    {
        var dt = ExecuteQuery("SELECT * FROM CATEGORIA");
        var lista = new List<CategoriaDTO>();
        foreach (DataRow row in dt.Rows)
        {
            lista.Add(new CategoriaDTO
            {
                Id = Convert.ToInt32(row["id"]),
                Nombre = row["nombre"].ToString() ?? "",
                Descripcion = row["descripcion"]?.ToString()
            });
        }
        return lista;
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\ConfiguracionFactory.cs --- 
--- NOMBRE: ConfiguracionFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class ConfiguracionFactory : MasterDao
{
    public ConfiguracionFactory(string connectionString) : base(connectionString) { }

    public void GuardarEmpresa(EmpresaDTO empresa)
    {
        var p = new SqlParameter[] {
            new SqlParameter("@nombre_comercial", empresa.NombreComercial),
            new SqlParameter("@razon_social", empresa.NombreComercial), // Simplificado
            new SqlParameter("@cedula_juridica", empresa.CedulaJuridica),
            new SqlParameter("@tipo_regimen", empresa.TipoRegimen),
            new SqlParameter("@telefono", "00000000"),
            new SqlParameter("@correo_notificaciones", empresa.CorreoNotificaciones),
            new SqlParameter("@sitio_web", "")
        };
        ExecuteNonQuery("sp_Empresa_Upsert", p);
    }

    public LicenciaDTO? ObtenerLicencia(string hardwareId)
    {
        var p = new SqlParameter[] { new SqlParameter("@hardware_id", hardwareId) };
        var dt = ExecuteQuery("sp_Licencia_Validar", p);
        if (dt.Rows.Count == 0) return null;

        var row = dt.Rows[0];
        return new LicenciaDTO
        {
            HardwareId = row["hardware_id"].ToString()!,
            Estado = row["estado"].ToString()!,
            FechaVencimiento = Convert.ToDateTime(row["fecha_vencimiento"])
        };
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\ProductoFactory.cs --- 
--- NOMBRE: ProductoFactory.cs --- 
 
Ôªø
using IntegraPro.DataAccess.Dao;
using IntegraPro.DataAccess.Mappers;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class ProductoFactory : MasterDao
{
    private readonly ProductoMapper _mapper;

    public ProductoFactory(string connectionString) : base(connectionString)
    {
        _mapper = new ProductoMapper();
    }

    public List<ProductoDTO> GetAll()
    {
        var dt = ExecuteQuery("SELECT * FROM PRODUCTO WHERE activo = 1");
        var lista = new List<ProductoDTO>();
        foreach (DataRow row in dt.Rows) lista.Add(_mapper.MapFromRow(row));
        return lista;
    }

    public ProductoDTO? GetById(int id)
    {
        var parameters = new[] { new SqlParameter("@id", id) };
        var dt = ExecuteQuery("SELECT * FROM PRODUCTO WHERE id = @id", parameters);
        return dt.Rows.Count > 0 ? _mapper.MapFromRow(dt.Rows[0]) : null;
    }

    public int Create(ProductoDTO producto)
    {
        // Nota: Aseg√∫rate de tener el SP sp_Producto_Insert en SQL que haga el INSERT y devuelva SCOPE_IDENTITY()
        return ExecuteScalar("sp_Producto_Insert", _mapper.MapToParameters(producto));
    }

    public void Update(ProductoDTO producto)
    {
        ExecuteNonQuery("sp_Producto_Update", _mapper.MapToParameters(producto), true);
    }

    public void InsertarComposicion(int padreId, int materialId, decimal cantidad)
    {
        var parameters = new[]
        {
            new SqlParameter("@producto_padre_id", padreId),
            new SqlParameter("@material_id", materialId),
            new SqlParameter("@cantidad_necesaria", cantidad)
        };
        ExecuteNonQuery("INSERT INTO PRODUCTO_COMPOSICION (producto_padre_id, material_id, cantidad_necesaria) VALUES (@producto_padre_id, @material_id, @cantidad_necesaria)", parameters);
    }

    public List<ProductoDTO> GetStockAlerts()
    {
        var dt = ExecuteQuery("SELECT * FROM VW_ALERTA_STOCK_BAJO");
        var lista = new List<ProductoDTO>();
        foreach (DataRow row in dt.Rows)
        {
            lista.Add(new ProductoDTO
            {
                Id = Convert.ToInt32(row["id"]),
                Nombre = row["nombre"].ToString() ?? "",
                Existencia = Convert.ToDecimal(row["existencia"]),
                StockMinimo = Convert.ToDecimal(row["stock_minimo"])
            });
        }
        return lista;
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\UsuarioFactory.cs --- 
--- NOMBRE: UsuarioFactory.cs --- 
 
Ôªøusing System.Data;
using IntegraPro.DataAccess.Dao;
using IntegraPro.DataAccess.Mappers;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Factory;

public class UsuarioFactory : MasterDao
{
    private readonly UsuarioMapper _mapper;

    public UsuarioFactory(string connectionString) : base(connectionString)
    {
        _mapper = new UsuarioMapper();
    }

    public UsuarioDTO? GetByUsername(string username)
    {
        var parameters = new SqlParameter[] { new SqlParameter("@username", username) };
        var table = ExecuteQuery("sp_Usuario_GetByUsername", parameters);

        if (table.Rows.Count == 0) return null;

        return _mapper.MapFromRow(table.Rows[0]);
    }

    public void Create(UsuarioDTO usuario)
    {
        var parameters = _mapper.MapToParameters(usuario);
        ExecuteStoredProcedure("sp_Usuario_Insert", parameters);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Mappers\IMapper.cs --- 
--- NOMBRE: IMapper.cs --- 
 
Ôªøusing System.Data;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Mappers;

public interface IMapper<T>
{
    T MapFromRow(DataRow row);
    SqlParameter[] MapToParameters(T entity);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Mappers\ProductoMapper.cs --- 
--- NOMBRE: ProductoMapper.cs --- 
 
Ôªøusing System.Data;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Mappers;

public class ProductoMapper : IMapper<ProductoDTO>
{
    public ProductoDTO MapFromRow(DataRow row)
    {
        return new ProductoDTO
        {
            Id = Convert.ToInt32(row["id"]),
            CategoriaId = Convert.ToInt32(row["categoria_id"]),
            CodCabys = row["cod_cabys"]?.ToString(),
            CodigoBarras = row["codigo_barras"]?.ToString(),
            Nombre = row["nombre"].ToString() ?? "",
            Descripcion = row["descripcion"]?.ToString(),
            UnidadMedida = row["unidad_medida"].ToString() ?? "Unid",
            CostoActual = Convert.ToDecimal(row["costo_actual"]),
            Precio1 = Convert.ToDecimal(row["precio_1"]),
            Existencia = Convert.ToDecimal(row["existencia"]),
            StockMinimo = Convert.ToDecimal(row["stock_minimo"]),
            EsServicio = Convert.ToBoolean(row["es_servicio"]),
            EsElaborado = Convert.ToBoolean(row["es_elaborado"]),
            Activo = Convert.ToBoolean(row["activo"])
        };
    }

    public SqlParameter[] MapToParameters(ProductoDTO entity)
    {
        return new SqlParameter[]
        {
            new SqlParameter("@id", entity.Id),
            new SqlParameter("@categoria_id", entity.CategoriaId),
            new SqlParameter("@cod_cabys", entity.CodCabys ?? (object)DBNull.Value),
            new SqlParameter("@codigo_barras", entity.CodigoBarras ?? (object)DBNull.Value),
            new SqlParameter("@nombre", entity.Nombre),
            new SqlParameter("@descripcion", entity.Descripcion ?? (object)DBNull.Value),
            new SqlParameter("@unidad_medida", entity.UnidadMedida),
            new SqlParameter("@costo_actual", entity.CostoActual),
            new SqlParameter("@precio_1", entity.Precio1),
            new SqlParameter("@existencia", entity.Existencia),
            new SqlParameter("@stock_minimo", entity.StockMinimo),
            new SqlParameter("@es_servicio", entity.EsServicio),
            new SqlParameter("@es_elaborado", entity.EsElaborado),
            new SqlParameter("@activo", entity.Activo)
        };
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Mappers\UsuarioMapper.cs --- 
--- NOMBRE: UsuarioMapper.cs --- 
 
Ôªøusing System.Data;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Mappers;

public class UsuarioMapper : IMapper<UsuarioDTO>
{
    public UsuarioDTO MapFromRow(DataRow row)
    {
        return new UsuarioDTO
        {
            Id = Convert.ToInt32(row["id"]),
            RolId = Convert.ToInt32(row["rol_id"]),
            SucursalId = Convert.ToInt32(row["sucursal_id"]),
            NombreCompleto = row["nombre_completo"]?.ToString() ?? "",
            Username = row["username"]?.ToString() ?? "",
            PasswordHash = row["password_hash"]?.ToString() ?? "",
            Activo = row["activo"] != DBNull.Value && Convert.ToBoolean(row["activo"]),
            UltimoLogin = row["ultimo_login"] != DBNull.Value ? Convert.ToDateTime(row["ultimo_login"]) : null
        };
    }

    public SqlParameter[] MapToParameters(UsuarioDTO entity)
    {
        return new SqlParameter[]
        {
            new SqlParameter("@id", entity.Id),
            new SqlParameter("@rol_id", entity.RolId),
            new SqlParameter("@sucursal_id", entity.SucursalId),
            new SqlParameter("@nombre_completo", entity.NombreCompleto ?? (object)DBNull.Value),
            new SqlParameter("@username", entity.Username ?? (object)DBNull.Value),
            new SqlParameter("@password_hash", entity.PasswordHash ?? (object)DBNull.Value),
            new SqlParameter("@activo", entity.Activo)
        };
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\obj\Debug\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
--- NOMBRE: .NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
 
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\obj\Debug\net9.0\IntegraPro.DataAccess.AssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.DataAccess.AssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("IntegraPro.DataAccess")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0")]
[assembly: System.Reflection.AssemblyProductAttribute("IntegraPro.DataAccess")]
[assembly: System.Reflection.AssemblyTitleAttribute("IntegraPro.DataAccess")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\obj\Debug\net9.0\IntegraPro.DataAccess.GlobalUsings.g.cs --- 
--- NOMBRE: IntegraPro.DataAccess.GlobalUsings.g.cs --- 
 
// <auto-generated/>
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Threading;
global using global::System.Threading.Tasks;
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Class1.cs --- 
--- NOMBRE: Class1.cs --- 
 
Ôªønamespace IntegraPro.DTO;

public class Class1
{

}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\CategoriaDTO.cs --- 
--- NOMBRE: CategoriaDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class CategoriaDTO
{
    public int Id { get; set; }
    public string Nombre { get; set; } = string.Empty;
    public string? Descripcion { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\ConfiguracionDTO.cs --- 
--- NOMBRE: ConfiguracionDTO.cs --- 
 
Ôªøusing System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace IntegraPro.DTO.Models;

public class EmpresaDTO
{
    public int Id { get; set; }
    public string NombreComercial { get; set; } = string.Empty;
    public string CedulaJuridica { get; set; } = string.Empty;
    public string CorreoNotificaciones { get; set; } = string.Empty;
    public string TipoRegimen { get; set; } = "Tradicional";
}

public class LicenciaDTO
{
    public string LicenciaKey { get; set; } = string.Empty;
    public string HardwareId { get; set; } = string.Empty;
    public DateTime FechaVencimiento { get; set; }
    public string Estado { get; set; } = "Demo";
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\ProductoDTO.cs --- 
--- NOMBRE: ProductoDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class ProductoDTO
{
    public int Id { get; set; }
    public int CategoriaId { get; set; }
    public string? CodCabys { get; set; }
    public string? CodigoBarras { get; set; }
    public string Nombre { get; set; } = string.Empty;
    public string? Descripcion { get; set; }
    public string UnidadMedida { get; set; } = "Unid"; // Unid, Kg, M2, M
    public decimal CostoActual { get; set; }
    public decimal Precio1 { get; set; }
    public decimal Existencia { get; set; }
    public decimal StockMinimo { get; set; }
    public bool EsServicio { get; set; }
    public bool EsElaborado { get; set; } // Si es TRUE, usa receta
    public bool Activo { get; set; }

    // Propiedad para manejar la receta/composici√≥n
    public List<ProductoComposicionDTO> Receta { get; set; } = new();
}

public class ProductoComposicionDTO
{
    public int MaterialId { get; set; }
    public string? MaterialNombre { get; set; }
    public decimal CantidadNecesaria { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\UsuarioDTO.cs --- 
--- NOMBRE: UsuarioDTO.cs --- 
 
Ôªøusing System.ComponentModel.DataAnnotations;

namespace IntegraPro.DTO.Models;

public class UsuarioDTO
{
    public int Id { get; set; }

    [Required(ErrorMessage = "El nombre completo es obligatorio")]
    public string NombreCompleto { get; set; } = string.Empty;

    [Required(ErrorMessage = "El nombre de usuario es obligatorio")]
    public string Username { get; set; } = string.Empty;

    public string? Password { get; set; }
    public string PasswordHash { get; set; } = string.Empty;
    public int RolId { get; set; }
    public int SucursalId { get; set; }
    public bool Activo { get; set; }
    public DateTime? UltimoLogin { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\obj\Debug\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
--- NOMBRE: .NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
 
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\obj\Debug\net9.0\IntegraPro.DTO.AssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.DTO.AssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("IntegraPro.DTO")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0")]
[assembly: System.Reflection.AssemblyProductAttribute("IntegraPro.DTO")]
[assembly: System.Reflection.AssemblyTitleAttribute("IntegraPro.DTO")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\obj\Debug\net9.0\IntegraPro.DTO.GlobalUsings.g.cs --- 
--- NOMBRE: IntegraPro.DTO.GlobalUsings.g.cs --- 
 
// <auto-generated/>
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Threading;
global using global::System.Threading.Tasks;
.
