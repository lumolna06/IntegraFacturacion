 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Program.cs --- 
--- NOMBRE: Program.cs --- 
 
using IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Services;
using IntegraPro.DataAccess.Factory;
using Microsoft.OpenApi.Models;
using IntegraPro.API.Filters; // Aseg˙rate de que esta referencia coincida con tu carpeta de filtros

var builder = WebApplication.CreateBuilder(args);

// ==========================================
// 1. CONFIGURACI”N DE CONEXI”N
// ==========================================
string connectionString = builder.Configuration.GetConnectionString("DefaultConnection")
    ?? "Server=DESKTOP-AR7JSQE\\SQLEXPRESS;Database=ERP_SistemaPro;Integrated Security=SSPI;TrustServerCertificate=True;";

// ==========================================
// 2. INYECCI”N DE DEPENDENCIAS (N-Capas)
// ==========================================

// --- Capa de Datos (Factories) ---
builder.Services.AddScoped(sp => new UsuarioFactory(connectionString));
builder.Services.AddScoped(sp => new ProductoFactory(connectionString));
builder.Services.AddScoped(sp => new CategoriaFactory(connectionString));
builder.Services.AddScoped(sp => new ConfiguracionFactory(connectionString));

// --- Capa de LÛgica (Services) ---
builder.Services.AddScoped<LicenciaService>();
builder.Services.AddScoped<IUsuarioService, UsuarioService>();
builder.Services.AddScoped<IProductoService, ProductoService>();

// ==========================================
// 3. SERVICIOS BASE DE LA API
// ==========================================
// Se activa la validaciÛn de licencia y sesiÛn autom·tica en TODO el sistema
builder.Services.AddControllers(options =>
{
    options.Filters.Add<LicenseFilter>();
});

builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new OpenApiInfo
    {
        Title = "IntegraPro ERP - Sistema de GestiÛn General",
        Version = "v1",
        Description = "API para gestiÛn de inventarios, facturaciÛn y licenciamiento con control de hardware."
    });
});

var app = builder.Build();

// ==========================================
// 4. PIPELINE DE SOLICITUDES (Middlewares)
// ==========================================

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "IntegraPro API v1");
    });
}

app.UseHttpsRedirection();

// Importante: El orden de estos middlewares es vital
app.UseAuthentication();
app.UseAuthorization();

app.MapControllers();

app.Run();
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\AuthController.cs --- 
--- NOMBRE: AuthController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Mvc;

namespace IntegraPro.API.Controllers;

[ApiController]
[Route("api/[controller]")]
public class AuthController : ControllerBase
{
    private readonly IUsuarioService _usuarioService;

    public AuthController(IUsuarioService usuarioService)
    {
        _usuarioService = usuarioService;
    }

    [HttpPost("login")]
    public ActionResult<ApiResponse<UsuarioDTO>> Login([FromBody] LoginRequest request)
    {
        var response = _usuarioService.Login(request.Username, request.Password);
        if (!response.Result)
            return BadRequest(response);

        return Ok(response);
    }

    [HttpPost("register")]
    public ActionResult<ApiResponse<bool>> Register([FromBody] UsuarioDTO usuario)
    {
        var response = _usuarioService.Registrar(usuario);
        if (!response.Result)
            return BadRequest(response);

        return Ok(response);
    }
}

public record LoginRequest(string Username, string Password);.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\LicenciaController.cs --- 
--- NOMBRE: LicenciaController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Services;
using IntegraPro.AppLogic.Utils;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace IntegraPro.WebAPI.Controllers;

[ApiController]
[Route("api/[controller]")]
public class LicenciaController : ControllerBase
{
    private readonly LicenciaService _service;

    public LicenciaController(LicenciaService service)
    {
        _service = service;
    }

    /// <summary>
    /// Paso 1: Obtener el Identificador de Hardware.
    /// Accesible sin licencia para permitir el inicio del proceso.
    /// </summary>
    [AllowAnonymous]
    [HttpGet("mi-hardware-id")]
    public IActionResult GetHardwareId()
    {
        string hid = _service.GetHardwareId();
        return Ok(new { hardwareId = hid });
    }

    /// <summary>
    /// Paso 2 (Manual): Activaci√≥n mediante una llave generada por el administrador.
    /// </summary>
    [AllowAnonymous]
    [HttpPost("activar")]
    public IActionResult Activar([FromQuery] string llave, [FromQuery] string empresa, [FromQuery] string ruc, [FromQuery] int maxEquipos)
    {
        var response = _service.ActivarLicencia(llave, empresa, ruc, maxEquipos);
        return Ok(response);
    }

    /// <summary>
    /// Paso 2 (Autom√°tico): El sistema se activa solo con datos b√°sicos.
    /// Genera la llave internamente para que el usuario no dependa del administrador inicialmente.
    /// </summary>
    [AllowAnonymous]
    [HttpPost("auto-activar")]
    public IActionResult AutoActivar([FromQuery] string empresa, [FromQuery] string ruc)
    {
        try
        {
            string hid = _service.GetHardwareId();
            // Generamos la llave autom√°ticamente para una licencia est√°ndar de 5 equipos
            int equiposGratis = 5;
            string llaveGenerada = _service.GenerarLlave(ruc, hid, equiposGratis);

            var response = _service.ActivarLicencia(llaveGenerada, empresa, ruc, equiposGratis);
            return Ok(response);
        }
        catch (Exception ex)
        {
            return BadRequest(new ApiResponse<bool>(false, $"Error en auto-activaci√≥n: {ex.Message}"));
        }
    }

    /// <summary>
    /// Verifica si el sistema est√° activo y si el RUC no ha sido bloqueado remotamente.
    /// </summary>
    [HttpGet("validar-estado")]
    public IActionResult Validar()
    {
        var response = _service.ValidarSistema();
        // Si el RUC est√° en tu lista de GitHub, ValidarSistema() devolver√° false.
        return response.Result ? Ok(response) : StatusCode(403, response);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\UsuarioController.cs --- 
--- NOMBRE: UsuarioController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Mvc;

namespace IntegraPro.API.Controllers;

[ApiController]
[Route("api/[controller]")]
public class UsuarioController : ControllerBase
{
    private readonly IUsuarioService _usuarioService;

    public UsuarioController(IUsuarioService usuarioService)
    {
        _usuarioService = usuarioService;
    }

    [HttpPost("login")]
    public ActionResult<ApiResponse<UsuarioDTO>> Login([FromBody] LoginRequest request)
    {
        var result = _usuarioService.Login(request.Username, request.Password);

        // Cambiado de .Success a .Result
        if (result.Result)
        {
            return Ok(result);
        }

        if (result.Message == "SESION_ABIERTA_OTRO_EQUIPO")
        {
            return Conflict(result);
        }

        return BadRequest(result);
    }

    [HttpPost("forzar-cierre-sesion")]
    public ActionResult<ApiResponse<bool>> ForzarCierre([FromBody] LoginRequest request)
    {
        var result = _usuarioService.ForzarCierreSesion(request.Username, request.Password);

        if (result.Result) // Cambiado a .Result
        {
            return Ok(result);
        }

        return BadRequest(result);
    }

    [HttpPost("registrar")]
    public ActionResult<ApiResponse<bool>> Registrar([FromBody] UsuarioDTO usuario)
    {
        var result = _usuarioService.Registrar(usuario);

        if (result.Result) // Cambiado a .Result
        {
            return Ok(result);
        }

        return BadRequest(result);
    }

    [HttpPost("logout/{id}")]
    public ActionResult<ApiResponse<bool>> Logout(int id)
    {
        var result = _usuarioService.Logout(id);

        if (result.Result) // Cambiado a .Result
        {
            return Ok(result);
        }

        return BadRequest(result);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Filters\LicenseFilter.cs --- 
--- NOMBRE: LicenseFilter.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Services;
using IntegraPro.DataAccess.Factory;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Filters;
using System.Security.Claims;

namespace IntegraPro.API.Filters;

public class LicenseFilter : IAuthorizationFilter
{
    private readonly LicenciaService _licenciaService;
    private readonly UsuarioFactory _usuarioFactory;

    public LicenseFilter(LicenciaService licenciaService, UsuarioFactory usuarioFactory)
    {
        _licenciaService = licenciaService;
        _usuarioFactory = usuarioFactory;
    }

    public void OnAuthorization(AuthorizationFilterContext context)
    {
        // =================================================================================
        // EXCEPCI√ìN: Permitir el paso libre a los endpoints de Activaci√≥n
        // =================================================================================
        var path = context.HttpContext.Request.Path.Value?.ToLower() ?? "";

        // Si la URL contiene "licencia", permitimos el acceso sin validar hardware ni sesi√≥n
        if (path.Contains("/api/licencia"))
        {
            return;
        }

        // 1. VALIDACI√ìN DE HARDWARE (¬øLa PC tiene permiso de usar el software?)
        var validacionHardware = _licenciaService.ValidarSistema();
        string hidActual = _licenciaService.GetHardwareId();

        if (!validacionHardware.Result)
        {
            context.Result = new ObjectResult(new
            {
                Result = false,
                Message = "EQUIPO_NO_AUTORIZADO",
                Details = "Esta computadora no cuenta con una licencia activa."
            })
            { StatusCode = 403 };
            return;
        }

        // 2. VALIDACI√ìN DE SESI√ìN √öNICA (¬øEs este usuario el que se logue√≥ en esta PC?)
        var username = context.HttpContext.User.Identity?.Name;

        if (!string.IsNullOrEmpty(username))
        {
            var usuario = _usuarioFactory.GetByUsername(username);

            if (usuario != null && !string.IsNullOrEmpty(usuario.HardwareIdSesion))
            {
                if (usuario.HardwareIdSesion != hidActual)
                {
                    context.Result = new ObjectResult(new
                    {
                        Result = false,
                        Message = "SESION_INVALIDA_OTRO_EQUIPO",
                        Details = "Tu sesi√≥n ha sido abierta en otra computadora. Se ha cerrado el acceso aqu√≠."
                    })
                    { StatusCode = 401 };
                }
            }
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\obj\Debug\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
--- NOMBRE: .NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
 
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\obj\Debug\net9.0\IntegraPro.API.AssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.API.AssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("IntegraPro.API")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0+fc3d0a092d39c0a95b12dc0dfec5f0046b936a05")]
[assembly: System.Reflection.AssemblyProductAttribute("IntegraPro.API")]
[assembly: System.Reflection.AssemblyTitleAttribute("IntegraPro.API")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\obj\Debug\net9.0\IntegraPro.API.GlobalUsings.g.cs --- 
--- NOMBRE: IntegraPro.API.GlobalUsings.g.cs --- 
 
// <auto-generated/>
global using global::Microsoft.AspNetCore.Builder;
global using global::Microsoft.AspNetCore.Hosting;
global using global::Microsoft.AspNetCore.Http;
global using global::Microsoft.AspNetCore.Routing;
global using global::Microsoft.Extensions.Configuration;
global using global::Microsoft.Extensions.DependencyInjection;
global using global::Microsoft.Extensions.Hosting;
global using global::Microsoft.Extensions.Logging;
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Net.Http.Json;
global using global::System.Threading;
global using global::System.Threading.Tasks;
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\obj\Debug\net9.0\IntegraPro.API.MvcApplicationPartsAssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.API.MvcApplicationPartsAssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: Microsoft.AspNetCore.Mvc.ApplicationParts.ApplicationPartAttribute("Microsoft.AspNetCore.OpenApi")]
[assembly: Microsoft.AspNetCore.Mvc.ApplicationParts.ApplicationPartAttribute("Swashbuckle.AspNetCore.SwaggerGen")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Class1.cs --- 
--- NOMBRE: Class1.cs --- 
 
Ôªønamespace IntegraPro.AppLogic;

public class Class1
{

}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\IProductoService.cs --- 
--- NOMBRE: IProductoService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Interfaces;

public interface IProductoService
{
    ApiResponse<List<ProductoDTO>> ObtenerTodos();
    ApiResponse<ProductoDTO> ObtenerPorId(int id);
    ApiResponse<bool> Crear(ProductoDTO producto);
    ApiResponse<bool> Actualizar(ProductoDTO producto);
    ApiResponse<List<ProductoDTO>> ObtenerAlertasStock();
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\IUsuarioService.cs --- 
--- NOMBRE: IUsuarioService.cs --- 
 
Ôªøusing IntegraPro.DTO.Models;
using IntegraPro.AppLogic.Utils;

namespace IntegraPro.AppLogic.Interfaces;

public interface IUsuarioService
{
    ApiResponse<UsuarioDTO> Login(string username, string password);
    ApiResponse<bool> Registrar(UsuarioDTO usuario);

    // A√±adimos los m√©todos que faltaban
    ApiResponse<bool> Logout(int usuarioId);
    ApiResponse<bool> ForzarCierreSesion(string username, string password);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\obj\Debug\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
--- NOMBRE: .NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
 
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\obj\Debug\net9.0\IntegraPro.AppLogic.AssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.AppLogic.AssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("IntegraPro.AppLogic")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0+fc3d0a092d39c0a95b12dc0dfec5f0046b936a05")]
[assembly: System.Reflection.AssemblyProductAttribute("IntegraPro.AppLogic")]
[assembly: System.Reflection.AssemblyTitleAttribute("IntegraPro.AppLogic")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\obj\Debug\net9.0\IntegraPro.AppLogic.GlobalUsings.g.cs --- 
--- NOMBRE: IntegraPro.AppLogic.GlobalUsings.g.cs --- 
 
// <auto-generated/>
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Threading;
global using global::System.Threading.Tasks;
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\LicenciaService.cs --- 
--- NOMBRE: LicenciaService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;
using System.Management;
using Microsoft.Data.SqlClient;
using System.Data;
using System.Security.Cryptography;
using System.Text;

namespace IntegraPro.AppLogic.Services;

public class LicenciaService
{
    private readonly ConfiguracionFactory _factory;

    // Esta llave debe ser la misma en tu generador de licencias privado
    private readonly string _masterKey = "IntegraPro_Secret_2026";

    // URL para bloquear clientes morosos o licencias robadas (formato: lista de RUCs separados por comas o lineas)
    private readonly string _killSwitchUrl = "https://tu-servidor-remoto.com/blacklist.txt";

    public LicenciaService(ConfiguracionFactory factory)
    {
        _factory = factory;
    }

    /// <summary>
    /// Activa el sistema por primera vez vincul√°ndolo al Hardware ID principal.
    /// </summary>
    public ApiResponse<bool> ActivarLicencia(string llaveActivacion, string nombreEmpresa, string ruc, int maxEquipos)
    {
        try
        {
            string hidActual = GetHardwareId();
            string llaveEsperada = GenerarLlave(ruc, hidActual, maxEquipos);

            if (llaveActivacion != llaveEsperada)
            {
                return new ApiResponse<bool>(false, "La llave de activaci√≥n es inv√°lida para este equipo o los datos no coinciden.");
            }

            _factory.RegistrarConfiguracionInicial(nombreEmpresa, ruc, maxEquipos, hidActual);

            return new ApiResponse<bool>(true, "¬°Sistema activado con √©xito!", true);
        }
        catch (Exception ex)
        {
            return new ApiResponse<bool>(false, $"Error al activar: {ex.Message}");
        }
    }

    /// <summary>
    /// Algoritmo de generaci√≥n de llaves (debe ser id√©ntico en tu generador externo)
    /// </summary>
    public string GenerarLlave(string ruc, string hid, int maxEquipos)
    {
        using (var sha = SHA256.Create())
        {
            // El formato es RUC-HID-MAX-KEY
            string rawData = $"{ruc.Trim()}-{hid.Trim()}-{maxEquipos}-{_masterKey}";
            byte[] bytes = sha.ComputeHash(Encoding.UTF8.GetBytes(rawData));

            // Retornamos un c√≥digo corto de 16 caracteres para facilidad del usuario
            return Convert.ToBase64String(bytes)
                .Replace("+", "")
                .Replace("/", "")
                .Replace("=", "")
                .Substring(0, 16)
                .ToUpper();
        }
    }

    /// <summary>
    /// Valida si el equipo actual tiene permiso de ejecuci√≥n.
    /// </summary>
    public ApiResponse<bool> ValidarSistema()
    {
        try
        {
            string hid = GetHardwareId();
            DataTable dt = _factory.ValidarLicenciaMultiEquipo(hid);

            if (dt != null && dt.Rows.Count > 0)
            {
                string resultado = dt.Rows[0]["Resultado"]?.ToString() ?? "";
                string rucRegistrado = dt.Rows[0]["Ruc"]?.ToString() ?? "";

                if (resultado == "EQUIPO_AUTORIZADO" || resultado == "NUEVO_EQUIPO_REGISTRADO")
                {
                    // Validaci√≥n de seguridad adicional (Remota)
                    if (!string.IsNullOrEmpty(rucRegistrado))
                    {
                        if (EstaEnListaNegra(rucRegistrado))
                        {
                            return new ApiResponse<bool>(false, "Licencia revocada: Por favor contacte al soporte t√©cnico.");
                        }
                    }

                    return new ApiResponse<bool>(true, $"Acceso concedido", true);
                }

                if (resultado == "LIMITE_ALCANZADO")
                {
                    return new ApiResponse<bool>(false, "Se ha alcanzado el l√≠mite de equipos permitidos para esta licencia.");
                }
            }

            return new ApiResponse<bool>(false, "Sistema no activado o hardware no reconocido.");
        }
        catch (Exception ex)
        {
            return new ApiResponse<bool>(false, $"Error cr√≠tico de seguridad: {ex.Message}");
        }
    }

    /// <summary>
    /// Obtiene el Identificador √∫nico de Hardware (HID)
    /// </summary>
    public string GetHardwareId()
    {
        string serial = "";
        try
        {
            // Intentar con Serial de la Placa Base (Motherboard)
            serial = GetWmiProperty("Win32_BaseBoard", "SerialNumber");

            // Fallback 1: BIOS
            if (EsInvalido(serial)) serial = GetWmiProperty("Win32_BIOS", "SerialNumber");

            // Fallback 2: ID del Procesador
            if (EsInvalido(serial)) serial = GetWmiProperty("Win32_Processor", "ProcessorId");

            // Fallback Final: Nombre de la m√°quina (Menos seguro pero funcional)
            if (EsInvalido(serial)) serial = $"PC-{Environment.MachineName.ToUpper()}";
        }
        catch
        {
            serial = $"FB-{Environment.MachineName.ToUpper()}";
        }
        return serial.Trim();
    }

    private bool EstaEnListaNegra(string ruc)
    {
        try
        {
            using (var client = new HttpClient())
            {
                client.Timeout = TimeSpan.FromSeconds(2); // No bloqueamos al usuario si no hay internet
                var response = client.GetStringAsync(_killSwitchUrl).Result;
                return response.Contains(ruc);
            }
        }
        catch
        {
            return false; // Si falla el internet, permitimos seguir trabajando localmente
        }
    }

    private string GetWmiProperty(string table, string property)
    {
        try
        {
            // Nota: Requiere NuGet System.Management
            using (ManagementObjectSearcher searcher = new ManagementObjectSearcher($"SELECT {property} FROM {table}"))
            {
                foreach (ManagementObject obj in searcher.Get())
                {
                    return obj[property]?.ToString()?.Trim() ?? "";
                }
            }
        }
        catch { }
        return "";
    }

    private bool EsInvalido(string sid)
    {
        if (string.IsNullOrWhiteSpace(sid)) return true;
        string val = sid.ToLower();
        return val == "default string" || val == "none" || val == "to be filled by o.e.m." ||
               val == "00000000" || val == "unknown" || val.Length < 5;
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\ProductoService.cs --- 
--- NOMBRE: ProductoService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class ProductoService : IProductoService
{
    private readonly ProductoFactory _factory;

    public ProductoService(ProductoFactory factory)
    {
        _factory = factory;
    }

    public ApiResponse<List<ProductoDTO>> ObtenerTodos()
    {
        try
        {
            var lista = _factory.GetAll();
            return new ApiResponse<List<ProductoDTO>>(true, "Productos recuperados con √©xito", lista);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "ObtenerTodosProductos", ex.Message);
            return new ApiResponse<List<ProductoDTO>>(false, $"Error al obtener productos: {ex.Message}");
        }
    }

    public ApiResponse<bool> Crear(ProductoDTO producto)
    {
        try
        {
            // Validaciones b√°sicas
            Guard.AgainstEmptyString(producto.Nombre, "Nombre del Producto");
            if (producto.Precio1 < 0) return new ApiResponse<bool>(false, "El precio no puede ser negativo");

            // 1. Insertar el producto en la tabla PRODUCTO
            // El factory debe devolver el ID generado (SCOPE_IDENTITY)
            int nuevoProductoId = _factory.Create(producto);

            // 2. Si el producto es elaborado (tiene receta), guardamos su composici√≥n
            if (producto.EsElaborado && producto.Receta != null && producto.Receta.Any())
            {
                foreach (var item in producto.Receta)
                {
                    // Guardamos cada material asociado al producto padre
                    _factory.InsertarComposicion(nuevoProductoId, item.MaterialId, item.CantidadNecesaria);
                }
                Logger.WriteLog("Inventario", "CrearProducto", $"Producto elaborado '{producto.Nombre}' creado con {producto.Receta.Count} materiales.");
            }
            else
            {
                Logger.WriteLog("Inventario", "CrearProducto", $"Producto simple '{producto.Nombre}' creado.");
            }

            return new ApiResponse<bool>(true, "Producto registrado correctamente", true);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "CrearProducto", ex.Message);
            return new ApiResponse<bool>(false, $"Error al crear producto: {ex.Message}");
        }
    }

    public ApiResponse<List<ProductoDTO>> ObtenerAlertasStock()
    {
        try
        {
            // Utiliza la vista VW_ALERTA_STOCK_BAJO definida en tu SQL
            var alertas = _factory.GetStockAlerts();
            return new ApiResponse<List<ProductoDTO>>(true, "Alertas de stock bajo obtenidas", alertas);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "ObtenerAlertasStock", ex.Message);
            return new ApiResponse<List<ProductoDTO>>(false, ex.Message);
        }
    }

    public ApiResponse<ProductoDTO> ObtenerPorId(int id)
    {
        try
        {
            var producto = _factory.GetById(id);
            if (producto == null) return new ApiResponse<ProductoDTO>(false, "Producto no encontrado");
            return new ApiResponse<ProductoDTO>(true, "Producto encontrado", producto);
        }
        catch (Exception ex)
        {
            return new ApiResponse<ProductoDTO>(false, ex.Message);
        }
    }

    public ApiResponse<bool> Actualizar(ProductoDTO producto)
    {
        try
        {
            _factory.Update(producto);
            return new ApiResponse<bool>(true, "Producto actualizado con √©xito", true);
        }
        catch (Exception ex)
        {
            return new ApiResponse<bool>(false, ex.Message);
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\UsuarioService.cs --- 
--- NOMBRE: UsuarioService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class UsuarioService : IUsuarioService
{
    private readonly UsuarioFactory _factory;
    private readonly LicenciaService _licenciaService;

    public UsuarioService(UsuarioFactory factory, LicenciaService licenciaService)
    {
        _factory = factory;
        _licenciaService = licenciaService;
    }

    public ApiResponse<UsuarioDTO> Login(string username, string password)
    {
        try
        {
            Guard.AgainstEmptyString(username, nameof(username));
            Guard.AgainstEmptyString(password, nameof(password));

            var usuario = _factory.GetByUsername(username);
            if (usuario == null || !usuario.Activo)
                return new ApiResponse<UsuarioDTO>(false, "Credenciales incorrectas o usuario inactivo");

            // 1. Verificar contrase√±a
            if (!PasswordHasher.VerifyPassword(password, usuario.PasswordHash))
            {
                Logger.WriteLog("Seguridad", "Login Fallido", $"Intento fallido: {username}");
                return new ApiResponse<UsuarioDTO>(false, "Credenciales incorrectas");
            }

            // 2. L√ìGICA DE SESI√ìN √öNICA LIGADA AL HARDWARE
            string hidActual = _licenciaService.GetHardwareId();

            if (!string.IsNullOrEmpty(usuario.HardwareIdSesion) && usuario.HardwareIdSesion != hidActual)
            {
                Logger.WriteLog("Seguridad", "Bloqueo Sesi√≥n", $"Usuario {username} intent√≥ entrar desde otra PC.");
                return new ApiResponse<UsuarioDTO>(false, "SESION_ABIERTA_OTRO_EQUIPO");
            }

            // 3. Registrar el Hardware ID en la sesi√≥n
            _factory.ActualizarSesionHardware(usuario.Id, hidActual);

            // 4. --- NUEVO: REGISTRAR FECHA Y HORA DEL √öLTIMO LOGIN ---
            _factory.RegistrarLogin(usuario.Id);

            // Actualizamos el objeto en memoria para que la respuesta de la API no sea null
            usuario.UltimoLogin = DateTime.Now;
            usuario.HardwareIdSesion = hidActual;
            usuario.PasswordHash = string.Empty; // Seguridad: No devolver el hash

            Logger.WriteLog("Seguridad", "Login Exitoso", $"Usuario {username} ha ingresado en equipo {hidActual}.");

            return new ApiResponse<UsuarioDTO>(true, "Acceso concedido", usuario);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "Login", ex.Message);
            return new ApiResponse<UsuarioDTO>(false, $"Error interno: {ex.Message}");
        }
    }

    public ApiResponse<bool> ForzarCierreSesion(string username, string password)
    {
        try
        {
            var usuario = _factory.GetByUsername(username);

            if (usuario != null && PasswordHasher.VerifyPassword(password, usuario.PasswordHash))
            {
                _factory.ActualizarSesionHardware(usuario.Id, null);
                Logger.WriteLog("Seguridad", "Forzar Cierre", $"Sesiones liberadas para el usuario: {username}");
                return new ApiResponse<bool>(true, "Sesiones liberadas. Ya puede reintentar el login.", true);
            }

            return new ApiResponse<bool>(false, "Credenciales inv√°lidas para realizar esta acci√≥n.");
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "ForzarCierre", ex.Message);
            return new ApiResponse<bool>(false, $"Error al forzar cierre: {ex.Message}");
        }
    }

    public ApiResponse<bool> Logout(int usuarioId)
    {
        try
        {
            _factory.ActualizarSesionHardware(usuarioId, null);
            return new ApiResponse<bool>(true, "Sesi√≥n cerrada correctamente", true);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "Logout", ex.Message);
            return new ApiResponse<bool>(false, $"Error al cerrar sesi√≥n: {ex.Message}");
        }
    }

    public ApiResponse<bool> Registrar(UsuarioDTO usuario)
    {
        try
        {
            Guard.AgainstNull(usuario, nameof(usuario));
            Guard.AgainstEmptyString(usuario.Username, "Nombre de Usuario");

            if (string.IsNullOrEmpty(usuario.Password))
                return new ApiResponse<bool>(false, "La contrase√±a es obligatoria");

            var existente = _factory.GetByUsername(usuario.Username);
            if (existente != null)
                return new ApiResponse<bool>(false, "El nombre de usuario ya est√° en uso");

            usuario.PasswordHash = PasswordHasher.HashPassword(usuario.Password);
            _factory.Create(usuario);

            return new ApiResponse<bool>(true, "Usuario creado exitosamente", true);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "Registro", ex.Message);
            return new ApiResponse<bool>(false, ex.Message);
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Utils\ApiResponse.cs --- 
--- NOMBRE: ApiResponse.cs --- 
 
namespace IntegraPro.AppLogic.Utils;

public class ApiResponse<T>
{
    public T? Data { get; set; }
    public string Message { get; set; } = string.Empty;
    public bool Result { get; set; }

    public ApiResponse(bool result, string message, T? data = default)
    {
        Result = result;
        Message = message;
        Data = data;
    }
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Utils\Guard.cs --- 
--- NOMBRE: Guard.cs --- 
 
namespace IntegraPro.AppLogic.Utils;

public static class Guard
{
    public static void AgainstNull(object? input, string parameterName)
    {
        if (input == null)
            throw new ArgumentNullException(parameterName, $"{parameterName} no puede ser nulo.");
    }

    public static void AgainstEmptyString(string input, string parameterName)
    {
        if (string.IsNullOrWhiteSpace(input))
            throw new ArgumentException($"{parameterName} no puede estar vacio.", parameterName);
    }

    public static string GenerateReadableId(string prefix)
    {
        return $"{prefix}-{Guid.NewGuid().ToString()[..8].ToUpper()}";
    }
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Utils\Logger.cs --- 
--- NOMBRE: Logger.cs --- 
 
namespace IntegraPro.AppLogic.Utils;

public static class Logger
{
    private static readonly string LogPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "logs.txt");

    public static void WriteLog(string modulo, string accion, string detalle)
    {
        try
        {
            string logLine = $"[{DateTime.Now:yyyy-MM-dd HH:mm:ss}] | {modulo} | {accion} | {detalle}{Environment.NewLine}";
            File.AppendAllText(LogPath, logLine);
        }
        catch { /* Fallback silencioso si el archivo esta bloqueado */ }
    }
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Utils\PasswordHasher.cs --- 
--- NOMBRE: PasswordHasher.cs --- 
 
using System.Security.Cryptography;

namespace IntegraPro.AppLogic.Utils;

public static class PasswordHasher
{
    private const int SaltSize = 16; // 128 bit
    private const int KeySize = 32;  // 256 bit
    private const int Iterations = 100000;
    private static readonly HashAlgorithmName _hashAlgorithm = HashAlgorithmName.SHA256;

    public static string HashPassword(string password)
    {
        byte[] salt = RandomNumberGenerator.GetBytes(SaltSize);
        byte[] hash = Rfc2898DeriveBytes.Pbkdf2(password, salt, Iterations, _hashAlgorithm, KeySize);

        return $"{Convert.ToHexString(salt)}.{Convert.ToHexString(hash)}";
    }

    public static bool VerifyPassword(string password, string hashedPassword)
    {
        string[] parts = hashedPassword.Split('.');
        byte[] salt = Convert.FromHexString(parts[0]);
        byte[] hash = Convert.FromHexString(parts[1]);

        byte[] inputHash = Rfc2898DeriveBytes.Pbkdf2(password, salt, Iterations, _hashAlgorithm, KeySize);

        return CryptographicOperations.FixedTimeEquals(hash, inputHash);
    }
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Class1.cs --- 
--- NOMBRE: Class1.cs --- 
 
Ôªønamespace IntegraPro.DataAccess;

public class Class1
{

}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Dao\MasterDao.cs --- 
--- NOMBRE: MasterDao.cs --- 
 
Ôªøusing System.Data;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Dao;

public abstract class MasterDao
{
    private readonly string _connectionString;

    protected MasterDao(string connectionString)
    {
        _connectionString = connectionString;
    }

    protected SqlConnection GetConnection() => new SqlConnection(_connectionString);

    // 1. Para consultas SELECT (devuelve tablas)
    protected DataTable ExecuteQuery(string query, SqlParameter[]? parameters = null, bool isStoredProcedure = true)
    {
        var table = new DataTable();
        using var connection = GetConnection();
        using var command = new SqlCommand(query, connection);

        if (isStoredProcedure)
            command.CommandType = CommandType.StoredProcedure;

        if (parameters != null)
            command.Parameters.AddRange(parameters);

        using var adapter = new SqlDataAdapter(command);
        adapter.Fill(table);
        return table;
    }

    // 2. Para INSERT que devuelven el ID generado (Indispensable para ProductoFactory)
    protected int ExecuteScalar(string spName, SqlParameter[]? parameters = null)
    {
        using var connection = GetConnection();
        using var command = new SqlCommand(spName, connection);
        command.CommandType = CommandType.StoredProcedure;

        if (parameters != null)
            command.Parameters.AddRange(parameters);

        connection.Open();
        var result = command.ExecuteScalar();
        return result != DBNull.Value ? Convert.ToInt32(result) : 0;
    }

    // 3. Para cambios directos (UPDATE, DELETE, INSERT simples)
    protected void ExecuteNonQuery(string query, SqlParameter[]? parameters = null, bool isStoredProcedure = true)
    {
        using var connection = GetConnection();
        using var command = new SqlCommand(query, connection);

        if (isStoredProcedure)
            command.CommandType = CommandType.StoredProcedure;

        if (parameters != null)
            command.Parameters.AddRange(parameters);

        connection.Open();
        command.ExecuteNonQuery();
    }

    // 4. Alias para compatibilidad con UsuarioFactory
    protected void ExecuteStoredProcedure(string spName, SqlParameter[] parameters)
    {
        ExecuteNonQuery(spName, parameters, true);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\CategoriaFactory.cs --- 
--- NOMBRE: CategoriaFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao; 
using IntegraPro.DTO.Models;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class CategoriaFactory : MasterDao
{
    public CategoriaFactory(string connectionString) : base(connectionString) { }

    public List<CategoriaDTO> GetAll()
    {
        var dt = ExecuteQuery("SELECT * FROM CATEGORIA");
        var lista = new List<CategoriaDTO>();
        foreach (DataRow row in dt.Rows)
        {
            lista.Add(new CategoriaDTO
            {
                Id = Convert.ToInt32(row["id"]),
                Nombre = row["nombre"].ToString() ?? "",
                Descripcion = row["descripcion"]?.ToString()
            });
        }
        return lista;
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\ConfiguracionFactory.cs --- 
--- NOMBRE: ConfiguracionFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class ConfiguracionFactory : MasterDao
{
    public ConfiguracionFactory(string connectionString) : base(connectionString) { }

    /// <summary>
    /// Registra la licencia inicial en la base de datos tras validar la llave de activaci√≥n.
    /// </summary>
    public void RegistrarConfiguracionInicial(string nombreEmpresa, string ruc, int maxEquipos, string hid)
    {
        var parameters = new Microsoft.Data.SqlClient.SqlParameter[] {
        new Microsoft.Data.SqlClient.SqlParameter("@nombre_empresa", nombreEmpresa),
        new Microsoft.Data.SqlClient.SqlParameter("@ruc", ruc),
        new Microsoft.Data.SqlClient.SqlParameter("@max_equipos", maxEquipos),
        new Microsoft.Data.SqlClient.SqlParameter("@hid_principal", hid)
    };

        // Llamamos al SP que creamos en SQL Server para que inserte Empresa y Sucursal
        ExecuteNonQuery("sp_Configuracion_ActivarSistema", parameters);
    }

    /// <summary>
    /// Llama al SP multinivel para validar si el equipo actual tiene acceso o si se debe auto-registrar.
    /// </summary>
    public DataTable ValidarLicenciaMultiEquipo(string hardwareId)
    {
        var parameters = new SqlParameter[]
        {
            new SqlParameter("@hardware_id", hardwareId)
        };

        return ExecuteQuery("sp_Licencia_AutoValidar_MultiEquipo", parameters);
    }

    /// <summary>
    /// Guarda los datos comerciales de la empresa.
    /// </summary>
    public void GuardarEmpresa(EmpresaDTO empresa)
    {
        var p = new SqlParameter[] {
            new SqlParameter("@nombre_comercial", empresa.NombreComercial),
            new SqlParameter("@razon_social", empresa.NombreComercial), // Usamos NombreComercial como RazonSocial para evitar error de propiedad
            new SqlParameter("@cedula_juridica", empresa.CedulaJuridica),
            new SqlParameter("@tipo_regimen", empresa.TipoRegimen),
            new SqlParameter("@telefono", "00000000"),
            new SqlParameter("@correo_notificaciones", empresa.CorreoNotificaciones),
            new SqlParameter("@sitio_web", "")
        };

        ExecuteNonQuery("sp_Empresa_Upsert", p);
    }

    /// <summary>
    /// M√©todo de legado para obtener licencia simple.
    /// </summary>
    public LicenciaDTO? ObtenerLicencia(string hardwareId)
    {
        var p = new SqlParameter[] { new SqlParameter("@hardware_id", hardwareId) };
        var dt = ExecuteQuery("sp_Licencia_Validar", p);

        if (dt.Rows.Count == 0) return null;

        var row = dt.Rows[0];
        return new LicenciaDTO
        {
            HardwareId = row["hardware_id"].ToString()!,
            Estado = row["estado"].ToString()!,
            FechaVencimiento = Convert.ToDateTime(row["fecha_vencimiento"])
        };
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\ProductoFactory.cs --- 
--- NOMBRE: ProductoFactory.cs --- 
 
Ôªø
using IntegraPro.DataAccess.Dao;
using IntegraPro.DataAccess.Mappers;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class ProductoFactory : MasterDao
{
    private readonly ProductoMapper _mapper;

    public ProductoFactory(string connectionString) : base(connectionString)
    {
        _mapper = new ProductoMapper();
    }

    public List<ProductoDTO> GetAll()
    {
        var dt = ExecuteQuery("SELECT * FROM PRODUCTO WHERE activo = 1");
        var lista = new List<ProductoDTO>();
        foreach (DataRow row in dt.Rows) lista.Add(_mapper.MapFromRow(row));
        return lista;
    }

    public ProductoDTO? GetById(int id)
    {
        var parameters = new[] { new SqlParameter("@id", id) };
        var dt = ExecuteQuery("SELECT * FROM PRODUCTO WHERE id = @id", parameters);
        return dt.Rows.Count > 0 ? _mapper.MapFromRow(dt.Rows[0]) : null;
    }

    public int Create(ProductoDTO producto)
    {
        // Nota: Aseg√∫rate de tener el SP sp_Producto_Insert en SQL que haga el INSERT y devuelva SCOPE_IDENTITY()
        return ExecuteScalar("sp_Producto_Insert", _mapper.MapToParameters(producto));
    }

    public void Update(ProductoDTO producto)
    {
        ExecuteNonQuery("sp_Producto_Update", _mapper.MapToParameters(producto), true);
    }

    public void InsertarComposicion(int padreId, int materialId, decimal cantidad)
    {
        var parameters = new[]
        {
            new SqlParameter("@producto_padre_id", padreId),
            new SqlParameter("@material_id", materialId),
            new SqlParameter("@cantidad_necesaria", cantidad)
        };
        ExecuteNonQuery("INSERT INTO PRODUCTO_COMPOSICION (producto_padre_id, material_id, cantidad_necesaria) VALUES (@producto_padre_id, @material_id, @cantidad_necesaria)", parameters);
    }

    public List<ProductoDTO> GetStockAlerts()
    {
        var dt = ExecuteQuery("SELECT * FROM VW_ALERTA_STOCK_BAJO");
        var lista = new List<ProductoDTO>();
        foreach (DataRow row in dt.Rows)
        {
            lista.Add(new ProductoDTO
            {
                Id = Convert.ToInt32(row["id"]),
                Nombre = row["nombre"].ToString() ?? "",
                Existencia = Convert.ToDecimal(row["existencia"]),
                StockMinimo = Convert.ToDecimal(row["stock_minimo"])
            });
        }
        return lista;
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\UsuarioFactory.cs --- 
--- NOMBRE: UsuarioFactory.cs --- 
 
Ôªøusing System.Data;
using IntegraPro.DataAccess.Dao;
using IntegraPro.DataAccess.Mappers;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Factory;

public class UsuarioFactory : MasterDao
{
    private readonly UsuarioMapper _mapper;

    public UsuarioFactory(string connectionString) : base(connectionString)
    {
        _mapper = new UsuarioMapper();
    }

    /// <summary>
    /// Obtiene un usuario por su nombre de usuario. 
    /// Utilizado por el Login y por el LicenseFilter para validar la sesi√≥n activa.
    /// </summary>
    public UsuarioDTO? GetByUsername(string username)
    {
        var parameters = new SqlParameter[] {
            new SqlParameter("@username", username)
        };

        var table = ExecuteQuery("sp_Usuario_GetByUsername", parameters);

        if (table.Rows.Count == 0) return null;

        return _mapper.MapFromRow(table.Rows[0]);
    }

    public void Create(UsuarioDTO usuario)
    {
        // Definimos exactamente los 7 par√°metros que espera tu SP
        var parameters = new SqlParameter[] {
        new SqlParameter("@id", 0), // El SP lo pide pero no lo usa
        new SqlParameter("@rol_id", usuario.RolId),
        new SqlParameter("@sucursal_id", usuario.SucursalId),
        new SqlParameter("@nombre_completo", usuario.NombreCompleto),
        new SqlParameter("@username", usuario.Username),
        new SqlParameter("@password_hash", usuario.PasswordHash),
        new SqlParameter("@activo", usuario.Activo)
    };

        // Ejecutamos el procedimiento
        ExecuteStoredProcedure("sp_Usuario_Insert", parameters);
    }

    /// <summary>
    /// Registra o limpia el Hardware ID asociado a la sesi√≥n activa del usuario.
    /// </summary>
    /// <param name="usuarioId">ID del usuario en la base de datos.</param>
    /// <param name="hardwareId">ID de la PC. Si es null, libera la sesi√≥n (Logout).</param>
    public void ActualizarSesionHardware(int usuarioId, string? hardwareId)
    {
        var parameters = new SqlParameter[] {
            new SqlParameter("@id", usuarioId),
            // Si hardwareId es null, enviamos DBNull.Value a SQL para limpiar el campo
            new SqlParameter("@hardware_id_sesion", (object?)hardwareId ?? DBNull.Value)
        };

        // Ejecuta el procedimiento almacenado que actualiza la tabla USUARIO
        ExecuteNonQuery("sp_Usuario_ActualizarSesion", parameters);
    }

    public void RegistrarLogin(int usuarioId)
    {
        var parameters = new Microsoft.Data.SqlClient.SqlParameter[] {
        new Microsoft.Data.SqlClient.SqlParameter("@id", usuarioId)
    };
        ExecuteNonQuery("sp_Usuario_RegistrarLogin", parameters);
    }

}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Mappers\IMapper.cs --- 
--- NOMBRE: IMapper.cs --- 
 
Ôªøusing System.Data;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Mappers;

public interface IMapper<T>
{
    T MapFromRow(DataRow row);
    SqlParameter[] MapToParameters(T entity);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Mappers\ProductoMapper.cs --- 
--- NOMBRE: ProductoMapper.cs --- 
 
Ôªøusing System.Data;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Mappers;

public class ProductoMapper : IMapper<ProductoDTO>
{
    public ProductoDTO MapFromRow(DataRow row)
    {
        return new ProductoDTO
        {
            Id = Convert.ToInt32(row["id"]),
            CategoriaId = Convert.ToInt32(row["categoria_id"]),
            CodCabys = row["cod_cabys"]?.ToString(),
            CodigoBarras = row["codigo_barras"]?.ToString(),
            Nombre = row["nombre"].ToString() ?? "",
            Descripcion = row["descripcion"]?.ToString(),
            UnidadMedida = row["unidad_medida"].ToString() ?? "Unid",
            CostoActual = Convert.ToDecimal(row["costo_actual"]),
            Precio1 = Convert.ToDecimal(row["precio_1"]),
            Existencia = Convert.ToDecimal(row["existencia"]),
            StockMinimo = Convert.ToDecimal(row["stock_minimo"]),
            EsServicio = Convert.ToBoolean(row["es_servicio"]),
            EsElaborado = Convert.ToBoolean(row["es_elaborado"]),
            Activo = Convert.ToBoolean(row["activo"])
        };
    }

    public SqlParameter[] MapToParameters(ProductoDTO entity)
    {
        return new SqlParameter[]
        {
            new SqlParameter("@id", entity.Id),
            new SqlParameter("@categoria_id", entity.CategoriaId),
            new SqlParameter("@cod_cabys", entity.CodCabys ?? (object)DBNull.Value),
            new SqlParameter("@codigo_barras", entity.CodigoBarras ?? (object)DBNull.Value),
            new SqlParameter("@nombre", entity.Nombre),
            new SqlParameter("@descripcion", entity.Descripcion ?? (object)DBNull.Value),
            new SqlParameter("@unidad_medida", entity.UnidadMedida),
            new SqlParameter("@costo_actual", entity.CostoActual),
            new SqlParameter("@precio_1", entity.Precio1),
            new SqlParameter("@existencia", entity.Existencia),
            new SqlParameter("@stock_minimo", entity.StockMinimo),
            new SqlParameter("@es_servicio", entity.EsServicio),
            new SqlParameter("@es_elaborado", entity.EsElaborado),
            new SqlParameter("@activo", entity.Activo)
        };
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Mappers\UsuarioMapper.cs --- 
--- NOMBRE: UsuarioMapper.cs --- 
 
Ôªøusing System.Data;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Mappers;

public class UsuarioMapper : IMapper<UsuarioDTO>
{
    public UsuarioDTO MapFromRow(DataRow row)
    {
        return new UsuarioDTO
        {
            Id = Convert.ToInt32(row["id"]),
            RolId = Convert.ToInt32(row["rol_id"]),
            SucursalId = Convert.ToInt32(row["sucursal_id"]),
            NombreCompleto = row["nombre_completo"]?.ToString() ?? "",
            Username = row["username"]?.ToString() ?? "",
            PasswordHash = row["password_hash"]?.ToString() ?? "",
            Activo = row["activo"] != DBNull.Value && Convert.ToBoolean(row["activo"]),
            UltimoLogin = row["ultimo_login"] != DBNull.Value ? Convert.ToDateTime(row["ultimo_login"]) : null,
            HardwareIdSesion = row.Table.Columns.Contains("hardware_id_sesion") && row["hardware_id_sesion"] != DBNull.Value
                               ? row["hardware_id_sesion"].ToString() : null
        };
    }

    public SqlParameter[] MapToParameters(UsuarioDTO entity)
    {
        return new SqlParameter[]
        {
            new SqlParameter("@id", entity.Id),
            new SqlParameter("@rol_id", entity.RolId),
            new SqlParameter("@sucursal_id", entity.SucursalId),
            new SqlParameter("@nombre_completo", entity.NombreCompleto ?? (object)DBNull.Value),
            new SqlParameter("@username", entity.Username ?? (object)DBNull.Value),
            new SqlParameter("@password_hash", entity.PasswordHash ?? (object)DBNull.Value),
            new SqlParameter("@activo", entity.Activo),
            new SqlParameter("@hardware_id_sesion", (object?)entity.HardwareIdSesion ?? DBNull.Value)
        };
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\obj\Debug\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
--- NOMBRE: .NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
 
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\obj\Debug\net9.0\IntegraPro.DataAccess.AssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.DataAccess.AssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("IntegraPro.DataAccess")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0+fc3d0a092d39c0a95b12dc0dfec5f0046b936a05")]
[assembly: System.Reflection.AssemblyProductAttribute("IntegraPro.DataAccess")]
[assembly: System.Reflection.AssemblyTitleAttribute("IntegraPro.DataAccess")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\obj\Debug\net9.0\IntegraPro.DataAccess.GlobalUsings.g.cs --- 
--- NOMBRE: IntegraPro.DataAccess.GlobalUsings.g.cs --- 
 
// <auto-generated/>
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Threading;
global using global::System.Threading.Tasks;
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Class1.cs --- 
--- NOMBRE: Class1.cs --- 
 
Ôªønamespace IntegraPro.DTO;

public class Class1
{

}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\CategoriaDTO.cs --- 
--- NOMBRE: CategoriaDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class CategoriaDTO
{
    public int Id { get; set; }
    public string Nombre { get; set; } = string.Empty;
    public string? Descripcion { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\ConfiguracionDTO.cs --- 
--- NOMBRE: ConfiguracionDTO.cs --- 
 
Ôªøusing System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace IntegraPro.DTO.Models;

public class EmpresaDTO
{
    public int Id { get; set; }
    public string NombreComercial { get; set; } = string.Empty;
    public string CedulaJuridica { get; set; } = string.Empty;
    public string CorreoNotificaciones { get; set; } = string.Empty;
    public string TipoRegimen { get; set; } = "Tradicional";
}

public class LicenciaDTO
{
    public string LicenciaKey { get; set; } = string.Empty;
    public string HardwareId { get; set; } = string.Empty;
    public DateTime FechaVencimiento { get; set; }
    public string Estado { get; set; } = "Demo";
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\ProductoDTO.cs --- 
--- NOMBRE: ProductoDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class ProductoDTO
{
    public int Id { get; set; }
    public int CategoriaId { get; set; }
    public string? CodCabys { get; set; }
    public string? CodigoBarras { get; set; }
    public string Nombre { get; set; } = string.Empty;
    public string? Descripcion { get; set; }
    public string UnidadMedida { get; set; } = "Unid"; // Unid, Kg, M2, M
    public decimal CostoActual { get; set; }
    public decimal Precio1 { get; set; }
    public decimal Existencia { get; set; }
    public decimal StockMinimo { get; set; }
    public bool EsServicio { get; set; }
    public bool EsElaborado { get; set; } // Si es TRUE, usa receta
    public bool Activo { get; set; }

    // Propiedad para manejar la receta/composici√≥n
    public List<ProductoComposicionDTO> Receta { get; set; } = new();
}

public class ProductoComposicionDTO
{
    public int MaterialId { get; set; }
    public string? MaterialNombre { get; set; }
    public decimal CantidadNecesaria { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\UsuarioDTO.cs --- 
--- NOMBRE: UsuarioDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class UsuarioDTO
{
    public int Id { get; set; }
    public int RolId { get; set; }
    public int SucursalId { get; set; }
    public string NombreCompleto { get; set; } = string.Empty;
    public string Username { get; set; } = string.Empty;
    public string? Password { get; set; }
    public string PasswordHash { get; set; } = string.Empty;
    public string CorreoElectronico { get; set; } = string.Empty;
    public bool Activo { get; set; }
    public DateTime? UltimoLogin { get; set; }

    // Nueva propiedad para control de sesi√≥n
    public string? HardwareIdSesion { get; set; }
}

// Clase de apoyo para recibir credenciales
public class LoginRequest
{
    public string Username { get; set; } = string.Empty;
    public string Password { get; set; } = string.Empty;
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\obj\Debug\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
--- NOMBRE: .NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
 
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\obj\Debug\net9.0\IntegraPro.DTO.AssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.DTO.AssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("IntegraPro.DTO")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0")]
[assembly: System.Reflection.AssemblyProductAttribute("IntegraPro.DTO")]
[assembly: System.Reflection.AssemblyTitleAttribute("IntegraPro.DTO")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\obj\Debug\net9.0\IntegraPro.DTO.GlobalUsings.g.cs --- 
--- NOMBRE: IntegraPro.DTO.GlobalUsings.g.cs --- 
 
// <auto-generated/>
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Threading;
global using global::System.Threading.Tasks;
.
