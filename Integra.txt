 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Program.cs --- 
--- NOMBRE: Program.cs --- 
 
using IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Services;
using IntegraPro.DataAccess.Factory;
using Microsoft.OpenApi.Models;
using IntegraPro.API.Filters;

var builder = WebApplication.CreateBuilder(args);

// ==========================================
// 1. CONFIGURACI”N DE CONEXI”N
// ==========================================
string connectionString = builder.Configuration.GetConnectionString("DefaultConnection")
    ?? "Server=DESKTOP-AR7JSQE\\SQLEXPRESS;Database=ERP_SistemaPro;Integrated Security=SSPI;TrustServerCertificate=True;";

// ==========================================
// 2. CONFIGURACI”N DE CORS (Agregado para evitar bloqueos)
// ==========================================
builder.Services.AddCors(options => {
    options.AddPolicy("AllowAll", policy => {
        policy.AllowAnyOrigin().AllowAnyMethod().AllowAnyHeader();
    });
});

// ==========================================
// 3. INYECCI”N DE DEPENDENCIAS (N-Capas)
// ==========================================

// --- Capa de Datos (Factories) ---
builder.Services.AddScoped(sp => new UsuarioFactory(connectionString));
builder.Services.AddScoped(sp => new ProductoFactory(connectionString));
builder.Services.AddScoped(sp => new CategoriaFactory(connectionString));
builder.Services.AddScoped(sp => new ConfiguracionFactory(connectionString));
builder.Services.AddScoped(sp => new InventarioFactory(connectionString));
builder.Services.AddScoped(sp => new VentaFactory(connectionString));
builder.Services.AddScoped(sp => new CajaFactory(connectionString));
builder.Services.AddScoped(sp => new ClienteFactory(connectionString));

// --- Capa de LÛgica (Services) ---
builder.Services.AddScoped<LicenciaService>();
builder.Services.AddScoped<IUsuarioService, UsuarioService>();
builder.Services.AddScoped<IProductoService, ProductoService>();
builder.Services.AddScoped<ICategoriaService, CategoriaService>();
builder.Services.AddScoped<IInventarioService, InventarioService>();

// AquÌ el contenedor inyectar· autom·ticamente VentaFactory, ClienteFactory y ProductoFactory
builder.Services.AddScoped<VentaService>();
builder.Services.AddScoped<CajaService>();

// ==========================================
// 4. SERVICIOS BASE DE LA API
// ==========================================
builder.Services.AddControllers(options =>
{
    options.Filters.Add<LicenseFilter>();
});

builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new OpenApiInfo
    {
        Title = "IntegraPro ERP - Sistema de GestiÛn General",
        Version = "v1",
        Description = "API para gestiÛn de inventarios, facturaciÛn y licenciamiento."
    });
});

var app = builder.Build();

// ==========================================
// 5. PIPELINE DE SOLICITUDES (Middlewares)
// ==========================================

// Usar CORS antes de MapControllers
app.UseCors("AllowAll");

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI(c =>
    {
        c.SwaggerEndpoint("/swagger/v1/swagger.json", "IntegraPro API v1");
    });
}

app.UseHttpsRedirection();
app.UseAuthentication();
app.UseAuthorization();
app.MapControllers();
app.Run();
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\AbonosController.cs --- 
--- NOMBRE: AbonosController.cs --- 
 
Ôªøusing Microsoft.AspNetCore.Mvc;
using IntegraPro.AppLogic.Services;
using IntegraPro.DTO.Models;

namespace IntegraPro.API.Controllers;

[Route("api/[controller]")]
[ApiController]
public class AbonosController(IConfiguration config) : ControllerBase
{
    private readonly AbonoService _abonoService = new(config.GetConnectionString("DefaultConnection")!);

    // --- NUEVO M√âTODO PARA CONSULTAR FACTURAS PENDIENTES ---
    // Se puede llamar como: api/Abonos/Pendientes o api/Abonos/Pendientes?clienteId=1
    [HttpGet("Pendientes")]
    public IActionResult GetPendientes([FromQuery] int? clienteId)
    {
        try
        {
            var pendientes = _abonoService.ObtenerPendientes(clienteId);
            return Ok(new { success = true, data = pendientes });
        }
        catch (Exception ex)
        {
            return BadRequest(new { success = false, message = ex.Message });
        }
    }

    [HttpPost("RegistrarAbono/{clienteId}")]
    public IActionResult Post([FromBody] AbonoDTO abono, int clienteId)
    {
        try
        {
            _abonoService.RegistrarAbono(abono, clienteId);
            return Ok(new { success = true, message = "Abono procesado correctamente." });
        }
        catch (Exception ex)
        {
            return BadRequest(new { success = false, message = ex.Message });
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\AuthController.cs --- 
--- NOMBRE: AuthController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Mvc;

namespace IntegraPro.API.Controllers;

[ApiController]
[Route("api/[controller]")]
public class AuthController : ControllerBase
{
    private readonly IUsuarioService _usuarioService;

    public AuthController(IUsuarioService usuarioService)
    {
        _usuarioService = usuarioService;
    }

    [HttpPost("login")]
    public ActionResult<ApiResponse<UsuarioDTO>> Login([FromBody] LoginRequest request)
    {
        var response = _usuarioService.Login(request.Username, request.Password);
        if (!response.Result)
            return BadRequest(response);

        return Ok(response);
    }

    [HttpPost("register")]
    public ActionResult<ApiResponse<bool>> Register([FromBody] UsuarioDTO usuario)
    {
        var response = _usuarioService.Registrar(usuario);
        if (!response.Result)
            return BadRequest(response);

        return Ok(response);
    }
}

public record LoginRequest(string Username, string Password);.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\CajaController.cs --- 
--- NOMBRE: CajaController.cs --- 
 
Ôªøusing Microsoft.AspNetCore.Mvc;
using IntegraPro.AppLogic.Services;
using IntegraPro.DTO.Models;

namespace IntegraPro.API.Controllers;

[Route("api/[controller]")]
[ApiController]
// Cambiamos el constructor para inyectar el CajaService directamente
public class CajaController(CajaService cajaService) : ControllerBase
{
    // Ya no usamos IConfiguration ni 'new', el sistema nos da el servicio listo
    private readonly CajaService _cajaService = cajaService;

    [HttpPost("Abrir")]
    public IActionResult Abrir([FromBody] CajaAperturaDTO apertura)
    {
        try
        {
            int id = _cajaService.AbrirCaja(apertura);
            return Ok(new { success = true, cajaId = id, message = "Caja abierta correctamente." });
        }
        catch (Exception ex)
        {
            return BadRequest(new { success = false, message = ex.Message });
        }
    }

    [HttpPost("Cerrar")]
    public IActionResult Cerrar([FromBody] CajaCierreDTO cierre)
    {
        try
        {
            _cajaService.CerrarCaja(cierre);
            return Ok(new { success = true, message = "Caja cerrada y liquidada exitosamente." });
        }
        catch (Exception ex)
        {
            return BadRequest(new { success = false, message = ex.Message });
        }
    }

    [HttpGet("Historial")]
    public IActionResult GetHistorial()
    {
        try
        {
            var historial = _cajaService.ObtenerHistorial();
            return Ok(new { success = true, data = historial });
        }
        catch (Exception ex)
        {
            return BadRequest(new { success = false, message = ex.Message });
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\CategoriaController.cs --- 
--- NOMBRE: CategoriaController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Mvc;

[ApiController]
[Route("api/[controller]")]
public class CategoriaController(ICategoriaService service) : ControllerBase
{
    [HttpGet] public IActionResult Get() => Ok(service.ObtenerTodas());
    [HttpPost] public IActionResult Post([FromBody] CategoriaDTO dto) => Ok(service.Crear(dto));
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\ClienteController.cs --- 
--- NOMBRE: ClienteController.cs --- 
 
Ôªøusing Microsoft.AspNetCore.Mvc;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.API.Controllers;

[Route("api/[controller]")]
[ApiController]
public class ClienteController(IConfiguration config) : ControllerBase
{
    // Usamos la cadena de conexi√≥n configurada en tu appsettings.json
    private readonly ClienteFactory _factory = new(config.GetConnectionString("DefaultConnection")!);

    [HttpGet]
    public IActionResult Get()
    {
        try
        {
            return Ok(_factory.ObtenerTodos());
        }
        catch (Exception ex)
        {
            return BadRequest(ex.Message);
        }
    }

    [HttpPost]
    public IActionResult Post([FromBody] ClienteDTO cliente)
    {
        try
        {
            int id = _factory.Insertar(cliente);
            return Ok(new { success = true, idCreated = id, message = "Cliente guardado." });
        }
        catch (Exception ex)
        {
            // √ötil para detectar si la identificaci√≥n ya existe (Unique Constraint)
            return BadRequest(new { success = false, message = "Error: " + ex.Message });
        }
    }

    [HttpPut]
    public IActionResult Put([FromBody] ClienteDTO cliente)
    {
        try
        {
            _factory.Actualizar(cliente);
            return Ok(new { success = true, message = "Cliente actualizado." });
        }
        catch (Exception ex)
        {
            return BadRequest(new { success = false, message = ex.Message });
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\InventarioController.cs --- 
--- NOMBRE: InventarioController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Mvc;

namespace IntegraPro.API.Controllers;

[ApiController]
[Route("api/[controller]")]
public class InventarioController(IInventarioService service) : ControllerBase
{
    [HttpPost]
    public IActionResult Post([FromBody] MovimientoInventarioDTO dto)
    {
        var result = service.Registrar(dto);
        return result.Result ? Ok(result) : BadRequest(result);
    }

    // NUEVO ENDPOINT: Para procesar la fabricaci√≥n de productos elaborados
    [HttpPost("producir")]
    public IActionResult Producir(int productoId, decimal cantidad, int usuarioId)
    {
        // Este m√©todo descontar√° materiales y aumentar√° el producto terminado
        var result = service.ProcesarProduccion(productoId, cantidad, usuarioId);
        return result.Result ? Ok(result) : BadRequest(result);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\LicenciaController.cs --- 
--- NOMBRE: LicenciaController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Services;
using IntegraPro.AppLogic.Utils;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace IntegraPro.WebAPI.Controllers;

[ApiController]
[Route("api/[controller]")]
public class LicenciaController : ControllerBase
{
    private readonly LicenciaService _service;

    public LicenciaController(LicenciaService service)
    {
        _service = service;
    }

    /// <summary>
    /// Paso 1: Obtener el Identificador de Hardware.
    /// Accesible sin licencia para permitir el inicio del proceso.
    /// </summary>
    [AllowAnonymous]
    [HttpGet("mi-hardware-id")]
    public IActionResult GetHardwareId()
    {
        string hid = _service.GetHardwareId();
        return Ok(new { hardwareId = hid });
    }

    /// <summary>
    /// Paso 2 (Manual): Activaci√≥n mediante una llave generada por el administrador.
    /// </summary>
    [AllowAnonymous]
    [HttpPost("activar")]
    public IActionResult Activar([FromQuery] string llave, [FromQuery] string empresa, [FromQuery] string ruc, [FromQuery] int maxEquipos)
    {
        var response = _service.ActivarLicencia(llave, empresa, ruc, maxEquipos);
        return Ok(response);
    }

    /// <summary>
    /// Paso 2 (Autom√°tico): El sistema se activa solo con datos b√°sicos.
    /// Genera la llave internamente para que el usuario no dependa del administrador inicialmente.
    /// </summary>
    [AllowAnonymous]
    [HttpPost("auto-activar")]
    public IActionResult AutoActivar([FromQuery] string empresa, [FromQuery] string ruc)
    {
        try
        {
            string hid = _service.GetHardwareId();
            // Generamos la llave autom√°ticamente para una licencia est√°ndar de 5 equipos
            int equiposGratis = 5;
            string llaveGenerada = _service.GenerarLlave(ruc, hid, equiposGratis);

            var response = _service.ActivarLicencia(llaveGenerada, empresa, ruc, equiposGratis);
            return Ok(response);
        }
        catch (Exception ex)
        {
            return BadRequest(new ApiResponse<bool>(false, $"Error en auto-activaci√≥n: {ex.Message}"));
        }
    }

    /// <summary>
    /// Verifica si el sistema est√° activo y si el RUC no ha sido bloqueado remotamente.
    /// </summary>
    [HttpGet("validar-estado")]
    public IActionResult Validar()
    {
        var response = _service.ValidarSistema();
        // Si el RUC est√° en tu lista de GitHub, ValidarSistema() devolver√° false.
        return response.Result ? Ok(response) : StatusCode(403, response);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\ProductoController.cs --- 
--- NOMBRE: ProductoController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Mvc;

[ApiController]
[Route("api/[controller]")]
public class ProductoController(IProductoService service) : ControllerBase
{
    [HttpGet] public IActionResult Get() => Ok(service.ObtenerTodos());
    [HttpPost] public IActionResult Post([FromBody] ProductoDTO dto) => Ok(service.Crear(dto));

    [HttpGet("alertas")]
    public IActionResult GetAlertas() => Ok(service.ObtenerAlertasStock());
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\UsuarioController.cs --- 
--- NOMBRE: UsuarioController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Mvc;

namespace IntegraPro.API.Controllers;

[ApiController]
[Route("api/[controller]")]
public class UsuarioController : ControllerBase
{
    private readonly IUsuarioService _usuarioService;

    public UsuarioController(IUsuarioService usuarioService)
    {
        _usuarioService = usuarioService;
    }

    [HttpPost("login")]
    public ActionResult<ApiResponse<UsuarioDTO>> Login([FromBody] LoginRequest request)
    {
        var result = _usuarioService.Login(request.Username, request.Password);

        // Cambiado de .Success a .Result
        if (result.Result)
        {
            return Ok(result);
        }

        if (result.Message == "SESION_ABIERTA_OTRO_EQUIPO")
        {
            return Conflict(result);
        }

        return BadRequest(result);
    }

    [HttpPost("forzar-cierre-sesion")]
    public ActionResult<ApiResponse<bool>> ForzarCierre([FromBody] LoginRequest request)
    {
        var result = _usuarioService.ForzarCierreSesion(request.Username, request.Password);

        if (result.Result) // Cambiado a .Result
        {
            return Ok(result);
        }

        return BadRequest(result);
    }

    [HttpPost("registrar")]
    public ActionResult<ApiResponse<bool>> Registrar([FromBody] UsuarioDTO usuario)
    {
        var result = _usuarioService.Registrar(usuario);

        if (result.Result) // Cambiado a .Result
        {
            return Ok(result);
        }

        return BadRequest(result);
    }

    [HttpPost("logout/{id}")]
    public ActionResult<ApiResponse<bool>> Logout(int id)
    {
        var result = _usuarioService.Logout(id);

        if (result.Result) // Cambiado a .Result
        {
            return Ok(result);
        }

        return BadRequest(result);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Controllers\VentaController.cs --- 
--- NOMBRE: VentaController.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Services;
using IntegraPro.DTO.Models;
using Microsoft.AspNetCore.Mvc;

namespace IntegraPro.API.Controllers;

[Route("api/[controller]")]
[ApiController]
// Usamos el constructor primario para inyectar el servicio directamente
public class VentaController(VentaService service) : ControllerBase
{
    private readonly VentaService _service = service;

    [HttpPost]
    public IActionResult Post([FromBody] FacturaDTO factura)
    {
        try
        {
            // El servicio orquestar√° la transacci√≥n: Factura + Kardex + Trigger
            string numFac = _service.ProcesarVenta(factura);

            return Ok(new
            {
                success = true,
                factura = numFac,
                message = "Venta procesada exitosamente. El inventario se actualiz√≥ mediante Kardex y Trigger."
            });
        }
        catch (Exception ex)
        {
            return BadRequest(new { success = false, message = ex.Message });
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\Filters\LicenseFilter.cs --- 
--- NOMBRE: LicenseFilter.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Services;
using IntegraPro.DataAccess.Factory;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Filters;
using System.Security.Claims;

namespace IntegraPro.API.Filters;

public class LicenseFilter : IAuthorizationFilter
{
    private readonly LicenciaService _licenciaService;
    private readonly UsuarioFactory _usuarioFactory;

    public LicenseFilter(LicenciaService licenciaService, UsuarioFactory usuarioFactory)
    {
        _licenciaService = licenciaService;
        _usuarioFactory = usuarioFactory;
    }

    public void OnAuthorization(AuthorizationFilterContext context)
    {
        // =================================================================================
        // EXCEPCI√ìN: Permitir el paso libre a los endpoints de Activaci√≥n
        // =================================================================================
        var path = context.HttpContext.Request.Path.Value?.ToLower() ?? "";

        // Si la URL contiene "licencia", permitimos el acceso sin validar hardware ni sesi√≥n
        if (path.Contains("/api/licencia"))
        {
            return;
        }

        // 1. VALIDACI√ìN DE HARDWARE (¬øLa PC tiene permiso de usar el software?)
        var validacionHardware = _licenciaService.ValidarSistema();
        string hidActual = _licenciaService.GetHardwareId();

        if (!validacionHardware.Result)
        {
            context.Result = new ObjectResult(new
            {
                Result = false,
                Message = "EQUIPO_NO_AUTORIZADO",
                Details = "Esta computadora no cuenta con una licencia activa."
            })
            { StatusCode = 403 };
            return;
        }

        // 2. VALIDACI√ìN DE SESI√ìN √öNICA (¬øEs este usuario el que se logue√≥ en esta PC?)
        var username = context.HttpContext.User.Identity?.Name;

        if (!string.IsNullOrEmpty(username))
        {
            var usuario = _usuarioFactory.GetByUsername(username);

            if (usuario != null && !string.IsNullOrEmpty(usuario.HardwareIdSesion))
            {
                if (usuario.HardwareIdSesion != hidActual)
                {
                    context.Result = new ObjectResult(new
                    {
                        Result = false,
                        Message = "SESION_INVALIDA_OTRO_EQUIPO",
                        Details = "Tu sesi√≥n ha sido abierta en otra computadora. Se ha cerrado el acceso aqu√≠."
                    })
                    { StatusCode = 401 };
                }
            }
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\obj\Debug\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
--- NOMBRE: .NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
 
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\obj\Debug\net9.0\IntegraPro.API.AssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.API.AssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("IntegraPro.API")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0+7f305de852982f374155bcd2c0c108960c4ac95d")]
[assembly: System.Reflection.AssemblyProductAttribute("IntegraPro.API")]
[assembly: System.Reflection.AssemblyTitleAttribute("IntegraPro.API")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\obj\Debug\net9.0\IntegraPro.API.GlobalUsings.g.cs --- 
--- NOMBRE: IntegraPro.API.GlobalUsings.g.cs --- 
 
// <auto-generated/>
global using global::Microsoft.AspNetCore.Builder;
global using global::Microsoft.AspNetCore.Hosting;
global using global::Microsoft.AspNetCore.Http;
global using global::Microsoft.AspNetCore.Routing;
global using global::Microsoft.Extensions.Configuration;
global using global::Microsoft.Extensions.DependencyInjection;
global using global::Microsoft.Extensions.Hosting;
global using global::Microsoft.Extensions.Logging;
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Net.Http.Json;
global using global::System.Threading;
global using global::System.Threading.Tasks;
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.API\obj\Debug\net9.0\IntegraPro.API.MvcApplicationPartsAssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.API.MvcApplicationPartsAssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: Microsoft.AspNetCore.Mvc.ApplicationParts.ApplicationPartAttribute("Microsoft.AspNetCore.OpenApi")]
[assembly: Microsoft.AspNetCore.Mvc.ApplicationParts.ApplicationPartAttribute("Swashbuckle.AspNetCore.SwaggerGen")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Class1.cs --- 
--- NOMBRE: Class1.cs --- 
 
Ôªønamespace IntegraPro.AppLogic;

public class Class1
{

}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\ICategoriaService.cs --- 
--- NOMBRE: ICategoriaService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Interfaces;

public interface ICategoriaService
{
    ApiResponse<List<CategoriaDTO>> ObtenerTodas();
    ApiResponse<bool> Crear(CategoriaDTO categoria);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\IInventarioService.cs --- 
--- NOMBRE: IInventarioService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Interfaces;

public interface IInventarioService
{
    ApiResponse<bool> Registrar(MovimientoInventarioDTO mov);

    // A√ëADE ESTA L√çNEA:
    ApiResponse<bool> ProcesarProduccion(int productoPadreId, decimal cantidadAProducir, int usuarioId);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\IProductoService.cs --- 
--- NOMBRE: IProductoService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Interfaces;

public interface IProductoService
{
    ApiResponse<List<ProductoDTO>> ObtenerTodos();
    ApiResponse<ProductoDTO> ObtenerPorId(int id);
    ApiResponse<bool> Crear(ProductoDTO producto);
    ApiResponse<bool> Actualizar(ProductoDTO producto);
    ApiResponse<List<ProductoDTO>> ObtenerAlertasStock();
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Interfaces\IUsuarioService.cs --- 
--- NOMBRE: IUsuarioService.cs --- 
 
Ôªøusing IntegraPro.DTO.Models;
using IntegraPro.AppLogic.Utils;

namespace IntegraPro.AppLogic.Interfaces;

public interface IUsuarioService
{
    ApiResponse<UsuarioDTO> Login(string username, string password);
    ApiResponse<bool> Registrar(UsuarioDTO usuario);

    // A√±adimos los m√©todos que faltaban
    ApiResponse<bool> Logout(int usuarioId);
    ApiResponse<bool> ForzarCierreSesion(string username, string password);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\obj\Debug\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
--- NOMBRE: .NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
 
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\obj\Debug\net9.0\IntegraPro.AppLogic.AssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.AppLogic.AssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("IntegraPro.AppLogic")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0+7f305de852982f374155bcd2c0c108960c4ac95d")]
[assembly: System.Reflection.AssemblyProductAttribute("IntegraPro.AppLogic")]
[assembly: System.Reflection.AssemblyTitleAttribute("IntegraPro.AppLogic")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\obj\Debug\net9.0\IntegraPro.AppLogic.GlobalUsings.g.cs --- 
--- NOMBRE: IntegraPro.AppLogic.GlobalUsings.g.cs --- 
 
// <auto-generated/>
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Threading;
global using global::System.Threading.Tasks;
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\AbonoService.cs --- 
--- NOMBRE: AbonoService.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class AbonoService(string connectionString)
{
    private readonly AbonoFactory _abonoFactory = new(connectionString);

    public void RegistrarAbono(AbonoDTO abono, int clienteId)
    {
        if (abono.MontoAbonado <= 0)
            throw new Exception("El monto del abono debe ser mayor a cero.");

        // Opcional: Podr√≠as validar aqu√≠ que el monto no exceda el saldo de la cuenta
        // antes de llamar al factory.

        _abonoFactory.ProcesarAbonoCompleto(abono, clienteId);
    }

    // --- NUEVO M√âTODO PARA CONSULTAR PENDIENTES ---
    public List<object> ObtenerPendientes(int? clienteId)
    {
        return _abonoFactory.ObtenerFacturasPendientes(clienteId);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\CajaService.cs --- 
--- NOMBRE: CajaService.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

// Cambiamos el constructor para recibir el Factory inyectado
public class CajaService(CajaFactory cajaFactory)
{
    private readonly CajaFactory _cajaFactory = cajaFactory;

    public int AbrirCaja(CajaAperturaDTO apertura) => _cajaFactory.AbrirCaja(apertura);

    public void CerrarCaja(CajaCierreDTO cierre)
    {
        if (cierre.MontoRealEnCaja < 0)
            throw new Exception("El monto real no puede ser un valor negativo.");

        _cajaFactory.CerrarCaja(cierre);
    }

    public List<object> ObtenerHistorial()
    {
        return _cajaFactory.ObtenerHistorialCierres();
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\CategoriaService.cs --- 
--- NOMBRE: CategoriaService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class CategoriaService(CategoriaFactory factory) : ICategoriaService
{
    public ApiResponse<List<CategoriaDTO>> ObtenerTodas()
        => new(true, "Lista de categor√≠as", factory.GetAll());

    public ApiResponse<bool> Crear(CategoriaDTO categoria)
    {
        try
        {
            bool ok = factory.Create(categoria);
            return new ApiResponse<bool>(ok, ok ? "Guardado con √©xito" : "Error", ok);
        }
        catch (Exception ex)
        {
            return new ApiResponse<bool>(false, ex.Message, false);
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\InventarioService.cs --- 
--- NOMBRE: InventarioService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class InventarioService(InventarioFactory factory, ProductoFactory productoFactory) : IInventarioService
{
    public ApiResponse<bool> Registrar(MovimientoInventarioDTO mov)
    {
        try
        {
            if (mov.Cantidad <= 0)
                return new ApiResponse<bool>(false, "La cantidad debe ser mayor a cero", false);

            bool ok = factory.Insertar(mov);
            return new ApiResponse<bool>(ok, ok ? "Movimiento registrado y stock actualizado" : "Error al registrar", ok);
        }
        catch (Exception ex)
        {
            return new ApiResponse<bool>(false, ex.Message, false);
        }
    }

    public ApiResponse<bool> ProcesarProduccion(int productoPadreId, decimal cantidadAProducir, int usuarioId)
    {
        try
        {
            if (cantidadAProducir <= 0)
                return new ApiResponse<bool>(false, "La cantidad a producir debe ser mayor a cero", false);

            // 1. Obtener la receta del producto padre
            var receta = productoFactory.ObtenerComposicion(productoPadreId);

            if (receta == null || receta.Count == 0)
                return new ApiResponse<bool>(false, "El producto seleccionado no tiene una receta definida o no es un producto elaborado.", false);

            // 2. Registrar SALIDAS de materias primas (Explosi√≥n de materiales)
            foreach (var item in receta)
            {
                var movSalida = new MovimientoInventarioDTO
                {
                    ProductoId = item.MaterialId,
                    UsuarioId = usuarioId,
                    TipoMovimiento = "SALIDA",
                    Cantidad = item.CantidadNecesaria * cantidadAProducir,
                    DocumentoReferencia = $"PROD-P{productoPadreId}",
                    Notas = $"Consumo autom√°tico para producir {cantidadAProducir} unidades del producto padre ID {productoPadreId}"
                };

                if (!factory.Insertar(movSalida))
                    throw new Exception($"Error al rebajar stock del material ID {item.MaterialId}");
            }

            // 3. Registrar ENTRADA del producto terminado
            var movEntrada = new MovimientoInventarioDTO
            {
                ProductoId = productoPadreId,
                UsuarioId = usuarioId,
                TipoMovimiento = "ENTRADA",
                Cantidad = cantidadAProducir,
                DocumentoReferencia = "ORDEN-PROD",
                Notas = $"Ingreso por finalizaci√≥n de proceso productivo"
            };

            if (!factory.Insertar(movEntrada))
                throw new Exception("Error al ingresar el stock del producto terminado.");

            return new ApiResponse<bool>(true, $"Producci√≥n exitosa: Se descontaron los insumos y se cargaron {cantidadAProducir} unidades al inventario.", true);
        }
        catch (Exception ex)
        {
            return new ApiResponse<bool>(false, "Error en proceso de producci√≥n: " + ex.Message, false);
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\LicenciaService.cs --- 
--- NOMBRE: LicenciaService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;
using System.Management;
using Microsoft.Data.SqlClient;
using System.Data;
using System.Security.Cryptography;
using System.Text;

namespace IntegraPro.AppLogic.Services;

public class LicenciaService
{
    private readonly ConfiguracionFactory _factory;

    // Esta llave debe ser la misma en tu generador de licencias privado
    private readonly string _masterKey = "IntegraPro_Secret_2026";

    // URL para bloquear clientes morosos o licencias robadas (formato: lista de RUCs separados por comas o lineas)
    private readonly string _killSwitchUrl = "https://tu-servidor-remoto.com/blacklist.txt";

    public LicenciaService(ConfiguracionFactory factory)
    {
        _factory = factory;
    }

    /// <summary>
    /// Activa el sistema por primera vez vincul√°ndolo al Hardware ID principal.
    /// </summary>
    public ApiResponse<bool> ActivarLicencia(string llaveActivacion, string nombreEmpresa, string ruc, int maxEquipos)
    {
        try
        {
            string hidActual = GetHardwareId();
            string llaveEsperada = GenerarLlave(ruc, hidActual, maxEquipos);

            if (llaveActivacion != llaveEsperada)
            {
                return new ApiResponse<bool>(false, "La llave de activaci√≥n es inv√°lida para este equipo o los datos no coinciden.");
            }

            _factory.RegistrarConfiguracionInicial(nombreEmpresa, ruc, maxEquipos, hidActual);

            return new ApiResponse<bool>(true, "¬°Sistema activado con √©xito!", true);
        }
        catch (Exception ex)
        {
            return new ApiResponse<bool>(false, $"Error al activar: {ex.Message}");
        }
    }

    /// <summary>
    /// Algoritmo de generaci√≥n de llaves (debe ser id√©ntico en tu generador externo)
    /// </summary>
    public string GenerarLlave(string ruc, string hid, int maxEquipos)
    {
        using (var sha = SHA256.Create())
        {
            // El formato es RUC-HID-MAX-KEY
            string rawData = $"{ruc.Trim()}-{hid.Trim()}-{maxEquipos}-{_masterKey}";
            byte[] bytes = sha.ComputeHash(Encoding.UTF8.GetBytes(rawData));

            // Retornamos un c√≥digo corto de 16 caracteres para facilidad del usuario
            return Convert.ToBase64String(bytes)
                .Replace("+", "")
                .Replace("/", "")
                .Replace("=", "")
                .Substring(0, 16)
                .ToUpper();
        }
    }

    /// <summary>
    /// Valida si el equipo actual tiene permiso de ejecuci√≥n.
    /// </summary>
    public ApiResponse<bool> ValidarSistema()
    {
        try
        {
            string hid = GetHardwareId();
            DataTable dt = _factory.ValidarLicenciaMultiEquipo(hid);

            if (dt != null && dt.Rows.Count > 0)
            {
                string resultado = dt.Rows[0]["Resultado"]?.ToString() ?? "";
                string rucRegistrado = dt.Rows[0]["Ruc"]?.ToString() ?? "";

                if (resultado == "EQUIPO_AUTORIZADO" || resultado == "NUEVO_EQUIPO_REGISTRADO")
                {
                    // Validaci√≥n de seguridad adicional (Remota)
                    if (!string.IsNullOrEmpty(rucRegistrado))
                    {
                        if (EstaEnListaNegra(rucRegistrado))
                        {
                            return new ApiResponse<bool>(false, "Licencia revocada: Por favor contacte al soporte t√©cnico.");
                        }
                    }

                    return new ApiResponse<bool>(true, $"Acceso concedido", true);
                }

                if (resultado == "LIMITE_ALCANZADO")
                {
                    return new ApiResponse<bool>(false, "Se ha alcanzado el l√≠mite de equipos permitidos para esta licencia.");
                }
            }

            return new ApiResponse<bool>(false, "Sistema no activado o hardware no reconocido.");
        }
        catch (Exception ex)
        {
            return new ApiResponse<bool>(false, $"Error cr√≠tico de seguridad: {ex.Message}");
        }
    }

    /// <summary>
    /// Obtiene el Identificador √∫nico de Hardware (HID)
    /// </summary>
    public string GetHardwareId()
    {
        string serial = "";
        try
        {
            // Intentar con Serial de la Placa Base (Motherboard)
            serial = GetWmiProperty("Win32_BaseBoard", "SerialNumber");

            // Fallback 1: BIOS
            if (EsInvalido(serial)) serial = GetWmiProperty("Win32_BIOS", "SerialNumber");

            // Fallback 2: ID del Procesador
            if (EsInvalido(serial)) serial = GetWmiProperty("Win32_Processor", "ProcessorId");

            // Fallback Final: Nombre de la m√°quina (Menos seguro pero funcional)
            if (EsInvalido(serial)) serial = $"PC-{Environment.MachineName.ToUpper()}";
        }
        catch
        {
            serial = $"FB-{Environment.MachineName.ToUpper()}";
        }
        return serial.Trim();
    }

    private bool EstaEnListaNegra(string ruc)
    {
        try
        {
            using (var client = new HttpClient())
            {
                client.Timeout = TimeSpan.FromSeconds(2); // No bloqueamos al usuario si no hay internet
                var response = client.GetStringAsync(_killSwitchUrl).Result;
                return response.Contains(ruc);
            }
        }
        catch
        {
            return false; // Si falla el internet, permitimos seguir trabajando localmente
        }
    }

    private string GetWmiProperty(string table, string property)
    {
        try
        {
            // Nota: Requiere NuGet System.Management
            using (ManagementObjectSearcher searcher = new ManagementObjectSearcher($"SELECT {property} FROM {table}"))
            {
                foreach (ManagementObject obj in searcher.Get())
                {
                    return obj[property]?.ToString()?.Trim() ?? "";
                }
            }
        }
        catch { }
        return "";
    }

    private bool EsInvalido(string sid)
    {
        if (string.IsNullOrWhiteSpace(sid)) return true;
        string val = sid.ToLower();
        return val == "default string" || val == "none" || val == "to be filled by o.e.m." ||
               val == "00000000" || val == "unknown" || val.Length < 5;
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\ProductoService.cs --- 
--- NOMBRE: ProductoService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class ProductoService(ProductoFactory factory) : IProductoService
{
    public ApiResponse<List<ProductoDTO>> ObtenerTodos() =>
        new(true, "Productos obtenidos", factory.GetAll());

    public ApiResponse<ProductoDTO> ObtenerPorId(int id)
    {
        var prod = factory.GetById(id);
        return new ApiResponse<ProductoDTO>(prod != null, prod != null ? "Encontrado" : "No existe", prod!);
    }

    public ApiResponse<bool> Crear(ProductoDTO producto)
    {
        try
        {
            int nuevoId = factory.Create(producto);
            if (producto.EsElaborado && producto.Receta != null)
            {
                foreach (var item in producto.Receta)
                    factory.InsertarComposicion(nuevoId, item.MaterialId, item.CantidadNecesaria);
            }
            return new ApiResponse<bool>(true, "Creado exitosamente", true);
        }
        catch (Exception ex) { return new ApiResponse<bool>(false, ex.Message, false); }
    }

    public ApiResponse<bool> Actualizar(ProductoDTO producto)
    {
        try
        {
            factory.Update(producto);
            return new ApiResponse<bool>(true, "Actualizado exitosamente", true);
        }
        catch (Exception ex) { return new ApiResponse<bool>(false, ex.Message, false); }
    }

    public ApiResponse<List<ProductoDTO>> ObtenerAlertasStock() =>
        new(true, "Alertas de stock", factory.GetStockAlerts());
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\UsuarioService.cs --- 
--- NOMBRE: UsuarioService.cs --- 
 
Ôªøusing IntegraPro.AppLogic.Interfaces;
using IntegraPro.AppLogic.Utils;
using IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class UsuarioService : IUsuarioService
{
    private readonly UsuarioFactory _factory;
    private readonly LicenciaService _licenciaService;

    public UsuarioService(UsuarioFactory factory, LicenciaService licenciaService)
    {
        _factory = factory;
        _licenciaService = licenciaService;
    }

    public ApiResponse<UsuarioDTO> Login(string username, string password)
    {
        try
        {
            Guard.AgainstEmptyString(username, nameof(username));
            Guard.AgainstEmptyString(password, nameof(password));

            var usuario = _factory.GetByUsername(username);
            if (usuario == null || !usuario.Activo)
                return new ApiResponse<UsuarioDTO>(false, "Credenciales incorrectas o usuario inactivo");

            // 1. Verificar contrase√±a
            if (!PasswordHasher.VerifyPassword(password, usuario.PasswordHash))
            {
                Logger.WriteLog("Seguridad", "Login Fallido", $"Intento fallido: {username}");
                return new ApiResponse<UsuarioDTO>(false, "Credenciales incorrectas");
            }

            // 2. L√ìGICA DE SESI√ìN √öNICA LIGADA AL HARDWARE
            string hidActual = _licenciaService.GetHardwareId();

            if (!string.IsNullOrEmpty(usuario.HardwareIdSesion) && usuario.HardwareIdSesion != hidActual)
            {
                Logger.WriteLog("Seguridad", "Bloqueo Sesi√≥n", $"Usuario {username} intent√≥ entrar desde otra PC.");
                return new ApiResponse<UsuarioDTO>(false, "SESION_ABIERTA_OTRO_EQUIPO");
            }

            // 3. Registrar el Hardware ID en la sesi√≥n
            _factory.ActualizarSesionHardware(usuario.Id, hidActual);

            // 4. --- NUEVO: REGISTRAR FECHA Y HORA DEL √öLTIMO LOGIN ---
            _factory.RegistrarLogin(usuario.Id);

            // Actualizamos el objeto en memoria para que la respuesta de la API no sea null
            usuario.UltimoLogin = DateTime.Now;
            usuario.HardwareIdSesion = hidActual;
            usuario.PasswordHash = string.Empty; // Seguridad: No devolver el hash

            Logger.WriteLog("Seguridad", "Login Exitoso", $"Usuario {username} ha ingresado en equipo {hidActual}.");

            return new ApiResponse<UsuarioDTO>(true, "Acceso concedido", usuario);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "Login", ex.Message);
            return new ApiResponse<UsuarioDTO>(false, $"Error interno: {ex.Message}");
        }
    }

    public ApiResponse<bool> ForzarCierreSesion(string username, string password)
    {
        try
        {
            var usuario = _factory.GetByUsername(username);

            if (usuario != null && PasswordHasher.VerifyPassword(password, usuario.PasswordHash))
            {
                _factory.ActualizarSesionHardware(usuario.Id, null);
                Logger.WriteLog("Seguridad", "Forzar Cierre", $"Sesiones liberadas para el usuario: {username}");
                return new ApiResponse<bool>(true, "Sesiones liberadas. Ya puede reintentar el login.", true);
            }

            return new ApiResponse<bool>(false, "Credenciales inv√°lidas para realizar esta acci√≥n.");
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "ForzarCierre", ex.Message);
            return new ApiResponse<bool>(false, $"Error al forzar cierre: {ex.Message}");
        }
    }

    public ApiResponse<bool> Logout(int usuarioId)
    {
        try
        {
            _factory.ActualizarSesionHardware(usuarioId, null);
            return new ApiResponse<bool>(true, "Sesi√≥n cerrada correctamente", true);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "Logout", ex.Message);
            return new ApiResponse<bool>(false, $"Error al cerrar sesi√≥n: {ex.Message}");
        }
    }

    public ApiResponse<bool> Registrar(UsuarioDTO usuario)
    {
        try
        {
            Guard.AgainstNull(usuario, nameof(usuario));
            Guard.AgainstEmptyString(usuario.Username, "Nombre de Usuario");

            if (string.IsNullOrEmpty(usuario.Password))
                return new ApiResponse<bool>(false, "La contrase√±a es obligatoria");

            var existente = _factory.GetByUsername(usuario.Username);
            if (existente != null)
                return new ApiResponse<bool>(false, "El nombre de usuario ya est√° en uso");

            usuario.PasswordHash = PasswordHasher.HashPassword(usuario.Password);
            _factory.Create(usuario);

            return new ApiResponse<bool>(true, "Usuario creado exitosamente", true);
        }
        catch (Exception ex)
        {
            Logger.WriteLog("Error", "Registro", ex.Message);
            return new ApiResponse<bool>(false, ex.Message);
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Services\VentaService.cs --- 
--- NOMBRE: VentaService.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Factory;
using IntegraPro.DTO.Models;

namespace IntegraPro.AppLogic.Services;

public class VentaService(VentaFactory ventaFactory, ClienteFactory cliFactory, ProductoFactory prodFactory)
{
    private readonly VentaFactory _ventaFactory = ventaFactory;
    private readonly ClienteFactory _cliFactory = cliFactory;
    private readonly ProductoFactory _prodFactory = prodFactory;

    public string ProcesarVenta(FacturaDTO factura)
    {
        // 1. VALIDACI√ìN DE STOCK (Evitar negativos)
        foreach (var det in factura.Detalles)
        {
            // USAMOS 'GetById' que es el nombre real en tu ProductoFactory
            var producto = _prodFactory.GetById(det.ProductoId);

            if (producto == null)
                throw new Exception($"El producto con ID {det.ProductoId} no existe.");

            if (producto.Existencia < det.Cantidad)
            {
                throw new Exception($"Stock insuficiente para '{producto.Nombre}'. " +
                                    $"Solicitado: {det.Cantidad:N2}, Disponible: {producto.Existencia:N2}.");
            }
        }

        // 2. VALIDACI√ìN DE CR√âDITO
        if (factura.CondicionVenta.Equals("Credito", StringComparison.OrdinalIgnoreCase))
        {
            var (saldoActual, limite, activo) = _cliFactory.ObtenerEstadoCredito(factura.ClienteId);

            if (!activo)
                throw new Exception("El cliente seleccionado se encuentra INACTIVO.");

            if ((saldoActual + factura.TotalComprobante) > limite)
            {
                throw new Exception($"L√≠mite de cr√©dito excedido. " +
                                    $"Saldo actual: {saldoActual:N2}, " +
                                    $"L√≠mite: {limite:N2}. " +
                                    $"Total factura: {factura.TotalComprobante:N2}.");
            }
        }

        // 3. EJECUCI√ìN TRANSACCIONAL √öNICA
        // Al llegar aqu√≠, ya validamos que hay stock y cr√©dito.
        string consecutivo = _ventaFactory.CrearFactura(factura);

        // 4. ACTUALIZAR SALDO DEL CLIENTE
        if (factura.CondicionVenta.Equals("Credito", StringComparison.OrdinalIgnoreCase))
        {
            _cliFactory.ActualizarSaldo(factura.ClienteId, factura.TotalComprobante);
        }

        return consecutivo;
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Utils\ApiResponse.cs --- 
--- NOMBRE: ApiResponse.cs --- 
 
namespace IntegraPro.AppLogic.Utils;

public class ApiResponse<T>
{
    public T? Data { get; set; }
    public string Message { get; set; } = string.Empty;
    public bool Result { get; set; }

    public ApiResponse(bool result, string message, T? data = default)
    {
        Result = result;
        Message = message;
        Data = data;
    }
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Utils\Guard.cs --- 
--- NOMBRE: Guard.cs --- 
 
namespace IntegraPro.AppLogic.Utils;

public static class Guard
{
    public static void AgainstNull(object? input, string parameterName)
    {
        if (input == null)
            throw new ArgumentNullException(parameterName, $"{parameterName} no puede ser nulo.");
    }

    public static void AgainstEmptyString(string input, string parameterName)
    {
        if (string.IsNullOrWhiteSpace(input))
            throw new ArgumentException($"{parameterName} no puede estar vacio.", parameterName);
    }

    public static string GenerateReadableId(string prefix)
    {
        return $"{prefix}-{Guid.NewGuid().ToString()[..8].ToUpper()}";
    }
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Utils\Logger.cs --- 
--- NOMBRE: Logger.cs --- 
 
namespace IntegraPro.AppLogic.Utils;

public static class Logger
{
    private static readonly string LogPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "logs.txt");

    public static void WriteLog(string modulo, string accion, string detalle)
    {
        try
        {
            string logLine = $"[{DateTime.Now:yyyy-MM-dd HH:mm:ss}] | {modulo} | {accion} | {detalle}{Environment.NewLine}";
            File.AppendAllText(LogPath, logLine);
        }
        catch { /* Fallback silencioso si el archivo esta bloqueado */ }
    }
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.AppLogic\Utils\PasswordHasher.cs --- 
--- NOMBRE: PasswordHasher.cs --- 
 
using System.Security.Cryptography;

namespace IntegraPro.AppLogic.Utils;

public static class PasswordHasher
{
    private const int SaltSize = 16; // 128 bit
    private const int KeySize = 32;  // 256 bit
    private const int Iterations = 100000;
    private static readonly HashAlgorithmName _hashAlgorithm = HashAlgorithmName.SHA256;

    public static string HashPassword(string password)
    {
        byte[] salt = RandomNumberGenerator.GetBytes(SaltSize);
        byte[] hash = Rfc2898DeriveBytes.Pbkdf2(password, salt, Iterations, _hashAlgorithm, KeySize);

        return $"{Convert.ToHexString(salt)}.{Convert.ToHexString(hash)}";
    }

    public static bool VerifyPassword(string password, string hashedPassword)
    {
        string[] parts = hashedPassword.Split('.');
        byte[] salt = Convert.FromHexString(parts[0]);
        byte[] hash = Convert.FromHexString(parts[1]);

        byte[] inputHash = Rfc2898DeriveBytes.Pbkdf2(password, salt, Iterations, _hashAlgorithm, KeySize);

        return CryptographicOperations.FixedTimeEquals(hash, inputHash);
    }
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Class1.cs --- 
--- NOMBRE: Class1.cs --- 
 
Ôªønamespace IntegraPro.DataAccess;

public class Class1
{

}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Dao\MasterDao.cs --- 
--- NOMBRE: MasterDao.cs --- 
 
Ôªøusing System.Data;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Dao;

public abstract class MasterDao
{
    private readonly string _connectionString;

    protected MasterDao(string connectionString)
    {
        _connectionString = connectionString;
    }

    protected SqlConnection GetConnection() => new SqlConnection(_connectionString);

    // 1. Para consultas SELECT (devuelve tablas)
    protected DataTable ExecuteQuery(string query, SqlParameter[]? parameters = null, bool isStoredProcedure = true)
    {
        var table = new DataTable();
        using var connection = GetConnection();
        using var command = new SqlCommand(query, connection);

        if (isStoredProcedure)
            command.CommandType = CommandType.StoredProcedure;

        if (parameters != null)
            command.Parameters.AddRange(parameters);

        using var adapter = new SqlDataAdapter(command);
        adapter.Fill(table);
        return table;
    }

    // 2. Para INSERT que devuelven el ID generado
    protected int ExecuteScalar(string spName, SqlParameter[]? parameters = null)
    {
        using var connection = GetConnection();
        using var command = new SqlCommand(spName, connection);
        command.CommandType = CommandType.StoredProcedure;

        if (parameters != null)
            command.Parameters.AddRange(parameters);

        connection.Open();
        var result = command.ExecuteScalar();
        return result != DBNull.Value ? Convert.ToInt32(result) : 0;
    }

    // 3. Para cambios directos (UPDATE, DELETE, INSERT simples)
    protected void ExecuteNonQuery(string query, SqlParameter[]? parameters = null, bool isStoredProcedure = true)
    {
        using var connection = GetConnection();
        using var command = new SqlCommand(query, connection);

        if (isStoredProcedure)
            command.CommandType = CommandType.StoredProcedure;

        if (parameters != null)
            command.Parameters.AddRange(parameters);

        connection.Open();
        command.ExecuteNonQuery();
    }

    // 4. Alias para compatibilidad con UsuarioFactory
    protected void ExecuteStoredProcedure(string spName, SqlParameter[] parameters)
    {
        ExecuteNonQuery(spName, parameters, true);
    }

    // ==========================================
    // NUEVOS M√âTODOS PARA TRANSACCIONES (ACID)
    // ==========================================

    // Permite ejecutar un Scalar (como obtener el ID de factura) dentro de una transacci√≥n abierta
    protected object ExecuteScalarInTransaction(string sql, SqlParameter[] parameters, SqlConnection connection, SqlTransaction transaction)
    {
        using var command = new SqlCommand(sql, connection, transaction);
        if (parameters != null) command.Parameters.AddRange(parameters);
        var result = command.ExecuteScalar();
        return result ?? DBNull.Value;
    }

    // Permite ejecutar comandos (como el detalle o el kardex) dentro de una transacci√≥n abierta
    protected void ExecuteNonQueryInTransaction(string sql, SqlParameter[] parameters, SqlConnection connection, SqlTransaction transaction)
    {
        using var command = new SqlCommand(sql, connection, transaction);
        if (parameters != null) command.Parameters.AddRange(parameters);
        command.ExecuteNonQuery();
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\AbonoFactory.cs --- 
--- NOMBRE: AbonoFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class AbonoFactory(string connectionString) : MasterDao(connectionString)
{
    public void ProcesarAbonoCompleto(AbonoDTO abono, int clienteId)
    {
        // Usamos una transacci√≥n para que si algo falla, no se descuente a medias
        string sql = @"
            BEGIN TRANSACTION;
            BEGIN TRY
                -- 1. Insertar el registro del abono
                INSERT INTO ABONO_CLIENTE (cuenta_cobrar_id, usuario_id, sucursal_id, fecha, monto_abonado, medio_pago, referencia)
                VALUES (@ccid, @uid, @sid, GETDATE(), @monto, @medio, @ref);

                -- 2. Restar el saldo de la factura espec√≠fica (CUENTA_COBRAR)
                UPDATE CUENTA_COBRAR 
                SET saldo_pendiente = saldo_pendiente - @monto,
                    estado = CASE WHEN (saldo_pendiente - @monto) <= 0 THEN 'Pagada' ELSE 'Pendiente' END
                WHERE id = @ccid;

                -- 3. Restar el saldo general del CLIENTE (para liberar su cr√©dito)
                UPDATE CLIENTE 
                SET saldo_pendiente = saldo_pendiente - @monto 
                WHERE id = @clienteId;

                COMMIT TRANSACTION;
            END TRY
            BEGIN CATCH
                ROLLBACK TRANSACTION;
                THROW;
            END CATCH";

        var p = new[] {
            new SqlParameter("@ccid", abono.CuentaCobrarId),
            new SqlParameter("@uid", abono.UsuarioId),
            new SqlParameter("@sid", abono.SucursalId),
            new SqlParameter("@monto", abono.MontoAbonado),
            new SqlParameter("@medio", abono.MedioPago),
            new SqlParameter("@ref", (object?)abono.Referencia ?? DBNull.Value),
            new SqlParameter("@clienteId", clienteId)
        };

        ExecuteNonQuery(sql, p, false);
    }

    // --- NUEVO M√âTODO PARA CONSULTAR DEUDAS PENDIENTES ---
    public List<object> ObtenerFacturasPendientes(int? clienteId = null)
    {
        string sql = "SELECT * FROM VW_EstadoCuenta_Clientes";
        List<SqlParameter> parametros = new List<SqlParameter>();

        if (clienteId.HasValue)
        {
            sql += " WHERE cliente_id = @cid";
            parametros.Add(new SqlParameter("@cid", clienteId.Value));
        }

        var dt = ExecuteQuery(sql, parametros.Count > 0 ? parametros.ToArray() : null, false);

        var lista = new List<object>();
        foreach (DataRow row in dt.Rows)
        {
            lista.Add(new
            {
                ClienteId = row["cliente_id"],
                Cliente = row["cliente_nombre"].ToString(),
                IdCuenta = row["cuenta_id"],
                FacturaNumero = row["factura_numero"].ToString(),
                MontoTotal = row["monto_total"],
                SaldoPendiente = row["saldo_pendiente"],
                FechaVencimiento = Convert.ToDateTime(row["fecha_vencimiento"]).ToShortDateString(),
                DiasRestantes = row["dias_para_vencimiento"]
            });
        }
        return lista;
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\CajaFactory.cs --- 
--- NOMBRE: CajaFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class CajaFactory(string connectionString) : MasterDao(connectionString)
{
    public int AbrirCaja(CajaAperturaDTO apertura)
    {
        string sql = @"INSERT INTO CAJA_CIERRE (sucursal_id, usuario_id, fecha_apertura, monto_inicial, estado) 
                       VALUES (@sid, @uid, GETDATE(), @monto, 'Abierta');
                       SELECT CAST(SCOPE_IDENTITY() as int);";

        var p = new[] {
            new SqlParameter("@sid", apertura.SucursalId),
            new SqlParameter("@uid", apertura.UsuarioId),
            new SqlParameter("@monto", apertura.MontoInicial)
        };
        var dt = ExecuteQuery(sql, p, false);
        return Convert.ToInt32(dt.Rows[0][0]);
    }

    public void CerrarCaja(CajaCierreDTO cierre)
    {
        string sqlInfo = "SELECT sucursal_id, fecha_apertura FROM CAJA_CIERRE WHERE id = @id AND estado = 'Abierta'";
        var dtInfo = ExecuteQuery(sqlInfo, new[] { new SqlParameter("@id", cierre.CajaId) }, false);

        if (dtInfo.Rows.Count == 0) throw new Exception("La caja no existe o ya se encuentra cerrada.");

        var sid = dtInfo.Rows[0]["sucursal_id"];
        var fechaApertura = dtInfo.Rows[0]["fecha_apertura"];

        string sqlCierre = @"
            DECLARE @ventas decimal(18,2) = (SELECT ISNULL(SUM(total_comprobante),0) FROM FACTURA_ENCABEZADO 
                                            WHERE sucursal_id = @sid AND fecha >= @fecha AND medio_pago = 'Efectivo');
            
            DECLARE @abonos decimal(18,2) = (SELECT ISNULL(SUM(monto_abonado),0) FROM ABONO_CLIENTE 
                                            WHERE sucursal_id = @sid AND fecha >= @fecha AND medio_pago = 'Efectivo');

            UPDATE CAJA_CIERRE SET 
                fecha_cierre = GETDATE(),
                ventas_efectivo = @ventas,
                abonos_efectivo = @abonos,
                esperado_caja = monto_inicial + @ventas + @abonos,
                real_caja = @montoReal,
                notas = @notas,
                estado = 'Cerrada'
            WHERE id = @id";

        var p = new[] {
            new SqlParameter("@id", cierre.CajaId),
            new SqlParameter("@sid", sid),
            new SqlParameter("@fecha", fechaApertura),
            new SqlParameter("@montoReal", cierre.MontoRealEnCaja),
            new SqlParameter("@notas", (object?)cierre.Notas ?? DBNull.Value)
        };

        ExecuteNonQuery(sqlCierre, p, false);
    }

    public List<object> ObtenerHistorialCierres()
    {
        string sql = "SELECT * FROM VW_REPORTE_CIERRES_CAJA ORDER BY fecha_cierre DESC";
        var dt = ExecuteQuery(sql, null, false);

        var lista = new List<object>();
        foreach (DataRow row in dt.Rows)
        {
            lista.Add(new
            {
                Id = row["caja_id"],
                Sucursal = row["sucursal"].ToString(),
                Cajero = row["cajero"].ToString(),
                Apertura = row["fecha_apertura"],
                Cierre = row["fecha_cierre"],
                Esperado = row["esperado_caja"],
                Real = row["real_caja"],
                Diferencia = row["diferencia"],
                Estado = row["estado_auditoria"],
                Notas = row["notas"].ToString()
            });
        }
        return lista;
    }

}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\CategoriaFactory.cs --- 
--- NOMBRE: CategoriaFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class CategoriaFactory : MasterDao
{
    public CategoriaFactory(string connectionString) : base(connectionString) { }

    public List<CategoriaDTO> GetAll()
    {
        // Usamos false porque es una consulta de texto plano, no un SP
        var dt = ExecuteQuery("SELECT * FROM CATEGORIA", null, false);
        var lista = new List<CategoriaDTO>();
        foreach (DataRow row in dt.Rows)
        {
            lista.Add(new CategoriaDTO
            {
                Id = Convert.ToInt32(row["id"]),
                Nombre = row["nombre"].ToString() ?? "",
                Descripcion = row["descripcion"]?.ToString()
            });
        }
        return lista;
    }

    public bool Create(CategoriaDTO dto)
    {
        var parameters = new[] {
            new SqlParameter("@nombre", dto.Nombre),
            new SqlParameter("@descripcion", dto.Descripcion ?? (object)DBNull.Value)
        };
        // Ejecutamos como consulta de texto (false)
        ExecuteNonQuery("INSERT INTO CATEGORIA (nombre, descripcion) VALUES (@nombre, @descripcion)", parameters, false);
        return true;
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\ClienteFactory.cs --- 
--- NOMBRE: ClienteFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class ClienteFactory(string connectionString) : MasterDao(connectionString)
{
    public List<ClienteDTO> ObtenerTodos()
    {
        string sql = "SELECT id, identificacion, nombre, correo, telefono, limite_credito, activo FROM CLIENTE";
        var dt = ExecuteQuery(sql, null, false);

        var lista = new List<ClienteDTO>();
        foreach (DataRow row in dt.Rows)
        {
            lista.Add(new ClienteDTO
            {
                Id = (int)row["id"],
                Identificacion = row["identificacion"].ToString() ?? "",
                Nombre = row["nombre"].ToString() ?? "",
                Correo = row["correo"]?.ToString(),
                Telefono = row["telefono"]?.ToString(),
                LimiteCredito = Convert.ToDecimal(row["limite_credito"]),
                Activo = Convert.ToBoolean(row["activo"])
            });
        }
        return lista;
    }

    public int Insertar(ClienteDTO cliente)
    {
        string sql = @"INSERT INTO CLIENTE (identificacion, nombre, correo, telefono, limite_credito, activo) 
                       VALUES (@ident, @nomb, @corr, @tele, @limi, @acti);
                       SELECT CAST(SCOPE_IDENTITY() as int) AS NuevoID;";

        var p = new[] {
            new SqlParameter("@ident", cliente.Identificacion),
            new SqlParameter("@nomb", cliente.Nombre),
            new SqlParameter("@corr", (object?)cliente.Correo ?? DBNull.Value),
            new SqlParameter("@tele", (object?)cliente.Telefono ?? DBNull.Value),
            new SqlParameter("@limi", cliente.LimiteCredito),
            new SqlParameter("@acti", cliente.Activo)
        };

        var dt = ExecuteQuery(sql, p, false);

        return dt.Rows.Count > 0 ? Convert.ToInt32(dt.Rows[0][0]) : 0;
    }

    public bool Actualizar(ClienteDTO cliente)
    {
        string sql = @"UPDATE CLIENTE SET 
                        identificacion = @ident, 
                        nombre = @nomb, 
                        correo = @corr, 
                        telefono = @tele, 
                        limite_credito = @limi, 
                        activo = @acti 
                       WHERE id = @id";

        var p = new[] {
            new SqlParameter("@id", cliente.Id),
            new SqlParameter("@ident", cliente.Identificacion),
            new SqlParameter("@nomb", cliente.Nombre),
            new SqlParameter("@corr", (object?)cliente.Correo ?? DBNull.Value),
            new SqlParameter("@tele", (object?)cliente.Telefono ?? DBNull.Value),
            new SqlParameter("@limi", cliente.LimiteCredito),
            new SqlParameter("@acti", cliente.Activo)
        };

        ExecuteNonQuery(sql, p, false);
        return true;
    }

    public (decimal saldo, decimal limite, bool activo) ObtenerEstadoCredito(int clienteId)
    {
        string sql = "SELECT ISNULL(saldo_pendiente, 0) as saldo_pendiente, limite_credito, activo FROM CLIENTE WHERE id = @id";
        var dt = ExecuteQuery(sql, new[] { new SqlParameter("@id", clienteId) }, false);

        if (dt.Rows.Count > 0)
        {
            return (
                Convert.ToDecimal(dt.Rows[0]["saldo_pendiente"]),
                Convert.ToDecimal(dt.Rows[0]["limite_credito"]),
                Convert.ToBoolean(dt.Rows[0]["activo"])
            );
        }
        return (0, 0, false);
    }

    // --- NUEVO M√âTODO PARA VALIDACI√ìN DE CR√âDITO ---
    public void ActualizarSaldo(int clienteId, decimal monto)
    {
        // Suma el monto de la nueva factura al saldo_pendiente actual del cliente
        string sql = "UPDATE CLIENTE SET saldo_pendiente = ISNULL(saldo_pendiente, 0) + @monto WHERE id = @id";

        var p = new[] {
            new SqlParameter("@monto", monto),
            new SqlParameter("@id", clienteId)
        };

        ExecuteNonQuery(sql, p, false);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\ConfiguracionFactory.cs --- 
--- NOMBRE: ConfiguracionFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class ConfiguracionFactory : MasterDao
{
    public ConfiguracionFactory(string connectionString) : base(connectionString) { }

    /// <summary>
    /// Registra la licencia inicial en la base de datos tras validar la llave de activaci√≥n.
    /// </summary>
    public void RegistrarConfiguracionInicial(string nombreEmpresa, string ruc, int maxEquipos, string hid)
    {
        var parameters = new Microsoft.Data.SqlClient.SqlParameter[] {
        new Microsoft.Data.SqlClient.SqlParameter("@nombre_empresa", nombreEmpresa),
        new Microsoft.Data.SqlClient.SqlParameter("@ruc", ruc),
        new Microsoft.Data.SqlClient.SqlParameter("@max_equipos", maxEquipos),
        new Microsoft.Data.SqlClient.SqlParameter("@hid_principal", hid)
    };

        // Llamamos al SP que creamos en SQL Server para que inserte Empresa y Sucursal
        ExecuteNonQuery("sp_Configuracion_ActivarSistema", parameters);
    }

    /// <summary>
    /// Llama al SP multinivel para validar si el equipo actual tiene acceso o si se debe auto-registrar.
    /// </summary>
    public DataTable ValidarLicenciaMultiEquipo(string hardwareId)
    {
        var parameters = new SqlParameter[]
        {
            new SqlParameter("@hardware_id", hardwareId)
        };

        return ExecuteQuery("sp_Licencia_AutoValidar_MultiEquipo", parameters);
    }

    /// <summary>
    /// Guarda los datos comerciales de la empresa.
    /// </summary>
    public void GuardarEmpresa(EmpresaDTO empresa)
    {
        var p = new SqlParameter[] {
            new SqlParameter("@nombre_comercial", empresa.NombreComercial),
            new SqlParameter("@razon_social", empresa.NombreComercial), // Usamos NombreComercial como RazonSocial para evitar error de propiedad
            new SqlParameter("@cedula_juridica", empresa.CedulaJuridica),
            new SqlParameter("@tipo_regimen", empresa.TipoRegimen),
            new SqlParameter("@telefono", "00000000"),
            new SqlParameter("@correo_notificaciones", empresa.CorreoNotificaciones),
            new SqlParameter("@sitio_web", "")
        };

        ExecuteNonQuery("sp_Empresa_Upsert", p);
    }

    /// <summary>
    /// M√©todo de legado para obtener licencia simple.
    /// </summary>
    public LicenciaDTO? ObtenerLicencia(string hardwareId)
    {
        var p = new SqlParameter[] { new SqlParameter("@hardware_id", hardwareId) };
        var dt = ExecuteQuery("sp_Licencia_Validar", p);

        if (dt.Rows.Count == 0) return null;

        var row = dt.Rows[0];
        return new LicenciaDTO
        {
            HardwareId = row["hardware_id"].ToString()!,
            Estado = row["estado"].ToString()!,
            FechaVencimiento = Convert.ToDateTime(row["fecha_vencimiento"])
        };
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\FacturaFactory.cs --- 
--- NOMBRE: FacturaFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class FacturaFactory(string connectionString) : MasterDao(connectionString)
{
    public int CrearEncabezado(FacturaDTO factura, string consecutivo, string clave)
    {
        // Cambiamos el nombre del par√°metro @desc a @tdesc para evitar conflictos con palabras reservadas
        string sql = @"INSERT INTO FACTURA_ENCABEZADO 
            (cliente_id, sucursal_id, usuario_id, consecutivo, clave_numerica, fecha, condicion_venta, medio_pago, total_neto, total_descuento, total_impuesto, total_comprobante, estado_hacienda)
            VALUES (@cli, @suc, @usu, @cons, @clav, GETDATE(), @cond, @medi, @neto, @tdesc, @imp, @total, 'Pendiente');
            SELECT CAST(SCOPE_IDENTITY() as int) AS NuevoID;";

        var p = new[] {
            new SqlParameter("@cli", SqlDbType.Int) { Value = factura.ClienteId },
            new SqlParameter("@suc", SqlDbType.Int) { Value = factura.SucursalId },
            new SqlParameter("@usu", SqlDbType.Int) { Value = factura.UsuarioId },
            new SqlParameter("@cons", SqlDbType.NVarChar) { Value = consecutivo },
            new SqlParameter("@clav", SqlDbType.NVarChar) { Value = clave },
            new SqlParameter("@cond", SqlDbType.NVarChar) { Value = factura.CondicionVenta },
            new SqlParameter("@medi", SqlDbType.NVarChar) { Value = factura.MedioPago },
            new SqlParameter("@neto", SqlDbType.Decimal) { Value = factura.TotalNeto },
            new SqlParameter("@tdesc", SqlDbType.Decimal) { Value = 0.0m }, // Aseguramos que siempre viaje como decimal
            new SqlParameter("@imp", SqlDbType.Decimal) { Value = factura.TotalImpuesto },
            new SqlParameter("@total", SqlDbType.Decimal) { Value = factura.TotalComprobante }
        };

        // Usamos ExecuteQuery indicando false para que no busque un Stored Procedure
        var dt = ExecuteQuery(sql, p, false);

        if (dt != null && dt.Rows.Count > 0)
        {
            return Convert.ToInt32(dt.Rows[0][0]);
        }

        throw new Exception("No se pudo obtener el ID de la factura reci√©n creada.");
    }

    public void InsertarDetalle(int facturaId, FacturaDetalleDTO d)
    {
        string sql = @"INSERT INTO FACTURA_DETALLE 
            (factura_id, producto_id, cantidad, precio_unitario, porcentaje_descuento, monto_descuento, monto_impuesto, total_linea)
            VALUES (@fid, @pid, @cant, @prec, @pdes, @mdes, @mimp, @total)";

        decimal montoDesc = (d.PrecioUnitario * d.Cantidad) * (d.PorcentajeDescuento / 100);
        decimal subtotal = (d.PrecioUnitario * d.Cantidad) - montoDesc;
        decimal impuesto = subtotal * 0.13m;

        var p = new[] {
            new SqlParameter("@fid", SqlDbType.Int) { Value = facturaId },
            new SqlParameter("@pid", SqlDbType.Int) { Value = d.ProductoId },
            new SqlParameter("@cant", SqlDbType.Decimal) { Value = d.Cantidad },
            new SqlParameter("@prec", SqlDbType.Decimal) { Value = d.PrecioUnitario },
            new SqlParameter("@pdes", SqlDbType.Decimal) { Value = d.PorcentajeDescuento },
            new SqlParameter("@mdes", SqlDbType.Decimal) { Value = montoDesc },
            new SqlParameter("@mimp", SqlDbType.Decimal) { Value = impuesto },
            new SqlParameter("@total", SqlDbType.Decimal) { Value = subtotal + impuesto }
        };

        ExecuteNonQuery(sql, p, false);
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\InventarioFactory.cs --- 
--- NOMBRE: InventarioFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Factory;

public class InventarioFactory(string connectionString) : MasterDao(connectionString)
{
    public bool Insertar(MovimientoInventarioDTO dto)
    {
        // Eliminamos 'fecha' de la consulta para que SQL use el DEFAULT GETDATE()
        // Dejamos que el Trigger maneje las existencias previa y posterior
        string sql = @"INSERT INTO MOVIMIENTO_INVENTARIO 
                       (producto_id, usuario_id, tipo_movimiento, cantidad, documento_referencia, notas) 
                       VALUES (@pid, @uid, @tipo, @cant, @ref, @not)";

        var p = new[] {
            new SqlParameter("@pid", dto.ProductoId),
            new SqlParameter("@uid", dto.UsuarioId),
            new SqlParameter("@tipo", dto.TipoMovimiento.ToUpper()), // Normalizamos a MAY√öSCULAS para el Trigger
            new SqlParameter("@cant", dto.Cantidad),
            new SqlParameter("@ref", (object?)dto.DocumentoReferencia ?? DBNull.Value),
            new SqlParameter("@not", (object?)dto.Notas ?? DBNull.Value)
        };

        try
        {
            // Ejecutamos solo el INSERT. 
            // El Trigger se encargar√° de actualizar la tabla PRODUCTO y los saldos del movimiento.
            ExecuteNonQuery(sql, p, false);
            return true;
        }
        catch (Exception)
        {
            // Loguear la excepci√≥n si es necesario
            return false;
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\ProductoFactory.cs --- 
--- NOMBRE: ProductoFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DataAccess.Mappers;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class ProductoFactory : MasterDao
{
    private readonly ProductoMapper _mapper;

    public ProductoFactory(string connectionString) : base(connectionString)
    {
        _mapper = new ProductoMapper();
    }

    public List<ProductoDTO> GetAll()
    {
        var dt = ExecuteQuery("SELECT * FROM PRODUCTO WHERE activo = 1", null, false);
        var lista = new List<ProductoDTO>();
        foreach (DataRow row in dt.Rows) lista.Add(_mapper.MapFromRow(row));
        return lista;
    }

    public ProductoDTO? GetById(int id)
    {
        var parameters = new[] { new SqlParameter("@id", id) };
        var dt = ExecuteQuery("SELECT * FROM PRODUCTO WHERE id = @id", parameters, false);
        return dt.Rows.Count > 0 ? _mapper.MapFromRow(dt.Rows[0]) : null;
    }

    public int Create(ProductoDTO producto)
    {
        return ExecuteScalar("sp_Producto_Insert", _mapper.MapToParameters(producto));
    }

    public void Update(ProductoDTO producto)
    {
        ExecuteNonQuery("sp_Producto_Update", _mapper.MapToParameters(producto), true);
    }

    // Registra un ingrediente para un producto elaborado
    public void InsertarComposicion(int padreId, int materialId, decimal cantidad)
    {
        var parameters = new[]
        {
            new SqlParameter("@producto_padre_id", padreId),
            new SqlParameter("@material_id", materialId),
            new SqlParameter("@cantidad_necesaria", cantidad)
        };

        // 
        string sql = "INSERT INTO PRODUCTO_COMPOSICION (producto_padre_id, material_id, cantidad_necesaria) VALUES (@producto_padre_id, @material_id, @cantidad_necesaria)";

        ExecuteNonQuery(sql, parameters, false);
    }

    // Obtiene la lista de materiales para que el InventarioService descuente stock
    // Dentro de ProductoFactory.cs
    public List<ProductoComposicionDTO> ObtenerComposicion(int padreId)
    {
        var parameters = new[] { new SqlParameter("@id", padreId) };

        // Cambia 'material_id' por el nombre real de tu columna si es diferente
        var dt = ExecuteQuery("SELECT material_id, cantidad_necesaria FROM PRODUCTO_COMPOSICION WHERE producto_padre_id = @id", parameters, false);

        var lista = new List<ProductoComposicionDTO>();
        foreach (DataRow row in dt.Rows)
        {
            lista.Add(new ProductoComposicionDTO
            {
                // Mapeo exacto a tu clase ProductoComposicionDTO
                MaterialId = Convert.ToInt32(row["material_id"]),
                CantidadNecesaria = Convert.ToDecimal(row["cantidad_necesaria"])
            });
        }
        return lista;
    }

    public List<ProductoDTO> GetStockAlerts()
    {
        var dt = ExecuteQuery("SELECT * FROM VW_ALERTA_STOCK_BAJO", null, false);
        var lista = new List<ProductoDTO>();
        foreach (DataRow row in dt.Rows)
        {
            lista.Add(new ProductoDTO
            {
                Id = Convert.ToInt32(row["id"]),
                Nombre = row["nombre"].ToString() ?? "",
                Existencia = Convert.ToDecimal(row["existencia"]),
                StockMinimo = Convert.ToDecimal(row["stock_minimo"])
            });
        }
        return lista;
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\UsuarioFactory.cs --- 
--- NOMBRE: UsuarioFactory.cs --- 
 
Ôªøusing System.Data;
using IntegraPro.DataAccess.Dao;
using IntegraPro.DataAccess.Mappers;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Factory;

public class UsuarioFactory : MasterDao
{
    private readonly UsuarioMapper _mapper;

    public UsuarioFactory(string connectionString) : base(connectionString)
    {
        _mapper = new UsuarioMapper();
    }

    /// <summary>
    /// Obtiene un usuario por su nombre de usuario. 
    /// Utilizado por el Login y por el LicenseFilter para validar la sesi√≥n activa.
    /// </summary>
    public UsuarioDTO? GetByUsername(string username)
    {
        var parameters = new SqlParameter[] {
            new SqlParameter("@username", username)
        };

        var table = ExecuteQuery("sp_Usuario_GetByUsername", parameters);

        if (table.Rows.Count == 0) return null;

        return _mapper.MapFromRow(table.Rows[0]);
    }

    public void Create(UsuarioDTO usuario)
    {
        // Definimos exactamente los 7 par√°metros que espera tu SP
        var parameters = new SqlParameter[] {
        new SqlParameter("@id", 0), // El SP lo pide pero no lo usa
        new SqlParameter("@rol_id", usuario.RolId),
        new SqlParameter("@sucursal_id", usuario.SucursalId),
        new SqlParameter("@nombre_completo", usuario.NombreCompleto),
        new SqlParameter("@username", usuario.Username),
        new SqlParameter("@password_hash", usuario.PasswordHash),
        new SqlParameter("@activo", usuario.Activo)
    };

        // Ejecutamos el procedimiento
        ExecuteStoredProcedure("sp_Usuario_Insert", parameters);
    }

    /// <summary>
    /// Registra o limpia el Hardware ID asociado a la sesi√≥n activa del usuario.
    /// </summary>
    /// <param name="usuarioId">ID del usuario en la base de datos.</param>
    /// <param name="hardwareId">ID de la PC. Si es null, libera la sesi√≥n (Logout).</param>
    public void ActualizarSesionHardware(int usuarioId, string? hardwareId)
    {
        var parameters = new SqlParameter[] {
            new SqlParameter("@id", usuarioId),
            // Si hardwareId es null, enviamos DBNull.Value a SQL para limpiar el campo
            new SqlParameter("@hardware_id_sesion", (object?)hardwareId ?? DBNull.Value)
        };

        // Ejecuta el procedimiento almacenado que actualiza la tabla USUARIO
        ExecuteNonQuery("sp_Usuario_ActualizarSesion", parameters);
    }

    public void RegistrarLogin(int usuarioId)
    {
        var parameters = new Microsoft.Data.SqlClient.SqlParameter[] {
        new Microsoft.Data.SqlClient.SqlParameter("@id", usuarioId)
    };
        ExecuteNonQuery("sp_Usuario_RegistrarLogin", parameters);
    }

}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Factory\VentaFactory.cs --- 
--- NOMBRE: VentaFactory.cs --- 
 
Ôªøusing IntegraPro.DataAccess.Dao;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;
using System.Data;

namespace IntegraPro.DataAccess.Factory;

public class VentaFactory(string connectionString) : MasterDao(connectionString)
{
    public string CrearFactura(FacturaDTO venta)
    {
        string consecutivo = venta.Consecutivo ?? "LOC-" + DateTime.Now.Ticks.ToString().Substring(10);
        bool esOffline = string.IsNullOrEmpty(venta.ClaveNumerica);
        string claveNumerica = !esOffline ? venta.ClaveNumerica! : "999" + DateTime.Now.ToString("ddMMyy") + "01" + DateTime.Now.Ticks.ToString().Substring(0, 10).PadLeft(20, '0');

        if (claveNumerica.Length > 50) claveNumerica = claveNumerica.Substring(0, 50);

        using (var connection = new SqlConnection(connectionString))
        {
            connection.Open();
            using (var transaction = connection.BeginTransaction())
            {
                try
                {
                    // 1. Encabezado
                    string sqlEnc = "INSERT INTO FACTURA_ENCABEZADO (cliente_id, sucursal_id, usuario_id, consecutivo, clave_numerica, fecha, condicion_venta, medio_pago, total_neto, total_impuesto, total_comprobante, estado_hacienda, es_offline) " +
                                   "VALUES (@cid, @sid, @uid, @cons, @clave, GETDATE(), @cond, @medio, @neto, @iva, @total, @estado, @off); " +
                                   "SELECT CAST(SCOPE_IDENTITY() as int);";

                    var pEnc = new[] {
                        new SqlParameter("@cid", venta.ClienteId),
                        new SqlParameter("@sid", venta.SucursalId),
                        new SqlParameter("@uid", venta.UsuarioId),
                        new SqlParameter("@cons", consecutivo),
                        new SqlParameter("@clave", claveNumerica),
                        new SqlParameter("@cond", venta.CondicionVenta),
                        new SqlParameter("@medio", venta.MedioPago),
                        new SqlParameter("@neto", venta.TotalNeto),
                        new SqlParameter("@iva", venta.TotalImpuesto),
                        new SqlParameter("@total", venta.TotalComprobante),
                        new SqlParameter("@estado", esOffline ? "LOCAL" : "ACEPTADO"),
                        new SqlParameter("@off", esOffline)
                    };

                    int facturaId = Convert.ToInt32(ExecuteScalarInTransaction(sqlEnc, pEnc, connection, transaction));

                    // 2. Detalles
                    foreach (var det in venta.Detalles)
                    {
                        decimal mImpuesto = (det.Cantidad * det.PrecioUnitario) * (det.PorcentajeImpuesto / 100);
                        decimal tLinea = (det.Cantidad * det.PrecioUnitario) + mImpuesto;

                        string sqlDet = "INSERT INTO FACTURA_DETALLE (factura_id, producto_id, cantidad, precio_unitario, monto_impuesto, total_linea, porcentaje_descuento, monto_descuento) " +
                                       "VALUES (@fid, @pid, @cant, @pre, @miva, @tot, 0, 0)";

                        var pDet = new[] {
                            new SqlParameter("@fid", facturaId),
                            new SqlParameter("@pid", det.ProductoId),
                            new SqlParameter("@cant", det.Cantidad),
                            new SqlParameter("@pre", det.PrecioUnitario),
                            new SqlParameter("@miva", mImpuesto),
                            new SqlParameter("@tot", tLinea)
                        };
                        ExecuteNonQueryInTransaction(sqlDet, pDet, connection, transaction);

                        // 3. Kardex
                        string sqlKardex = "INSERT INTO MOVIMIENTO_INVENTARIO (producto_id, usuario_id, fecha, tipo_movimiento, cantidad, documento_referencia, notas) " +
                                          "VALUES (@pid, @uid, GETDATE(), 'SALIDA', @cant, @ref, 'Venta')";

                        var pKar = new[] {
                            new SqlParameter("@pid", det.ProductoId),
                            new SqlParameter("@uid", venta.UsuarioId),
                            new SqlParameter("@cant", det.Cantidad),
                            new SqlParameter("@ref", consecutivo)
                        };
                        ExecuteNonQueryInTransaction(sqlKardex, pKar, connection, transaction);
                    }

                    transaction.Commit();
                    return consecutivo;
                }
                catch (Exception ex)
                {
                    transaction.Rollback();
                    throw new Exception("Error en VentaFactory: " + ex.Message);
                }
            }
        }
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Mappers\IMapper.cs --- 
--- NOMBRE: IMapper.cs --- 
 
Ôªøusing System.Data;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Mappers;

public interface IMapper<T>
{
    T MapFromRow(DataRow row);
    SqlParameter[] MapToParameters(T entity);
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Mappers\ProductoMapper.cs --- 
--- NOMBRE: ProductoMapper.cs --- 
 
Ôªøusing System.Data;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Mappers;

public class ProductoMapper : IMapper<ProductoDTO>
{
    public ProductoDTO MapFromRow(DataRow row)
    {
        return new ProductoDTO
        {
            Id = Convert.ToInt32(row["id"]),
            CategoriaId = Convert.ToInt32(row["categoria_id"]),
            CodCabys = row["cod_cabys"]?.ToString(),
            CodigoBarras = row["codigo_barras"]?.ToString(),
            Nombre = row["nombre"].ToString() ?? "",
            Descripcion = row["descripcion"]?.ToString(),
            UnidadMedida = row["unidad_medida"].ToString() ?? "Unid",
            CostoActual = Convert.ToDecimal(row["costo_actual"]),
            Precio1 = Convert.ToDecimal(row["precio_1"]),
            // Manejo de precios nulos (Precio 2, 3 y 4)
            Precio2 = row["precio_2"] != DBNull.Value ? Convert.ToDecimal(row["precio_2"]) : null,
            Precio3 = row["precio_3"] != DBNull.Value ? Convert.ToDecimal(row["precio_3"]) : null,
            Precio4 = row["precio_4"] != DBNull.Value ? Convert.ToDecimal(row["precio_4"]) : null,
            Existencia = Convert.ToDecimal(row["existencia"]),
            StockMinimo = Convert.ToDecimal(row["stock_minimo"]),
            ExentoIva = Convert.ToBoolean(row["exento_iva"]),
            EsServicio = Convert.ToBoolean(row["es_servicio"]),
            EsElaborado = Convert.ToBoolean(row["es_elaborado"]),
            Activo = Convert.ToBoolean(row["activo"])
        };
    }

    public SqlParameter[] MapToParameters(ProductoDTO entity)
    {
        var parameters = new List<SqlParameter>
        {
            new SqlParameter("@categoria_id", entity.CategoriaId),
            new SqlParameter("@cod_cabys", (object?)entity.CodCabys ?? DBNull.Value),
            new SqlParameter("@codigo_barras", (object?)entity.CodigoBarras ?? DBNull.Value),
            new SqlParameter("@nombre", entity.Nombre),
            new SqlParameter("@descripcion", (object?)entity.Descripcion ?? DBNull.Value),
            new SqlParameter("@unidad_medida", entity.UnidadMedida),
            new SqlParameter("@costo_actual", entity.CostoActual),
            new SqlParameter("@precio_1", entity.Precio1),
            // Par√°metros para precios adicionales e IVA
            new SqlParameter("@precio_2", (object?)entity.Precio2 ?? DBNull.Value),
            new SqlParameter("@precio_3", (object?)entity.Precio3 ?? DBNull.Value),
            new SqlParameter("@precio_4", (object?)entity.Precio4 ?? DBNull.Value),
            new SqlParameter("@exento_iva", entity.ExentoIva),
            new SqlParameter("@existencia", entity.Existencia),
            new SqlParameter("@stock_minimo", entity.StockMinimo),
            new SqlParameter("@es_servicio", entity.EsServicio),
            new SqlParameter("@es_elaborado", entity.EsElaborado),
            new SqlParameter("@activo", entity.Activo)
        };

        // SOLO si el Id es mayor a 0 (es un Update), lo agregamos.
        if (entity.Id > 0)
        {
            parameters.Add(new SqlParameter("@id", entity.Id));
        }

        return parameters.ToArray();
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\Mappers\UsuarioMapper.cs --- 
--- NOMBRE: UsuarioMapper.cs --- 
 
Ôªøusing System.Data;
using IntegraPro.DTO.Models;
using Microsoft.Data.SqlClient;

namespace IntegraPro.DataAccess.Mappers;

public class UsuarioMapper : IMapper<UsuarioDTO>
{
    public UsuarioDTO MapFromRow(DataRow row)
    {
        return new UsuarioDTO
        {
            Id = Convert.ToInt32(row["id"]),
            RolId = Convert.ToInt32(row["rol_id"]),
            SucursalId = Convert.ToInt32(row["sucursal_id"]),
            NombreCompleto = row["nombre_completo"]?.ToString() ?? "",
            Username = row["username"]?.ToString() ?? "",
            PasswordHash = row["password_hash"]?.ToString() ?? "",
            Activo = row["activo"] != DBNull.Value && Convert.ToBoolean(row["activo"]),
            UltimoLogin = row["ultimo_login"] != DBNull.Value ? Convert.ToDateTime(row["ultimo_login"]) : null,
            HardwareIdSesion = row.Table.Columns.Contains("hardware_id_sesion") && row["hardware_id_sesion"] != DBNull.Value
                               ? row["hardware_id_sesion"].ToString() : null
        };
    }

    public SqlParameter[] MapToParameters(UsuarioDTO entity)
    {
        return new SqlParameter[]
        {
            new SqlParameter("@id", entity.Id),
            new SqlParameter("@rol_id", entity.RolId),
            new SqlParameter("@sucursal_id", entity.SucursalId),
            new SqlParameter("@nombre_completo", entity.NombreCompleto ?? (object)DBNull.Value),
            new SqlParameter("@username", entity.Username ?? (object)DBNull.Value),
            new SqlParameter("@password_hash", entity.PasswordHash ?? (object)DBNull.Value),
            new SqlParameter("@activo", entity.Activo),
            new SqlParameter("@hardware_id_sesion", (object?)entity.HardwareIdSesion ?? DBNull.Value)
        };
    }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\obj\Debug\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
--- NOMBRE: .NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
 
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\obj\Debug\net9.0\IntegraPro.DataAccess.AssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.DataAccess.AssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("IntegraPro.DataAccess")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0+7f305de852982f374155bcd2c0c108960c4ac95d")]
[assembly: System.Reflection.AssemblyProductAttribute("IntegraPro.DataAccess")]
[assembly: System.Reflection.AssemblyTitleAttribute("IntegraPro.DataAccess")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DataAccess\obj\Debug\net9.0\IntegraPro.DataAccess.GlobalUsings.g.cs --- 
--- NOMBRE: IntegraPro.DataAccess.GlobalUsings.g.cs --- 
 
// <auto-generated/>
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Threading;
global using global::System.Threading.Tasks;
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Class1.cs --- 
--- NOMBRE: Class1.cs --- 
 
Ôªønamespace IntegraPro.DTO;

public class Class1
{

}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\AbonoDTO.cs --- 
--- NOMBRE: AbonoDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class AbonoDTO
{
    public int CuentaCobrarId { get; set; }
    public int UsuarioId { get; set; }
    public int SucursalId { get; set; }
    public decimal MontoAbonado { get; set; }
    public string MedioPago { get; set; } = "Efectivo";
    public string? Referencia { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\CajaDTO.cs --- 
--- NOMBRE: CajaDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class CajaAperturaDTO
{
    public int SucursalId { get; set; }
    public int UsuarioId { get; set; }
    public decimal MontoInicial { get; set; }
}

public class CajaCierreDTO
{
    public int CajaId { get; set; }
    public decimal MontoRealEnCaja { get; set; }
    public string? Notas { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\CategoriaDTO.cs --- 
--- NOMBRE: CategoriaDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class CategoriaDTO
{
    public int Id { get; set; }
    public string Nombre { get; set; } = string.Empty;
    public string? Descripcion { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\ClienteDTO.cs --- 
--- NOMBRE: ClienteDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class ClienteDTO
{
    public int Id { get; set; }
    public string Identificacion { get; set; } = string.Empty;
    public string Nombre { get; set; } = string.Empty;
    public string? Correo { get; set; }
    public string? Telefono { get; set; }
    public decimal LimiteCredito { get; set; }
    public bool Activo { get; set; } = true;
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\ConfiguracionDTO.cs --- 
--- NOMBRE: ConfiguracionDTO.cs --- 
 
Ôªøusing System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace IntegraPro.DTO.Models;

public class EmpresaDTO
{
    public int Id { get; set; }
    public string NombreComercial { get; set; } = string.Empty;
    public string CedulaJuridica { get; set; } = string.Empty;
    public string CorreoNotificaciones { get; set; } = string.Empty;
    public string TipoRegimen { get; set; } = "Tradicional";
}

public class LicenciaDTO
{
    public string LicenciaKey { get; set; } = string.Empty;
    public string HardwareId { get; set; } = string.Empty;
    public DateTime FechaVencimiento { get; set; }
    public string Estado { get; set; } = "Demo";
}
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\FacturaDTO.cs --- 
--- NOMBRE: FacturaDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class FacturaDTO
{
    // --- Encabezado ---
    public int ClienteId { get; set; }
    public int SucursalId { get; set; }
    public int UsuarioId { get; set; }

    // --- PROPIEDADES PARA FACTURACI√ìN ELECTR√ìNICA / LOCAL ---
    // El Factory usar√° estos si vienen del Front, o los generar√° si son null
    public string? Consecutivo { get; set; }
    public string? ClaveNumerica { get; set; }

    public string CondicionVenta { get; set; } = "Contado"; // Contado o Credito
    public string MedioPago { get; set; } = "Efectivo";
    public string? Notas { get; set; }

    // Detalle de productos
    public List<FacturaDetalleDTO> Detalles { get; set; } = new();

    // Totales calculados (Suma de todas las l√≠neas)
    public decimal TotalNeto { get; set; }
    public decimal TotalImpuesto { get; set; }
    public decimal TotalComprobante { get; set; }
}

public class FacturaDetalleDTO
{
    public int ProductoId { get; set; }
    public decimal Cantidad { get; set; }
    public decimal PrecioUnitario { get; set; }

    // --- PROPIEDAD CR√çTICA PARA LA SOLUCI√ìN ROBUSTA ---
    // Permite manejar 13%, 1%, 2%, 4% o 0% por cada producto individualmente
    public decimal PorcentajeImpuesto { get; set; }

    public decimal PorcentajeDescuento { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\MovimientoInventarioDTO.cs --- 
--- NOMBRE: MovimientoInventarioDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class MovimientoInventarioDTO
{
    public int Id { get; set; }
    public int ProductoId { get; set; }
    public int UsuarioId { get; set; }
    public DateTime Fecha { get; set; } = DateTime.Now;
    public string TipoMovimiento { get; set; } = "ENTRADA"; // ENTRADA o SALIDA
    public decimal Cantidad { get; set; }
    public decimal? ExistenciaPrevia { get; set; }
    public decimal? ExistenciaPosterior { get; set; }
    public string? DocumentoReferencia { get; set; }
    public string? Notas { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\ProductoDTO.cs --- 
--- NOMBRE: ProductoDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class ProductoDTO
{
    public int Id { get; set; }
    public int CategoriaId { get; set; }
    public string? CodCabys { get; set; }
    public string? CodigoBarras { get; set; }
    public string Nombre { get; set; } = string.Empty;
    public string? Descripcion { get; set; }
    public string UnidadMedida { get; set; } = "Unid"; // Unid, Kg, M2, M
    public decimal CostoActual { get; set; }

    // Niveles de precios seg√∫n tu tabla SQL
    public decimal Precio1 { get; set; }
    public decimal? Precio2 { get; set; }
    public decimal? Precio3 { get; set; }
    public decimal? Precio4 { get; set; }

    public decimal Existencia { get; set; }
    public decimal StockMinimo { get; set; }

    // Configuraci√≥n fiscal y de tipo
    public bool ExentoIva { get; set; } // Coincide con exento_iva de tu tabla
    public bool Activo { get; set; }
    public bool EsServicio { get; set; }
    public bool EsElaborado { get; set; } // Si es TRUE, usa receta

    // Propiedad para manejar la receta/composici√≥n
    public List<ProductoComposicionDTO> Receta { get; set; } = new();
}

public class ProductoComposicionDTO
{
    public int MaterialId { get; set; }
    public string? MaterialNombre { get; set; }
    public decimal CantidadNecesaria { get; set; }
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\Models\UsuarioDTO.cs --- 
--- NOMBRE: UsuarioDTO.cs --- 
 
Ôªønamespace IntegraPro.DTO.Models;

public class UsuarioDTO
{
    public int Id { get; set; }
    public int RolId { get; set; }
    public int SucursalId { get; set; }
    public string NombreCompleto { get; set; } = string.Empty;
    public string Username { get; set; } = string.Empty;
    public string? Password { get; set; }
    public string PasswordHash { get; set; } = string.Empty;
    public string CorreoElectronico { get; set; } = string.Empty;
    public bool Activo { get; set; }
    public DateTime? UltimoLogin { get; set; }

    // Nueva propiedad para control de sesi√≥n
    public string? HardwareIdSesion { get; set; }
}

// Clase de apoyo para recibir credenciales
public class LoginRequest
{
    public string Username { get; set; } = string.Empty;
    public string Password { get; set; } = string.Empty;
}.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\obj\Debug\net9.0\.NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
--- NOMBRE: .NETCoreApp,Version=v9.0.AssemblyAttributes.cs --- 
 
// <autogenerated />
using System;
using System.Reflection;
[assembly: global::System.Runtime.Versioning.TargetFrameworkAttribute(".NETCoreApp,Version=v9.0", FrameworkDisplayName = ".NET 9.0")]
.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\obj\Debug\net9.0\IntegraPro.DTO.AssemblyInfo.cs --- 
--- NOMBRE: IntegraPro.DTO.AssemblyInfo.cs --- 
 
//------------------------------------------------------------------------------
// <auto-generated>
//     Este c√≥digo fue generado por una herramienta.
//     Versi√≥n de runtime:4.0.30319.42000
//
//     Los cambios en este archivo podr√≠an causar un comportamiento incorrecto y se perder√°n si
//     se vuelve a generar el c√≥digo.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("IntegraPro.DTO")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Debug")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0+7f305de852982f374155bcd2c0c108960c4ac95d")]
[assembly: System.Reflection.AssemblyProductAttribute("IntegraPro.DTO")]
[assembly: System.Reflection.AssemblyTitleAttribute("IntegraPro.DTO")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]

// Generado por la clase WriteCodeFragment de MSBuild.

.
 
--- RUTA: C:\Users\Luis\source\repos\Integra\IntegraPro\IntegraPro.DTO\obj\Debug\net9.0\IntegraPro.DTO.GlobalUsings.g.cs --- 
--- NOMBRE: IntegraPro.DTO.GlobalUsings.g.cs --- 
 
// <auto-generated/>
global using global::System;
global using global::System.Collections.Generic;
global using global::System.IO;
global using global::System.Linq;
global using global::System.Net.Http;
global using global::System.Threading;
global using global::System.Threading.Tasks;
.
